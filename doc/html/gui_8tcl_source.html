<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TKE: /Users/trevorw/projects/tke-code/lib/gui.tcl Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>/Users/trevorw/projects/tke-code/lib/gui.tcl</h1><a href="gui_8tcl.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor"># Name:    gui.tcl</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># Author:  Trevor Williams  (phase1geo@gmail.com)</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Date:    5/11/2013</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># Brief:   Contains all of the main GUI elements for the editor and</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor">#          their behavior.</span>
<a name="l00006"></a>00006 <span class="preprocessor"></span>
<a name="l00007"></a>00007 <span class="keyword">namespace </span>eval gui {
<a name="l00008"></a>00008 
<a name="l00009"></a>00009   source [file join $::tke_dir lib ns.tcl]
<a name="l00010"></a>00010 
<a name="l00011"></a>00011   variable curr_id          0
<a name="l00012"></a>00012   variable files            {}
<a name="l00013"></a>00013   variable pw_index         0
<a name="l00014"></a>00014   variable pw_current       0
<a name="l00015"></a>00015   variable nb_index         0
<a name="l00016"></a>00016   variable nb_move          <span class="stringliteral">&quot;&quot;</span>
<a name="l00017"></a>00017   variable file_move        0
<a name="l00018"></a>00018   variable session_file     [file join $::tke_home session.tkedat]
<a name="l00019"></a>00019   variable lengths          {}
<a name="l00020"></a>00020   variable user_exit_status <span class="stringliteral">&quot;&quot;</span>
<a name="l00021"></a>00021   variable file_locked      0
<a name="l00022"></a>00022   variable file_favorited   0
<a name="l00023"></a>00023   variable last_opened      [list]
<a name="l00024"></a>00024   variable fif_files        [list]
<a name="l00025"></a>00025   variable info_clear       <span class="stringliteral">&quot;&quot;</span>
<a name="l00026"></a>00026   variable trailing_ws_re   {[\ \t]+$}
<a name="l00027"></a>00027   variable case_sensitive   1
<a name="l00028"></a>00028 
<a name="l00029"></a>00029   array <span class="keyword">set</span> widgets         {}
<a name="l00030"></a>00030   array <span class="keyword">set</span> language        {}
<a name="l00031"></a>00031   array <span class="keyword">set</span> images          {}
<a name="l00032"></a>00032   array <span class="keyword">set</span> tab_tip         {}
<a name="l00033"></a>00033   array <span class="keyword">set</span> line_sel_anchor {}
<a name="l00034"></a>00034   array <span class="keyword">set</span> tab_current     {}
<a name="l00035"></a>00035   array <span class="keyword">set</span> txt_current     {}
<a name="l00036"></a>00036   array <span class="keyword">set</span> cursor_hist     {}
<a name="l00037"></a>00037 
<a name="l00038"></a>00038   array <span class="keyword">set</span> files_index {
<a name="l00039"></a>00039     fname    0
<a name="l00040"></a>00040     mtime    1
<a name="l00041"></a>00041     save_cmd 2
<a name="l00042"></a>00042     tab      3
<a name="l00043"></a>00043     lock     4
<a name="l00044"></a>00044     readonly 5
<a name="l00045"></a>00045     sidebar  6
<a name="l00046"></a>00046     modified 7
<a name="l00047"></a>00047     buffer   8
<a name="l00048"></a>00048     gutters  9
<a name="l00049"></a>00049     diff     10
<a name="l00050"></a>00050   }
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">  #######################</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">  #  PUBLIC PROCEDURES  #</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">  #######################</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a>00056 <span class="preprocessor">  ######################################################################</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">  # Returns the file index based on the given fname.  If the filename</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">  # was not found, return an index value of -1.</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>  proc get_file_index {fname} {
<a name="l00060"></a>00060 
<a name="l00061"></a>00061     variable files
<a name="l00062"></a>00062     variable files_index
<a name="l00063"></a>00063 
<a name="l00064"></a>00064     <span class="keywordflow">return</span> [lsearch -index $files_index(fname) $files $fname]
<a name="l00065"></a>00065 
<a name="l00066"></a>00066   }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068   <span class="preprocessor">######################################################################</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">  # Checks to see if the given file is newer than the file within the</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">  # editor.  If it is newer, prompt the user to update the file.</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>  proc check_file {index} {
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     variable files
<a name="l00074"></a>00074     variable files_index
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     <span class="keyword">set</span> fname [lindex $files $index $files_index(fname)]
<a name="l00077"></a>00077     <span class="keywordflow">if</span> {$fname ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l00078"></a>00078       <span class="keyword">set</span> mtime [lindex $files $index $files_index(mtime)]
<a name="l00079"></a>00079       <span class="keywordflow">if</span> {[file exists $fname]} {
<a name="l00080"></a>00080         file stat $fname stat
<a name="l00081"></a>00081         <span class="keywordflow">if</span> {$mtime != $stat(mtime)} {
<a name="l00082"></a>00082           <span class="keywordflow">if</span> {[lindex $files $index $files_index(modified)]} {
<a name="l00083"></a>00083             <span class="keyword">set</span> answer [tk_messageBox -parent . -icon question -message [msgcat::mc <span class="stringliteral">&quot;Reload file?&quot;</span>] \
<a name="l00084"></a>00084               -detail $fname -type yesno -<span class="keywordflow">default</span> yes]
<a name="l00085"></a>00085             <span class="keywordflow">if</span> {$answer eq <span class="stringliteral">&quot;yes&quot;</span>} {
<a name="l00086"></a>00086               update_file $index
<a name="l00087"></a>00087             }
<a name="l00088"></a>00088           } <span class="keywordflow">else</span> {
<a name="l00089"></a>00089             update_file $index
<a name="l00090"></a>00090           }
<a name="l00091"></a>00091           lset files $index $files_index(mtime) $stat(mtime)
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093       } elseif {$mtime ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l00094"></a>00094         <span class="keyword">set</span> answer [tk_messageBox -parent . -icon question -message [msgcat::mc <span class="stringliteral">&quot;Delete tab?&quot;</span>] \
<a name="l00095"></a>00095           -detail $fname -type yesno -<span class="keywordflow">default</span> yes]
<a name="l00096"></a>00096         <span class="keywordflow">if</span> {$answer eq <span class="stringliteral">&quot;yes&quot;</span>} {
<a name="l00097"></a>00097           close_tab [lindex $files $index $files_index(tab)]
<a name="l00098"></a>00098         } <span class="keywordflow">else</span> {
<a name="l00099"></a>00099           lset files $index $files_index(mtime) <span class="stringliteral">&quot;&quot;</span>
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101       }
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104   }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="preprocessor">  ######################################################################</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span><span class="preprocessor">  # Polls every 10 seconds to see if any of the loaded files have been</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span><span class="preprocessor">  # updated since the last save.</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>  proc poll {} {
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     variable files
<a name="l00112"></a>00112     variable files_index
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="preprocessor">    # Check the modification of every file in the files list</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span>    <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; [llength $files]} {incr i} {
<a name="l00116"></a>00116       check_file $i
<a name="l00117"></a>00117     }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="preprocessor">    # Check again after 10 seconds</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>    after 10000 [ns gui]::poll
<a name="l00121"></a>00121 
<a name="l00122"></a>00122   }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="preprocessor">  ######################################################################</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="preprocessor">  # Sets the title of the window to match the current file.</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>  proc set_title {} {
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="preprocessor">    # Get the current tab</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {([<span class="keyword">set</span> tb [current_tabbar]] ne <span class="stringliteral">&quot;&quot;</span>) &amp;&amp; ([llength [$tb tabs]] &gt; 0)} {
<a name="l00130"></a>00130       <span class="keyword">set</span> tab_name [$tb tab current -text]
<a name="l00131"></a>00131     } <span class="keywordflow">else</span> {
<a name="l00132"></a>00132       <span class="keyword">set</span> tab_name <span class="stringliteral">&quot;&quot;</span>
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     wm title . <span class="stringliteral">&quot;$tab_name \[[lindex [split [info hostname] .] 0]:[pwd]\]&quot;</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137   }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="preprocessor">  ######################################################################</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span><span class="preprocessor">  # Creates all images.</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>  proc create_images {} {
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     variable images
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="preprocessor">    # Delete any previously created images that we will be recreating</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[array size images] &gt; 0} {
<a name="l00147"></a>00147       <span class="keywordflow">foreach</span> name [list lock readonly diff close split down global] {
<a name="l00148"></a>00148         image <span class="keyword">delete</span> $images($name)
<a name="l00149"></a>00149       }
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     <span class="keyword">set</span> foreground [utils::get_default_foreground]
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="keywordflow">switch</span> [preferences::get General/WindowTheme] {
<a name="l00155"></a>00155       dark {
<a name="l00156"></a>00156         <span class="keyword">set</span> lock     $foreground
<a name="l00157"></a>00157         <span class="keyword">set</span> readonly grey70
<a name="l00158"></a>00158         <span class="keyword">set</span> diff     $foreground
<a name="l00159"></a>00159         <span class="keyword">set</span> images(global) [image create photo -file [file join $::tke_dir lib images global_dark.gif]]
<a name="l00160"></a>00160       }
<a name="l00161"></a>00161       <span class="keywordflow">default</span> {
<a name="l00162"></a>00162         <span class="keyword">set</span> lock     $foreground
<a name="l00163"></a>00163         <span class="keyword">set</span> readonly grey30
<a name="l00164"></a>00164         <span class="keyword">set</span> diff     $foreground
<a name="l00165"></a>00165         <span class="keyword">set</span> images(global) [image create photo -file [file join $::tke_dir lib images global.gif]]
<a name="l00166"></a>00166       }
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="keyword">set</span> images(lock)     [image create bitmap -file     [file join $::tke_dir lib images lock.bmp] \
<a name="l00170"></a>00170                                               -maskfile [file join $::tke_dir lib images lock.bmp] \
<a name="l00171"></a>00171                                               -foreground $lock]
<a name="l00172"></a>00172     <span class="keyword">set</span> images(readonly) [image create bitmap -file     [file join $::tke_dir lib images lock.bmp] \
<a name="l00173"></a>00173                                               -maskfile [file join $::tke_dir lib images lock.bmp] \
<a name="l00174"></a>00174                                               -foreground $readonly]
<a name="l00175"></a>00175     <span class="keyword">set</span> images(diff)     [image create bitmap -file     [file join $::tke_dir lib images diff.bmp] \
<a name="l00176"></a>00176                                               -maskfile [file join $::tke_dir lib images diff.bmp] \
<a name="l00177"></a>00177                                               -foreground $diff]
<a name="l00178"></a>00178     <span class="keyword">set</span> images(close)    [image create bitmap -file     [file join $::tke_dir lib images close.bmp] \
<a name="l00179"></a>00179                                               -maskfile [file join $::tke_dir lib images close.bmp] \
<a name="l00180"></a>00180                                               -foreground $foreground]
<a name="l00181"></a>00181     <span class="keyword">set</span> images(split)    [image create bitmap -file     [file join $::tke_dir lib images split.bmp] \
<a name="l00182"></a>00182                                               -maskfile [file join $::tke_dir lib images split.bmp] \
<a name="l00183"></a>00183                                               -foreground $foreground]
<a name="l00184"></a>00184     <span class="keyword">set</span> images(down)     [image create bitmap -file     [file join $::tke_dir lib images down.bmp] \
<a name="l00185"></a>00185                                               -maskfile [file join $::tke_dir lib images down.bmp] \
<a name="l00186"></a>00186                                               -foreground $foreground]
<a name="l00187"></a>00187 
<a name="l00188"></a>00188   }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 <span class="preprocessor">  ######################################################################</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor">  # Create the main GUI interface.</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>  proc create {} {
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     variable widgets
<a name="l00195"></a>00195     variable images
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="preprocessor">    # Set the application icon photo</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span>    wm iconphoto . [image create photo -file [file join $::tke_dir lib images tke_logo_128.gif]]
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="preprocessor">    # Create images</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>    create_images
<a name="l00202"></a>00202     <span class="keyword">set</span> images(logo) [image create photo -file [file join $::tke_dir lib images tke_logo_64.gif]]
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 <span class="preprocessor">    # Create the panedwindow</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>    <span class="keyword">set</span> widgets(pw) [ttk::panedwindow .pw -orient horizontal]
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="preprocessor">    # Add the sidebar</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span>    <span class="keyword">set</span> widgets(sb) [sidebar::create $widgets(pw).sb]
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="preprocessor">    # Create panedwindow (to support split pane view)</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span>    $widgets(pw) add [ttk::frame $widgets(pw).tf]
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     <span class="preprocessor"># Create the notebook panedwindow</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span>    <span class="keyword">set</span> widgets(nb_pw) [ttk::panedwindow $widgets(pw).tf.nbpw -orient horizontal]
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <span class="preprocessor">    # Add notebook</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span>    add_notebook
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="preprocessor">    # Pack the notebook panedwindow</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span>    pack $widgets(nb_pw) -fill both -expand yes
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="preprocessor">    # Create the find_in_files widget</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>    <span class="keyword">set</span> widgets(fif)       [ttk::frame .fif]
<a name="l00224"></a>00224     ttk::label $widgets(fif).lf -text <span class="stringliteral">&quot;Find: &quot;</span>
<a name="l00225"></a>00225     <span class="keyword">set</span> widgets(fif_find)  [ttk::entry $widgets(fif).ef]
<a name="l00226"></a>00226     <span class="keyword">set</span> widgets(fif_case)  [ttk::checkbutton $widgets(fif).case -text <span class="stringliteral">&quot;Aa&quot;</span> -variable gui::case_sensitive]
<a name="l00227"></a>00227     ttk::label $widgets(fif).li -text <span class="stringliteral">&quot;In: &quot;</span>
<a name="l00228"></a>00228     <span class="keyword">set</span> widgets(fif_in)    [tokenentry::tokenentry $widgets(fif).ti -font [$widgets(fif_find) cget -font]]
<a name="l00229"></a>00229     set widgets(fif_close) [ttk::label $widgets(fif).close -image $images(close)]
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     tooltip::tooltip $widgets(fif_case) &quot;Case sensitivity&quot;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     bind $widgets(fif_find) &lt;Return&gt; {
<a name="l00234"></a>00234       <span class="keywordflow">if</span> {([llength [$gui::widgets(fif_in) tokenget]] &gt; 0) &amp;&amp; \
<a name="l00235"></a>00235           ([$gui::widgets(fif_find) get] ne &quot;&quot;)} {
<a name="l00236"></a>00236         <span class="keyword">set</span> gui::user_exit_status 1
<a name="l00237"></a>00237       }
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239     bind $widgets(fif_find)          &lt;Escape&gt;    { <span class="keyword">set</span> gui::user_exit_status 0 }
<a name="l00240"></a>00240     bind [$widgets(fif_in) entrytag] &lt;Return&gt;    { <span class="keywordflow">if</span> {[gui::check_fif_for_return]} <span class="keywordflow">break</span> }
<a name="l00241"></a>00241     bind [$widgets(fif_in) entrytag] &lt;Escape&gt;    { <span class="keyword">set</span> gui::user_exit_status 0 }
<a name="l00242"></a>00242     bind $widgets(fif_case)          &lt;Escape&gt;    { <span class="keyword">set</span> gui::user_exit_status 0 }
<a name="l00243"></a>00243     bind $widgets(fif_close)         &lt;Button-1&gt;  { <span class="keyword">set</span> gui::user_exit_status 0 }
<a name="l00244"></a>00244     bind $widgets(fif_close)         &lt;Key-space&gt; { <span class="keyword">set</span> gui::user_exit_status 0 }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     grid columnconfigure $widgets(fif) 1 -weight 1
<a name="l00247"></a>00247     grid $widgets(fif).lf    -row 0 -column 0 -sticky ew -pady 2
<a name="l00248"></a>00248     grid $widgets(fif).ef    -row 0 -column 1 -sticky ew -pady 2
<a name="l00249"></a>00249     grid $widgets(fif).case  -row 0 -column 2 -sticky news -padx 2 -pady 2
<a name="l00250"></a>00250     grid $widgets(fif).close -row 0 -column 3 -sticky news -padx 2 -pady 2
<a name="l00251"></a>00251     grid $widgets(fif).li    -row 1 -column 0 -sticky ew -pady 2
<a name="l00252"></a>00252     grid $widgets(fif).ti    -row 1 -column 1 -sticky ew -pady 2 -columnspan 2
<a name="l00253"></a>00253     
<a name="l00254"></a>00254 <span class="preprocessor">    # Create the information bar</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span>    <span class="keyword">set</span> widgets(info)        [ttk::frame .if]
<a name="l00256"></a>00256     <span class="keyword">set</span> widgets(info_state)  [ttk::label .if.l1]
<a name="l00257"></a>00257     <span class="keyword">set</span> widgets(info_msg)    [ttk::label .if.l2]
<a name="l00258"></a>00258     <span class="keyword">set</span> widgets(info_indent) [ttk::label .if.l3]
<a name="l00259"></a>00259     <span class="keyword">set</span> widgets(info_syntax) [syntax::create_menubutton .if.syn]
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     $widgets(info_syntax) configure -state disabled
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     pack .if.l1  -side left  -padx 2 -pady 2
<a name="l00264"></a>00264     pack .if.l2  -side left  -padx 2 -pady 2
<a name="l00265"></a>00265     pack .if.syn -side right -padx 2 -pady 2
<a name="l00266"></a>00266     pack .if.l3  -side right -padx 2 -pady 2
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="preprocessor"># Create the configurable response widget</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span>    <span class="keyword">set</span> widgets(ursp)       [ttk::frame .rf]
<a name="l00270"></a>00270     <span class="keyword">set</span> widgets(ursp_label) [ttk::label .rf.l]
<a name="l00271"></a>00271     <span class="keyword">set</span> widgets(ursp_entry) [ttk::entry .rf.e]
<a name="l00272"></a>00272     ttk::label .rf.close -image $images(close)
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     bind $widgets(ursp_entry) &lt;Return&gt;    &quot;set gui::user_exit_status 1&quot;
<a name="l00275"></a>00275     bind $widgets(ursp_entry) &lt;Escape&gt;    &quot;set gui::user_exit_status 0&quot;
<a name="l00276"></a>00276     bind .rf.close            &lt;Button-1&gt;  &quot;set gui::user_exit_status 0&quot;
<a name="l00277"></a>00277     bind .rf.close            &lt;Key-space&gt; &quot;set gui::user_exit_status 0&quot;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     grid rowconfigure    .rf 0 -weight 1
<a name="l00280"></a>00280     grid columnconfigure .rf 1 -weight 1
<a name="l00281"></a>00281     grid $widgets(ursp_label) -row 0 -column 0 -sticky news -padx 2 -pady 2
<a name="l00282"></a>00282     grid $widgets(ursp_entry) -row 0 -column 1 -sticky news -padx 2 -pady 2
<a name="l00283"></a>00283     grid .rf.close            -row 0 -column 2 -sticky news -padx 2 -pady 2
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="preprocessor"># Pack the notebook</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span>    grid rowconfigure    . 0 -weight 1
<a name="l00287"></a>00287     grid columnconfigure . 0 -weight 1
<a name="l00288"></a>00288     grid $widgets(pw)   -row 0 -column 0 -sticky news
<a name="l00289"></a>00289     grid $widgets(ursp) -row 1 -column 0 -sticky ew
<a name="l00290"></a>00290     grid $widgets(fif)  -row 2 -column 0 -sticky ew
<a name="l00291"></a>00291     grid $widgets(info) -row 3 -column 0 -sticky ew
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     grid <span class="keyword">remove</span> $widgets(ursp)
<a name="l00294"></a>00294     grid remove $widgets(fif)
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="preprocessor"># Create tab popup</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>    <span class="keyword">set</span> widgets(menu) [menu $widgets(nb_pw).popupMenu -tearoff 0 -postcommand gui::setup_tab_popup_menu]
<a name="l00298"></a>00298     $widgets(menu) add command -label [msgcat::mc &quot;Close Tab&quot;] -command {
<a name="l00299"></a>00299       gui::close_current {}
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301     $widgets(menu) add command -label [msgcat::mc &quot;Close Other Tab(s)&quot;] -command {
<a name="l00302"></a>00302       gui::close_others
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304     $widgets(menu) add command -label [msgcat::mc &quot;Close All Tabs&quot;] -command {
<a name="l00305"></a>00305       gui::close_all
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     $widgets(menu) add separator
<a name="l00308"></a>00308     $widgets(menu) add checkbutton -label [msgcat::mc &quot;Locked&quot;] -onvalue 1 -offvalue 0 -variable gui::file_locked -command {
<a name="l00309"></a>00309       gui::set_current_file_lock {} $gui::file_locked
<a name="l00310"></a>00310     }
<a name="l00311"></a>00311     $widgets(menu) add checkbutton -label [msgcat::mc &quot;Favorited&quot;] -onvalue 1 -offvalue 0 -variable gui::file_favorited -command {
<a name="l00312"></a>00312       gui::set_current_file_favorite {} $gui::file_favorited
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314     $widgets(menu) add separator
<a name="l00315"></a>00315     $widgets(menu) add command -label [msgcat::mc &quot;Show in Sidebar&quot;] -command {
<a name="l00316"></a>00316       gui::show_current_in_sidebar
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318     $widgets(menu) add separator
<a name="l00319"></a>00319     $widgets(menu) add command -label [msgcat::mc &quot;Move to Other Pane&quot;] -command {
<a name="l00320"></a>00320       gui::move_to_pane
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 <span class="preprocessor">    # Add plugins to tab popup</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>    plugins::handle_tab_popup $widgets(menu)
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     <span class="preprocessor"># Add the menu bar</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span>    menus::create
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 <span class="preprocessor">    # Show the sidebar (if necessary)</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[preferences::get View/ShowSidebar]} {
<a name="l00331"></a>00331       show_sidebar_view
<a name="l00332"></a>00332     } <span class="keywordflow">else</span> {
<a name="l00333"></a>00333       hide_sidebar_view
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 <span class="preprocessor">    # Show the console (if necessary)</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[preferences::get View/ShowConsole]} {
<a name="l00338"></a>00338       show_console_view
<a name="l00339"></a>00339     } <span class="keywordflow">else</span> {
<a name="l00340"></a>00340 <span class="preprocessor">      # hide_console_view</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span>    }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 <span class="preprocessor">    # Show the tabbar (if necessary)</span>
<a name="l00344"></a>00344 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[preferences::get View/ShowTabBar]} {
<a name="l00345"></a>00345       show_tab_view
<a name="l00346"></a>00346     } <span class="keywordflow">else</span> {
<a name="l00347"></a>00347       hide_tab_view
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 <span class="preprocessor">    # Show the status bar (if necessary)</span>
<a name="l00351"></a>00351 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[preferences::get View/ShowStatusBar]} {
<a name="l00352"></a>00352       show_status_view
<a name="l00353"></a>00353     } <span class="keywordflow">else</span> {
<a name="l00354"></a>00354       hide_status_view
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357 <span class="preprocessor">    # If the user attempts to close the window via the window manager, treat</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span><span class="preprocessor">    # it as an exit request from the menu system.</span>
<a name="l00359"></a>00359 <span class="preprocessor"></span>    wm protocol . WM_DELETE_WINDOW {
<a name="l00360"></a>00360       menus::exit_command
<a name="l00361"></a>00361     }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="preprocessor">    # Trace changes to the Appearance/Theme preference variable</span>
<a name="l00364"></a>00364 <span class="preprocessor"></span>    trace variable preferences::prefs(Editor/WarningWidth)       w gui::handle_warning_width_change
<a name="l00365"></a>00365     trace variable preferences::prefs(Editor/MaxUndo)            w gui::handle_max_undo
<a name="l00366"></a>00366     trace variable preferences::prefs(View/AllowTabScrolling)    w gui::handle_allow_tab_scrolling
<a name="l00367"></a>00367     trace variable preferences::prefs(Tools/VimMode)             w gui::handle_vim_mode
<a name="l00368"></a>00368     trace variable preferences::prefs(Appearance/EditorFontSize) w gui::handle_editor_font_size
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372   <span class="preprocessor">######################################################################</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span><span class="preprocessor">  # Returns 1 if a return key event should cause the find in files search</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span><span class="preprocessor">  # to begin.</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span>  proc check_fif_for_return {} {
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     variable widgets
<a name="l00378"></a>00378     variable user_exit_status
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="keywordflow">if</span> {([llength [$widgets(fif_in) tokenget]] &gt; 0) &amp;&amp; \
<a name="l00381"></a>00381         ([$widgets(fif_in) entryget] eq &quot;&quot;) &amp;&amp; \
<a name="l00382"></a>00382         ([$widgets(fif_find) get] ne &quot;&quot;)} {
<a name="l00383"></a>00383       <span class="keyword">set</span> user_exit_status 1
<a name="l00384"></a>00384       <span class="keywordflow">return</span> 1
<a name="l00385"></a>00385     }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     <span class="keywordflow">return</span> 0
<a name="l00388"></a>00388 
<a name="l00389"></a>00389   }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="preprocessor">  ######################################################################</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span><span class="preprocessor">  # Handles any preference changes to the Editor/WarningWidth setting.</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>  proc handle_warning_width_change {name1 name2 op} {
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     variable widgets
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 <span class="preprocessor">    # Set the warning width to the specified value</span>
<a name="l00398"></a>00398 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> pane [$widgets(nb_pw) panes] {
<a name="l00399"></a>00399       <span class="keywordflow">foreach</span> tab [$pane.tbf.tb tabs] {
<a name="l00400"></a>00400         <span class="keywordflow">foreach</span> txt_pane [$tab.pw panes] {
<a name="l00401"></a>00401           $txt_pane.txt configure -warnwidth [preferences::get Editor/WarningWidth]
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403       }
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406   }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="preprocessor">  ######################################################################</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span><span class="preprocessor">  # Handles any preference changes to the Editor/MaxUndo setting.</span>
<a name="l00410"></a>00410 <span class="preprocessor"></span>  proc handle_max_undo {name1 name2 op} {
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     variable widgets
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="preprocessor">    # Set the max_undo to the specified value</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> pane [$widgets(nb_pw) panes] {
<a name="l00416"></a>00416       <span class="keywordflow">foreach</span> tab [$pane.tbf.tb tabs] {
<a name="l00417"></a>00417         <span class="keywordflow">foreach</span> txt_pane [$tab.pw panes] {
<a name="l00418"></a>00418           $txt_pane.txt configure -maxundo [preferences::get Editor/MaxUndo]
<a name="l00419"></a>00419         }
<a name="l00420"></a>00420       }
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423   }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 <span class="preprocessor">  ######################################################################</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span><span class="preprocessor">  # Handles any changes to the View/AllowTabScrolling preference variable.</span>
<a name="l00427"></a>00427 <span class="preprocessor"></span>  proc handle_allow_tab_scrolling {name1 name2 op} {
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     variable widgets
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="keywordflow">foreach</span> pane [$widgets(nb_pw) panes] {
<a name="l00432"></a>00432       $pane.tbf.tb configure -mintabwidth [expr {[preferences::get View/AllowTabScrolling] ? [lindex [$pane.tbf.tb configure -mintabwidth] 3] : 1}]
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435   }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 <span class="preprocessor">  ######################################################################</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span><span class="preprocessor">  # Handles any changes to the Tools/VimMode preference variable.</span>
<a name="l00439"></a>00439 <span class="preprocessor"></span>  proc handle_vim_mode {name1 name2 op} {
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     vim::set_vim_mode_all
<a name="l00442"></a>00442 
<a name="l00443"></a>00443   }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 <span class="preprocessor">  ######################################################################</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span><span class="preprocessor">  # Handles any changes to the General/WindowTheme preference value.</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span>  proc handle_window_theme {theme} {
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     variable widgets
<a name="l00450"></a>00450     variable images
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="keywordflow">if</span> {[info exists widgets(nb_pw)]} {
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 <span class="preprocessor">      # Get the default background and foreground colors</span>
<a name="l00455"></a>00455 <span class="preprocessor"></span>      <span class="keyword">set</span> bg  [utils::get_default_background]
<a name="l00456"></a>00456       <span class="keyword">set</span> fg  [utils::get_default_foreground]
<a name="l00457"></a>00457       <span class="keyword">set</span> abg [utils::auto_adjust_color $bg 30]
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="preprocessor">      # Store the readonly/lock status of each tab</span>
<a name="l00460"></a>00460 <span class="preprocessor"></span>      array <span class="keyword">set</span> tab_status [list]
<a name="l00461"></a>00461       <span class="keywordflow">foreach</span> nb [$widgets(nb_pw) panes] {
<a name="l00462"></a>00462         <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; [llength [$nb.tbf.tb tabs]]} {incr i} {
<a name="l00463"></a>00463           <span class="keywordflow">if</span> {[$nb.tbf.tb tab $i -image] eq $images(readonly)} {
<a name="l00464"></a>00464             <span class="keyword">set</span> tab_status($nb.tbf.tb,$i,readonly) 1
<a name="l00465"></a>00465           } elseif {[$nb.tbf.tb tab $i -image] eq $images(lock)} {
<a name="l00466"></a>00466             <span class="keyword">set</span> tab_status($nb.tbf.tb,$i,lock) 1
<a name="l00467"></a>00467           } elseif {[$nb.tbf.tb tab $i -image] eq $images(diff)} {
<a name="l00468"></a>00468             <span class="keyword">set</span> tab_status($nb.tbf.tb,$i,diff) 1
<a name="l00469"></a>00469           }
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471       }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="preprocessor">      # Update all of the images</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span>      create_images
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 <span class="preprocessor">      # Update the lock/readonly/diff images in the tabs</span>
<a name="l00477"></a>00477 <span class="preprocessor"></span>      <span class="keywordflow">foreach</span> name [array names tab_status] {
<a name="l00478"></a>00478         lassign [split $name ,] tb i type
<a name="l00479"></a>00479         $tb tab $i -image $images($type)
<a name="l00480"></a>00480       }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="preprocessor">      # Update the find in file close button</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span>      $widgets(fif_close) configure -image $images(close)
<a name="l00484"></a>00484       <span class="preprocessor"># $widgets(fif_in)    configure -background $fg</span>
<a name="l00485"></a>00485 <span class="preprocessor"></span>
<a name="l00486"></a>00486 <span class="preprocessor">      # Update all of the tabbars</span>
<a name="l00487"></a>00487 <span class="preprocessor"></span>      <span class="keywordflow">foreach</span> nb [$widgets(nb_pw) panes] {
<a name="l00488"></a>00488         $nb.tbf.tb    configure -background $bg -foreground $fg -activebackground $abg -inactivebackground $bg
<a name="l00489"></a>00489         $nb.tbf.extra configure -image $images(down)
<a name="l00490"></a>00490         set tabs [$nb.tbf.tb tabs]
<a name="l00491"></a>00491         foreach tab $tabs {
<a name="l00492"></a>00492           $tab.pw.tf.split  configure -image $images(split)
<a name="l00493"></a>00493           $tab.sf.close     configure -image $images(close)
<a name="l00494"></a>00494           $tab.rf.close     configure -image $images(close)
<a name="l00495"></a>00495           $tab.rf.glob      configure -image $images(global)
<a name="l00496"></a>00496           if {[winfo exists $tab.pw.tf2.split]} {
<a name="l00497"></a>00497             $tab.pw.tf2.split configure -image $images(close)
<a name="l00498"></a>00498           }
<a name="l00499"></a>00499         }
<a name="l00500"></a>00500       }
<a name="l00501"></a>00501       
<a name="l00502"></a>00502 <span class="preprocessor">      # TBD - We need to adjust the appearance of the diff map widgets (if they exist)</span>
<a name="l00503"></a>00503 <span class="preprocessor"></span>
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506   }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 <span class="preprocessor">  ######################################################################</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span><span class="preprocessor">  # Updates all of the font sizes in the text window to the given.</span>
<a name="l00510"></a>00510 <span class="preprocessor"></span>  proc handle_editor_font_size {name1 name2 op} {
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 <span class="preprocessor">    # Update the size of the editor_font</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span>    font configure editor_font -size [preferences::get Appearance/EditorFontSize]
<a name="l00514"></a>00514 
<a name="l00515"></a>00515   }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 <span class="preprocessor">  ######################################################################</span>
<a name="l00518"></a>00518 <span class="preprocessor"></span><span class="preprocessor">  # Toggles the specified labelbutton.</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span>  proc toggle_labelbutton {w} {
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="keywordflow">if</span> {[$w cget -relief] eq <span class="stringliteral">&quot;raised&quot;</span>} {
<a name="l00522"></a>00522       $w configure -relief sunken
<a name="l00523"></a>00523     } <span class="keywordflow">else</span> {
<a name="l00524"></a>00524       $w configure -relief raised
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527   }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529 <span class="preprocessor">  ######################################################################</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span><span class="preprocessor">  # Returns 1 if the current buffer can be moved to the other pane.</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span>  proc movable_to_other_pane {} {
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     variable widgets
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <span class="keywordflow">return</span> [expr {([llength [[current_tabbar] tabs]] &gt; 1) || ([llength [$widgets(nb_pw) panes]] &gt; 1)}]
<a name="l00536"></a>00536 
<a name="l00537"></a>00537   }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539   ######################################################################
<a name="l00540"></a>00540   # Sets up the tab popup menu.
<a name="l00541"></a>00541   proc setup_tab_popup_menu {} {
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     variable widgets
<a name="l00544"></a>00544     variable files
<a name="l00545"></a>00545     variable files_index
<a name="l00546"></a>00546     variable file_locked
<a name="l00547"></a>00547     variable file_favorited
<a name="l00548"></a>00548 
<a name="l00549"></a>00549 <span class="preprocessor">    # Get the current file index</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span>    <span class="keyword">set</span> file_index [current_file]
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="preprocessor">    # Get the readonly variable</span>
<a name="l00553"></a>00553 <span class="preprocessor"></span>    <span class="keyword">set</span> readonly [lindex $files $file_index $files_index(readonly)]
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 <span class="preprocessor">    # Set the file_locked variable</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span>    <span class="keyword">set</span> file_locked [expr $readonly || [lindex $files $file_index $files_index(lock)]]
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 <span class="preprocessor">    # Set the file_favorited variable</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span>    <span class="keyword">set</span> file_favorited [favorites::is_favorite [lindex $files $file_index $files_index(fname)]]
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 <span class="preprocessor">    # Get the current tabbar</span>
<a name="l00562"></a>00562 <span class="preprocessor"></span>    <span class="keyword">set</span> tb [current_tabbar]
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="preprocessor">    # Set the state of the menu items</span>
<a name="l00565"></a>00565 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[llength [$tb tabs]] &gt; 1} {
<a name="l00566"></a>00566       $widgets(menu) entryconfigure [msgcat::mc &quot;Close Other*&quot;] -state normal
<a name="l00567"></a>00567     } else {
<a name="l00568"></a>00568       $widgets(menu) entryconfigure [msgcat::mc &quot;Close Other*&quot;] -state disabled
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570     if {([llength [$tb tabs]] &gt; 1) || ([llength [$widgets(nb_pw) panes]] &gt; 1)} {
<a name="l00571"></a>00571       $widgets(menu) entryconfigure [msgcat::mc &quot;Move*&quot;] -state normal
<a name="l00572"></a>00572     } else {
<a name="l00573"></a>00573       $widgets(menu) entryconfigure [msgcat::mc &quot;Move*&quot;] -state disabled
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575     if {$readonly} {
<a name="l00576"></a>00576       $widgets(menu) entryconfigure [msgcat::mc &quot;Locked&quot;] -state disabled
<a name="l00577"></a>00577     } else {
<a name="l00578"></a>00578       $widgets(menu) entryconfigure [msgcat::mc &quot;Locked&quot;] -state normal
<a name="l00579"></a>00579     }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     <span class="preprocessor"># Handle plugin states</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>    plugins::menu_state $widgets(menu) tab_popup
<a name="l00583"></a>00583 
<a name="l00584"></a>00584   }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586   <span class="preprocessor">######################################################################</span>
<a name="l00587"></a>00587 <span class="preprocessor"></span><span class="preprocessor">  # Shows the sidebar viewer.</span>
<a name="l00588"></a>00588 <span class="preprocessor"></span>  proc show_sidebar_view {} {
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     variable widgets
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     $widgets(pw) insert 0 $widgets(sb)
<a name="l00593"></a>00593 
<a name="l00594"></a>00594   }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596   <span class="preprocessor">######################################################################</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span><span class="preprocessor">  # Hides the sidebar viewer.</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span>  proc hide_sidebar_view {} {
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     variable widgets
<a name="l00601"></a>00601 
<a name="l00602"></a>00602     <span class="keywordflow">catch</span> { $widgets(pw) forget $widgets(sb) }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604   }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606   <span class="preprocessor">######################################################################</span>
<a name="l00607"></a>00607 <span class="preprocessor"></span><span class="preprocessor">  # Shows the console.</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span>  proc show_console_view {} {
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="keywordflow">catch</span> { console show }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612   }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614 <span class="preprocessor">  ######################################################################</span>
<a name="l00615"></a>00615 <span class="preprocessor"></span><span class="preprocessor">  # Hides the console.</span>
<a name="l00616"></a>00616 <span class="preprocessor"></span>  proc hide_console_view {} {
<a name="l00617"></a>00617 
<a name="l00618"></a>00618     <span class="keywordflow">catch</span> { console hide }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620   }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 <span class="preprocessor">  ######################################################################</span>
<a name="l00623"></a>00623 <span class="preprocessor"></span><span class="preprocessor">  # Shows the tab bar.</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span>  proc show_tab_view {} {
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     variable widgets
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="keywordflow">foreach</span> nb [$widgets(nb_pw) panes] {
<a name="l00629"></a>00629       <span class="keywordflow">if</span> {[lsearch [pack slaves $nb] $nb.tbf] == -1} {
<a name="l00630"></a>00630         pack $nb.tbf -before $nb.tf -fill x
<a name="l00631"></a>00631       }
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634   }
<a name="l00635"></a>00635 
<a name="l00636"></a>00636 <span class="preprocessor">  ######################################################################</span>
<a name="l00637"></a>00637 <span class="preprocessor"></span><span class="preprocessor">  # Hides the tab bar.</span>
<a name="l00638"></a>00638 <span class="preprocessor"></span>  proc hide_tab_view {} {
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     variable widgets
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     <span class="keywordflow">foreach</span> nb [$widgets(nb_pw) panes] {
<a name="l00643"></a>00643       <span class="keywordflow">if</span> {[lsearch [pack slaves $nb] $nb.tbf] != -1} {
<a name="l00644"></a>00644         pack forget $nb.tbf
<a name="l00645"></a>00645       }
<a name="l00646"></a>00646     }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648   }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 <span class="preprocessor">  ######################################################################</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span><span class="preprocessor">  # Shows the status bar.</span>
<a name="l00652"></a>00652 <span class="preprocessor"></span>  proc show_status_view {} {
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     variable widgets
<a name="l00655"></a>00655 
<a name="l00656"></a>00656     <span class="keywordflow">catch</span> { grid $widgets(info) }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658   }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 <span class="preprocessor">  ######################################################################</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span><span class="preprocessor">  # Hides the status view</span>
<a name="l00662"></a>00662 <span class="preprocessor"></span>  proc hide_status_view {} {
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     variable widgets
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     <span class="keywordflow">catch</span> { grid <span class="keyword">remove</span> $widgets(info) }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668   }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670 <span class="preprocessor">  ######################################################################</span>
<a name="l00671"></a>00671 <span class="preprocessor"></span><span class="preprocessor">  # Shows the line numbers.</span>
<a name="l00672"></a>00672 <span class="preprocessor"></span>  proc set_line_number_view {tid value} {
<a name="l00673"></a>00673     
<a name="l00674"></a>00674 <span class="preprocessor">    # Show the line numbers in the current editor</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span>    [current_txt $tid] configure -linemap $value 
<a name="l00676"></a>00676     
<a name="l00677"></a>00677   }
<a name="l00678"></a>00678   
<a name="l00679"></a>00679 <span class="preprocessor">  ######################################################################</span>
<a name="l00680"></a>00680 <span class="preprocessor"></span><span class="preprocessor">  # Changes the given filename to the new filename in the file list and</span>
<a name="l00681"></a>00681 <span class="preprocessor"></span><span class="preprocessor">  # updates the tab name to match the new name.</span>
<a name="l00682"></a>00682 <span class="preprocessor"></span>  proc change_filename {old_name new_name} {
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     variable files
<a name="l00685"></a>00685     variable files_index
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 <span class="preprocessor">    # If the given old_name exists in the file list, update it and</span>
<a name="l00688"></a>00688 <span class="preprocessor"></span><span class="preprocessor">    # also update the tab name.</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> index [lsearch -index $files_index(fname) $files $old_name]] != -1} {
<a name="l00690"></a>00690 
<a name="l00691"></a>00691 <span class="preprocessor">      # Update the file information</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span>      lset files $index $files_index(fname) $new_name
<a name="l00693"></a>00693 
<a name="l00694"></a>00694       <span class="preprocessor"># Update the tab name</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span>      <span class="keyword">set</span> tab [lindex $files $index $files_index(tab)]
<a name="l00696"></a>00696       [lindex [pane_tb_index_from_tab $tab] 1] tab $tab -text [file tail $new_name]
<a name="l00697"></a>00697 
<a name="l00698"></a>00698 <span class="preprocessor">      # Update the title if necessary</span>
<a name="l00699"></a>00699 <span class="preprocessor"></span>      set_title
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703   }
<a name="l00704"></a>00704 
<a name="l00705"></a>00705 <span class="preprocessor">  ######################################################################</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span><span class="preprocessor">  # Returns 1 if the given file exists in one of the notebooks.</span>
<a name="l00707"></a>00707 <span class="preprocessor"></span>  proc file_exists {fname} {
<a name="l00708"></a>00708 
<a name="l00709"></a>00709     variable files
<a name="l00710"></a>00710     variable files_index
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="keywordflow">return</span> [expr {[lsearch -index $files_index(fname) $files $fname] != -1}]
<a name="l00713"></a>00713 
<a name="l00714"></a>00714   }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716   <span class="preprocessor">######################################################################</span>
<a name="l00717"></a>00717 <span class="preprocessor"></span><span class="preprocessor">  # Save the window geometry to the geometry.dat file.</span>
<a name="l00718"></a>00718 <span class="preprocessor"></span>  proc save_session {} {
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     variable widgets
<a name="l00721"></a>00721     variable session_file
<a name="l00722"></a>00722     variable last_opened
<a name="l00723"></a>00723     variable files
<a name="l00724"></a>00724     variable files_index
<a name="l00725"></a>00725 
<a name="l00726"></a>00726 <span class="preprocessor">    # Gather content to save</span>
<a name="l00727"></a>00727 <span class="preprocessor"></span>    <span class="keyword">set</span> content(Geometry)                [wm geometry .]
<a name="l00728"></a>00728     <span class="keyword">set</span> content(CurrentWorkingDirectory) [pwd]
<a name="l00729"></a>00729 
<a name="l00730"></a>00730 <span class="preprocessor">    # Gather the current tab info</span>
<a name="l00731"></a>00731 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> file $files {
<a name="l00732"></a>00732 
<a name="l00733"></a>00733       <span class="keyword">set</span> tab [lindex $file $files_index(tab)]
<a name="l00734"></a>00734       <span class="keyword">set</span> txt [get_txt_from_tab $tab]
<a name="l00735"></a>00735       lassign [pane_tb_index_from_tab $tab] pane tb tab_index
<a name="l00736"></a>00736 
<a name="l00737"></a>00737       <span class="keyword">set</span> finfo(fname)       [lindex $file $files_index(fname)]
<a name="l00738"></a>00738       <span class="keyword">set</span> finfo(savecommand) [lindex $file $files_index(save_cmd)]
<a name="l00739"></a>00739       <span class="keyword">set</span> finfo(pane)        $pane
<a name="l00740"></a>00740       set finfo(tab)         $tab_index
<a name="l00741"></a>00741       set finfo(lock)        [lindex $file $files_index(lock)]
<a name="l00742"></a>00742       set finfo(readonly)    [lindex $file $files_index(readonly)]
<a name="l00743"></a>00743       set finfo(diff)        [lindex $file $files_index(diff)]
<a name="l00744"></a>00744       set finfo(sidebar)     [lindex $file $files_index(sidebar)]
<a name="l00745"></a>00745       set finfo(language)    [syntax::get_current_language $txt]
<a name="l00746"></a>00746       set finfo(buffer)      [lindex $file $files_index(buffer)]
<a name="l00747"></a>00747       set finfo(indent)      [indent::get_auto_indent $txt]
<a name="l00748"></a>00748       set finfo(modified)    0
<a name="l00749"></a>00749 
<a name="l00750"></a>00750       lappend content(FileInfo) [array get finfo]
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     <span class="preprocessor"># Get the currently selected tabs</span>
<a name="l00755"></a>00755 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> nb [$widgets(nb_pw) panes] {
<a name="l00756"></a>00756       <span class="keywordflow">if</span> {[<span class="keyword">set</span> tab [$nb.tbf.tb select]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l00757"></a>00757         lappend content(CurrentTabs) [$nb.tbf.tb index $tab]
<a name="l00758"></a>00758       }
<a name="l00759"></a>00759     }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 <span class="preprocessor">    # Get the last_opened list</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span>    <span class="keyword">set</span> content(LastOpened) $last_opened
<a name="l00763"></a>00763 
<a name="l00764"></a>00764     <span class="preprocessor"># Write the content to the save file</span>
<a name="l00765"></a>00765 <span class="preprocessor"></span>    <span class="keywordflow">catch</span> { tkedat::write $session_file [array <span class="keyword">get</span> content] }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767   }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="preprocessor">  ######################################################################</span>
<a name="l00770"></a>00770 <span class="preprocessor"></span><span class="preprocessor">  # Loads the geometry information (if it exists) and changes the current</span>
<a name="l00771"></a>00771 <span class="preprocessor"></span><span class="preprocessor">  # window geometry to match the read value.</span>
<a name="l00772"></a>00772 <span class="preprocessor"></span>  proc load_session {tid} {
<a name="l00773"></a>00773 
<a name="l00774"></a>00774     variable widgets
<a name="l00775"></a>00775     variable session_file
<a name="l00776"></a>00776     variable last_opened
<a name="l00777"></a>00777     variable files
<a name="l00778"></a>00778     variable files_index
<a name="l00779"></a>00779     variable pw_current
<a name="l00780"></a>00780 
<a name="l00781"></a>00781 <span class="preprocessor">    # Read the state file</span>
<a name="l00782"></a>00782 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {![<span class="keywordflow">catch</span> { tkedat::read $session_file } rc]} {
<a name="l00783"></a>00783 
<a name="l00784"></a>00784       array <span class="keyword">set</span> content $rc
<a name="l00785"></a>00785 
<a name="l00786"></a>00786 <span class="preprocessor">      # Put the state information into the rest of the GUI</span>
<a name="l00787"></a>00787 <span class="preprocessor"></span>      wm geometry . $content(Geometry)
<a name="l00788"></a>00788 
<a name="l00789"></a>00789       <span class="preprocessor"># If we are supposed to load the last saved session, do it now</span>
<a name="l00790"></a>00790 <span class="preprocessor"></span>      <span class="keywordflow">if</span> {[preferences::get General/LoadLastSession] &amp;&amp; \
<a name="l00791"></a>00791           ([llength $files] == 1) &amp;&amp; \
<a name="l00792"></a>00792           ([lindex $files 0 $files_index(fname)] eq <span class="stringliteral">&quot;&quot;</span>) &amp;&amp; \
<a name="l00793"></a>00793           [info exists content(FileInfo)]} {
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="preprocessor">        # Set the current working directory to the saved value</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span>        <span class="keywordflow">if</span> {[file exists $content(CurrentWorkingDirectory)]} {
<a name="l00797"></a>00797           cd $content(CurrentWorkingDirectory)
<a name="l00798"></a>00798         }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800 <span class="preprocessor">        # Put the list in order</span>
<a name="l00801"></a>00801 <span class="preprocessor"></span>        <span class="keyword">set</span> ordered     [lrepeat 2 [lrepeat [llength $content(FileInfo)] <span class="stringliteral">&quot;&quot;</span>]]
<a name="l00802"></a>00802         <span class="keyword">set</span> second_pane 0
<a name="l00803"></a>00803         <span class="keyword">set</span> i           0
<a name="l00804"></a>00804         <span class="keywordflow">foreach</span> finfo_list $content(FileInfo) {
<a name="l00805"></a>00805           array <span class="keyword">set</span> finfo $finfo_list
<a name="l00806"></a>00806           lset ordered $finfo(pane) $finfo(tab) $i
<a name="l00807"></a>00807           set second_pane [expr $finfo(pane) == 2]
<a name="l00808"></a>00808           incr i
<a name="l00809"></a>00809         }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811         <span class="preprocessor"># If the second pane is necessary, create it now</span>
<a name="l00812"></a>00812 <span class="preprocessor"></span>        <span class="keywordflow">if</span> {[llength $content(CurrentTabs)] == 2} {
<a name="l00813"></a>00813           add_notebook
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 <span class="preprocessor">        # Add the tabs (in order) to each of the panes and set the current tab in each pane</span>
<a name="l00817"></a>00817 <span class="preprocessor"></span>        <span class="keywordflow">for</span> {<span class="keyword">set</span> pane 0} {$pane &lt; [llength $content(CurrentTabs)]} {incr pane} {
<a name="l00818"></a>00818           <span class="keyword">set</span> pw_current $pane
<a name="l00819"></a>00819           <span class="keyword">set</span> set_tab    1
<a name="l00820"></a>00820           <span class="keywordflow">foreach</span> index [lindex $ordered $pane] {
<a name="l00821"></a>00821             <span class="keywordflow">if</span> {$index ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l00822"></a>00822               array <span class="keyword">set</span> finfo [lindex $content(FileInfo) $index]
<a name="l00823"></a>00823               if {[file exists $finfo(fname)]} {
<a name="l00824"></a>00824                 add_file end $finfo(fname) \
<a name="l00825"></a>00825                   -savecommand $finfo(savecommand) -lock $finfo(lock) -readonly $finfo(readonly) \
<a name="l00826"></a>00826                   -diff $finfo(diff) -sidebar $finfo(sidebar)
<a name="l00827"></a>00827                 if {[syntax::get_current_language [current_txt {}]] ne $finfo(language)} {
<a name="l00828"></a>00828                   syntax::set_language $finfo(language)
<a name="l00829"></a>00829                 }
<a name="l00830"></a>00830                 <span class="keywordflow">if</span> {[info exists finfo(indent)]} {
<a name="l00831"></a>00831                   set_current_auto_indent $tid $finfo(indent)
<a name="l00832"></a>00832                 }
<a name="l00833"></a>00833               } <span class="keywordflow">else</span> {
<a name="l00834"></a>00834                 <span class="keyword">set</span> set_tab 0
<a name="l00835"></a>00835               }
<a name="l00836"></a>00836             }
<a name="l00837"></a>00837           }
<a name="l00838"></a>00838           <span class="keywordflow">if</span> {$set_tab} {
<a name="l00839"></a>00839             set_current_tab [lindex [[lindex [$widgets(nb_pw) panes] $pane].tbf.tb tabs] [lindex $content(CurrentTabs) $pane]]
<a name="l00840"></a>00840           }
<a name="l00841"></a>00841         }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843       }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845       <span class="preprocessor"># Restore the &quot;last_opened&quot; list</span>
<a name="l00846"></a>00846 <span class="preprocessor"></span>      <span class="keyword">set</span> last_opened $content(LastOpened)
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     }
<a name="l00849"></a>00849 
<a name="l00850"></a>00850   }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852 <span class="preprocessor">  ######################################################################</span>
<a name="l00853"></a>00853 <span class="preprocessor"></span><span class="preprocessor">  # Makes the next tab in the notebook viewable.</span>
<a name="l00854"></a>00854 <span class="preprocessor"></span>  proc next_tab {} {
<a name="l00855"></a>00855 
<a name="l00856"></a>00856     variable pw_current
<a name="l00857"></a>00857     variable tab_current
<a name="l00858"></a>00858 
<a name="l00859"></a>00859 <span class="preprocessor">    # Get the location information for the current tab in the current pane</span>
<a name="l00860"></a>00860 <span class="preprocessor"></span>    lassign [pane_tb_index_from_tab $tab_current($pw_current)] pane tb tab_index
<a name="l00861"></a>00861 
<a name="l00862"></a>00862 <span class="preprocessor">    # Get the tab index of the tab to the right of the currently selected tab</span>
<a name="l00863"></a>00863 <span class="preprocessor"></span>    <span class="keyword">set</span> index [expr $tab_index + 1]
<a name="l00864"></a>00864 
<a name="l00865"></a>00865 <span class="preprocessor">    # If the new tab index is at the end, circle to the first tab</span>
<a name="l00866"></a>00866 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$index == [$tb index end]} {
<a name="l00867"></a>00867       <span class="keyword">set</span> index 0
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870 <span class="preprocessor">    # Select the next tab</span>
<a name="l00871"></a>00871 <span class="preprocessor"></span>    set_current_tab [lindex [$tb tabs] $index]
<a name="l00872"></a>00872 
<a name="l00873"></a>00873   }
<a name="l00874"></a>00874 
<a name="l00875"></a>00875 <span class="preprocessor">  ######################################################################</span>
<a name="l00876"></a>00876 <span class="preprocessor"></span><span class="preprocessor">  # Makes the previous tab in the notebook viewable.</span>
<a name="l00877"></a>00877 <span class="preprocessor"></span>  proc previous_tab {} {
<a name="l00878"></a>00878 
<a name="l00879"></a>00879     variable pw_current
<a name="l00880"></a>00880     variable tab_current
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="preprocessor">    # Get the location information for the current tab in the current pane</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span>    lassign [pane_tb_index_from_tab $tab_current($pw_current)] pane tb tab_index
<a name="l00884"></a>00884 
<a name="l00885"></a>00885 <span class="preprocessor">    # Get the tab index of the tab to the left of the currently selected tab</span>
<a name="l00886"></a>00886 <span class="preprocessor"></span>    <span class="keyword">set</span> index [expr $tab_index - 1]
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="preprocessor">    # If the new tab index is at the less than 0, circle to the last tab</span>
<a name="l00889"></a>00889 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$index == -1} {
<a name="l00890"></a>00890       <span class="keyword">set</span> index [expr [$tb index end] - 1]
<a name="l00891"></a>00891     }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="preprocessor">    # Select the previous tab</span>
<a name="l00894"></a>00894 <span class="preprocessor"></span>    set_current_tab [lindex [$tb tabs] $index]
<a name="l00895"></a>00895 
<a name="l00896"></a>00896   }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898 <span class="preprocessor">  ######################################################################</span>
<a name="l00899"></a>00899 <span class="preprocessor"></span><span class="preprocessor">  # Makes the last viewed tab in the notebook viewable.</span>
<a name="l00900"></a>00900 <span class="preprocessor"></span>  proc last_tab {} {
<a name="l00901"></a>00901 
<a name="l00902"></a>00902     variable pw_current
<a name="l00903"></a>00903     variable tab_current
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     lassign [pane_tb_index_from_tab $tab_current($pw_current)] pane tb
<a name="l00906"></a>00906 
<a name="l00907"></a>00907 <span class="preprocessor">    # Select the last tab</span>
<a name="l00908"></a>00908 <span class="preprocessor"></span>    set_current_tab [lindex [$tb tabs] [$tb index last]]
<a name="l00909"></a>00909 
<a name="l00910"></a>00910   }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 <span class="preprocessor">  ######################################################################</span>
<a name="l00913"></a>00913 <span class="preprocessor"></span><span class="preprocessor">  # If more than one pane is displayed, sets the current pane to the other</span>
<a name="l00914"></a>00914 <span class="preprocessor"></span><span class="preprocessor">  # pane.</span>
<a name="l00915"></a>00915 <span class="preprocessor"></span>  proc next_pane {} {
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     variable widgets
<a name="l00918"></a>00918     variable pw_current
<a name="l00919"></a>00919     variable tab_current
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 <span class="preprocessor">    # If we have more than one pane, go to it</span>
<a name="l00922"></a>00922 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[llength [$widgets(nb_pw) panes]] &gt; 1} {
<a name="l00923"></a>00923       set_current_tab $tab_current([expr $pw_current ^ 1])
<a name="l00924"></a>00924     }
<a name="l00925"></a>00925 
<a name="l00926"></a>00926   }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928 <span class="preprocessor">  ######################################################################</span>
<a name="l00929"></a>00929 <span class="preprocessor"></span><span class="preprocessor">  # Returns the number of panes.</span>
<a name="l00930"></a>00930 <span class="preprocessor"></span>  proc panes {} {
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     variable widgets
<a name="l00933"></a>00933 
<a name="l00934"></a>00934     <span class="keywordflow">return</span> [llength [$widgets(nb_pw) panes]]
<a name="l00935"></a>00935 
<a name="l00936"></a>00936   }
<a name="l00937"></a>00937 
<a name="l00938"></a>00938   <span class="preprocessor">######################################################################</span>
<a name="l00939"></a>00939 <span class="preprocessor"></span><span class="preprocessor">  # Returns the number of tabs in the current pane.</span>
<a name="l00940"></a>00940 <span class="preprocessor"></span>  proc tabs_in_pane {} {
<a name="l00941"></a>00941 
<a name="l00942"></a>00942     variable pw_current
<a name="l00943"></a>00943     variable tab_current
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="keywordflow">if</span> {[info exists tab_current($pw_current)]} {
<a name="l00946"></a>00946       <span class="keywordflow">return</span> [llength [[lindex [pane_tb_index_from_tab $tab_current($pw_current)] 1] tabs]]
<a name="l00947"></a>00947     } <span class="keywordflow">else</span> {
<a name="l00948"></a>00948       <span class="keywordflow">return</span> 0
<a name="l00949"></a>00949     }
<a name="l00950"></a>00950 
<a name="l00951"></a>00951   }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953 <span class="preprocessor">  ######################################################################</span>
<a name="l00954"></a>00954 <span class="preprocessor"></span><span class="preprocessor">  # Adds the given filename to the list of most recently opened files.</span>
<a name="l00955"></a>00955 <span class="preprocessor"></span>  proc add_to_recently_opened {fname} {
<a name="l00956"></a>00956 
<a name="l00957"></a>00957     variable last_opened
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="keywordflow">if</span> {[<span class="keyword">set</span> index [lsearch $last_opened $fname]] != -1} {
<a name="l00960"></a>00960       <span class="keyword">set</span> last_opened [lreplace $last_opened $index $index]
<a name="l00961"></a>00961     }
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="keyword">set</span> last_opened [lrange [list $fname {*}$last_opened] 0 20]
<a name="l00964"></a>00964 
<a name="l00965"></a>00965   }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 <span class="preprocessor">  ######################################################################</span>
<a name="l00968"></a>00968 <span class="preprocessor"></span><span class="preprocessor">  # Returns the last_opened list contents.</span>
<a name="l00969"></a>00969 <span class="preprocessor"></span>  proc get_last_opened {} {
<a name="l00970"></a>00970 
<a name="l00971"></a>00971     variable last_opened
<a name="l00972"></a>00972 
<a name="l00973"></a>00973     <span class="keywordflow">return</span> $last_opened
<a name="l00974"></a>00974 
<a name="l00975"></a>00975   }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 <span class="preprocessor">  ######################################################################</span>
<a name="l00978"></a>00978 <span class="preprocessor"></span><span class="preprocessor">  # Clears the last_opened list contents.</span>
<a name="l00979"></a>00979 <span class="preprocessor"></span>  proc clear_last_opened {} {
<a name="l00980"></a>00980 
<a name="l00981"></a>00981     variable last_opened
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     <span class="keyword">set</span> last_opened [list]
<a name="l00984"></a>00984 
<a name="l00985"></a>00985   }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987 <span class="preprocessor">  ######################################################################</span>
<a name="l00988"></a>00988 <span class="preprocessor"></span><span class="preprocessor">  # Selects all of the text in the current text widget.</span>
<a name="l00989"></a>00989 <span class="preprocessor"></span>  proc select_all {tid} {
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 <span class="preprocessor">    # Get the current text widget</span>
<a name="l00992"></a>00992 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l00993"></a>00993 
<a name="l00994"></a>00994 <span class="preprocessor">    # Set the selection to include everything</span>
<a name="l00995"></a>00995 <span class="preprocessor"></span>    $txt tag add sel 1.0 end
<a name="l00996"></a>00996 
<a name="l00997"></a>00997   }
<a name="l00998"></a>00998 
<a name="l00999"></a>00999 <span class="preprocessor">  ######################################################################</span>
<a name="l01000"></a>01000 <span class="preprocessor"></span><span class="preprocessor">  # Returns true if we have only a single tab that has not been modified</span>
<a name="l01001"></a>01001 <span class="preprocessor"></span><span class="preprocessor">  # or named.</span>
<a name="l01002"></a>01002 <span class="preprocessor"></span>  proc untitled_check {} {
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     variable widgets
<a name="l01005"></a>01005     variable files
<a name="l01006"></a>01006     variable files_index
<a name="l01007"></a>01007 
<a name="l01008"></a>01008 <span class="preprocessor">    # If we have no more tabs and there is another pane, remove this pane</span>
<a name="l01009"></a>01009 <span class="preprocessor"></span>    <span class="keywordflow">return</span> [expr {([llength $files] == 1) &amp;&amp; \
<a name="l01010"></a>01010                   ([lindex $files 0 $files_index(fname)] eq <span class="stringliteral">&quot;&quot;</span>) &amp;&amp; \
<a name="l01011"></a>01011                   ([vim::get_cleaned_content [get_txt_from_tab [lindex [[lindex [$widgets(nb_pw) panes] 0].tbf.tb tabs] 0]]] eq <span class="stringliteral">&quot;&quot;</span>)}]
<a name="l01012"></a>01012 
<a name="l01013"></a>01013   }
<a name="l01014"></a>01014 
<a name="l01015"></a>01015   ######################################################################
<a name="l01016"></a>01016   # Adds a <span class="keyword">new</span> file to the editor pane.
<a name="l01017"></a>01017   #
<a name="l01018"></a>01018   # Several options are available:
<a name="l01019"></a>01019   # -savecommand &lt;command&gt;  Optional command that is run when the file is saved.
<a name="l01020"></a>01020   # -lock        &lt;bool&gt;     Initial lock setting.
<a name="l01021"></a>01021   # -readonly    &lt;bool&gt;     Set <span class="keywordflow">if</span> file should not be saveable.
<a name="l01022"></a>01022   # -sidebar     &lt;bool&gt;     Specifies <span class="keywordflow">if</span> file/directory should be added to the sidebar.
<a name="l01023"></a>01023   # -buffer      &lt;bool&gt;     If <span class="keyword">true</span>, treats contents as a temporary buffer.
<a name="l01024"></a>01024   # -gutters     &lt;list&gt;     Creates a gutter in the editor.  The contents of list are as follows:
<a name="l01025"></a>01025   #                           {name {{symbol_name {symbol_tag_options+}}+}}+
<a name="l01026"></a>01026 <span class="preprocessor">  #                         For a list of valid symbol_tag_options, see the options available for</span>
<a name="l01027"></a>01027 <span class="preprocessor"></span><span class="preprocessor">  #                         tags in a text widget.</span>
<a name="l01028"></a>01028 <span class="preprocessor"></span>  proc add_new_file {index args} {
<a name="l01029"></a>01029 
<a name="l01030"></a>01030     variable files
<a name="l01031"></a>01031     variable files_index
<a name="l01032"></a>01032     variable pw_current
<a name="l01033"></a>01033 
<a name="l01034"></a>01034 <span class="preprocessor">    # Handle options</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span>    array <span class="keyword">set</span> opts [list \
<a name="l01036"></a>01036       -savecommand <span class="stringliteral">&quot;&quot;</span> \
<a name="l01037"></a>01037       -lock        0 \
<a name="l01038"></a>01038       -readonly    0 \
<a name="l01039"></a>01039       -sidebar     $::cl_sidebar \
<a name="l01040"></a>01040       -buffer      0 \
<a name="l01041"></a>01041       -gutters     [list] \
<a name="l01042"></a>01042     ]
<a name="l01043"></a>01043     array <span class="keyword">set</span> opts $args
<a name="l01044"></a>01044 
<a name="l01045"></a>01045 <span class="preprocessor">    # Perform untitled tab check</span>
<a name="l01046"></a>01046 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[untitled_check]} {
<a name="l01047"></a>01047       <span class="keywordflow">return</span>
<a name="l01048"></a>01048     }
<a name="l01049"></a>01049 
<a name="l01050"></a>01050 <span class="preprocessor">    # Adjust the index (if necessary)</span>
<a name="l01051"></a>01051 <span class="preprocessor"></span>    <span class="keyword">set</span> index [adjust_insert_tab_index $index <span class="stringliteral">&quot;Untitled&quot;</span>]
<a name="l01052"></a>01052 
<a name="l01053"></a>01053 <span class="preprocessor">    # Get the current index</span>
<a name="l01054"></a>01054 <span class="preprocessor"></span>    <span class="keyword">set</span> w [insert_tab $index [msgcat::mc <span class="stringliteral">&quot;Untitled&quot;</span>] 0 $opts(-gutters)]
<a name="l01055"></a>01055 
<a name="l01056"></a>01056 <span class="preprocessor">    # Create the file info structure</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span>    <span class="keyword">set</span> file_info [lrepeat [array size files_index] <span class="stringliteral">&quot;&quot;</span>]
<a name="l01058"></a>01058     lset file_info $files_index(fname)    <span class="stringliteral">&quot;&quot;</span>
<a name="l01059"></a>01059     lset file_info $files_index(mtime)    <span class="stringliteral">&quot;&quot;</span>
<a name="l01060"></a>01060     lset file_info $files_index(save_cmd) $opts(-savecommand)
<a name="l01061"></a>01061     lset file_info $files_index(tab)      $w
<a name="l01062"></a>01062     lset file_info $files_index(lock)     0
<a name="l01063"></a>01063     lset file_info $files_index(readonly) $opts(-readonly)
<a name="l01064"></a>01064     lset file_info $files_index(sidebar)  $opts(-sidebar)
<a name="l01065"></a>01065     lset file_info $files_index(buffer)   $opts(-buffer)
<a name="l01066"></a>01066     lset file_info $files_index(modified) 0
<a name="l01067"></a>01067     lset file_info $files_index(gutters)  $opts(-gutters)
<a name="l01068"></a>01068     lset file_info $files_index(diff)     0
<a name="l01069"></a>01069 
<a name="l01070"></a>01070     <span class="preprocessor"># Add the file information to the files list</span>
<a name="l01071"></a>01071 <span class="preprocessor"></span>    lappend files $file_info
<a name="l01072"></a>01072 
<a name="l01073"></a>01073 <span class="preprocessor">    # Add the file&#39;s directory to the sidebar and highlight it</span>
<a name="l01074"></a>01074 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$opts(-sidebar)} {
<a name="l01075"></a>01075       sidebar::add_directory [pwd]
<a name="l01076"></a>01076     }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078 <span class="preprocessor">    # Sets the file lock to the specified value</span>
<a name="l01079"></a>01079 <span class="preprocessor"></span>    set_current_file_lock {} $opts(-lock)
<a name="l01080"></a>01080 
<a name="l01081"></a>01081     <span class="preprocessor"># Run any plugins that need to be run when a file is opened</span>
<a name="l01082"></a>01082 <span class="preprocessor"></span>    plugins::handle_on_open [expr [llength $files] - 1]
<a name="l01083"></a>01083 
<a name="l01084"></a>01084   }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086 <span class="preprocessor">  ######################################################################</span>
<a name="l01087"></a>01087 <span class="preprocessor"></span><span class="preprocessor">  # Creates a new tab for the given filename specified at the given index</span>
<a name="l01088"></a>01088 <span class="preprocessor"></span><span class="preprocessor">  # tab position.</span>
<a name="l01089"></a>01089 <span class="preprocessor"></span><span class="preprocessor">  #</span>
<a name="l01090"></a>01090 <span class="preprocessor"></span><span class="preprocessor">  # Several options are available:</span>
<a name="l01091"></a>01091 <span class="preprocessor"></span><span class="preprocessor">  # -savecommand &lt;command&gt;  Optional command that is run when the file is saved.</span>
<a name="l01092"></a>01092 <span class="preprocessor"></span><span class="preprocessor">  # -lock        &lt;bool&gt;     Initial lock setting.</span>
<a name="l01093"></a>01093 <span class="preprocessor"></span><span class="preprocessor">  # -readonly    &lt;bool&gt;     Set if file should not be saveable.</span>
<a name="l01094"></a>01094 <span class="preprocessor"></span><span class="preprocessor">  # -sidebar     &lt;bool&gt;     Specifies if file/directory should be added to the sidebar.</span>
<a name="l01095"></a>01095 <span class="preprocessor"></span><span class="preprocessor">  # -buffer      &lt;bool&gt;     If true, treats the text widget as a temporary buffer.</span>
<a name="l01096"></a>01096 <span class="preprocessor"></span><span class="preprocessor">  # -gutters     &lt;list&gt;     Creates a gutter in the editor.  The contents of list are as follows:</span>
<a name="l01097"></a>01097 <span class="preprocessor"></span><span class="preprocessor">  #                           {name {{symbol_name {symbol_tag_options+}}+}}+</span>
<a name="l01098"></a>01098 <span class="preprocessor"></span><span class="preprocessor">  #                         For a list of valid symbol_tag_options, see the options available for</span>
<a name="l01099"></a>01099 <span class="preprocessor"></span><span class="preprocessor">  #                         tags in a text widget.</span>
<a name="l01100"></a>01100 <span class="preprocessor"></span><span class="preprocessor">  # -diff        &lt;bool&gt;     Specifies if we need to do a diff of the file.</span>
<a name="l01101"></a>01101 <span class="preprocessor"></span>  proc add_file {index fname args} {
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     variable widgets
<a name="l01104"></a>01104     variable files
<a name="l01105"></a>01105     variable files_index
<a name="l01106"></a>01106     variable pw_current
<a name="l01107"></a>01107     variable tab_current
<a name="l01108"></a>01108     variable last_opened
<a name="l01109"></a>01109 
<a name="l01110"></a>01110 <span class="preprocessor">    # Handle arguments</span>
<a name="l01111"></a>01111 <span class="preprocessor"></span>    array <span class="keyword">set</span> opts {
<a name="l01112"></a>01112       -savecommand <span class="stringliteral">&quot;&quot;</span>
<a name="l01113"></a>01113       -lock        0
<a name="l01114"></a>01114       -readonly    0
<a name="l01115"></a>01115       -sidebar     1
<a name="l01116"></a>01116       -buffer      0
<a name="l01117"></a>01117       -gutters     {}
<a name="l01118"></a>01118       -diff        0
<a name="l01119"></a>01119     }
<a name="l01120"></a>01120     array <span class="keyword">set</span> opts $args
<a name="l01121"></a>01121 
<a name="l01122"></a>01122 <span class="preprocessor">    # If have a single untitled tab in view, close it before adding the file</span>
<a name="l01123"></a>01123 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[untitled_check]} {
<a name="l01124"></a>01124       close_tab $tab_current($pw_current) 0 0
<a name="l01125"></a>01125     }
<a name="l01126"></a>01126     
<a name="l01127"></a>01127 <span class="preprocessor">    # Check to see if the file is already loaded</span>
<a name="l01128"></a>01128 <span class="preprocessor"></span>    <span class="keyword">set</span> file_index -1
<a name="l01129"></a>01129     <span class="keywordflow">foreach</span> findex [lsearch -all -index $files_index(fname) $files $fname] {
<a name="l01130"></a>01130       <span class="keywordflow">if</span> {[lindex $files $findex $files_index(diff)] == $opts(-diff)} {
<a name="l01131"></a>01131         <span class="keyword">set</span> file_index $findex
<a name="l01132"></a>01132         <span class="keywordflow">break</span>
<a name="l01133"></a>01133       }
<a name="l01134"></a>01134     }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136 <span class="preprocessor">    # If the file is already loaded, display the tab</span>
<a name="l01137"></a>01137 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$file_index != -1} {
<a name="l01138"></a>01138 
<a name="l01139"></a>01139       set_current_tab [lindex $files $file_index $files_index(tab)]
<a name="l01140"></a>01140 
<a name="l01141"></a>01141 <span class="preprocessor">    # Otherwise, load the file in a new tab</span>
<a name="l01142"></a>01142 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
<a name="l01143"></a>01143 
<a name="l01144"></a>01144 <span class="preprocessor">      # Adjust the index (if necessary)</span>
<a name="l01145"></a>01145 <span class="preprocessor"></span>      <span class="keyword">set</span> index [adjust_insert_tab_index $index [file tail $fname]]
<a name="l01146"></a>01146 
<a name="l01147"></a>01147 <span class="preprocessor">      # Add the tab to the editor frame</span>
<a name="l01148"></a>01148 <span class="preprocessor"></span>      <span class="keyword">set</span> w [insert_tab $index [file tail $fname] $opts(-diff) $opts(-gutters)]
<a name="l01149"></a>01149 
<a name="l01150"></a>01150       <span class="preprocessor"># Create the file information</span>
<a name="l01151"></a>01151 <span class="preprocessor"></span>      <span class="keyword">set</span> file_info [lrepeat [array size files_index] <span class="stringliteral">&quot;&quot;</span>]
<a name="l01152"></a>01152       lset file_info $files_index(fname)    $fname
<a name="l01153"></a>01153       lset file_info $files_index(mtime)    &quot;&quot;
<a name="l01154"></a>01154       lset file_info $files_index(save_cmd) $opts(-savecommand)
<a name="l01155"></a>01155       lset file_info $files_index(tab)      $w
<a name="l01156"></a>01156       lset file_info $files_index(lock)     0
<a name="l01157"></a>01157       lset file_info $files_index(readonly) [expr $opts(-readonly) || $opts(-diff)]
<a name="l01158"></a>01158       lset file_info $files_index(sidebar)  $opts(-sidebar)
<a name="l01159"></a>01159       lset file_info $files_index(buffer)   $opts(-buffer)
<a name="l01160"></a>01160       lset file_info $files_index(modified) 0
<a name="l01161"></a>01161       lset file_info $files_index(gutters)  $opts(-gutters)
<a name="l01162"></a>01162       lset file_info $files_index(diff)     $opts(-diff)
<a name="l01163"></a>01163 
<a name="l01164"></a>01164       if {![<span class="keywordflow">catch</span> { open $fname r } rc]} {
<a name="l01165"></a>01165 
<a name="l01166"></a>01166         <span class="keyword">set</span> txt [get_txt_from_tab $w]
<a name="l01167"></a>01167 
<a name="l01168"></a>01168 <span class="preprocessor">        # Read the file contents and insert them</span>
<a name="l01169"></a>01169 <span class="preprocessor"></span>        $txt insert end [<span class="keywordtype">string</span> range [read $rc] 0 end-1]
<a name="l01170"></a>01170 
<a name="l01171"></a>01171 <span class="preprocessor">        # Close the file</span>
<a name="l01172"></a>01172 <span class="preprocessor"></span>        close $rc
<a name="l01173"></a>01173 
<a name="l01174"></a>01174 <span class="preprocessor">        # Change the text to unmodified</span>
<a name="l01175"></a>01175 <span class="preprocessor"></span>        $txt edit reset
<a name="l01176"></a>01176 
<a name="l01177"></a>01177 <span class="preprocessor">        # Set the insertion mark to the first position</span>
<a name="l01178"></a>01178 <span class="preprocessor"></span>        $txt mark <span class="keyword">set</span> insert 1.0
<a name="l01179"></a>01179 
<a name="l01180"></a>01180         # Perform an insertion adjust, <span class="keywordflow">if</span> necessary
<a name="l01181"></a>01181         vim::adjust_insert $txt.t
<a name="l01182"></a>01182 
<a name="l01183"></a>01183         file stat $fname stat
<a name="l01184"></a>01184         lset file_info $files_index(mtime) $stat(mtime)
<a name="l01185"></a>01185         lappend files $file_info
<a name="l01186"></a>01186 
<a name="l01187"></a>01187         <span class="preprocessor"># Add the file to the list of recently opened files</span>
<a name="l01188"></a>01188 <span class="preprocessor"></span>        gui::add_to_recently_opened $fname
<a name="l01189"></a>01189         
<a name="l01190"></a>01190 <span class="preprocessor">        # If a diff command was specified, run and parse it now</span>
<a name="l01191"></a>01191 <span class="preprocessor"></span>        <span class="keywordflow">if</span> {$opts(-diff)} {
<a name="l01192"></a>01192           diff::show $txt
<a name="l01193"></a>01193         }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195       } <span class="keywordflow">else</span> {
<a name="l01196"></a>01196 
<a name="l01197"></a>01197         lappend files $file_info
<a name="l01198"></a>01198 
<a name="l01199"></a>01199       }
<a name="l01200"></a>01200 
<a name="l01201"></a>01201 <span class="preprocessor">      # Change the tab text</span>
<a name="l01202"></a>01202 <span class="preprocessor"></span>      [current_tabbar] tab $w -text <span class="stringliteral">&quot; [file tail $fname]&quot;</span>
<a name="l01203"></a>01203 
<a name="l01204"></a>01204     }
<a name="l01205"></a>01205 
<a name="l01206"></a>01206 <span class="preprocessor">    # Add the file&#39;s directory to the sidebar and highlight it</span>
<a name="l01207"></a>01207 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$opts(-sidebar)} {
<a name="l01208"></a>01208       sidebar::add_directory [file dirname [file normalize $fname]]
<a name="l01209"></a>01209       sidebar::highlight_filename $fname 1
<a name="l01210"></a>01210     }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 <span class="preprocessor">    # Sets the file lock to the specified value</span>
<a name="l01213"></a>01213 <span class="preprocessor"></span>    set_current_file_lock {} $opts(-lock)
<a name="l01214"></a>01214 
<a name="l01215"></a>01215     <span class="preprocessor"># Run any plugins that should run when a file is opened</span>
<a name="l01216"></a>01216 <span class="preprocessor"></span>    plugins::handle_on_open [expr [llength $files] - 1]
<a name="l01217"></a>01217 
<a name="l01218"></a>01218   }
<a name="l01219"></a>01219 
<a name="l01220"></a>01220 <span class="preprocessor">  ######################################################################</span>
<a name="l01221"></a>01221 <span class="preprocessor"></span><span class="preprocessor">  # Normalizes the given filename and resolves any NFS mount information if</span>
<a name="l01222"></a>01222 <span class="preprocessor"></span><span class="preprocessor">  # the specified host is not the current host.</span>
<a name="l01223"></a>01223 <span class="preprocessor"></span>  proc normalize {host fname} {
<a name="l01224"></a>01224 
<a name="l01225"></a>01225 <span class="preprocessor">    # Perform a normalization of the file</span>
<a name="l01226"></a>01226 <span class="preprocessor"></span>    <span class="keyword">set</span> fname [file normalize $fname]
<a name="l01227"></a>01227 
<a name="l01228"></a>01228 <span class="preprocessor">    # If the host does not match our host, handle the NFS mount normalization</span>
<a name="l01229"></a>01229 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$host ne [info hostname]} {
<a name="l01230"></a>01230       array <span class="keyword">set</span> nfs_mounts [preferences::get NFSMounts]
<a name="l01231"></a>01231       <span class="keywordflow">if</span> {[info exists nfs_mounts($host)]} {
<a name="l01232"></a>01232         lassign $nfs_mounts($host) mount_dir shortcut
<a name="l01233"></a>01233         set shortcut_len [<span class="keywordtype">string</span> length $shortcut]
<a name="l01234"></a>01234         if {[<span class="keywordtype">string</span> equal -length $shortcut_len $shortcut $fname]} {
<a name="l01235"></a>01235           <span class="keyword">set</span> fname [<span class="keywordtype">string</span> replace $fname 0 [expr $shortcut_len - 1] $mount_dir]
<a name="l01236"></a>01236         }
<a name="l01237"></a>01237       }
<a name="l01238"></a>01238     }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240     <span class="keywordflow">return</span> $fname
<a name="l01241"></a>01241 
<a name="l01242"></a>01242   }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244 <span class="preprocessor">  ######################################################################</span>
<a name="l01245"></a>01245 <span class="preprocessor"></span><span class="preprocessor">  # Add a list of files to the editor panel and raise the window to</span>
<a name="l01246"></a>01246 <span class="preprocessor"></span><span class="preprocessor">  # make it visible.</span>
<a name="l01247"></a>01247 <span class="preprocessor"></span>  proc add_files_and_raise {host index args} {
<a name="l01248"></a>01248 
<a name="l01249"></a>01249 <span class="preprocessor">    # Add the list of files to the editor panel.</span>
<a name="l01250"></a>01250 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> fname [lreverse $args] {
<a name="l01251"></a>01251       add_file $index [normalize $host $fname]
<a name="l01252"></a>01252     }
<a name="l01253"></a>01253 
<a name="l01254"></a>01254 <span class="preprocessor">    # Raise ourselves</span>
<a name="l01255"></a>01255 <span class="preprocessor"></span>    raise_window
<a name="l01256"></a>01256 
<a name="l01257"></a>01257   }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259 <span class="preprocessor">  ######################################################################</span>
<a name="l01260"></a>01260 <span class="preprocessor"></span><span class="preprocessor">  # Raise ourself to the top.</span>
<a name="l01261"></a>01261 <span class="preprocessor"></span>  proc raise_window {} {
<a name="l01262"></a>01262 
<a name="l01263"></a>01263     variable widgets
<a name="l01264"></a>01264 
<a name="l01265"></a>01265 <span class="preprocessor">    # If the notebook widget doesn&#39;t exist this will cause an error to occur.</span>
<a name="l01266"></a>01266 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$widgets(nb_pw) ne &quot;&quot;} {
<a name="l01267"></a>01267 
<a name="l01268"></a>01268       wm withdraw  .
<a name="l01269"></a>01269       wm deiconify .
<a name="l01270"></a>01270 
<a name="l01271"></a>01271     }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273   }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275 <span class="preprocessor">  ######################################################################</span>
<a name="l01276"></a>01276 <span class="preprocessor"></span><span class="preprocessor">  # Update the file located at the given notebook index.</span>
<a name="l01277"></a>01277 <span class="preprocessor"></span>  proc update_file {file_index} {
<a name="l01278"></a>01278 
<a name="l01279"></a>01279     variable files
<a name="l01280"></a>01280     variable files_index
<a name="l01281"></a>01281 
<a name="l01282"></a>01282 <span class="preprocessor">    # Get the file information</span>
<a name="l01283"></a>01283 <span class="preprocessor"></span>    <span class="keyword">set</span> file_info [lindex $files $file_index]
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 <span class="preprocessor">    # Get the current notebook.</span>
<a name="l01286"></a>01286 <span class="preprocessor"></span>    <span class="keyword">set</span> tab [lindex $file_info $files_index(tab)]
<a name="l01287"></a>01287 
<a name="l01288"></a>01288 <span class="preprocessor">    # Get the text widget at the given index</span>
<a name="l01289"></a>01289 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [get_txt_from_tab $tab]
<a name="l01290"></a>01290 
<a name="l01291"></a>01291 <span class="preprocessor">    # Get the current insertion index</span>
<a name="l01292"></a>01292 <span class="preprocessor"></span>    <span class="keyword">set</span> insert_index [$txt index insert]
<a name="l01293"></a>01293 
<a name="l01294"></a>01294 <span class="preprocessor">    # Delete the text widget</span>
<a name="l01295"></a>01295 <span class="preprocessor"></span>    $txt configure -state normal
<a name="l01296"></a>01296     $txt <span class="keyword">delete</span> 1.0 end
<a name="l01297"></a>01297 
<a name="l01298"></a>01298     <span class="keywordflow">if</span> {![<span class="keywordflow">catch</span> <span class="stringliteral">&quot;open [lindex $file_info $files_index(fname)] r&quot;</span> rc]} {
<a name="l01299"></a>01299 
<a name="l01300"></a>01300 <span class="preprocessor">      # Read the file contents and insert them</span>
<a name="l01301"></a>01301 <span class="preprocessor"></span>      $txt insert end [<span class="keywordtype">string</span> range [read $rc] 0 end-1]
<a name="l01302"></a>01302 
<a name="l01303"></a>01303 <span class="preprocessor">      # Close the file</span>
<a name="l01304"></a>01304 <span class="preprocessor"></span>      close $rc
<a name="l01305"></a>01305 
<a name="l01306"></a>01306 <span class="preprocessor">      # Change the tab text</span>
<a name="l01307"></a>01307 <span class="preprocessor"></span>      lassign [pane_tb_index_from_tab $tab] pane tb tab_index
<a name="l01308"></a>01308       $tb tab $tab -text <span class="stringliteral">&quot; [file tail [lindex $file_info $files_index(fname)]]&quot;</span>
<a name="l01309"></a>01309 
<a name="l01310"></a>01310 <span class="preprocessor">      # Update the title bar (if necessary)</span>
<a name="l01311"></a>01311 <span class="preprocessor"></span>      set_title
<a name="l01312"></a>01312 
<a name="l01313"></a>01313 <span class="preprocessor">      # Change the text to unmodified</span>
<a name="l01314"></a>01314 <span class="preprocessor"></span>      $txt edit reset
<a name="l01315"></a>01315       lset files $file_index $files_index(modified) 0
<a name="l01316"></a>01316 
<a name="l01317"></a>01317 <span class="preprocessor">      # Set the insertion mark to the first position</span>
<a name="l01318"></a>01318 <span class="preprocessor"></span>      $txt mark <span class="keyword">set</span> insert $insert_index
<a name="l01319"></a>01319       vim::adjust_insert $txt.t
<a name="l01320"></a>01320 
<a name="l01321"></a>01321 <span class="preprocessor">      # Make the insertion mark visible</span>
<a name="l01322"></a>01322 <span class="preprocessor"></span>      $txt see $insert_index
<a name="l01323"></a>01323 
<a name="l01324"></a>01324 <span class="preprocessor">      # Allow plugins to be run on update</span>
<a name="l01325"></a>01325 <span class="preprocessor"></span>      plugins::handle_on_update $file_index
<a name="l01326"></a>01326 
<a name="l01327"></a>01327     }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329 <span class="preprocessor">    # If we are locked, set our state back to disabled</span>
<a name="l01330"></a>01330 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[lindex $file_info $files_index(lock)]} {
<a name="l01331"></a>01331       $txt configure -state disabled
<a name="l01332"></a>01332     }
<a name="l01333"></a>01333 
<a name="l01334"></a>01334   }
<a name="l01335"></a>01335 
<a name="l01336"></a>01336 <span class="preprocessor">  ######################################################################</span>
<a name="l01337"></a>01337 <span class="preprocessor"></span><span class="preprocessor">  # Updates the currently displayed file.</span>
<a name="l01338"></a>01338 <span class="preprocessor"></span>  proc update_current {} {
<a name="l01339"></a>01339 
<a name="l01340"></a>01340     update_file [current_file]
<a name="l01341"></a>01341 
<a name="l01342"></a>01342   }
<a name="l01343"></a>01343 
<a name="l01344"></a>01344 <span class="preprocessor">  ######################################################################</span>
<a name="l01345"></a>01345 <span class="preprocessor"></span><span class="preprocessor">  # Returns the filename of the current tab.</span>
<a name="l01346"></a>01346 <span class="preprocessor"></span>  proc current_filename {} {
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     variable files
<a name="l01349"></a>01349     variable files_index
<a name="l01350"></a>01350 
<a name="l01351"></a>01351     <span class="keywordflow">return</span> [lindex $files [current_file] $files_index(fname)]
<a name="l01352"></a>01352 
<a name="l01353"></a>01353   }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355 <span class="preprocessor">  ######################################################################</span>
<a name="l01356"></a>01356 <span class="preprocessor"></span><span class="preprocessor">  # Saves the current tab filename.</span>
<a name="l01357"></a>01357 <span class="preprocessor"></span>  proc save_current {tid {save_as <span class="stringliteral">&quot;&quot;</span>}} {
<a name="l01358"></a>01358 
<a name="l01359"></a>01359     variable files
<a name="l01360"></a>01360     variable files_index
<a name="l01361"></a>01361 
<a name="l01362"></a>01362 <span class="preprocessor">    # Get the current tabbar</span>
<a name="l01363"></a>01363 <span class="preprocessor"></span>    <span class="keyword">set</span> tb [current_tabbar]
<a name="l01364"></a>01364 
<a name="l01365"></a>01365 <span class="preprocessor">    # Get the current file index</span>
<a name="l01366"></a>01366 <span class="preprocessor"></span>    <span class="keyword">set</span> file_index [current_file]
<a name="l01367"></a>01367 
<a name="l01368"></a>01368 <span class="preprocessor">    # If a save_as name is specified, change the filename</span>
<a name="l01369"></a>01369 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$save_as ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l01370"></a>01370       sidebar::highlight_filename [lindex $files $file_index $files_index(fname)] 0
<a name="l01371"></a>01371       lset files $file_index $files_index(fname) $save_as
<a name="l01372"></a>01372 
<a name="l01373"></a>01373     <span class="preprocessor"># If the current file doesn&#39;t have a filename, allow the user to set it</span>
<a name="l01374"></a>01374 <span class="preprocessor"></span>    } elseif {([lindex $files $file_index $files_index(fname)] eq <span class="stringliteral">&quot;&quot;</span>) || \
<a name="l01375"></a>01375                [lindex $files $file_index $files_index(buffer)]} {
<a name="l01376"></a>01376       <span class="keyword">set</span> save_opts [list]
<a name="l01377"></a>01377       <span class="keywordflow">if</span> {[llength [<span class="keyword">set</span> extensions [syntax::get_extensions $tid]]] &gt; 0} {
<a name="l01378"></a>01378         lappend save_opts -defaultextension [lindex $extensions 0]
<a name="l01379"></a>01379       }
<a name="l01380"></a>01380       <span class="keywordflow">if</span> {[<span class="keyword">set</span> sfile [tk_getSaveFile {*}$save_opts -parent . -title [msgcat::mc <span class="stringliteral">&quot;Save As&quot;</span>] -initialdir [pwd]]] eq <span class="stringliteral">&quot;&quot;</span>} {
<a name="l01381"></a>01381         <span class="keywordflow">return</span>
<a name="l01382"></a>01382       } <span class="keywordflow">else</span> {
<a name="l01383"></a>01383         lset files $file_index $files_index(fname) $sfile
<a name="l01384"></a>01384       }
<a name="l01385"></a>01385     }
<a name="l01386"></a>01386 
<a name="l01387"></a>01387     <span class="preprocessor"># Run the on_save plugins</span>
<a name="l01388"></a>01388 <span class="preprocessor"></span>    plugins::handle_on_save $file_index
<a name="l01389"></a>01389 
<a name="l01390"></a>01390 <span class="preprocessor">    # Save the file contents</span>
<a name="l01391"></a>01391 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keywordflow">catch</span> { open [lindex $files $file_index $files_index(fname)] w } rc]} {
<a name="l01392"></a>01392       tk_messageBox -parent . -title <span class="stringliteral">&quot;Error&quot;</span> -type ok -<span class="keywordflow">default</span> ok -message <span class="stringliteral">&quot;Unable to write file&quot;</span> -detail $rc
<a name="l01393"></a>01393       <span class="keywordflow">return</span>
<a name="l01394"></a>01394     }
<a name="l01395"></a>01395 
<a name="l01396"></a>01396 <span class="preprocessor">    # Write the file contents</span>
<a name="l01397"></a>01397 <span class="preprocessor"></span>    puts $rc [scrub_text [current_txt $tid]]
<a name="l01398"></a>01398     close $rc
<a name="l01399"></a>01399 
<a name="l01400"></a>01400 <span class="preprocessor">    # If the file doesn&#39;t have a timestamp, it&#39;s a new file so add and highlight it in the sidebar</span>
<a name="l01401"></a>01401 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {([lindex $files $file_index $files_index(mtime)] eq <span class="stringliteral">&quot;&quot;</span>) || ($save_as ne <span class="stringliteral">&quot;&quot;</span>)} {
<a name="l01402"></a>01402 
<a name="l01403"></a>01403 <span class="preprocessor">      # Calculate the normalized filename</span>
<a name="l01404"></a>01404 <span class="preprocessor"></span>      <span class="keyword">set</span> fname [file normalize [lindex $files $file_index $files_index(fname)]]
<a name="l01405"></a>01405 
<a name="l01406"></a>01406 <span class="preprocessor">      # Add the filename to the most recently opened list</span>
<a name="l01407"></a>01407 <span class="preprocessor"></span>      add_to_recently_opened $fname
<a name="l01408"></a>01408 
<a name="l01409"></a>01409 <span class="preprocessor">      # If it is okay to add the file to the sidebar, do it now</span>
<a name="l01410"></a>01410 <span class="preprocessor"></span>      <span class="keywordflow">if</span> {[lindex $files $file_index $files_index(sidebar)]} {
<a name="l01411"></a>01411 
<a name="l01412"></a>01412 <span class="preprocessor">        # Add the file&#39;s directory to the sidebar</span>
<a name="l01413"></a>01413 <span class="preprocessor"></span>        sidebar::add_directory [file dirname $fname]
<a name="l01414"></a>01414 
<a name="l01415"></a>01415 <span class="preprocessor">        # Highlight the file in the sidebar</span>
<a name="l01416"></a>01416 <span class="preprocessor"></span>        sidebar::highlight_filename [lindex $files $file_index $files_index(fname)] 1
<a name="l01417"></a>01417 
<a name="l01418"></a>01418       }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 <span class="preprocessor">      # Syntax highlight the file</span>
<a name="l01421"></a>01421 <span class="preprocessor"></span>      syntax::set_language [syntax::get_default_language [lindex $files $file_index $files_index(fname)]]
<a name="l01422"></a>01422 
<a name="l01423"></a>01423     }
<a name="l01424"></a>01424 
<a name="l01425"></a>01425 <span class="preprocessor">    # Update the timestamp</span>
<a name="l01426"></a>01426 <span class="preprocessor"></span>    file stat [lindex $files $file_index $files_index(fname)] stat
<a name="l01427"></a>01427     lset files $file_index $files_index(mtime) $stat(mtime)
<a name="l01428"></a>01428 
<a name="l01429"></a>01429     <span class="preprocessor"># Change the tab text</span>
<a name="l01430"></a>01430 <span class="preprocessor"></span>    $tb tab current -text <span class="stringliteral">&quot; [file tail [lindex $files $file_index $files_index(fname)]]&quot;</span>
<a name="l01431"></a>01431     set_title
<a name="l01432"></a>01432 
<a name="l01433"></a>01433 <span class="preprocessor">    # Change the text to unmodified</span>
<a name="l01434"></a>01434 <span class="preprocessor"></span>    [current_txt $tid] edit modified <span class="keyword">false</span>
<a name="l01435"></a>01435     lset files $file_index $files_index(modified) 0
<a name="l01436"></a>01436 
<a name="l01437"></a>01437 <span class="preprocessor">    # If there is a save command, run it now</span>
<a name="l01438"></a>01438 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[lindex $files $file_index $files_index(save_cmd)] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l01439"></a>01439       eval [lindex $files $file_index $files_index(save_cmd)]
<a name="l01440"></a>01440     }
<a name="l01441"></a>01441 
<a name="l01442"></a>01442   }
<a name="l01443"></a>01443 
<a name="l01444"></a>01444 <span class="preprocessor">  ######################################################################</span>
<a name="l01445"></a>01445 <span class="preprocessor"></span><span class="preprocessor">  # Saves all of the opened tab contents (if necessary).  If a tab has</span>
<a name="l01446"></a>01446 <span class="preprocessor"></span><span class="preprocessor">  # not been previously saved (a new file), that tab is made the current</span>
<a name="l01447"></a>01447 <span class="preprocessor"></span><span class="preprocessor">  # tab and the save_current procedure is called.</span>
<a name="l01448"></a>01448 <span class="preprocessor"></span>  proc save_all {} {
<a name="l01449"></a>01449 
<a name="l01450"></a>01450     variable files
<a name="l01451"></a>01451     variable files_index
<a name="l01452"></a>01452 
<a name="l01453"></a>01453     <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; [llength $files]} {incr i} {
<a name="l01454"></a>01454 
<a name="l01455"></a>01455 <span class="preprocessor">      # If the file needs to be saved, do it</span>
<a name="l01456"></a>01456 <span class="preprocessor"></span>      <span class="keywordflow">if</span> {[lindex $files $i $files_index(modified)] &amp;&amp; ![lindex $files $i $files_index(buffer)]} {
<a name="l01457"></a>01457 
<a name="l01458"></a>01458         <span class="keyword">set</span> tab  [lindex $files $i $files_index(tab)]
<a name="l01459"></a>01459 
<a name="l01460"></a>01460 <span class="preprocessor">        # If the file needs to be saved as a new filename, call the save_current</span>
<a name="l01461"></a>01461 <span class="preprocessor"></span><span class="preprocessor">        # procedure</span>
<a name="l01462"></a>01462 <span class="preprocessor"></span>        <span class="keywordflow">if</span> {[lindex $files $i $files_index(fname)] eq <span class="stringliteral">&quot;&quot;</span>} {
<a name="l01463"></a>01463 
<a name="l01464"></a>01464           set_current_tab $tab
<a name="l01465"></a>01465           save_current
<a name="l01466"></a>01466 
<a name="l01467"></a>01467 <span class="preprocessor">        # Perform a tab-only save</span>
<a name="l01468"></a>01468 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<a name="l01469"></a>01469 
<a name="l01470"></a>01470 <span class="preprocessor">          # Get the text widget</span>
<a name="l01471"></a>01471 <span class="preprocessor"></span>          <span class="keyword">set</span> txt [get_txt_from_tab $tab]
<a name="l01472"></a>01472 
<a name="l01473"></a>01473 <span class="preprocessor">          # Run the on_save plugins</span>
<a name="l01474"></a>01474 <span class="preprocessor"></span>          plugins::handle_on_save $i
<a name="l01475"></a>01475 
<a name="l01476"></a>01476 <span class="preprocessor">          # Save the file contents</span>
<a name="l01477"></a>01477 <span class="preprocessor"></span>          <span class="keywordflow">if</span> {[<span class="keywordflow">catch</span> { open [lindex $files $i $files_index(fname)] w } rc]} {
<a name="l01478"></a>01478             <span class="keywordflow">continue</span>
<a name="l01479"></a>01479           }
<a name="l01480"></a>01480 
<a name="l01481"></a>01481 <span class="preprocessor">          # Write the file contents</span>
<a name="l01482"></a>01482 <span class="preprocessor"></span>          puts $rc [vim::get_cleaned_content $txt]
<a name="l01483"></a>01483           close $rc
<a name="l01484"></a>01484 
<a name="l01485"></a>01485 <span class="preprocessor">          # Update the timestamp</span>
<a name="l01486"></a>01486 <span class="preprocessor"></span>          file stat [lindex $files $i $files_index(fname)] stat
<a name="l01487"></a>01487           lset files $i $files_index(mtime) $stat(mtime)
<a name="l01488"></a>01488 
<a name="l01489"></a>01489           <span class="preprocessor"># Change the tab text</span>
<a name="l01490"></a>01490 <span class="preprocessor"></span>          [lindex [pane_tb_index_from_tab $tab] 1] tab $tab -text <span class="stringliteral">&quot; [file tail [lindex $files $i $files_index(fname)]]&quot;</span>
<a name="l01491"></a>01491 
<a name="l01492"></a>01492 <span class="preprocessor">          # Change the text to unmodified</span>
<a name="l01493"></a>01493 <span class="preprocessor"></span>          $txt edit modified <span class="keyword">false</span>
<a name="l01494"></a>01494           lset files $i $files_index(modified) 0
<a name="l01495"></a>01495 
<a name="l01496"></a>01496 <span class="preprocessor">          # If there is a save command, run it now</span>
<a name="l01497"></a>01497 <span class="preprocessor"></span>          <span class="keywordflow">if</span> {[lindex $files $i $files_index(save_cmd)] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l01498"></a>01498             eval [lindex $files $i $files_index(save_cmd)]
<a name="l01499"></a>01499           }
<a name="l01500"></a>01500         }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502       }
<a name="l01503"></a>01503 
<a name="l01504"></a>01504     }
<a name="l01505"></a>01505 
<a name="l01506"></a>01506 <span class="preprocessor">    # Make sure that the title is consistent</span>
<a name="l01507"></a>01507 <span class="preprocessor"></span>    set_title
<a name="l01508"></a>01508 
<a name="l01509"></a>01509   }
<a name="l01510"></a>01510 
<a name="l01511"></a>01511 <span class="preprocessor">  ######################################################################</span>
<a name="l01512"></a>01512 <span class="preprocessor"></span><span class="preprocessor">  # Close the current tab.  If force is set to 1, closes regardless of</span>
<a name="l01513"></a>01513 <span class="preprocessor"></span><span class="preprocessor">  # modified state of text widget.  If force is set to 0 and the text</span>
<a name="l01514"></a>01514 <span class="preprocessor"></span><span class="preprocessor">  # widget is modified, the user will be questioned if they want to save</span>
<a name="l01515"></a>01515 <span class="preprocessor"></span><span class="preprocessor">  # the contents of the file prior to closing the tab.</span>
<a name="l01516"></a>01516 <span class="preprocessor"></span>  proc close_current {tid {force 0} {exiting 0}} {
<a name="l01517"></a>01517 
<a name="l01518"></a>01518     variable pw_current
<a name="l01519"></a>01519     variable files
<a name="l01520"></a>01520     variable files_index
<a name="l01521"></a>01521 
<a name="l01522"></a>01522 <span class="preprocessor">    # Get the current file index</span>
<a name="l01523"></a>01523 <span class="preprocessor"></span>    <span class="keyword">set</span> file_index [current_file]
<a name="l01524"></a>01524 
<a name="l01525"></a>01525 <span class="preprocessor">    # If the file needs to be saved, do it now</span>
<a name="l01526"></a>01526 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[lindex $files $file_index $files_index(modified)] &amp;&amp; \
<a name="l01527"></a>01527         ![lindex $files $file_index $files_index(buffer)] &amp;&amp; \
<a name="l01528"></a>01528         !$force} {
<a name="l01529"></a>01529       <span class="keyword">set</span> fname [file tail [lindex $files $file_index $files_index(fname)]]
<a name="l01530"></a>01530       <span class="keywordflow">if</span> {$fname eq <span class="stringliteral">&quot;&quot;</span>} {
<a name="l01531"></a>01531         <span class="keyword">set</span> fname <span class="stringliteral">&quot;Untitled&quot;</span>
<a name="l01532"></a>01532       }
<a name="l01533"></a>01533       <span class="keyword">set</span> msg <span class="stringliteral">&quot;[msgcat::mc Save] $fname?&quot;</span>
<a name="l01534"></a>01534       <span class="keywordflow">if</span> {[<span class="keyword">set</span> answer [tk_messageBox -<span class="keywordflow">default</span> yes -type [expr {$exiting ? {yesno} : {yesnocancel}}] -message $msg -title [msgcat::mc <span class="stringliteral">&quot;Save request&quot;</span>]]] eq <span class="stringliteral">&quot;yes&quot;</span>} {
<a name="l01535"></a>01535         save_current $tid
<a name="l01536"></a>01536       } elseif {$answer eq <span class="stringliteral">&quot;cancel&quot;</span>} {
<a name="l01537"></a>01537         <span class="keywordflow">return</span>
<a name="l01538"></a>01538       }
<a name="l01539"></a>01539     }
<a name="l01540"></a>01540 
<a name="l01541"></a>01541 <span class="preprocessor">    # Close the current tab</span>
<a name="l01542"></a>01542 <span class="preprocessor"></span>    close_tab [[current_tabbar] select] $exiting
<a name="l01543"></a>01543 
<a name="l01544"></a>01544   }
<a name="l01545"></a>01545 
<a name="l01546"></a>01546 <span class="preprocessor">  ######################################################################</span>
<a name="l01547"></a>01547 <span class="preprocessor"></span><span class="preprocessor">  # Closes the tab specified by &quot;tab&quot;.  This is called by the tabbar when</span>
<a name="l01548"></a>01548 <span class="preprocessor"></span><span class="preprocessor">  # the user clicks on the close button of a tab.</span>
<a name="l01549"></a>01549 <span class="preprocessor"></span>  proc close_tab_by_tabbar {w tab} {
<a name="l01550"></a>01550 
<a name="l01551"></a>01551     variable widgets
<a name="l01552"></a>01552     variable files
<a name="l01553"></a>01553     variable files_index
<a name="l01554"></a>01554     variable pw_current
<a name="l01555"></a>01555 
<a name="l01556"></a>01556 <span class="preprocessor">    # Get the file index</span>
<a name="l01557"></a>01557 <span class="preprocessor"></span>    <span class="keyword">set</span> index [get_file_index $tab]
<a name="l01558"></a>01558 
<a name="l01559"></a>01559 <span class="preprocessor">    # Unhighlight the file in the file browser</span>
<a name="l01560"></a>01560 <span class="preprocessor"></span>    sidebar::highlight_filename [lindex $files $index $files_index(fname)] 0
<a name="l01561"></a>01561 
<a name="l01562"></a>01562 <span class="preprocessor">    # Run the close event for this file</span>
<a name="l01563"></a>01563 <span class="preprocessor"></span>    plugins::handle_on_close $index
<a name="l01564"></a>01564 
<a name="l01565"></a>01565 <span class="preprocessor">    # Delete the file from files</span>
<a name="l01566"></a>01566 <span class="preprocessor"></span>    <span class="keyword">set</span> files [lreplace $files $index $index]
<a name="l01567"></a>01567 
<a name="l01568"></a>01568 <span class="preprocessor">    # Remove the tab frame</span>
<a name="l01569"></a>01569 <span class="preprocessor"></span>    <span class="keywordflow">catch</span> { pack forget $tab }
<a name="l01570"></a>01570 
<a name="l01571"></a>01571 <span class="preprocessor">    # Display the current pane (if one exists)</span>
<a name="l01572"></a>01572 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> tab [$w select]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l01573"></a>01573       set_current_tab $tab
<a name="l01574"></a>01574     }
<a name="l01575"></a>01575 
<a name="l01576"></a>01576 <span class="preprocessor">    # If we have no more tabs and there is another pane, remove this pane</span>
<a name="l01577"></a>01577 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {([llength [$w tabs]] == 0) &amp;&amp; ([llength [$widgets(nb_pw) panes]] &gt; 1)} {
<a name="l01578"></a>01578       $widgets(nb_pw) forget $pw_current
<a name="l01579"></a>01579       set pw_current 0
<a name="l01580"></a>01580       set w          [lindex [$widgets(nb_pw) panes] 0].tbf.tb
<a name="l01581"></a>01581     }
<a name="l01582"></a>01582 
<a name="l01583"></a>01583     <span class="preprocessor"># Add a new file if we have no more tabs, we are the only pane, and the preference</span>
<a name="l01584"></a>01584 <span class="preprocessor"></span><span class="preprocessor">    # setting is to not close after the last tab is closed.</span>
<a name="l01585"></a>01585 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {([llength [$w tabs]] == 0) &amp;&amp; ([llength [$widgets(nb_pw) panes]] == 1)} {
<a name="l01586"></a>01586       <span class="keywordflow">if</span> {[preferences::get General/ExitOnLastClose]} {
<a name="l01587"></a>01587         menus::exit_command
<a name="l01588"></a>01588       } <span class="keywordflow">else</span> {
<a name="l01589"></a>01589         add_new_file end
<a name="l01590"></a>01590       }
<a name="l01591"></a>01591     }
<a name="l01592"></a>01592 
<a name="l01593"></a>01593   }
<a name="l01594"></a>01594 
<a name="l01595"></a>01595 <span class="preprocessor">  ######################################################################</span>
<a name="l01596"></a>01596 <span class="preprocessor"></span><span class="preprocessor">  # Close the specified tab (do not ask the user about closing the tab).</span>
<a name="l01597"></a>01597 <span class="preprocessor"></span>  proc close_tab {tab {exiting 0} {keep_tab 1}} {
<a name="l01598"></a>01598 
<a name="l01599"></a>01599     variable widgets
<a name="l01600"></a>01600     variable files
<a name="l01601"></a>01601     variable files_index
<a name="l01602"></a>01602     variable pw_current
<a name="l01603"></a>01603 
<a name="l01604"></a>01604 <span class="preprocessor">    # Get the notebook</span>
<a name="l01605"></a>01605 <span class="preprocessor"></span>    lassign [pane_tb_index_from_tab $tab] pane tb tab_index
<a name="l01606"></a>01606 
<a name="l01607"></a>01607 <span class="preprocessor">    # Get the file index</span>
<a name="l01608"></a>01608 <span class="preprocessor"></span>    <span class="keyword">set</span> index [get_file_index $tab]
<a name="l01609"></a>01609 
<a name="l01610"></a>01610 <span class="preprocessor">    # Unhighlight the file in the file browser</span>
<a name="l01611"></a>01611 <span class="preprocessor"></span>    sidebar::highlight_filename [lindex $files $index $files_index(fname)] 0
<a name="l01612"></a>01612 
<a name="l01613"></a>01613 <span class="preprocessor">    # Run the close event for this file</span>
<a name="l01614"></a>01614 <span class="preprocessor"></span>    plugins::handle_on_close $index
<a name="l01615"></a>01615 
<a name="l01616"></a>01616 <span class="preprocessor">    # Delete the file from files</span>
<a name="l01617"></a>01617 <span class="preprocessor"></span>    <span class="keyword">set</span> files [lreplace $files $index $index]
<a name="l01618"></a>01618 
<a name="l01619"></a>01619 <span class="preprocessor">    # Remove the tab from the tabbar</span>
<a name="l01620"></a>01620 <span class="preprocessor"></span>    $tb <span class="keyword">delete</span> $tab_index
<a name="l01621"></a>01621 
<a name="l01622"></a>01622 <span class="preprocessor">    # Delete the text frame</span>
<a name="l01623"></a>01623 <span class="preprocessor"></span>    <span class="keywordflow">catch</span> { pack forget $tab }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625 <span class="preprocessor">    # Destroy the text frame</span>
<a name="l01626"></a>01626 <span class="preprocessor"></span>    destroy $tab
<a name="l01627"></a>01627 
<a name="l01628"></a>01628 <span class="preprocessor">    # Display the current pane (if one exists)</span>
<a name="l01629"></a>01629 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> tab [$tb select]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l01630"></a>01630       set_current_tab $tab 0 $exiting
<a name="l01631"></a>01631     }
<a name="l01632"></a>01632 
<a name="l01633"></a>01633 <span class="preprocessor">    # If we have no more tabs and there is another pane, remove this pane</span>
<a name="l01634"></a>01634 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {([llength [$tb tabs]] == 0) &amp;&amp; ([llength [$widgets(nb_pw) panes]] &gt; 1)} {
<a name="l01635"></a>01635       $widgets(nb_pw) forget $pane
<a name="l01636"></a>01636       set pw_current 0
<a name="l01637"></a>01637       set tb         [lindex [$widgets(nb_pw) panes] 0].tbf.tb
<a name="l01638"></a>01638     }
<a name="l01639"></a>01639 
<a name="l01640"></a>01640     <span class="preprocessor"># Add a new file if we have no more tabs, we are the only pane, and the preference</span>
<a name="l01641"></a>01641 <span class="preprocessor"></span><span class="preprocessor">    # setting is to not close after the last tab is closed.</span>
<a name="l01642"></a>01642 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {([llength [$tb tabs]] == 0) &amp;&amp; ([llength [$widgets(nb_pw) panes]] == 1) &amp;&amp; !$exiting} {
<a name="l01643"></a>01643       <span class="keywordflow">if</span> {[preferences::get General/ExitOnLastClose] || $::cl_exit_on_close} {
<a name="l01644"></a>01644         menus::exit_command
<a name="l01645"></a>01645       } elseif {$keep_tab} {
<a name="l01646"></a>01646         add_new_file end
<a name="l01647"></a>01647       }
<a name="l01648"></a>01648     }
<a name="l01649"></a>01649 
<a name="l01650"></a>01650   }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652 <span class="preprocessor">  ######################################################################</span>
<a name="l01653"></a>01653 <span class="preprocessor"></span><span class="preprocessor">  # Close all tabs but the current tab.</span>
<a name="l01654"></a>01654 <span class="preprocessor"></span>  proc close_others {} {
<a name="l01655"></a>01655 
<a name="l01656"></a>01656     variable widgets
<a name="l01657"></a>01657     variable pw_current
<a name="l01658"></a>01658 
<a name="l01659"></a>01659     <span class="keyword">set</span> current_pw [lindex [$widgets(nb_pw) panes] $pw_current]
<a name="l01660"></a>01660 
<a name="l01661"></a>01661     foreach nb [lreverse [$widgets(nb_pw) panes]] {
<a name="l01662"></a>01662       <span class="keywordflow">foreach</span> tab [lreverse [$nb.tbf.tb tabs]] {
<a name="l01663"></a>01663         <span class="keywordflow">if</span> {($nb ne $current_pw) || ($tab ne [$nb.tbf.tb select])} {
<a name="l01664"></a>01664           set_current_tab $tab 0 1
<a name="l01665"></a>01665           close_current {}
<a name="l01666"></a>01666         }
<a name="l01667"></a>01667       }
<a name="l01668"></a>01668     }
<a name="l01669"></a>01669 
<a name="l01670"></a>01670   }
<a name="l01671"></a>01671 
<a name="l01672"></a>01672 <span class="preprocessor">  ######################################################################</span>
<a name="l01673"></a>01673 <span class="preprocessor"></span><span class="preprocessor">  # Close all of the tabs.</span>
<a name="l01674"></a>01674 <span class="preprocessor"></span>  proc close_all {{exiting 0}} {
<a name="l01675"></a>01675 
<a name="l01676"></a>01676     variable widgets
<a name="l01677"></a>01677 
<a name="l01678"></a>01678     <span class="keywordflow">foreach</span> nb [lreverse [$widgets(nb_pw) panes]] {
<a name="l01679"></a>01679       <span class="keywordflow">foreach</span> tab [lreverse [$nb.tbf.tb tabs]] {
<a name="l01680"></a>01680         set_current_tab $tab 0 1
<a name="l01681"></a>01681         close_current {} 0 $exiting
<a name="l01682"></a>01682       }
<a name="l01683"></a>01683     }
<a name="l01684"></a>01684 
<a name="l01685"></a>01685   }
<a name="l01686"></a>01686 
<a name="l01687"></a>01687 <span class="preprocessor">  ######################################################################</span>
<a name="l01688"></a>01688 <span class="preprocessor"></span><span class="preprocessor">  # Closes the tab with the identified name (if it exists).</span>
<a name="l01689"></a>01689 <span class="preprocessor"></span>  proc close_file {fname} {
<a name="l01690"></a>01690 
<a name="l01691"></a>01691     variable files
<a name="l01692"></a>01692     variable files_index
<a name="l01693"></a>01693 
<a name="l01694"></a>01694     <span class="keywordflow">if</span> {[<span class="keyword">set</span> index [lsearch -index $files_index(fname) $files $fname]] != -1} {
<a name="l01695"></a>01695       close_tab [lindex $files $index $files_index(tab)]
<a name="l01696"></a>01696     }
<a name="l01697"></a>01697 
<a name="l01698"></a>01698   }
<a name="l01699"></a>01699 
<a name="l01700"></a>01700 <span class="preprocessor">  ######################################################################</span>
<a name="l01701"></a>01701 <span class="preprocessor"></span><span class="preprocessor">  # Sorts all of the open tabs (in both panes, if both panes are visible)</span>
<a name="l01702"></a>01702 <span class="preprocessor"></span><span class="preprocessor">  # by alphabetical order.</span>
<a name="l01703"></a>01703 <span class="preprocessor"></span>  proc sort_tabs {} {
<a name="l01704"></a>01704 
<a name="l01705"></a>01705     variable widgets
<a name="l01706"></a>01706     variable files
<a name="l01707"></a>01707     variable files_index
<a name="l01708"></a>01708 
<a name="l01709"></a>01709     <span class="keywordflow">foreach</span> nb [$widgets(nb_pw) panes] {
<a name="l01710"></a>01710 
<a name="l01711"></a>01711 <span class="preprocessor">      # Create the tabbar path</span>
<a name="l01712"></a>01712 <span class="preprocessor"></span>      <span class="keyword">set</span> tb <span class="stringliteral">&quot;$nb.tbf.tb&quot;</span>
<a name="l01713"></a>01713 
<a name="l01714"></a>01714 <span class="preprocessor">      # Get the current tab</span>
<a name="l01715"></a>01715 <span class="preprocessor"></span>      <span class="keyword">set</span> current_tab [$tb select]
<a name="l01716"></a>01716 
<a name="l01717"></a>01717 <span class="preprocessor">      # Get the list of opened tabs</span>
<a name="l01718"></a>01718 <span class="preprocessor"></span>      <span class="keyword">set</span> tabs [list]
<a name="l01719"></a>01719       <span class="keywordflow">foreach</span> tab [$tb tabs] {
<a name="l01720"></a>01720         <span class="keyword">set</span> fullname [$tb tab $tab -text]
<a name="l01721"></a>01721         regexp {(\S+)$} $fullname -&gt; name
<a name="l01722"></a>01722         lappend tabs [list $name $fullname $tab [lsearch -index $files_index(tab) $files $tab]]
<a name="l01723"></a>01723         $tb <span class="keyword">delete</span> $tab
<a name="l01724"></a>01724       }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726 <span class="preprocessor">      # Sort the tabs by alphabetical order and move them</span>
<a name="l01727"></a>01727 <span class="preprocessor"></span>      <span class="keywordflow">foreach</span> tab [lsort -index 0 $tabs] {
<a name="l01728"></a>01728         lassign $tab name fullname tabid index
<a name="l01729"></a>01729         $tb insert end $tabid -text $fullname -emboss 0
<a name="l01730"></a>01730       }
<a name="l01731"></a>01731 
<a name="l01732"></a>01732 <span class="preprocessor">      # Reset the current tab</span>
<a name="l01733"></a>01733 <span class="preprocessor"></span>      $tb select $current_tab
<a name="l01734"></a>01734 
<a name="l01735"></a>01735     }
<a name="l01736"></a>01736 
<a name="l01737"></a>01737   }
<a name="l01738"></a>01738 
<a name="l01739"></a>01739 <span class="preprocessor">  ######################################################################</span>
<a name="l01740"></a>01740 <span class="preprocessor"></span><span class="preprocessor">  # Moves the current notebook tab to the other notebook pane.  If the</span>
<a name="l01741"></a>01741 <span class="preprocessor"></span><span class="preprocessor">  # other notebook pane is not displayed, create it and display it.</span>
<a name="l01742"></a>01742 <span class="preprocessor"></span>  proc move_to_pane {} {
<a name="l01743"></a>01743 
<a name="l01744"></a>01744     variable widgets
<a name="l01745"></a>01745     variable pw_current
<a name="l01746"></a>01746     variable files
<a name="l01747"></a>01747     variable files_index
<a name="l01748"></a>01748 
<a name="l01749"></a>01749 <span class="preprocessor">    # Get the list of panes</span>
<a name="l01750"></a>01750 <span class="preprocessor"></span>    <span class="keyword">set</span> panes [$widgets(nb_pw) panes]
<a name="l01751"></a>01751 
<a name="l01752"></a>01752     <span class="preprocessor"># If the other pane does not exist, add it</span>
<a name="l01753"></a>01753 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[llength $panes] == 1} {
<a name="l01754"></a>01754       add_notebook
<a name="l01755"></a>01755       <span class="keyword">set</span> panes [$widgets(nb_pw) panes]
<a name="l01756"></a>01756     }
<a name="l01757"></a>01757 
<a name="l01758"></a>01758     <span class="preprocessor"># Get the relevant information from the current text widget</span>
<a name="l01759"></a>01759 <span class="preprocessor"></span>    <span class="keyword">set</span> txt      [current_txt {}]
<a name="l01760"></a>01760     <span class="keyword">set</span> file     [lindex $files [current_file]]
<a name="l01761"></a>01761     <span class="keywordflow">if</span> {[<span class="keyword">set</span> fname [current_filename]] eq <span class="stringliteral">&quot;&quot;</span>} {
<a name="l01762"></a>01762       <span class="keyword">set</span> fname [msgcat::mc <span class="stringliteral">&quot;Untitled&quot;</span>]
<a name="l01763"></a>01763     }
<a name="l01764"></a>01764     <span class="keyword">set</span> content  [$txt <span class="keyword">get</span> 1.0 end-1c]
<a name="l01765"></a>01765     <span class="keyword">set</span> insert   [$txt index insert]
<a name="l01766"></a>01766     <span class="keyword">set</span> select   [$txt tag ranges sel]
<a name="l01767"></a>01767     <span class="keyword">set</span> modified [lindex $file $files_index(modified)]
<a name="l01768"></a>01768     <span class="keyword">set</span> language [syntax::get_current_language $txt]
<a name="l01769"></a>01769 
<a name="l01770"></a>01770 <span class="preprocessor">    # Collect the gutter symbols</span>
<a name="l01771"></a>01771 <span class="preprocessor"></span>    array <span class="keyword">set</span> symbols {}
<a name="l01772"></a>01772     <span class="keywordflow">foreach</span> gutter [lindex $file $files_index(gutters)] {
<a name="l01773"></a>01773       <span class="keyword">set</span> gutter_name [lindex $gutter 0]
<a name="l01774"></a>01774       <span class="keyword">set</span> symbols($gutter_name) [$txt gutter <span class="keyword">get</span> $gutter_name]
<a name="l01775"></a>01775     }
<a name="l01776"></a>01776 
<a name="l01777"></a>01777 <span class="preprocessor">    # Delete the current tab</span>
<a name="l01778"></a>01778 <span class="preprocessor"></span>    close_current {} 1
<a name="l01779"></a>01779 
<a name="l01780"></a>01780 <span class="preprocessor">    # Get the name of the other pane if it exists</span>
<a name="l01781"></a>01781 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[llength [$widgets(nb_pw) panes]] == 2} {
<a name="l01782"></a>01782       <span class="keyword">set</span> pw_current [expr $pw_current ^ 1]
<a name="l01783"></a>01783     }
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 <span class="preprocessor">    # Adjust the index (if necessary)</span>
<a name="l01786"></a>01786 <span class="preprocessor"></span>    <span class="keyword">set</span> index [adjust_insert_tab_index end [file tail $fname]]
<a name="l01787"></a>01787 
<a name="l01788"></a>01788 <span class="preprocessor">    # Create a new tab</span>
<a name="l01789"></a>01789 <span class="preprocessor"></span>    <span class="keyword">set</span> w [insert_tab $index [file tail $fname] [lindex $file $files_index(diff)] [lindex $file $files_index(gutters)] $language]
<a name="l01790"></a>01790 
<a name="l01791"></a>01791 <span class="preprocessor">    # Add the text, insertion marker and selection</span>
<a name="l01792"></a>01792 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt {}]
<a name="l01793"></a>01793     $txt insert end $content
<a name="l01794"></a>01794     $txt mark <span class="keyword">set</span> insert $insert
<a name="l01795"></a>01795 
<a name="l01796"></a>01796 <span class="preprocessor">    # Add the gutter symbols</span>
<a name="l01797"></a>01797 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> {name symbol_list} [array <span class="keyword">get</span> symbols] {
<a name="l01798"></a>01798       $txt gutter <span class="keyword">set</span> $name {*}$symbol_list
<a name="l01799"></a>01799     }
<a name="l01800"></a>01800 
<a name="l01801"></a>01801 <span class="preprocessor">    # Perform an insertion adjust, if necessary</span>
<a name="l01802"></a>01802 <span class="preprocessor"></span>    vim::adjust_insert $txt.t
<a name="l01803"></a>01803 
<a name="l01804"></a>01804 <span class="preprocessor">    # Add the selection (if it exists)</span>
<a name="l01805"></a>01805 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[llength $select] &gt; 0} {
<a name="l01806"></a>01806       $txt tag add sel {*}$select
<a name="l01807"></a>01807     }
<a name="l01808"></a>01808 
<a name="l01809"></a>01809 <span class="preprocessor">    # Update the file components to include position change information</span>
<a name="l01810"></a>01810 <span class="preprocessor"></span>    lset file $files_index(tab)      $w
<a name="l01811"></a>01811     lset file $files_index(modified) 0
<a name="l01812"></a>01812     lappend files $file
<a name="l01813"></a>01813 
<a name="l01814"></a>01814     <span class="preprocessor"># If the text widget was not in a modified state, force it to be so now</span>
<a name="l01815"></a>01815 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {!$modified} {
<a name="l01816"></a>01816       $txt edit modified <span class="keyword">false</span>
<a name="l01817"></a>01817       [current_tabbar] tab current -text <span class="stringliteral">&quot; [file tail $fname]&quot;</span>
<a name="l01818"></a>01818       set_title
<a name="l01819"></a>01819     }
<a name="l01820"></a>01820 
<a name="l01821"></a>01821 <span class="preprocessor">    # Highlight the file in the sidebar</span>
<a name="l01822"></a>01822 <span class="preprocessor"></span>    sidebar::highlight_filename $fname 1
<a name="l01823"></a>01823 
<a name="l01824"></a>01824   }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826 <span class="preprocessor">  ######################################################################</span>
<a name="l01827"></a>01827 <span class="preprocessor"></span><span class="preprocessor">  # Performs an undo of the current tab.</span>
<a name="l01828"></a>01828 <span class="preprocessor"></span>  proc undo {tid} {
<a name="l01829"></a>01829 
<a name="l01830"></a>01830 <span class="preprocessor">    # Get the current textbox</span>
<a name="l01831"></a>01831 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l01832"></a>01832 
<a name="l01833"></a>01833 <span class="preprocessor">    # Perform the undo operation from Vim perspective</span>
<a name="l01834"></a>01834 <span class="preprocessor"></span>    vim::undo $txt.t
<a name="l01835"></a>01835 
<a name="l01836"></a>01836   }
<a name="l01837"></a>01837 
<a name="l01838"></a>01838 <span class="preprocessor">  ######################################################################</span>
<a name="l01839"></a>01839 <span class="preprocessor"></span><span class="preprocessor">  # Returns true if there is something in the undo buffer.</span>
<a name="l01840"></a>01840 <span class="preprocessor"></span>  proc undoable {tid} {
<a name="l01841"></a>01841 
<a name="l01842"></a>01842 <span class="preprocessor">    # Get the current textbox</span>
<a name="l01843"></a>01843 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l01844"></a>01844 
<a name="l01845"></a>01845     <span class="keywordflow">return</span> [$txt edit undoable]
<a name="l01846"></a>01846 
<a name="l01847"></a>01847   }
<a name="l01848"></a>01848 
<a name="l01849"></a>01849 <span class="preprocessor">  ######################################################################</span>
<a name="l01850"></a>01850 <span class="preprocessor"></span><span class="preprocessor">  # This procedure performs an redo operation.</span>
<a name="l01851"></a>01851 <span class="preprocessor"></span>  proc redo {tid} {
<a name="l01852"></a>01852 
<a name="l01853"></a>01853 <span class="preprocessor">    # Get the current textbox</span>
<a name="l01854"></a>01854 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l01855"></a>01855 
<a name="l01856"></a>01856 <span class="preprocessor">    # Perform the redo operation from Vim perspective</span>
<a name="l01857"></a>01857 <span class="preprocessor"></span>    vim::redo $txt.t
<a name="l01858"></a>01858 
<a name="l01859"></a>01859   }
<a name="l01860"></a>01860 
<a name="l01861"></a>01861 <span class="preprocessor">  ######################################################################</span>
<a name="l01862"></a>01862 <span class="preprocessor"></span><span class="preprocessor">  # Returns true if there is something in the redo buffer.</span>
<a name="l01863"></a>01863 <span class="preprocessor"></span>  proc redoable {tid} {
<a name="l01864"></a>01864 
<a name="l01865"></a>01865 <span class="preprocessor">    # Get the current textbox</span>
<a name="l01866"></a>01866 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l01867"></a>01867 
<a name="l01868"></a>01868     <span class="keywordflow">return</span> [$txt edit redoable]
<a name="l01869"></a>01869 
<a name="l01870"></a>01870   }
<a name="l01871"></a>01871 
<a name="l01872"></a>01872 <span class="preprocessor">  ######################################################################</span>
<a name="l01873"></a>01873 <span class="preprocessor"></span><span class="preprocessor">  # Cuts the currently selected text.</span>
<a name="l01874"></a>01874 <span class="preprocessor"></span>  proc cut {tid} {
<a name="l01875"></a>01875 
<a name="l01876"></a>01876 <span class="preprocessor">    # Perform the cut</span>
<a name="l01877"></a>01877 <span class="preprocessor"></span>    [current_txt $tid] cut
<a name="l01878"></a>01878 
<a name="l01879"></a>01879 <span class="preprocessor">    # Add the clipboard contents to history</span>
<a name="l01880"></a>01880 <span class="preprocessor"></span>    cliphist::add_from_clipboard
<a name="l01881"></a>01881 
<a name="l01882"></a>01882   }
<a name="l01883"></a>01883 
<a name="l01884"></a>01884 <span class="preprocessor">  ##############################################################################</span>
<a name="l01885"></a>01885 <span class="preprocessor"></span><span class="preprocessor">  # This procedure performs a text selection copy operation.</span>
<a name="l01886"></a>01886 <span class="preprocessor"></span>  proc copy {tid} {
<a name="l01887"></a>01887 
<a name="l01888"></a>01888 <span class="preprocessor">    # Perform the copy</span>
<a name="l01889"></a>01889 <span class="preprocessor"></span>    [current_txt $tid] copy
<a name="l01890"></a>01890 
<a name="l01891"></a>01891 <span class="preprocessor">    # Add the clipboard contents to history</span>
<a name="l01892"></a>01892 <span class="preprocessor"></span>    cliphist::add_from_clipboard
<a name="l01893"></a>01893 
<a name="l01894"></a>01894   }
<a name="l01895"></a>01895 
<a name="l01896"></a>01896 <span class="preprocessor">  ######################################################################</span>
<a name="l01897"></a>01897 <span class="preprocessor"></span><span class="preprocessor">  # Returns true if text is currently selected in the current buffer.</span>
<a name="l01898"></a>01898 <span class="preprocessor"></span>  proc selected {tid} {
<a name="l01899"></a>01899 
<a name="l01900"></a>01900     <span class="keywordflow">if</span> {([<span class="keyword">set</span> txt [current_txt $tid]] ne <span class="stringliteral">&quot;&quot;</span>) &amp;&amp; \
<a name="l01901"></a>01901         ([llength [$txt tag ranges sel]] &gt; 0)} {
<a name="l01902"></a>01902       <span class="keywordflow">return</span> 1
<a name="l01903"></a>01903     } <span class="keywordflow">else</span> {
<a name="l01904"></a>01904       <span class="keywordflow">return</span> 0
<a name="l01905"></a>01905     }
<a name="l01906"></a>01906 
<a name="l01907"></a>01907   }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909 <span class="preprocessor">  ##############################################################################</span>
<a name="l01910"></a>01910 <span class="preprocessor"></span><span class="preprocessor">  # This procedure performs a text selection paste operation.  Returns 1 if the</span>
<a name="l01911"></a>01911 <span class="preprocessor"></span><span class="preprocessor">  # paste operation was performed on the current text widget; otherwise, returns 0.</span>
<a name="l01912"></a>01912 <span class="preprocessor"></span>  proc paste {tid} {
<a name="l01913"></a>01913 
<a name="l01914"></a>01914 <span class="preprocessor">    # Get the current text widget</span>
<a name="l01915"></a>01915 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l01916"></a>01916 
<a name="l01917"></a>01917 <span class="preprocessor">    # If the current txt widget has the focus, paste clipboard contents to it and record the</span>
<a name="l01918"></a>01918 <span class="preprocessor"></span><span class="preprocessor">    # paste with the Vim namespace.</span>
<a name="l01919"></a>01919 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[focus] eq <span class="stringliteral">&quot;$txt.t&quot;</span>} {
<a name="l01920"></a>01920 
<a name="l01921"></a>01921 <span class="preprocessor">      # Perform the paste</span>
<a name="l01922"></a>01922 <span class="preprocessor"></span>      $txt paste
<a name="l01923"></a>01923 
<a name="l01924"></a>01924 <span class="preprocessor">      # Handle the Vim paste</span>
<a name="l01925"></a>01925 <span class="preprocessor"></span>      vim::handle_paste $txt
<a name="l01926"></a>01926 
<a name="l01927"></a>01927       <span class="keywordflow">return</span> 1
<a name="l01928"></a>01928 
<a name="l01929"></a>01929     }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931     <span class="keywordflow">return</span> 0
<a name="l01932"></a>01932 
<a name="l01933"></a>01933   }
<a name="l01934"></a>01934 
<a name="l01935"></a>01935 <span class="preprocessor">  ######################################################################</span>
<a name="l01936"></a>01936 <span class="preprocessor"></span><span class="preprocessor">  # This procedure performs a paste operation, formatting the pasted text</span>
<a name="l01937"></a>01937 <span class="preprocessor"></span><span class="preprocessor">  # to match the code that it is being pasted into.</span>
<a name="l01938"></a>01938 <span class="preprocessor"></span>  proc paste_and_format {tid} {
<a name="l01939"></a>01939 
<a name="l01940"></a>01940     <span class="keywordflow">if</span> {![<span class="keywordflow">catch</span> {clipboard <span class="keyword">get</span>}]} {
<a name="l01941"></a>01941 
<a name="l01942"></a>01942 <span class="preprocessor">      # Get the length of the clipboard text</span>
<a name="l01943"></a>01943 <span class="preprocessor"></span>      <span class="keyword">set</span> cliplen [<span class="keywordtype">string</span> length [clipboard <span class="keyword">get</span>]]
<a name="l01944"></a>01944 
<a name="l01945"></a>01945 <span class="preprocessor">      # Get the position of the insertion cursor</span>
<a name="l01946"></a>01946 <span class="preprocessor"></span>      <span class="keyword">set</span> insertpos [[current_txt $tid] index insert]
<a name="l01947"></a>01947 
<a name="l01948"></a>01948 <span class="preprocessor">      # Perform the paste operation</span>
<a name="l01949"></a>01949 <span class="preprocessor"></span>      <span class="keywordflow">if</span> {[paste $tid]} {
<a name="l01950"></a>01950 
<a name="l01951"></a>01951 <span class="preprocessor">        # Have the indent namespace format the clipboard contents</span>
<a name="l01952"></a>01952 <span class="preprocessor"></span>        indent::format_text [current_txt $tid].t $insertpos <span class="stringliteral">&quot;$insertpos+${cliplen}c&quot;</span>
<a name="l01953"></a>01953 
<a name="l01954"></a>01954       }
<a name="l01955"></a>01955 
<a name="l01956"></a>01956     }
<a name="l01957"></a>01957 
<a name="l01958"></a>01958   }
<a name="l01959"></a>01959 
<a name="l01960"></a>01960 <span class="preprocessor">  ######################################################################</span>
<a name="l01961"></a>01961 <span class="preprocessor"></span><span class="preprocessor">  # Returns true if there is something in the paste buffer and the current</span>
<a name="l01962"></a>01962 <span class="preprocessor"></span><span class="preprocessor">  # editor is editable.</span>
<a name="l01963"></a>01963 <span class="preprocessor"></span>  proc pastable {tid} {
<a name="l01964"></a>01964 
<a name="l01965"></a>01965     <span class="keywordflow">return</span> [expr {![<span class="keywordflow">catch</span> {clipboard <span class="keyword">get</span>} contents] &amp;&amp; ($contents ne <span class="stringliteral">&quot;&quot;</span>) &amp;&amp; [editable $tid]}]
<a name="l01966"></a>01966 
<a name="l01967"></a>01967   }
<a name="l01968"></a>01968 
<a name="l01969"></a>01969   ######################################################################
<a name="l01970"></a>01970   # Returns <span class="keyword">true</span> <span class="keywordflow">if</span> the current editor is editable.
<a name="l01971"></a>01971   proc editable {tid} {
<a name="l01972"></a>01972 
<a name="l01973"></a>01973     <span class="keywordflow">return</span> [expr {[[current_txt $tid] cget -state] eq <span class="stringliteral">&quot;normal&quot;</span>}]
<a name="l01974"></a>01974 
<a name="l01975"></a>01975   }
<a name="l01976"></a>01976 
<a name="l01977"></a>01977 <span class="preprocessor">  ######################################################################</span>
<a name="l01978"></a>01978 <span class="preprocessor"></span><span class="preprocessor">  # Formats either the selected text (if type is &quot;selected&quot;) or the entire</span>
<a name="l01979"></a>01979 <span class="preprocessor"></span><span class="preprocessor">  # file contents (if type is &quot;all&quot;).</span>
<a name="l01980"></a>01980 <span class="preprocessor"></span>  proc format {tid type} {
<a name="l01981"></a>01981 
<a name="l01982"></a>01982     variable files
<a name="l01983"></a>01983     variable files_index
<a name="l01984"></a>01984 
<a name="l01985"></a>01985 <span class="preprocessor">    # Get the current text widget</span>
<a name="l01986"></a>01986 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l01987"></a>01987 
<a name="l01988"></a>01988 <span class="preprocessor">    # Get the locked/readonly status</span>
<a name="l01989"></a>01989 <span class="preprocessor"></span>    <span class="keyword">set</span> file_index [current_file]
<a name="l01990"></a>01990     <span class="keyword">set</span> readonly   [expr [lindex $files $file_index $files_index(lock)] || \
<a name="l01991"></a>01991                          [lindex $files $file_index $files_index(readonly)]]
<a name="l01992"></a>01992 
<a name="l01993"></a>01993 <span class="preprocessor">    # If the file is locked or readonly, set the state so that it can be modified</span>
<a name="l01994"></a>01994 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$readonly} {
<a name="l01995"></a>01995       $txt configure -state normal
<a name="l01996"></a>01996     }
<a name="l01997"></a>01997 
<a name="l01998"></a>01998     <span class="keywordflow">if</span> {$type eq <span class="stringliteral">&quot;selected&quot;</span>} {
<a name="l01999"></a>01999       <span class="keywordflow">foreach</span> {endpos startpos} [lreverse [$txt tag ranges sel]] {
<a name="l02000"></a>02000         indent::format_text $txt.t $startpos $endpos
<a name="l02001"></a>02001       }
<a name="l02002"></a>02002     } <span class="keywordflow">else</span> {
<a name="l02003"></a>02003       indent::format_text $txt.t 1.0 end
<a name="l02004"></a>02004     }
<a name="l02005"></a>02005 
<a name="l02006"></a>02006 <span class="preprocessor">    # If the file is locked or readonly, clear the modified state and reset the text state</span>
<a name="l02007"></a>02007 <span class="preprocessor"></span><span class="preprocessor">    # back to disabled</span>
<a name="l02008"></a>02008 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$readonly} {
<a name="l02009"></a>02009 
<a name="l02010"></a>02010 <span class="preprocessor">      # Clear the modified state and reset the state</span>
<a name="l02011"></a>02011 <span class="preprocessor"></span>      $txt edit modified <span class="keyword">false</span>
<a name="l02012"></a>02012       $txt configure -state disabled
<a name="l02013"></a>02013 
<a name="l02014"></a>02014 <span class="preprocessor">      # Change the tab text</span>
<a name="l02015"></a>02015 <span class="preprocessor"></span>      [current_tabbar] tab current -text <span class="stringliteral">&quot; [file tail [lindex $files $file_index $files_index(fname)]]&quot;</span>
<a name="l02016"></a>02016       set_title
<a name="l02017"></a>02017 
<a name="l02018"></a>02018 <span class="preprocessor">      # Change the text to unmodified</span>
<a name="l02019"></a>02019 <span class="preprocessor"></span>      lset files $file_index $files_index(modified) 0
<a name="l02020"></a>02020 
<a name="l02021"></a>02021     }
<a name="l02022"></a>02022 
<a name="l02023"></a>02023   }
<a name="l02024"></a>02024 
<a name="l02025"></a>02025 <span class="preprocessor">  ######################################################################</span>
<a name="l02026"></a>02026 <span class="preprocessor"></span><span class="preprocessor">  # Displays the search bar.</span>
<a name="l02027"></a>02027 <span class="preprocessor"></span>  proc search {tid {dir <span class="stringliteral">&quot;next&quot;</span>}} {
<a name="l02028"></a>02028 
<a name="l02029"></a>02029     variable pw_current
<a name="l02030"></a>02030     variable tab_current
<a name="l02031"></a>02031 
<a name="l02032"></a>02032 <span class="preprocessor">    # Get the current text frame</span>
<a name="l02033"></a>02033 <span class="preprocessor"></span>    <span class="keyword">set</span> tab $tab_current($pw_current)
<a name="l02034"></a>02034 
<a name="l02035"></a>02035     <span class="preprocessor"># Update the search binding</span>
<a name="l02036"></a>02036 <span class="preprocessor"></span>    bind $tab.sf.e &lt;Return&gt; <span class="stringliteral">&quot;[ns gui]::search_start {$tid} $dir&quot;</span>
<a name="l02037"></a>02037 
<a name="l02038"></a>02038 <span class="preprocessor">    # Display the search bar and separator</span>
<a name="l02039"></a>02039 <span class="preprocessor"></span>    grid $tab.sf
<a name="l02040"></a>02040     grid $tab.sep1
<a name="l02041"></a>02041 
<a name="l02042"></a>02042 <span class="preprocessor">    # Clear the search entry</span>
<a name="l02043"></a>02043 <span class="preprocessor"></span>    $tab.sf.e <span class="keyword">delete</span> 0 end
<a name="l02044"></a>02044 
<a name="l02045"></a>02045 <span class="preprocessor">    # Place the focus on the search bar</span>
<a name="l02046"></a>02046 <span class="preprocessor"></span>    focus $tab.sf.e
<a name="l02047"></a>02047 
<a name="l02048"></a>02048   }
<a name="l02049"></a>02049 
<a name="l02050"></a>02050 <span class="preprocessor">  ######################################################################</span>
<a name="l02051"></a>02051 <span class="preprocessor"></span><span class="preprocessor">  # Closes the search widget.</span>
<a name="l02052"></a>02052 <span class="preprocessor"></span>  proc close_search {} {
<a name="l02053"></a>02053 
<a name="l02054"></a>02054     variable pw_current
<a name="l02055"></a>02055     variable tab_current
<a name="l02056"></a>02056 
<a name="l02057"></a>02057 <span class="preprocessor">    # Get the current text frame</span>
<a name="l02058"></a>02058 <span class="preprocessor"></span>    <span class="keyword">set</span> tab $tab_current($pw_current)
<a name="l02059"></a>02059 
<a name="l02060"></a>02060     <span class="preprocessor"># Hide the search frame</span>
<a name="l02061"></a>02061 <span class="preprocessor"></span>    grid <span class="keyword">remove</span> $tab.sf
<a name="l02062"></a>02062     grid <span class="keyword">remove</span> $tab.sep1
<a name="l02063"></a>02063 
<a name="l02064"></a>02064 <span class="preprocessor">    # Put the focus on the text widget</span>
<a name="l02065"></a>02065 <span class="preprocessor"></span>    set_txt_focus [last_txt_focus {}]
<a name="l02066"></a>02066 
<a name="l02067"></a>02067   }
<a name="l02068"></a>02068 
<a name="l02069"></a>02069 <span class="preprocessor">  ######################################################################</span>
<a name="l02070"></a>02070 <span class="preprocessor"></span><span class="preprocessor">  # Displays the search and replace bar.</span>
<a name="l02071"></a>02071 <span class="preprocessor"></span>  proc search_and_replace {} {
<a name="l02072"></a>02072 
<a name="l02073"></a>02073     variable pw_current
<a name="l02074"></a>02074     variable tab_current
<a name="l02075"></a>02075 
<a name="l02076"></a>02076 <span class="preprocessor">    # Get the current text frame</span>
<a name="l02077"></a>02077 <span class="preprocessor"></span>    <span class="keyword">set</span> tab $tab_current($pw_current)
<a name="l02078"></a>02078 
<a name="l02079"></a>02079     <span class="preprocessor"># Display the search bar and separator</span>
<a name="l02080"></a>02080 <span class="preprocessor"></span>    grid $tab.rf
<a name="l02081"></a>02081     grid $tab.sep1
<a name="l02082"></a>02082 
<a name="l02083"></a>02083 <span class="preprocessor">    # Clear the search entry</span>
<a name="l02084"></a>02084 <span class="preprocessor"></span>    $tab.rf.fe <span class="keyword">delete</span> 0 end
<a name="l02085"></a>02085     $tab.rf.re <span class="keyword">delete</span> 0 end
<a name="l02086"></a>02086 
<a name="l02087"></a>02087 <span class="preprocessor">    # Place the focus on the find entry field</span>
<a name="l02088"></a>02088 <span class="preprocessor"></span>    focus $tab.rf.fe
<a name="l02089"></a>02089 
<a name="l02090"></a>02090   }
<a name="l02091"></a>02091 
<a name="l02092"></a>02092 <span class="preprocessor">  ######################################################################</span>
<a name="l02093"></a>02093 <span class="preprocessor"></span><span class="preprocessor">  # Closes the search and replace bar.</span>
<a name="l02094"></a>02094 <span class="preprocessor"></span>  proc close_search_and_replace {} {
<a name="l02095"></a>02095 
<a name="l02096"></a>02096     variable pw_current
<a name="l02097"></a>02097     variable tab_current
<a name="l02098"></a>02098 
<a name="l02099"></a>02099 <span class="preprocessor">    # Get the current text frame</span>
<a name="l02100"></a>02100 <span class="preprocessor"></span>    <span class="keyword">set</span> tab $tab_current($pw_current)
<a name="l02101"></a>02101 
<a name="l02102"></a>02102     <span class="preprocessor"># Hide the search and replace bar</span>
<a name="l02103"></a>02103 <span class="preprocessor"></span>    grid <span class="keyword">remove</span> $tab.rf
<a name="l02104"></a>02104     grid <span class="keyword">remove</span> $tab.sep1
<a name="l02105"></a>02105 
<a name="l02106"></a>02106 <span class="preprocessor">    # Put the focus on the text widget</span>
<a name="l02107"></a>02107 <span class="preprocessor"></span>    set_txt_focus [last_txt_focus {}]
<a name="l02108"></a>02108 
<a name="l02109"></a>02109   }
<a name="l02110"></a>02110 
<a name="l02111"></a>02111 <span class="preprocessor">  ######################################################################</span>
<a name="l02112"></a>02112 <span class="preprocessor"></span><span class="preprocessor">  # Clears the current search text.</span>
<a name="l02113"></a>02113 <span class="preprocessor"></span>  proc clear_search {tid} {
<a name="l02114"></a>02114 
<a name="l02115"></a>02115 <span class="preprocessor">    # Get the currently selected text widget</span>
<a name="l02116"></a>02116 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l02117"></a>02117 
<a name="l02118"></a>02118 <span class="preprocessor">    # Clear the highlight class</span>
<a name="l02119"></a>02119 <span class="preprocessor"></span>    <span class="keywordflow">catch</span> { ctext::deleteHighlightClass $txt search }
<a name="l02120"></a>02120 
<a name="l02121"></a>02121   }
<a name="l02122"></a>02122 
<a name="l02123"></a>02123 <span class="preprocessor">  ######################################################################</span>
<a name="l02124"></a>02124 <span class="preprocessor"></span><span class="preprocessor">  # Starts a text search</span>
<a name="l02125"></a>02125 <span class="preprocessor"></span>  proc search_start {tid {dir <span class="stringliteral">&quot;next&quot;</span>}} {
<a name="l02126"></a>02126 
<a name="l02127"></a>02127     variable case_sensitive
<a name="l02128"></a>02128 
<a name="l02129"></a>02129 <span class="preprocessor">    # If the user has specified a new search value, find all occurrences</span>
<a name="l02130"></a>02130 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> str [[current_search].e <span class="keyword">get</span>]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02131"></a>02131 
<a name="l02132"></a>02132 <span class="preprocessor">      # Escape any parenthesis in the regular expression</span>
<a name="l02133"></a>02133 <span class="preprocessor"></span>      <span class="keyword">set</span> str [<span class="keywordtype">string</span> map {{(} {\(} {)} {\)}} $str]
<a name="l02134"></a>02134 
<a name="l02135"></a>02135       # Test the regular expression, <span class="keywordflow">if</span> it is invalid, let the user know
<a name="l02136"></a>02136       <span class="keywordflow">if</span> {[<span class="keywordflow">catch</span> { regexp $str <span class="stringliteral">&quot;&quot;</span> } rc]} {
<a name="l02137"></a>02137         after 100 [list [ns gui]::set_info_message $rc]
<a name="l02138"></a>02138         <span class="keywordflow">return</span>
<a name="l02139"></a>02139       }
<a name="l02140"></a>02140 
<a name="l02141"></a>02141 <span class="preprocessor">      # Get the current text widget</span>
<a name="l02142"></a>02142 <span class="preprocessor"></span>      <span class="keyword">set</span> txt [current_txt $tid]
<a name="l02143"></a>02143 
<a name="l02144"></a>02144 <span class="preprocessor">      # Gather any search options</span>
<a name="l02145"></a>02145 <span class="preprocessor"></span>      <span class="keyword">set</span> search_opts [list]
<a name="l02146"></a>02146       <span class="keywordflow">if</span> {!$case_sensitive} {
<a name="l02147"></a>02147         lappend search_opts -nocase
<a name="l02148"></a>02148       }
<a name="l02149"></a>02149 
<a name="l02150"></a>02150 <span class="preprocessor">      # Clear the search highlight class</span>
<a name="l02151"></a>02151 <span class="preprocessor"></span>      clear_search $tid
<a name="l02152"></a>02152 
<a name="l02153"></a>02153 <span class="preprocessor">      # Create a highlight class for the given search string</span>
<a name="l02154"></a>02154 <span class="preprocessor"></span>      ctext::addSearchClassForRegexp $txt search black yellow <span class="stringliteral">&quot;&quot;</span> $str $search_opts
<a name="l02155"></a>02155 
<a name="l02156"></a>02156     }
<a name="l02157"></a>02157 
<a name="l02158"></a>02158 <span class="preprocessor">    # Select the search term</span>
<a name="l02159"></a>02159 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$dir eq <span class="stringliteral">&quot;next&quot;</span>} {
<a name="l02160"></a>02160       search_next $tid 0
<a name="l02161"></a>02161     } <span class="keywordflow">else</span> {
<a name="l02162"></a>02162       search_prev $tid 0
<a name="l02163"></a>02163     }
<a name="l02164"></a>02164 
<a name="l02165"></a>02165   }
<a name="l02166"></a>02166 
<a name="l02167"></a>02167 <span class="preprocessor">  ######################################################################</span>
<a name="l02168"></a>02168 <span class="preprocessor"></span><span class="preprocessor">  # Searches for the next occurrence of the search item.</span>
<a name="l02169"></a>02169 <span class="preprocessor"></span>  proc search_next {tid app} {
<a name="l02170"></a>02170 
<a name="l02171"></a>02171     <span class="keyword">set</span> wrapped 0
<a name="l02172"></a>02172 
<a name="l02173"></a>02173 <span class="preprocessor">    # Get the current text widget</span>
<a name="l02174"></a>02174 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l02175"></a>02175 
<a name="l02176"></a>02176 <span class="preprocessor">    # If we are not appending to the selection, clear the selection</span>
<a name="l02177"></a>02177 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {!$app} {
<a name="l02178"></a>02178       $txt tag <span class="keyword">remove</span> sel 1.0 end
<a name="l02179"></a>02179     }
<a name="l02180"></a>02180 
<a name="l02181"></a>02181 <span class="preprocessor">    # Search the text widget from the current insertion cursor forward.</span>
<a name="l02182"></a>02182 <span class="preprocessor"></span>    lassign [$txt tag nextrange _search <span class="stringliteral">&quot;insert+1c&quot;</span>] startpos endpos
<a name="l02183"></a>02183 
<a name="l02184"></a>02184 <span class="preprocessor">    # We need to wrap on the search item</span>
<a name="l02185"></a>02185 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$startpos eq <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02186"></a>02186       lassign [$txt tag nextrange _search 1.0] startpos endpos
<a name="l02187"></a>02187       <span class="keyword">set</span> wrapped 1
<a name="l02188"></a>02188     }
<a name="l02189"></a>02189 
<a name="l02190"></a>02190 <span class="preprocessor">    # Select the next match</span>
<a name="l02191"></a>02191 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$startpos ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02192"></a>02192       <span class="keywordflow">if</span> {![vim::in_vim_mode $txt.t]} {
<a name="l02193"></a>02193         $txt tag add sel $startpos $endpos
<a name="l02194"></a>02194       }
<a name="l02195"></a>02195       $txt mark <span class="keyword">set</span> insert $startpos
<a name="l02196"></a>02196       $txt see insert
<a name="l02197"></a>02197       <span class="keywordflow">if</span> {$wrapped} {
<a name="l02198"></a>02198         set_info_message <span class="stringliteral">&quot;Search wrapped to beginning of file&quot;</span>
<a name="l02199"></a>02199       }
<a name="l02200"></a>02200     } <span class="keywordflow">else</span> {
<a name="l02201"></a>02201       set_info_message <span class="stringliteral">&quot;No search results found&quot;</span>
<a name="l02202"></a>02202     }
<a name="l02203"></a>02203 
<a name="l02204"></a>02204 <span class="preprocessor">    # Closes the search interface</span>
<a name="l02205"></a>02205 <span class="preprocessor"></span>    close_search
<a name="l02206"></a>02206 
<a name="l02207"></a>02207   }
<a name="l02208"></a>02208 
<a name="l02209"></a>02209 <span class="preprocessor">  ######################################################################</span>
<a name="l02210"></a>02210 <span class="preprocessor"></span><span class="preprocessor">  # Searches for the previous occurrence of the search item.</span>
<a name="l02211"></a>02211 <span class="preprocessor"></span>  proc search_prev {tid app} {
<a name="l02212"></a>02212 
<a name="l02213"></a>02213     <span class="keyword">set</span> wrapped 0
<a name="l02214"></a>02214 
<a name="l02215"></a>02215 <span class="preprocessor">    # Get the current text widget</span>
<a name="l02216"></a>02216 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l02217"></a>02217 
<a name="l02218"></a>02218 <span class="preprocessor">    # If we are not appending to the selection, clear the selection</span>
<a name="l02219"></a>02219 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {!$app} {
<a name="l02220"></a>02220       $txt tag <span class="keyword">remove</span> sel 1.0 end
<a name="l02221"></a>02221     }
<a name="l02222"></a>02222 
<a name="l02223"></a>02223 <span class="preprocessor">    # Search the text widget from the current insertion cursor forward.</span>
<a name="l02224"></a>02224 <span class="preprocessor"></span>    lassign [$txt tag prevrange _search insert] startpos endpos
<a name="l02225"></a>02225 
<a name="l02226"></a>02226 <span class="preprocessor">    # We need to wrap on the search item</span>
<a name="l02227"></a>02227 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$startpos eq <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02228"></a>02228       lassign [$txt tag prevrange _search end] startpos endpos
<a name="l02229"></a>02229       <span class="keyword">set</span> wrapped 1
<a name="l02230"></a>02230     }
<a name="l02231"></a>02231 
<a name="l02232"></a>02232 <span class="preprocessor">    # Select the next match</span>
<a name="l02233"></a>02233 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$startpos ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02234"></a>02234       <span class="keywordflow">if</span> {![vim::in_vim_mode $txt.t]} {
<a name="l02235"></a>02235         $txt tag add sel $startpos $endpos
<a name="l02236"></a>02236       }
<a name="l02237"></a>02237       $txt mark <span class="keyword">set</span> insert $startpos
<a name="l02238"></a>02238       $txt see insert
<a name="l02239"></a>02239       <span class="keywordflow">if</span> {$wrapped} {
<a name="l02240"></a>02240         set_info_message <span class="stringliteral">&quot;Search wrapped to end of file&quot;</span>
<a name="l02241"></a>02241       }
<a name="l02242"></a>02242     } <span class="keywordflow">else</span> {
<a name="l02243"></a>02243       set_info_message <span class="stringliteral">&quot;No search results found&quot;</span>
<a name="l02244"></a>02244     }
<a name="l02245"></a>02245 
<a name="l02246"></a>02246 <span class="preprocessor">    # Close the search interface</span>
<a name="l02247"></a>02247 <span class="preprocessor"></span>    close_search
<a name="l02248"></a>02248 
<a name="l02249"></a>02249   }
<a name="l02250"></a>02250 
<a name="l02251"></a>02251 <span class="preprocessor">  ######################################################################</span>
<a name="l02252"></a>02252 <span class="preprocessor"></span><span class="preprocessor">  # Searches for all of the occurrences and selects them all.</span>
<a name="l02253"></a>02253 <span class="preprocessor"></span>  proc search_all {tid} {
<a name="l02254"></a>02254 
<a name="l02255"></a>02255 <span class="preprocessor">    # Get the current text widget</span>
<a name="l02256"></a>02256 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l02257"></a>02257 
<a name="l02258"></a>02258 <span class="preprocessor">    # Clear the selection</span>
<a name="l02259"></a>02259 <span class="preprocessor"></span>    $txt tag <span class="keyword">remove</span> sel 1.0 end
<a name="l02260"></a>02260 
<a name="l02261"></a>02261 <span class="preprocessor">    # Add all matching search items to the selection</span>
<a name="l02262"></a>02262 <span class="preprocessor"></span>    $txt tag add sel {*}[$txt tag ranges _search]
<a name="l02263"></a>02263 
<a name="l02264"></a>02264 <span class="preprocessor">    # Make the first line viewable</span>
<a name="l02265"></a>02265 <span class="preprocessor"></span>    <span class="keywordflow">catch</span> {
<a name="l02266"></a>02266       <span class="keyword">set</span> firstpos [lindex [$txt tag ranges _search] 0]
<a name="l02267"></a>02267       $txt mark <span class="keyword">set</span> insert $firstpos
<a name="l02268"></a>02268       $txt see $firstpos
<a name="l02269"></a>02269     }
<a name="l02270"></a>02270 
<a name="l02271"></a>02271 <span class="preprocessor">    # Close the search interface</span>
<a name="l02272"></a>02272 <span class="preprocessor"></span>    close_search
<a name="l02273"></a>02273 
<a name="l02274"></a>02274   }
<a name="l02275"></a>02275 
<a name="l02276"></a>02276 <span class="preprocessor">  ######################################################################</span>
<a name="l02277"></a>02277 <span class="preprocessor"></span><span class="preprocessor">  # Performs a search and replace operation based on the GUI element</span>
<a name="l02278"></a>02278 <span class="preprocessor"></span><span class="preprocessor">  # settings.</span>
<a name="l02279"></a>02279 <span class="preprocessor"></span>  proc do_search_and_replace {tid} {
<a name="l02280"></a>02280 
<a name="l02281"></a>02281     variable pw_current
<a name="l02282"></a>02282     variable tab_current
<a name="l02283"></a>02283     variable case_sensitive
<a name="l02284"></a>02284 
<a name="l02285"></a>02285 <span class="preprocessor">    # Get the current tab frame</span>
<a name="l02286"></a>02286 <span class="preprocessor"></span>    <span class="keyword">set</span> tab $tab_current($pw_current)
<a name="l02287"></a>02287 
<a name="l02288"></a>02288     <span class="preprocessor"># Perform the search and replace</span>
<a name="l02289"></a>02289 <span class="preprocessor"></span>    do_raw_search_and_replace $tid 1.0 end [$tab.rf.fe <span class="keyword">get</span>] [$tab.rf.re <span class="keyword">get</span>] \
<a name="l02290"></a>02290       !$case_sensitive [expr {[$tab.rf.glob cget -relief] eq <span class="stringliteral">&quot;sunken&quot;</span>}]
<a name="l02291"></a>02291 
<a name="l02292"></a>02292 <span class="preprocessor">    # Close the search and replace bar</span>
<a name="l02293"></a>02293 <span class="preprocessor"></span>    close_search_and_replace
<a name="l02294"></a>02294 
<a name="l02295"></a>02295   }
<a name="l02296"></a>02296 
<a name="l02297"></a>02297 <span class="preprocessor">  ######################################################################</span>
<a name="l02298"></a>02298 <span class="preprocessor"></span><span class="preprocessor">  # Performs a search and replace given the expression,</span>
<a name="l02299"></a>02299 <span class="preprocessor"></span>  proc do_raw_search_and_replace {tid sline eline search replace ignore_case all} {
<a name="l02300"></a>02300 
<a name="l02301"></a>02301     variable widgets
<a name="l02302"></a>02302     variable lengths
<a name="l02303"></a>02303 
<a name="l02304"></a>02304 <span class="preprocessor">    # Get the current text widget</span>
<a name="l02305"></a>02305 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l02306"></a>02306 
<a name="l02307"></a>02307 <span class="preprocessor">    # Clear the selection</span>
<a name="l02308"></a>02308 <span class="preprocessor"></span>    $txt tag <span class="keyword">remove</span> sel 1.0 end
<a name="l02309"></a>02309 
<a name="l02310"></a>02310 <span class="preprocessor">    # Perform the string substitutions</span>
<a name="l02311"></a>02311 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {!$all} {
<a name="l02312"></a>02312       <span class="keyword">set</span> sline [$txt index <span class="stringliteral">&quot;insert linestart&quot;</span>]
<a name="l02313"></a>02313       <span class="keyword">set</span> eline [$txt index <span class="stringliteral">&quot;insert lineend&quot;</span>]
<a name="l02314"></a>02314     }
<a name="l02315"></a>02315 
<a name="l02316"></a>02316 <span class="preprocessor">    # Escape any parenthesis in the search string</span>
<a name="l02317"></a>02317 <span class="preprocessor"></span>    <span class="keyword">set</span> search [<span class="keywordtype">string</span> map {{(} {\(} {)} {\)}} $search]
<a name="l02318"></a>02318 
<a name="l02319"></a>02319     # Create regsub arguments
<a name="l02320"></a>02320     <span class="keyword">set</span> rs_args [list]
<a name="l02321"></a>02321     <span class="keywordflow">if</span> {$ignore_case} {
<a name="l02322"></a>02322       lappend rs_args -nocase
<a name="l02323"></a>02323     }
<a name="l02324"></a>02324 
<a name="l02325"></a>02325 <span class="preprocessor">    # Replace the text and re-highlight the changes</span>
<a name="l02326"></a>02326 <span class="preprocessor"></span>    <span class="keyword">set</span> indices [lreverse [$txt search -all -regexp -count [ns gui]::lengths {*}$rs_args -- $search $sline $eline]]
<a name="l02327"></a>02327     <span class="keyword">set</span> i       [expr [<span class="keyword">set</span> num_indices [llength $indices]] - 1]
<a name="l02328"></a>02328     <span class="keywordflow">foreach</span> index $indices {
<a name="l02329"></a>02329       $txt replace $index <span class="stringliteral">&quot;$index+[lindex $lengths $i]c&quot;</span> $replace
<a name="l02330"></a>02330       incr i -1
<a name="l02331"></a>02331     }
<a name="l02332"></a>02332     <span class="keywordflow">if</span> {$num_indices &gt; 0} {
<a name="l02333"></a>02333       $txt see [lindex $indices 0]
<a name="l02334"></a>02334       $txt mark <span class="keyword">set</span> insert [lindex $indices 0]
<a name="l02335"></a>02335       $txt highlight $sline $eline
<a name="l02336"></a>02336     }
<a name="l02337"></a>02337     set_info_message <span class="stringliteral">&quot;$num_indices substitutions done&quot;</span>
<a name="l02338"></a>02338 
<a name="l02339"></a>02339 <span class="preprocessor">    # Make sure that the insertion cursor is valid</span>
<a name="l02340"></a>02340 <span class="preprocessor"></span>    [ns vim]::adjust_insert $txt
<a name="l02341"></a>02341 
<a name="l02342"></a>02342   }
<a name="l02343"></a>02343 
<a name="l02344"></a>02344 <span class="preprocessor">  ######################################################################</span>
<a name="l02345"></a>02345 <span class="preprocessor"></span><span class="preprocessor">  # Returns the list of stored filenames.</span>
<a name="l02346"></a>02346 <span class="preprocessor"></span>  proc get_actual_filenames {} {
<a name="l02347"></a>02347 
<a name="l02348"></a>02348     variable files
<a name="l02349"></a>02349     variable files_index
<a name="l02350"></a>02350 
<a name="l02351"></a>02351     <span class="keyword">set</span> actual_filenames [list]
<a name="l02352"></a>02352 
<a name="l02353"></a>02353     <span class="keywordflow">foreach</span> finfo $files {
<a name="l02354"></a>02354       <span class="keywordflow">if</span> {[<span class="keyword">set</span> fname [lindex $finfo $files_index(fname)]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02355"></a>02355         lappend actual_filenames $fname
<a name="l02356"></a>02356       }
<a name="l02357"></a>02357     }
<a name="l02358"></a>02358 
<a name="l02359"></a>02359     <span class="keywordflow">return</span> $actual_filenames
<a name="l02360"></a>02360 
<a name="l02361"></a>02361   }
<a name="l02362"></a>02362 
<a name="l02363"></a>02363 <span class="preprocessor">  ######################################################################</span>
<a name="l02364"></a>02364 <span class="preprocessor"></span><span class="preprocessor">  # Sets the file lock to the specified value for the current file.</span>
<a name="l02365"></a>02365 <span class="preprocessor"></span>  proc set_current_file_lock {tid lock} {
<a name="l02366"></a>02366 
<a name="l02367"></a>02367     variable files
<a name="l02368"></a>02368     variable files_index
<a name="l02369"></a>02369     variable images
<a name="l02370"></a>02370 
<a name="l02371"></a>02371 <span class="preprocessor">    # Get the current file index</span>
<a name="l02372"></a>02372 <span class="preprocessor"></span>    <span class="keyword">set</span> file_index [current_file]
<a name="l02373"></a>02373 
<a name="l02374"></a>02374 <span class="preprocessor">    # Set the current lock status</span>
<a name="l02375"></a>02375 <span class="preprocessor"></span>    lset files $file_index $files_index(lock) $lock
<a name="l02376"></a>02376 
<a name="l02377"></a>02377     <span class="preprocessor"># Change the state of the text widget to match the lock value</span>
<a name="l02378"></a>02378 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[lindex $files $file_index $files_index(diff)]} {
<a name="l02379"></a>02379       [current_tabbar]   tab current -compound left -image $images(diff)
<a name="l02380"></a>02380       [current_txt $tid] configure -state disabled
<a name="l02381"></a>02381     } elseif {[lindex $files $file_index $files_index(readonly)]} {
<a name="l02382"></a>02382       [current_tabbar]   tab current -compound left -image $images(readonly)
<a name="l02383"></a>02383       [current_txt $tid] configure -state disabled
<a name="l02384"></a>02384     } elseif {$lock} {
<a name="l02385"></a>02385       [current_tabbar]   tab current -compound left -image $images(lock)
<a name="l02386"></a>02386       [current_txt $tid] configure -state disabled
<a name="l02387"></a>02387     } <span class="keywordflow">else</span> {
<a name="l02388"></a>02388       [current_tabbar]   tab current -image <span class="stringliteral">&quot;&quot;</span>
<a name="l02389"></a>02389       [current_txt $tid] configure -state normal
<a name="l02390"></a>02390     }
<a name="l02391"></a>02391 
<a name="l02392"></a>02392     <span class="keywordflow">return</span> 1
<a name="l02393"></a>02393 
<a name="l02394"></a>02394   }
<a name="l02395"></a>02395 
<a name="l02396"></a>02396 <span class="preprocessor">  ######################################################################</span>
<a name="l02397"></a>02397 <span class="preprocessor"></span><span class="preprocessor">  # Set or clear the favorite status of the current file.</span>
<a name="l02398"></a>02398 <span class="preprocessor"></span>  proc set_current_file_favorite {tid favorite} {
<a name="l02399"></a>02399 
<a name="l02400"></a>02400     variable files
<a name="l02401"></a>02401     variable files_index
<a name="l02402"></a>02402 
<a name="l02403"></a>02403 <span class="preprocessor">    # Get the current file index</span>
<a name="l02404"></a>02404 <span class="preprocessor"></span>    <span class="keyword">set</span> file_index [current_file]
<a name="l02405"></a>02405     <span class="keyword">set</span> fname      [lindex $files $file_index $files_index(fname)]
<a name="l02406"></a>02406 
<a name="l02407"></a>02407 <span class="preprocessor">    # Add or remove the file from the favorites list</span>
<a name="l02408"></a>02408 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$favorite} {
<a name="l02409"></a>02409       favorites::add $fname
<a name="l02410"></a>02410     } <span class="keywordflow">else</span> {
<a name="l02411"></a>02411       favorites::remove $fname
<a name="l02412"></a>02412     }
<a name="l02413"></a>02413 
<a name="l02414"></a>02414   }
<a name="l02415"></a>02415 
<a name="l02416"></a>02416 <span class="preprocessor">  ######################################################################</span>
<a name="l02417"></a>02417 <span class="preprocessor"></span><span class="preprocessor">  # Sets auto-indent for the current editor to the given value.</span>
<a name="l02418"></a>02418 <span class="preprocessor"></span>  proc set_current_auto_indent {tid value} {
<a name="l02419"></a>02419 
<a name="l02420"></a>02420     variable widgets
<a name="l02421"></a>02421 
<a name="l02422"></a>02422 <span class="preprocessor">    # Get the current text widget</span>
<a name="l02423"></a>02423 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l02424"></a>02424 
<a name="l02425"></a>02425 <span class="preprocessor">    # Set the auto-indent mode</span>
<a name="l02426"></a>02426 <span class="preprocessor"></span>    indent::set_auto_indent $txt $value
<a name="l02427"></a>02427 
<a name="l02428"></a>02428 <span class="preprocessor">    # Update the UI</span>
<a name="l02429"></a>02429 <span class="preprocessor"></span>    update_auto_indent $txt
<a name="l02430"></a>02430 
<a name="l02431"></a>02431   }
<a name="l02432"></a>02432 
<a name="l02433"></a>02433 <span class="preprocessor">  ######################################################################</span>
<a name="l02434"></a>02434 <span class="preprocessor"></span><span class="preprocessor">  # Updates the UI to indicate the current auto-indent mode.</span>
<a name="l02435"></a>02435 <span class="preprocessor"></span>  proc update_auto_indent {txt} {
<a name="l02436"></a>02436 
<a name="l02437"></a>02437     variable widgets
<a name="l02438"></a>02438 
<a name="l02439"></a>02439     <span class="keywordflow">if</span> {[indent::get_auto_indent $txt]} {
<a name="l02440"></a>02440       $widgets(info_indent) configure -text &quot;  IND  &quot;
<a name="l02441"></a>02441     } else {
<a name="l02442"></a>02442       $widgets(info_indent) configure -text &quot;&quot;
<a name="l02443"></a>02443     }
<a name="l02444"></a>02444 
<a name="l02445"></a>02445   }
<a name="l02446"></a>02446 
<a name="l02447"></a>02447   <span class="preprocessor">######################################################################</span>
<a name="l02448"></a>02448 <span class="preprocessor"></span><span class="preprocessor">  # Shows the current file in the sidebar.</span>
<a name="l02449"></a>02449 <span class="preprocessor"></span>  proc show_current_in_sidebar {} {
<a name="l02450"></a>02450 
<a name="l02451"></a>02451     variable files
<a name="l02452"></a>02452     variable files_index
<a name="l02453"></a>02453 
<a name="l02454"></a>02454 <span class="preprocessor">    # Display the file in the sidebar</span>
<a name="l02455"></a>02455 <span class="preprocessor"></span>    sidebar::show_file [lindex $files [current_file] $files_index(fname)]
<a name="l02456"></a>02456 
<a name="l02457"></a>02457   }
<a name="l02458"></a>02458 
<a name="l02459"></a>02459 <span class="preprocessor">  ######################################################################</span>
<a name="l02460"></a>02460 <span class="preprocessor"></span><span class="preprocessor">  # Sets the current information message to the given string.</span>
<a name="l02461"></a>02461 <span class="preprocessor"></span>  proc set_info_message {msg {clear_delay 3000}} {
<a name="l02462"></a>02462 
<a name="l02463"></a>02463     variable widgets
<a name="l02464"></a>02464     variable info_clear
<a name="l02465"></a>02465 
<a name="l02466"></a>02466     <span class="keywordflow">if</span> {[info exists widgets(info_msg)]} {
<a name="l02467"></a>02467       <span class="keywordflow">if</span> {$info_clear ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02468"></a>02468         after cancel $info_clear
<a name="l02469"></a>02469       }
<a name="l02470"></a>02470       lassign [winfo rgb . [<span class="keyword">set</span> foreground [utils::get_default_foreground]]] fr fg fb
<a name="l02471"></a>02471       lassign [winfo rgb . [utils::get_default_background]] br bg bb
<a name="l02472"></a>02472       $widgets(info_msg) configure -text $msg -foreground $foreground
<a name="l02473"></a>02473       set info_clear [after $clear_delay \
<a name="l02474"></a>02474                        [list gui::clear_info_message \
<a name="l02475"></a>02475                          [expr $fr &gt;&gt; 8] [expr $fg &gt;&gt; 8] [expr $fb &gt;&gt; 8] \
<a name="l02476"></a>02476                          [expr $br &gt;&gt; 8] [expr $bg &gt;&gt; 8] [expr $bb &gt;&gt; 8]]]
<a name="l02477"></a>02477     } else {
<a name="l02478"></a>02478       puts $msg
<a name="l02479"></a>02479     }
<a name="l02480"></a>02480 
<a name="l02481"></a>02481   }
<a name="l02482"></a>02482 
<a name="l02483"></a>02483 <span class="preprocessor">  ######################################################################</span>
<a name="l02484"></a>02484 <span class="preprocessor"></span><span class="preprocessor">  # Clears the info message.</span>
<a name="l02485"></a>02485 <span class="preprocessor"></span>  proc clear_info_message {fr fg fb br bg bb {fade_count 0}} {
<a name="l02486"></a>02486 
<a name="l02487"></a>02487     variable widgets
<a name="l02488"></a>02488     variable info_clear
<a name="l02489"></a>02489 
<a name="l02490"></a>02490     <span class="keywordflow">if</span> {$fade_count == 10} {
<a name="l02491"></a>02491 
<a name="l02492"></a>02492 <span class="preprocessor">      # Clear the text</span>
<a name="l02493"></a>02493 <span class="preprocessor"></span>      $widgets(info_msg) configure -text &quot;&quot;
<a name="l02494"></a>02494 
<a name="l02495"></a>02495       <span class="preprocessor"># Clear the info_clear variable</span>
<a name="l02496"></a>02496 <span class="preprocessor"></span>      <span class="keyword">set</span> info_clear <span class="stringliteral">&quot;&quot;</span>
<a name="l02497"></a>02497 
<a name="l02498"></a>02498     } <span class="keywordflow">else</span> {
<a name="l02499"></a>02499 
<a name="l02500"></a>02500 <span class="preprocessor">      # Calculate the color</span>
<a name="l02501"></a>02501 <span class="preprocessor"></span>      <span class="keyword">set</span> color [::format {#%02x%02x%02x} \
<a name="l02502"></a>02502                   [expr $fr - ((($fr - $br) / 10) * $fade_count)] \
<a name="l02503"></a>02503                   [expr $fg - ((($fg - $bg) / 10) * $fade_count)] \
<a name="l02504"></a>02504                   [expr $fb - ((($fb - $bb) / 10) * $fade_count)]]
<a name="l02505"></a>02505 
<a name="l02506"></a>02506       # Set the foreground color to simulate the fade effect
<a name="l02507"></a>02507       $widgets(info_msg) configure -foreground $color
<a name="l02508"></a>02508 
<a name="l02509"></a>02509       set info_clear [after 100 [list gui::clear_info_message $fr $fg $fb $br $bg $bb [incr fade_count]]]
<a name="l02510"></a>02510 
<a name="l02511"></a>02511     }
<a name="l02512"></a>02512 
<a name="l02513"></a>02513   }
<a name="l02514"></a>02514 
<a name="l02515"></a>02515   <span class="preprocessor">######################################################################</span>
<a name="l02516"></a>02516 <span class="preprocessor"></span><span class="preprocessor">  # Gets user input from the interface in a generic way.</span>
<a name="l02517"></a>02517 <span class="preprocessor"></span>  proc user_response_get {msg pvar {allow_vars 1}} {
<a name="l02518"></a>02518 
<a name="l02519"></a>02519     variable widgets
<a name="l02520"></a>02520 
<a name="l02521"></a>02521     upvar $pvar var
<a name="l02522"></a>02522 
<a name="l02523"></a>02523 <span class="preprocessor">    # Initialize the widget</span>
<a name="l02524"></a>02524 <span class="preprocessor"></span>    $widgets(ursp_label) configure -text $msg
<a name="l02525"></a>02525     $widgets(ursp_entry) delete 0 end
<a name="l02526"></a>02526 
<a name="l02527"></a>02527     <span class="preprocessor"># Display the user input widget</span>
<a name="l02528"></a>02528 <span class="preprocessor"></span>    grid $widgets(ursp)
<a name="l02529"></a>02529 
<a name="l02530"></a>02530     <span class="preprocessor"># Get current focus and grab</span>
<a name="l02531"></a>02531 <span class="preprocessor"></span>    <span class="keyword">set</span> old_focus [focus]
<a name="l02532"></a>02532     <span class="keyword">set</span> old_grab  [grab current $widgets(ursp)]
<a name="l02533"></a>02533     <span class="keywordflow">if</span> {$old_grab ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02534"></a>02534       <span class="keyword">set</span> grab_status [grab status $old_grab]
<a name="l02535"></a>02535     }
<a name="l02536"></a>02536 
<a name="l02537"></a>02537 <span class="preprocessor">    # Set focus to the ursp_entry widget</span>
<a name="l02538"></a>02538 <span class="preprocessor"></span>    focus $widgets(ursp_entry)
<a name="l02539"></a>02539 
<a name="l02540"></a>02540     <span class="preprocessor"># Wait for the ursp_entry widget to be visible and then grab it</span>
<a name="l02541"></a>02541 <span class="preprocessor"></span>    tkwait visibility $widgets(ursp_entry)
<a name="l02542"></a>02542     grab $widgets(ursp_entry)
<a name="l02543"></a>02543 
<a name="l02544"></a>02544     <span class="preprocessor"># Wait for the widget to be closed</span>
<a name="l02545"></a>02545 <span class="preprocessor"></span>    vwait gui::user_exit_status
<a name="l02546"></a>02546 
<a name="l02547"></a>02547 <span class="preprocessor">    # Reset the original focus and grab</span>
<a name="l02548"></a>02548 <span class="preprocessor"></span>    <span class="keywordflow">catch</span> { focus $old_focus }
<a name="l02549"></a>02549     <span class="keywordflow">catch</span> { grab release $widgets(ursp_entry) }
<a name="l02550"></a>02550     <span class="keywordflow">if</span> {$old_grab ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02551"></a>02551       <span class="keywordflow">if</span> {$grab_status ne <span class="stringliteral">&quot;global&quot;</span>} {
<a name="l02552"></a>02552         grab $old_grab
<a name="l02553"></a>02553       } <span class="keywordflow">else</span> {
<a name="l02554"></a>02554         grab -global $old_grab
<a name="l02555"></a>02555       }
<a name="l02556"></a>02556     }
<a name="l02557"></a>02557 
<a name="l02558"></a>02558 <span class="preprocessor">    # Hide the user input widget</span>
<a name="l02559"></a>02559 <span class="preprocessor"></span>    grid <span class="keyword">remove</span> $widgets(ursp)
<a name="l02560"></a>02560 
<a name="l02561"></a>02561     <span class="preprocessor"># Get the user response value</span>
<a name="l02562"></a>02562 <span class="preprocessor"></span>    <span class="keyword">set</span> var [$widgets(ursp_entry) get]
<a name="l02563"></a>02563 
<a name="l02564"></a>02564     <span class="preprocessor"># If variable substitutions are allowed, perform any substitutions</span>
<a name="l02565"></a>02565 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$allow_vars} {
<a name="l02566"></a>02566       <span class="keyword">set</span> var [utils::perform_substitutions $var]
<a name="l02567"></a>02567     }
<a name="l02568"></a>02568 
<a name="l02569"></a>02569     <span class="keywordflow">return</span> $gui::user_exit_status
<a name="l02570"></a>02570 
<a name="l02571"></a>02571   }
<a name="l02572"></a>02572 
<a name="l02573"></a>02573 <span class="preprocessor">  ######################################################################</span>
<a name="l02574"></a>02574 <span class="preprocessor"></span><span class="preprocessor">  # Returns file information for the given file index and attribute.</span>
<a name="l02575"></a>02575 <span class="preprocessor"></span><span class="preprocessor">  # This is called by the get_file_info API command.</span>
<a name="l02576"></a>02576 <span class="preprocessor"></span>  proc get_file_info {index attr} {
<a name="l02577"></a>02577 
<a name="l02578"></a>02578     variable files
<a name="l02579"></a>02579     variable files_index
<a name="l02580"></a>02580 
<a name="l02581"></a>02581 <span class="preprocessor">    # Perform error detections</span>
<a name="l02582"></a>02582 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {($index &lt; 0) || ($index &gt;= [llength $files])} {
<a name="l02583"></a>02583       <span class="keywordflow">return</span> -code error [msgcat::mc <span class="stringliteral">&quot;File index is out of range&quot;</span>]
<a name="l02584"></a>02584     }
<a name="l02585"></a>02585     <span class="keywordflow">if</span> {$attr eq <span class="stringliteral">&quot;sb_index&quot;</span>} {
<a name="l02586"></a>02586       <span class="keywordflow">return</span> [sidebar::get_index $index]
<a name="l02587"></a>02587     } elseif {$attr eq <span class="stringliteral">&quot;txt&quot;</span>} {
<a name="l02588"></a>02588       <span class="keywordflow">return</span> [get_txt_from_tab [lindex $files $index $files_index(tab)]]
<a name="l02589"></a>02589     } elseif {$attr eq <span class="stringliteral">&quot;current&quot;</span>} {
<a name="l02590"></a>02590       <span class="keywordflow">return</span> [expr {[get_txt_from_tab [lindex $files $index $files_index(tab)]] eq [current_txt {}]}]
<a name="l02591"></a>02591     } elseif {![info exists files_index($attr)]} {
<a name="l02592"></a>02592       <span class="keywordflow">return</span> -code error [msgcat::mc <span class="stringliteral">&quot;File attribute (%s) does not exist&quot;</span> $attr]
<a name="l02593"></a>02593     }
<a name="l02594"></a>02594 
<a name="l02595"></a>02595     <span class="keywordflow">return</span> [lindex $files $index $files_index($attr)]
<a name="l02596"></a>02596 
<a name="l02597"></a>02597   }
<a name="l02598"></a>02598 
<a name="l02599"></a>02599 <span class="preprocessor">  ######################################################################</span>
<a name="l02600"></a>02600 <span class="preprocessor"></span><span class="preprocessor">  # Retrieves the &quot;find in file&quot; inputs from the user.</span>
<a name="l02601"></a>02601 <span class="preprocessor"></span>  proc fif_get_input {prsp_list} {
<a name="l02602"></a>02602 
<a name="l02603"></a>02603     variable widgets
<a name="l02604"></a>02604     variable fif_files
<a name="l02605"></a>02605     variable case_sensitive
<a name="l02606"></a>02606 
<a name="l02607"></a>02607     upvar $prsp_list rsp_list
<a name="l02608"></a>02608 
<a name="l02609"></a>02609 <span class="preprocessor">    # Reset the input widgets</span>
<a name="l02610"></a>02610 <span class="preprocessor"></span>    $widgets(fif_find) delete 0 end
<a name="l02611"></a>02611     $widgets(fif_in)   delete 0 end
<a name="l02612"></a>02612 
<a name="l02613"></a>02613     <span class="preprocessor"># Populate the fif_in tokenentry menu</span>
<a name="l02614"></a>02614 <span class="preprocessor"></span>    <span class="keyword">set</span> fif_files [sidebar::get_fif_files]
<a name="l02615"></a>02615     $widgets(fif_in) configure -listvar gui::fif_files -matchmode regexp -matchindex 0 -matchdisplayindex 0
<a name="l02616"></a>02616 
<a name="l02617"></a>02617     <span class="preprocessor"># Display the FIF widget</span>
<a name="l02618"></a>02618 <span class="preprocessor"></span>    grid $widgets(fif)
<a name="l02619"></a>02619 
<a name="l02620"></a>02620     <span class="preprocessor"># Get current focus and grab</span>
<a name="l02621"></a>02621 <span class="preprocessor"></span>    <span class="keyword">set</span> old_focus [focus]
<a name="l02622"></a>02622     <span class="keyword">set</span> old_grab  [grab current $widgets(fif)]
<a name="l02623"></a>02623     <span class="keywordflow">if</span> {$old_grab ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02624"></a>02624       <span class="keyword">set</span> grab_status [grab status $old_grab]
<a name="l02625"></a>02625     }
<a name="l02626"></a>02626 
<a name="l02627"></a>02627 <span class="preprocessor">    # Set focus to the ursp_entry widget</span>
<a name="l02628"></a>02628 <span class="preprocessor"></span>    focus $widgets(fif_find)
<a name="l02629"></a>02629 
<a name="l02630"></a>02630     <span class="preprocessor"># Wait for the fif frame to be visible and then grab it</span>
<a name="l02631"></a>02631 <span class="preprocessor"></span>    tkwait visibility $widgets(fif)
<a name="l02632"></a>02632     grab $widgets(fif)
<a name="l02633"></a>02633 
<a name="l02634"></a>02634     vwait gui::user_exit_status
<a name="l02635"></a>02635 
<a name="l02636"></a>02636     <span class="preprocessor"># Reset the original focus and grab</span>
<a name="l02637"></a>02637 <span class="preprocessor"></span>    <span class="keywordflow">catch</span> { focus $old_focus }
<a name="l02638"></a>02638     <span class="keywordflow">catch</span> { grab release $widgets(fif) }
<a name="l02639"></a>02639     <span class="keywordflow">if</span> {$old_grab ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02640"></a>02640       <span class="keywordflow">if</span> {$grab_status ne <span class="stringliteral">&quot;global&quot;</span>} {
<a name="l02641"></a>02641         grab $old_grab
<a name="l02642"></a>02642       } <span class="keywordflow">else</span> {
<a name="l02643"></a>02643         grab -global $old_grab
<a name="l02644"></a>02644       }
<a name="l02645"></a>02645     }
<a name="l02646"></a>02646 
<a name="l02647"></a>02647 <span class="preprocessor">    # Hide the widget</span>
<a name="l02648"></a>02648 <span class="preprocessor"></span>    grid <span class="keyword">remove</span> $widgets(fif)
<a name="l02649"></a>02649 
<a name="l02650"></a>02650     <span class="preprocessor"># Get the list of files/directories from the list of tokens</span>
<a name="l02651"></a>02651 <span class="preprocessor"></span>    <span class="keyword">set</span> ins [list]
<a name="l02652"></a>02652     <span class="keywordflow">foreach</span> token [$widgets(fif_in) tokenget] {
<a name="l02653"></a>02653       <span class="keywordflow">if</span> {[<span class="keyword">set</span> index [lsearch -index 0 $fif_files $token]] != -1} {
<a name="l02654"></a>02654         lappend ins {*}[lindex $fif_files $index 1]
<a name="l02655"></a>02655       } <span class="keywordflow">else</span> {
<a name="l02656"></a>02656         lappend ins [utils::perform_substitutions $token]
<a name="l02657"></a>02657       }
<a name="l02658"></a>02658     }
<a name="l02659"></a>02659 
<a name="l02660"></a>02660 <span class="preprocessor">    # Figure out any search options</span>
<a name="l02661"></a>02661 <span class="preprocessor"></span>    <span class="keyword">set</span> egrep_opts [list]
<a name="l02662"></a>02662     <span class="keywordflow">if</span> {!$case_sensitive} {
<a name="l02663"></a>02663       lappend egrep_opts -i
<a name="l02664"></a>02664     }
<a name="l02665"></a>02665 
<a name="l02666"></a>02666 <span class="preprocessor">    # Gather the input to return</span>
<a name="l02667"></a>02667 <span class="preprocessor"></span>    <span class="keyword">set</span> rsp_list [list find [$widgets(fif_find) get] in $ins egrep_opts $egrep_opts]
<a name="l02668"></a>02668 
<a name="l02669"></a>02669     return $gui::user_exit_status
<a name="l02670"></a>02670 
<a name="l02671"></a>02671   }
<a name="l02672"></a>02672 
<a name="l02673"></a>02673   <span class="preprocessor">######################################################################</span>
<a name="l02674"></a>02674 <span class="preprocessor"></span><span class="preprocessor">  # Displays the help menu &quot;About&quot; window.</span>
<a name="l02675"></a>02675 <span class="preprocessor"></span>  proc show_about {} {
<a name="l02676"></a>02676 
<a name="l02677"></a>02677     variable images
<a name="l02678"></a>02678 
<a name="l02679"></a>02679 <span class="preprocessor">    # Generate the version string</span>
<a name="l02680"></a>02680 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$::version_point == 0} {
<a name="l02681"></a>02681       <span class="keyword">set</span> version_str <span class="stringliteral">&quot;$::version_major.$::version_minor ($::version_hgid)&quot;</span>
<a name="l02682"></a>02682     } <span class="keywordflow">else</span> {
<a name="l02683"></a>02683       <span class="keyword">set</span> version_str <span class="stringliteral">&quot;$::version_major.$::version_minor.$::version_point ($::version_hgid)&quot;</span>
<a name="l02684"></a>02684     }
<a name="l02685"></a>02685 
<a name="l02686"></a>02686     <span class="keywordflow">if</span> {[[ns preferences]::get General/UpdateReleaseType] eq <span class="stringliteral">&quot;devel&quot;</span>} {
<a name="l02687"></a>02687       <span class="keyword">set</span> release_type <span class="stringliteral">&quot;Development&quot;</span>
<a name="l02688"></a>02688     } <span class="keywordflow">else</span> {
<a name="l02689"></a>02689       <span class="keyword">set</span> release_type <span class="stringliteral">&quot;Stable&quot;</span>
<a name="l02690"></a>02690     }
<a name="l02691"></a>02691 
<a name="l02692"></a>02692     toplevel     .aboutwin
<a name="l02693"></a>02693     wm title     .aboutwin <span class="stringliteral">&quot;&quot;</span>
<a name="l02694"></a>02694     wm <span class="keyword">transient</span> .aboutwin .
<a name="l02695"></a>02695     wm resizable .aboutwin 0 0
<a name="l02696"></a>02696     wm geometry  .aboutwin 300x250
<a name="l02697"></a>02697 
<a name="l02698"></a>02698     ttk::frame .aboutwin.f
<a name="l02699"></a>02699     ttk::label .aboutwin.f.logo -compound left -image $images(logo) -text <span class="stringliteral">&quot; tke&quot;</span> \
<a name="l02700"></a>02700       -font [font create -family Helvetica -size 30 -weight bold]
<a name="l02701"></a>02701 
<a name="l02702"></a>02702     ttk::frame .aboutwin.f.if
<a name="l02703"></a>02703     ttk::label .aboutwin.f.if.l0 -text [msgcat::mc <span class="stringliteral">&quot;Developer:&quot;</span>]
<a name="l02704"></a>02704     ttk::label .aboutwin.f.if.v0 -text <span class="stringliteral">&quot;Trevor Williams&quot;</span>
<a name="l02705"></a>02705     ttk::label .aboutwin.f.if.l1 -text [msgcat::mc <span class="stringliteral">&quot;Email:&quot;</span>]
<a name="l02706"></a>02706     ttk::label .aboutwin.f.if.v1 -text <span class="stringliteral">&quot;phase1geo@gmail.com&quot;</span>
<a name="l02707"></a>02707     ttk::label .aboutwin.f.if.l2 -text [msgcat::mc <span class="stringliteral">&quot;Version:&quot;</span>]
<a name="l02708"></a>02708     ttk::label .aboutwin.f.if.v2 -text $version_str
<a name="l02709"></a>02709     ttk::label .aboutwin.f.if.l3 -text [msgcat::mc <span class="stringliteral">&quot;Release Type:&quot;</span>]
<a name="l02710"></a>02710     ttk::label .aboutwin.f.if.v3 -text $release_type
<a name="l02711"></a>02711     ttk::label .aboutwin.f.if.l4 -text [msgcat::mc <span class="stringliteral">&quot;Tcl/Tk Version:&quot;</span>]
<a name="l02712"></a>02712     ttk::label .aboutwin.f.if.v4 -text [info patchlevel]
<a name="l02713"></a>02713 
<a name="l02714"></a>02714     grid .aboutwin.f.if.l0 -row 0 -column 0 -sticky news -padx 2 -pady 2
<a name="l02715"></a>02715     grid .aboutwin.f.if.v0 -row 0 -column 1 -sticky news -padx 2 -pady 2
<a name="l02716"></a>02716     grid .aboutwin.f.if.l1 -row 1 -column 0 -sticky news -padx 2 -pady 2
<a name="l02717"></a>02717     grid .aboutwin.f.if.v1 -row 1 -column 1 -sticky news -padx 2 -pady 2
<a name="l02718"></a>02718     grid .aboutwin.f.if.l2 -row 2 -column 0 -sticky news -padx 2 -pady 2
<a name="l02719"></a>02719     grid .aboutwin.f.if.v2 -row 2 -column 1 -sticky news -padx 2 -pady 2
<a name="l02720"></a>02720     grid .aboutwin.f.if.l3 -row 3 -column 0 -sticky news -padx 2 -pady 2
<a name="l02721"></a>02721     grid .aboutwin.f.if.v3 -row 3 -column 1 -sticky news -padx 2 -pady 2
<a name="l02722"></a>02722     grid .aboutwin.f.if.l4 -row 4 -column 0 -sticky news -padx 2 -pady 2
<a name="l02723"></a>02723     grid .aboutwin.f.if.v4 -row 4 -column 1 -sticky news -padx 2 -pady 2
<a name="l02724"></a>02724 
<a name="l02725"></a>02725     ttk::label .aboutwin.f.copyright -text [msgcat::mc <span class="stringliteral">&quot;Copyright %d-%d&quot;</span> 2013 15]
<a name="l02726"></a>02726 
<a name="l02727"></a>02727     pack .aboutwin.f.logo      -padx 2 -pady 8 -anchor w
<a name="l02728"></a>02728     pack .aboutwin.f.if        -padx 2 -pady 2
<a name="l02729"></a>02729     pack .aboutwin.f.copyright -padx 2 -pady 8
<a name="l02730"></a>02730 
<a name="l02731"></a>02731     pack .aboutwin.f -fill both -expand yes
<a name="l02732"></a>02732 
<a name="l02733"></a>02733 <span class="preprocessor">    # Center the window in the editor window</span>
<a name="l02734"></a>02734 <span class="preprocessor"></span>    ::tk::PlaceWindow .aboutwin widget .
<a name="l02735"></a>02735 
<a name="l02736"></a>02736   }
<a name="l02737"></a>02737 
<a name="l02738"></a>02738 <span class="preprocessor">  ######################################################################</span>
<a name="l02739"></a>02739 <span class="preprocessor"></span><span class="preprocessor">  # Displays the number insertion dialog box if we are currently in</span>
<a name="l02740"></a>02740 <span class="preprocessor"></span><span class="preprocessor">  # multicursor mode.</span>
<a name="l02741"></a>02741 <span class="preprocessor"></span>  proc insert_numbers {txt} {
<a name="l02742"></a>02742 
<a name="l02743"></a>02743     <span class="keywordflow">if</span> {[multicursor::enabled $txt]} {
<a name="l02744"></a>02744 
<a name="l02745"></a>02745       <span class="keyword">set</span> var1 <span class="stringliteral">&quot;&quot;</span>
<a name="l02746"></a>02746 
<a name="l02747"></a>02747 <span class="preprocessor">      # Get the number string from the user</span>
<a name="l02748"></a>02748 <span class="preprocessor"></span>      <span class="keywordflow">if</span> {[user_response_get <span class="stringliteral">&quot;Starting number:&quot;</span> var1]} {
<a name="l02749"></a>02749 
<a name="l02750"></a>02750 <span class="preprocessor">        # Insert the numbers (if not successful, output an error to the user)</span>
<a name="l02751"></a>02751 <span class="preprocessor"></span>        <span class="keywordflow">if</span> {![multicursor::insert_numbers $txt $var1]} {
<a name="l02752"></a>02752           set_info_message <span class="stringliteral">&quot;Unable to successfully parse number string&quot;</span>
<a name="l02753"></a>02753         }
<a name="l02754"></a>02754 
<a name="l02755"></a>02755       }
<a name="l02756"></a>02756 
<a name="l02757"></a>02757 <span class="preprocessor">    # Otherwise, display an error message to the user</span>
<a name="l02758"></a>02758 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
<a name="l02759"></a>02759       set_info_message <span class="stringliteral">&quot;Must be in multicursor mode to insert numbers&quot;</span>
<a name="l02760"></a>02760     }
<a name="l02761"></a>02761 
<a name="l02762"></a>02762   }
<a name="l02763"></a>02763 
<a name="l02764"></a>02764 <span class="preprocessor">  ######################################################################</span>
<a name="l02765"></a>02765 <span class="preprocessor"></span><span class="preprocessor">  # Toggles the split pane for the current tab.</span>
<a name="l02766"></a>02766 <span class="preprocessor"></span>  proc toggle_split_pane {tid} {
<a name="l02767"></a>02767 
<a name="l02768"></a>02768     <span class="keywordflow">if</span> {[llength [[current_txt $tid] peer names]] &gt; 0} {
<a name="l02769"></a>02769       hide_split_pane $tid
<a name="l02770"></a>02770     } <span class="keywordflow">else</span> {
<a name="l02771"></a>02771       show_split_pane $tid
<a name="l02772"></a>02772     }
<a name="l02773"></a>02773 
<a name="l02774"></a>02774   }
<a name="l02775"></a>02775 
<a name="l02776"></a>02776 <span class="preprocessor">  ######################################################################</span>
<a name="l02777"></a>02777 <span class="preprocessor"></span><span class="preprocessor">  # Returns a list of all of the text widgets in the tool.</span>
<a name="l02778"></a>02778 <span class="preprocessor"></span>  proc get_all_texts {} {
<a name="l02779"></a>02779 
<a name="l02780"></a>02780     variable widgets
<a name="l02781"></a>02781 
<a name="l02782"></a>02782     <span class="keyword">set</span> txts [list]
<a name="l02783"></a>02783 
<a name="l02784"></a>02784     <span class="keywordflow">if</span> {[info exists widgets(nb_pw)]} {
<a name="l02785"></a>02785 
<a name="l02786"></a>02786       <span class="keywordflow">foreach</span> nb [$widgets(nb_pw) panes] {
<a name="l02787"></a>02787         <span class="keywordflow">foreach</span> tab [$nb.tbf.tb tabs] {
<a name="l02788"></a>02788           lappend txts [get_txt_from_tab $tab]
<a name="l02789"></a>02789           <span class="keywordflow">if</span> {[winfo exists [get_txt2_from_tab $tab]]} {
<a name="l02790"></a>02790             lappend txts [get_txt2_from_tab $tab]
<a name="l02791"></a>02791           }
<a name="l02792"></a>02792         }
<a name="l02793"></a>02793       }
<a name="l02794"></a>02794 
<a name="l02795"></a>02795     }
<a name="l02796"></a>02796 
<a name="l02797"></a>02797     <span class="keywordflow">return</span> $txts
<a name="l02798"></a>02798 
<a name="l02799"></a>02799   }
<a name="l02800"></a>02800 
<a name="l02801"></a>02801 <span class="preprocessor">  ########################</span>
<a name="l02802"></a>02802 <span class="preprocessor"></span><span class="preprocessor">  #  PRIVATE PROCEDURES  #</span>
<a name="l02803"></a>02803 <span class="preprocessor"></span><span class="preprocessor">  ########################</span>
<a name="l02804"></a>02804 <span class="preprocessor"></span>
<a name="l02805"></a>02805 <span class="preprocessor">  ######################################################################</span>
<a name="l02806"></a>02806 <span class="preprocessor"></span><span class="preprocessor">  # Gets the pane and notebook from the given tab.</span>
<a name="l02807"></a>02807 <span class="preprocessor"></span>  proc pane_tb_index_from_tab {tab} {
<a name="l02808"></a>02808 
<a name="l02809"></a>02809     variable widgets
<a name="l02810"></a>02810 
<a name="l02811"></a>02811     <span class="keyword">set</span> pane 0
<a name="l02812"></a>02812     <span class="keywordflow">foreach</span> nb [$widgets(nb_pw) panes] {
<a name="l02813"></a>02813       <span class="keywordflow">if</span> {[<span class="keyword">set</span> index [lsearch [$nb.tbf.tb tabs] $tab]] != -1} {
<a name="l02814"></a>02814         <span class="keywordflow">return</span> [list $pane $nb.tbf.tb $index]
<a name="l02815"></a>02815       }
<a name="l02816"></a>02816       incr pane
<a name="l02817"></a>02817     }
<a name="l02818"></a>02818 
<a name="l02819"></a>02819     <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;Internal error:  pane_tb_index_from_tab called for non-existent tab ($tab)&quot;</span>
<a name="l02820"></a>02820 
<a name="l02821"></a>02821   }
<a name="l02822"></a>02822 
<a name="l02823"></a>02823 <span class="preprocessor">  ######################################################################</span>
<a name="l02824"></a>02824 <span class="preprocessor"></span><span class="preprocessor">  # Add notebook widget.</span>
<a name="l02825"></a>02825 <span class="preprocessor"></span>  proc add_notebook {} {
<a name="l02826"></a>02826 
<a name="l02827"></a>02827     variable widgets
<a name="l02828"></a>02828     variable curr_notebook
<a name="l02829"></a>02829     variable images
<a name="l02830"></a>02830 
<a name="l02831"></a>02831 <span class="preprocessor">    # Create editor notebook</span>
<a name="l02832"></a>02832 <span class="preprocessor"></span>    $widgets(nb_pw) add [set nb [ttk::frame $widgets(nb_pw).nb[incr curr_notebook]]] -weight 1
<a name="l02833"></a>02833 
<a name="l02834"></a>02834     <span class="preprocessor"># Figure out colors to apply to notebook</span>
<a name="l02835"></a>02835 <span class="preprocessor"></span>    <span class="keyword">set</span> bg  [utils::get_default_background]
<a name="l02836"></a>02836     <span class="keyword">set</span> fg  [utils::get_default_foreground]
<a name="l02837"></a>02837     <span class="keyword">set</span> abg [utils::auto_adjust_color $bg 30]
<a name="l02838"></a>02838 
<a name="l02839"></a>02839 <span class="preprocessor">    # Add the tabbar frame</span>
<a name="l02840"></a>02840 <span class="preprocessor"></span>    ttk::frame $nb.tbf
<a name="l02841"></a>02841     tabbar::tabbar $nb.tbf.tb -command <span class="stringliteral">&quot;gui::set_current_tab_from_tb&quot;</span> -closecommand <span class="stringliteral">&quot;gui::close_tab_by_tabbar&quot;</span> \
<a name="l02842"></a>02842       -background $bg -foreground $fg -activebackground $abg -inactivebackground $bg
<a name="l02843"></a>02843     ttk::label $nb.tbf.extra -image $images(down) -padding {4 4 4 4}
<a name="l02844"></a>02844 
<a name="l02845"></a>02845     grid rowconfigure    $nb.tbf 0 -weight 1
<a name="l02846"></a>02846     grid columnconfigure $nb.tbf 0 -weight 1
<a name="l02847"></a>02847     grid $nb.tbf.tb    -row 0 -column 0 -sticky news
<a name="l02848"></a>02848     grid $nb.tbf.extra -row 0 -column 1 -sticky news
<a name="l02849"></a>02849     grid <span class="keyword">remove</span> $nb.tbf.tb
<a name="l02850"></a>02850     grid <span class="keyword">remove</span> $nb.tbf.extra
<a name="l02851"></a>02851 
<a name="l02852"></a>02852     bind $nb.tbf.extra &lt;Button-1&gt; <span class="stringliteral">&quot;gui::show_tabs $nb&quot;</span>
<a name="l02853"></a>02853 
<a name="l02854"></a>02854 <span class="preprocessor">    # Create popup menu for extra tabs</span>
<a name="l02855"></a>02855 <span class="preprocessor"></span>    menu $nb.tbf.extra.mnu -tearoff 0
<a name="l02856"></a>02856 
<a name="l02857"></a>02857     ttk::frame $nb.tf
<a name="l02858"></a>02858 
<a name="l02859"></a>02859     pack $nb.tbf -fill x
<a name="l02860"></a>02860     pack $nb.tf  -fill both -expand yes
<a name="l02861"></a>02861 
<a name="l02862"></a>02862     bind [$nb.tbf.tb btag] &lt;ButtonPress-$::right_click&gt; {
<a name="l02863"></a>02863       <span class="keywordflow">if</span> {[info exists gui::tab_tip(%W)]} {
<a name="l02864"></a>02864         unset gui::tab_tip(%W)
<a name="l02865"></a>02865         tooltip::tooltip clear %W
<a name="l02866"></a>02866         tooltip::hide
<a name="l02867"></a>02867       }
<a name="l02868"></a>02868       set pane [winfo parent [winfo parent [winfo parent %W]]]
<a name="l02869"></a>02869       set gui::pw_current [lsearch [$gui::widgets(nb_pw) panes] [winfo parent [winfo parent [winfo parent %W]]]]
<a name="l02870"></a>02870       if {![<span class="keywordflow">catch</span> <span class="stringliteral">&quot;[winfo parent %W] select @%x,%y&quot;</span>]} {
<a name="l02871"></a>02871         tk_popup $gui::widgets(menu) %X %Y
<a name="l02872"></a>02872       }
<a name="l02873"></a>02873     }
<a name="l02874"></a>02874 
<a name="l02875"></a>02875     bind $nb.tbf.tb &lt;&lt;TabbarScrollEnabled&gt;&gt;  <span class="stringliteral">&quot;grid $nb.tbf.extra&quot;</span>
<a name="l02876"></a>02876     bind $nb.tbf.tb &lt;&lt;TabbarScrollDisabled&gt;&gt; <span class="stringliteral">&quot;grid remove $nb.tbf.extra&quot;</span>
<a name="l02877"></a>02877 
<a name="l02878"></a>02878 <span class="preprocessor">    # Handle tooltips</span>
<a name="l02879"></a>02879 <span class="preprocessor"></span>    bind [$nb.tbf.tb btag] &lt;Motion&gt; { gui::handle_notebook_motion [winfo parent %W] %x %y }
<a name="l02880"></a>02880 
<a name="l02881"></a>02881   }
<a name="l02882"></a>02882 
<a name="l02883"></a>02883 <span class="preprocessor">  ######################################################################</span>
<a name="l02884"></a>02884 <span class="preprocessor"></span><span class="preprocessor">  # Called when the user places the cursor over a notebook tab.</span>
<a name="l02885"></a>02885 <span class="preprocessor"></span>  proc handle_notebook_motion {W x y} {
<a name="l02886"></a>02886 
<a name="l02887"></a>02887     variable tab_tip
<a name="l02888"></a>02888     variable tab_close
<a name="l02889"></a>02889     variable images
<a name="l02890"></a>02890 
<a name="l02891"></a>02891 <span class="preprocessor">    # If the tab is one of the left or right shift tabs, exit now</span>
<a name="l02892"></a>02892 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> tab_index [$W index @$x,$y]] == -1} {
<a name="l02893"></a>02893       <span class="keywordflow">return</span>
<a name="l02894"></a>02894     }
<a name="l02895"></a>02895 
<a name="l02896"></a>02896     <span class="keyword">set</span> tab [lindex [$W tabs] $tab_index]
<a name="l02897"></a>02897 
<a name="l02898"></a>02898 <span class="preprocessor">    # Handle tooltip</span>
<a name="l02899"></a>02899 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {![info exists tab_tip($W)]} {
<a name="l02900"></a>02900       set_tab_tooltip $W $tab
<a name="l02901"></a>02901     } elseif {$tab_tip($W) ne $tab} {
<a name="l02902"></a>02902       clear_tab_tooltip $W
<a name="l02903"></a>02903       set_tab_tooltip $W $tab
<a name="l02904"></a>02904     } <span class="keywordflow">else</span> {
<a name="l02905"></a>02905       clear_tab_tooltip $W
<a name="l02906"></a>02906     }
<a name="l02907"></a>02907 
<a name="l02908"></a>02908   }
<a name="l02909"></a>02909 
<a name="l02910"></a>02910 <span class="preprocessor">  ######################################################################</span>
<a name="l02911"></a>02911 <span class="preprocessor"></span><span class="preprocessor">  # Sets a tooltip for the specified tab.</span>
<a name="l02912"></a>02912 <span class="preprocessor"></span>  proc set_tab_tooltip {W tab} {
<a name="l02913"></a>02913 
<a name="l02914"></a>02914     variable tab_tip
<a name="l02915"></a>02915     variable files
<a name="l02916"></a>02916     variable files_index
<a name="l02917"></a>02917 
<a name="l02918"></a>02918 <span class="preprocessor">    # Get the full pathname to the current file</span>
<a name="l02919"></a>02919 <span class="preprocessor"></span>    <span class="keyword">set</span> fname [lindex $files [get_file_index $tab] $files_index(fname)]
<a name="l02920"></a>02920 
<a name="l02921"></a>02921 <span class="preprocessor">    # Create the tooltip</span>
<a name="l02922"></a>02922 <span class="preprocessor"></span>    <span class="keyword">set</span> tab_tip($W) $tab
<a name="l02923"></a>02923     tooltip::tooltip $W $fname
<a name="l02924"></a>02924     event generate $W &lt;Enter&gt;
<a name="l02925"></a>02925 
<a name="l02926"></a>02926   }
<a name="l02927"></a>02927 
<a name="l02928"></a>02928   <span class="preprocessor">######################################################################</span>
<a name="l02929"></a>02929 <span class="preprocessor"></span><span class="preprocessor">  # Clears the tooltip for the specified tab.</span>
<a name="l02930"></a>02930 <span class="preprocessor"></span>  proc clear_tab_tooltip {W} {
<a name="l02931"></a>02931 
<a name="l02932"></a>02932     variable tab_tip
<a name="l02933"></a>02933 
<a name="l02934"></a>02934     unset -nocomplain tab_tip($W)
<a name="l02935"></a>02935     tooltip::tooltip clear $W
<a name="l02936"></a>02936     tooltip::hide
<a name="l02937"></a>02937 
<a name="l02938"></a>02938   }
<a name="l02939"></a>02939 
<a name="l02940"></a>02940   <span class="preprocessor">######################################################################</span>
<a name="l02941"></a>02941 <span class="preprocessor"></span><span class="preprocessor">  # Adjusts the given index (if necessary) such that the tab will be</span>
<a name="l02942"></a>02942 <span class="preprocessor"></span><span class="preprocessor">  # inserted into the current notebook in alphabetical order.</span>
<a name="l02943"></a>02943 <span class="preprocessor"></span>  proc adjust_insert_tab_index {index title} {
<a name="l02944"></a>02944 
<a name="l02945"></a>02945     <span class="keywordflow">if</span> {[preferences::get View/OpenTabsAlphabetically] &amp;&amp; ($index eq <span class="stringliteral">&quot;end&quot;</span>)} {
<a name="l02946"></a>02946 
<a name="l02947"></a>02947       <span class="keyword">set</span> sorted_index 0
<a name="l02948"></a>02948 
<a name="l02949"></a>02949       <span class="keywordflow">if</span> {[<span class="keyword">set</span> tb [current_tabbar]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l02950"></a>02950         <span class="keywordflow">foreach</span> tab [$tb tabs] {
<a name="l02951"></a>02951           regexp {(\S+)$} [$tb tab $tab -text] -&gt; curr_title
<a name="l02952"></a>02952           <span class="keywordflow">if</span> {[<span class="keywordtype">string</span> compare $title $curr_title] == -1} {
<a name="l02953"></a>02953             <span class="keywordflow">return</span> $sorted_index
<a name="l02954"></a>02954           }
<a name="l02955"></a>02955           incr sorted_index
<a name="l02956"></a>02956         }
<a name="l02957"></a>02957       }
<a name="l02958"></a>02958 
<a name="l02959"></a>02959     }
<a name="l02960"></a>02960 
<a name="l02961"></a>02961     <span class="keywordflow">return</span> $index
<a name="l02962"></a>02962 
<a name="l02963"></a>02963   }
<a name="l02964"></a>02964 
<a name="l02965"></a>02965 <span class="preprocessor">  ######################################################################</span>
<a name="l02966"></a>02966 <span class="preprocessor"></span><span class="preprocessor">  # Inserts a new tab into the editor tab notebook.</span>
<a name="l02967"></a>02967 <span class="preprocessor"></span>  proc insert_tab {index title diff gutters {initial_language <span class="stringliteral">&quot;&quot;</span>}} {
<a name="l02968"></a>02968 
<a name="l02969"></a>02969     variable widgets
<a name="l02970"></a>02970     variable curr_id
<a name="l02971"></a>02971     variable language
<a name="l02972"></a>02972     variable pw_current
<a name="l02973"></a>02973     variable images
<a name="l02974"></a>02974     variable case_sensitive
<a name="l02975"></a>02975 
<a name="l02976"></a>02976 <span class="preprocessor">    # Get the unique tab ID</span>
<a name="l02977"></a>02977 <span class="preprocessor"></span>    <span class="keyword">set</span> <span class="keywordtype">id</span> [incr curr_id]
<a name="l02978"></a>02978 
<a name="l02979"></a>02979 <span class="preprocessor">    # Get the current notebook</span>
<a name="l02980"></a>02980 <span class="preprocessor"></span>    <span class="keyword">set</span> tb [current_tabbar]
<a name="l02981"></a>02981     <span class="keyword">set</span> nb [winfo parent [winfo parent $tb]]
<a name="l02982"></a>02982 
<a name="l02983"></a>02983 <span class="preprocessor">    # Make the tabbar visible and the syntax menubutton enabled</span>
<a name="l02984"></a>02984 <span class="preprocessor"></span>    grid $tb
<a name="l02985"></a>02985     $widgets(info_syntax) configure -state normal
<a name="l02986"></a>02986 
<a name="l02987"></a>02987     <span class="preprocessor"># Create the tab frame</span>
<a name="l02988"></a>02988 <span class="preprocessor"></span>    <span class="keyword">set</span> tab_frame [ttk::frame $nb.$id]
<a name="l02989"></a>02989 
<a name="l02990"></a>02990 <span class="preprocessor">    # Create the editor pane</span>
<a name="l02991"></a>02991 <span class="preprocessor"></span>    ttk::panedwindow $tab_frame.pw
<a name="l02992"></a>02992 
<a name="l02993"></a>02993 <span class="preprocessor">    # Create tab frame name</span>
<a name="l02994"></a>02994 <span class="preprocessor"></span>    <span class="keyword">set</span> txt $tab_frame.pw.tf.txt
<a name="l02995"></a>02995 
<a name="l02996"></a>02996 <span class="preprocessor">    # Create the editor frame</span>
<a name="l02997"></a>02997 <span class="preprocessor"></span>    $tab_frame.pw add [ttk::frame $tab_frame.pw.tf]
<a name="l02998"></a>02998     ctext $txt -wrap none -undo 1 -autoseparators 1 -insertofftime 0 \
<a name="l02999"></a>02999       -highlightcolor yellow -warnwidth [preferences::get Editor/WarningWidth] \
<a name="l03000"></a>03000       -maxundo [preferences::get Editor/MaxUndo] \
<a name="l03001"></a>03001       -diff_mode $diff \
<a name="l03002"></a>03002       -linemap [preferences::get View/ShowLineNumbers] \
<a name="l03003"></a>03003       -linemap_mark_command gui::mark_command -linemap_select_bg orange \
<a name="l03004"></a>03004       -linemap_relief flat -linemap_minwidth 4 \
<a name="l03005"></a>03005       -xscrollcommand <span class="stringliteral">&quot;utils::set_xscrollbar $tab_frame.pw.tf.hb&quot;</span> \
<a name="l03006"></a>03006       -yscrollcommand <span class="stringliteral">&quot;utils::set_yscrollbar $tab_frame.pw.tf.vb&quot;</span>
<a name="l03007"></a>03007     ttk::button    $tab_frame.pw.tf.split -style BButton -image $images(split) -command <span class="stringliteral">&quot;gui::toggle_split_pane {}&quot;</span>
<a name="l03008"></a>03008     ttk::scrollbar $tab_frame.pw.tf.hb    -orient horizontal -command <span class="stringliteral">&quot;$txt xview&quot;</span>
<a name="l03009"></a>03009     <span class="keywordflow">if</span> {$diff} {
<a name="l03010"></a>03010       diff::map $tab_frame.pw.tf.vb $txt -command <span class="stringliteral">&quot;$txt yview&quot;</span>
<a name="l03011"></a>03011     } <span class="keywordflow">else</span> {
<a name="l03012"></a>03012       ttk::scrollbar $tab_frame.pw.tf.vb -orient vertical   -command <span class="stringliteral">&quot;$txt yview&quot;</span>
<a name="l03013"></a>03013     }
<a name="l03014"></a>03014 
<a name="l03015"></a>03015 <span class="preprocessor">    # Create the editor font if it does not currently exist</span>
<a name="l03016"></a>03016 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[lsearch [font names] editor_font] == -1} {
<a name="l03017"></a>03017       font create editor_font -family [font configure [$txt cget -font] -family] -size [preferences::get Appearance/EditorFontSize]
<a name="l03018"></a>03018     }
<a name="l03019"></a>03019 
<a name="l03020"></a>03020     $txt configure -font editor_font
<a name="l03021"></a>03021 
<a name="l03022"></a>03022     bind Ctext  &lt;&lt;Modified&gt;&gt;          <span class="stringliteral">&quot;gui::text_changed %W&quot;</span>
<a name="l03023"></a>03023     bind $txt.t &lt;FocusIn&gt;             <span class="stringliteral">&quot;+gui::set_current_tab_from_txt %W&quot;</span>
<a name="l03024"></a>03024     bind $txt.l &lt;ButtonPress-3&gt;       [bind $txt.l &lt;ButtonPress-1&gt;]
<a name="l03025"></a>03025     bind $txt.l &lt;ButtonPress-1&gt;       <span class="stringliteral">&quot;gui::select_line %W %y&quot;</span>
<a name="l03026"></a>03026     bind $txt.l &lt;B1-Motion&gt;           <span class="stringliteral">&quot;gui::select_lines %W %y&quot;</span>
<a name="l03027"></a>03027     bind $txt.l &lt;Shift-ButtonPress-1&gt; <span class="stringliteral">&quot;gui::select_lines %W %y&quot;</span>
<a name="l03028"></a>03028     bind $txt   &lt;&lt;Selection&gt;&gt;         <span class="stringliteral">&quot;gui::selection_changed $txt&quot;</span>
<a name="l03029"></a>03029     bind $txt   &lt;ButtonPress-1&gt;       <span class="stringliteral">&quot;after idle [list gui::update_position $txt]&quot;</span>
<a name="l03030"></a>03030     bind $txt   &lt;B1-Motion&gt;           <span class="stringliteral">&quot;gui::update_position $txt&quot;</span>
<a name="l03031"></a>03031     bind $txt   &lt;KeyRelease&gt;          <span class="stringliteral">&quot;gui::update_position $txt&quot;</span>
<a name="l03032"></a>03032     bind $txt   &lt;Motion&gt;              <span class="stringliteral">&quot;gui::clear_tab_tooltip $tb&quot;</span>
<a name="l03033"></a>03033     bind Text   &lt;&lt;Cut&gt;&gt;               <span class="stringliteral">&quot;&quot;</span>
<a name="l03034"></a>03034     bind Text   &lt;&lt;Copy&gt;&gt;              <span class="stringliteral">&quot;&quot;</span>
<a name="l03035"></a>03035     bind Text   &lt;&lt;Paste&gt;&gt;             <span class="stringliteral">&quot;&quot;</span>
<a name="l03036"></a>03036     bind Text   &lt;Control-d&gt;           <span class="stringliteral">&quot;&quot;</span>
<a name="l03037"></a>03037     bind Text   &lt;Control-i&gt;           <span class="stringliteral">&quot;&quot;</span>
<a name="l03038"></a>03038 
<a name="l03039"></a>03039 <span class="preprocessor">    # Move the all bindtag ahead of the Text bindtag</span>
<a name="l03040"></a>03040 <span class="preprocessor"></span>    <span class="keyword">set</span> text_index [lsearch [bindtags $txt.t] Text]
<a name="l03041"></a>03041     <span class="keyword">set</span> all_index  [lsearch [bindtags $txt.t] all]
<a name="l03042"></a>03042     bindtags $txt.t [lreplace [bindtags $txt.t] $all_index $all_index]
<a name="l03043"></a>03043     bindtags $txt.t [linsert  [bindtags $txt.t] $text_index all]
<a name="l03044"></a>03044 
<a name="l03045"></a>03045     grid rowconfigure    $tab_frame.pw.tf 1 -weight 1
<a name="l03046"></a>03046     grid columnconfigure $tab_frame.pw.tf 0 -weight 1
<a name="l03047"></a>03047     grid $tab_frame.pw.tf.txt   -row 0 -column 0 -sticky news -rowspan 2
<a name="l03048"></a>03048     grid $tab_frame.pw.tf.split -row 0 -column 1 -sticky news
<a name="l03049"></a>03049     grid $tab_frame.pw.tf.vb    -row 1 -column 1 -sticky ns
<a name="l03050"></a>03050     grid $tab_frame.pw.tf.hb    -row 2 -column 0 -sticky ew
<a name="l03051"></a>03051 
<a name="l03052"></a>03052 <span class="preprocessor">    # Create the Vim command bar</span>
<a name="l03053"></a>03053 <span class="preprocessor"></span>    vim::bind_command_entry $txt [entry $tab_frame.ve] {}
<a name="l03054"></a>03054 
<a name="l03055"></a>03055 <span class="preprocessor">    # Create the search bar</span>
<a name="l03056"></a>03056 <span class="preprocessor"></span>    ttk::frame       $tab_frame.sf
<a name="l03057"></a>03057     ttk::label       $tab_frame.sf.l1    -text [msgcat::mc <span class="stringliteral">&quot;Find:&quot;</span>]
<a name="l03058"></a>03058     ttk::entry       $tab_frame.sf.e
<a name="l03059"></a>03059     ttk::checkbutton $tab_frame.sf.case  -text <span class="stringliteral">&quot;Aa&quot;</span> -variable gui::case_sensitive
<a name="l03060"></a>03060     ttk::label       $tab_frame.sf.close -image $images(close)
<a name="l03061"></a>03061 
<a name="l03062"></a>03062     tooltip::tooltip $tab_frame.sf.case &quot;Case sensitivity&quot;
<a name="l03063"></a>03063 
<a name="l03064"></a>03064     pack $tab_frame.sf.l1    -side left  -padx 2 -pady 2
<a name="l03065"></a>03065     pack $tab_frame.sf.e     -side left  -padx 2 -pady 2 -fill x -expand yes
<a name="l03066"></a>03066     pack $tab_frame.sf.close -side right -padx 2 -pady 2
<a name="l03067"></a>03067     pack $tab_frame.sf.case  -side right -padx 2 -pady 2
<a name="l03068"></a>03068 
<a name="l03069"></a>03069     bind $tab_frame.sf.e     &lt;Escape&gt;    &quot;gui::close_search&quot;
<a name="l03070"></a>03070     bind $tab_frame.sf.case  &lt;Escape&gt;    &quot;gui::close_search&quot;
<a name="l03071"></a>03071     bind $tab_frame.sf.close &lt;Button-1&gt;  &quot;gui::close_search&quot;
<a name="l03072"></a>03072     bind $tab_frame.sf.close &lt;Key-space&gt; &quot;gui::close_search&quot;
<a name="l03073"></a>03073 
<a name="l03074"></a>03074     <span class="preprocessor"># Create the search/replace bar</span>
<a name="l03075"></a>03075 <span class="preprocessor"></span>    ttk::frame       $tab_frame.rf
<a name="l03076"></a>03076     ttk::label       $tab_frame.rf.fl    -text [msgcat::mc <span class="stringliteral">&quot;Find:&quot;</span>]
<a name="l03077"></a>03077     ttk::entry       $tab_frame.rf.fe
<a name="l03078"></a>03078     ttk::label       $tab_frame.rf.rl    -text [msgcat::mc <span class="stringliteral">&quot;Replace:&quot;</span>]
<a name="l03079"></a>03079     ttk::entry       $tab_frame.rf.re
<a name="l03080"></a>03080     ttk::checkbutton $tab_frame.rf.case  -text <span class="stringliteral">&quot;Aa&quot;</span> -variable gui::case_sensitive
<a name="l03081"></a>03081     ttk::label       $tab_frame.rf.glob  -image $images(global) -relief raised
<a name="l03082"></a>03082     ttk::label       $tab_frame.rf.close -image $images(close)
<a name="l03083"></a>03083 
<a name="l03084"></a>03084     tooltip::tooltip $tab_frame.rf.case &quot;Case sensitivity&quot;
<a name="l03085"></a>03085     tooltip::tooltip $tab_frame.rf.glob &quot;Replace globally&quot;
<a name="l03086"></a>03086 
<a name="l03087"></a>03087     pack $tab_frame.rf.fl    -side left -padx 2 -pady 2
<a name="l03088"></a>03088     pack $tab_frame.rf.fe    -side left -padx 2 -pady 2 -fill x -expand yes
<a name="l03089"></a>03089     pack $tab_frame.rf.rl    -side left -padx 2 -pady 2
<a name="l03090"></a>03090     pack $tab_frame.rf.re    -side left -padx 2 -pady 2 -fill x -expand yes
<a name="l03091"></a>03091     pack $tab_frame.rf.case  -side left -padx 2 -pady 2
<a name="l03092"></a>03092     pack $tab_frame.rf.glob  -side left -padx 2 -pady 2
<a name="l03093"></a>03093     pack $tab_frame.rf.close -side left -padx 2 -pady 2
<a name="l03094"></a>03094 
<a name="l03095"></a>03095     bind $tab_frame.rf.fe    &lt;Return&gt;    &quot;gui::do_search_and_replace {}<span class="stringliteral">&quot;</span>
<a name="l03096"></a>03096 <span class="stringliteral">    bind $tab_frame.rf.re    &lt;Return&gt;    &quot;</span>gui::do_search_and_replace {}<span class="stringliteral">&quot;</span>
<a name="l03097"></a>03097 <span class="stringliteral">    bind $tab_frame.rf.glob  &lt;Return&gt;    &quot;</span>gui::do_search_and_replace {}<span class="stringliteral">&quot;</span>
<a name="l03098"></a>03098 <span class="stringliteral">    bind $tab_frame.rf.fe    &lt;Escape&gt;    &quot;</span>gui::close_search_and_replace<span class="stringliteral">&quot;</span>
<a name="l03099"></a>03099 <span class="stringliteral">    bind $tab_frame.rf.re    &lt;Escape&gt;    &quot;</span>gui::close_search_and_replace<span class="stringliteral">&quot;</span>
<a name="l03100"></a>03100 <span class="stringliteral">    bind $tab_frame.rf.case  &lt;Escape&gt;    &quot;</span>gui::close_search_and_replace<span class="stringliteral">&quot;</span>
<a name="l03101"></a>03101 <span class="stringliteral">    bind $tab_frame.rf.glob  &lt;Button-1&gt;  &quot;</span>gui::toggle_labelbutton %W<span class="stringliteral">&quot;</span>
<a name="l03102"></a>03102 <span class="stringliteral">    bind $tab_frame.rf.glob  &lt;Key-space&gt; &quot;</span>gui::toggle_labelbutton %W<span class="stringliteral">&quot;</span>
<a name="l03103"></a>03103 <span class="stringliteral">    bind $tab_frame.rf.glob  &lt;Escape&gt;    &quot;</span>gui::close_search_and_replace<span class="stringliteral">&quot;</span>
<a name="l03104"></a>03104 <span class="stringliteral">    bind $tab_frame.rf.close &lt;Button-1&gt;  &quot;</span>gui::close_search_and_replace<span class="stringliteral">&quot;</span>
<a name="l03105"></a>03105 <span class="stringliteral">    bind $tab_frame.rf.close &lt;Key-space&gt; &quot;</span>gui::close_search_and_replace<span class="stringliteral">&quot;</span>
<a name="l03106"></a>03106 <span class="stringliteral"></span>
<a name="l03107"></a>03107 <span class="stringliteral">    # Create the diff bar</span>
<a name="l03108"></a>03108 <span class="stringliteral">    if {$diff} {</span>
<a name="l03109"></a>03109 <span class="stringliteral">      diff::create_diff_bar $txt $tab_frame.df</span>
<a name="l03110"></a>03110 <span class="stringliteral">      ttk::separator $tab_frame.sep2 -orient horizontal</span>
<a name="l03111"></a>03111 <span class="stringliteral">    }</span>
<a name="l03112"></a>03112 <span class="stringliteral">    </span>
<a name="l03113"></a>03113 <span class="stringliteral">    # Create separator between search and information bar</span>
<a name="l03114"></a>03114 <span class="stringliteral">    ttk::separator $tab_frame.sep1 -orient horizontal</span>
<a name="l03115"></a>03115 <span class="stringliteral"></span>
<a name="l03116"></a>03116 <span class="stringliteral">    grid rowconfigure    $tab_frame 0 -weight 1</span>
<a name="l03117"></a>03117 <span class="stringliteral">    grid columnconfigure $tab_frame 0 -weight 1</span>
<a name="l03118"></a>03118 <span class="stringliteral">    grid $tab_frame.pw   -row 0 -column 0 -sticky news</span>
<a name="l03119"></a>03119 <span class="stringliteral">    grid $tab_frame.ve   -row 1 -column 0 -sticky ew</span>
<a name="l03120"></a>03120 <span class="stringliteral">    grid $tab_frame.sf   -row 2 -column 0 -sticky ew</span>
<a name="l03121"></a>03121 <span class="stringliteral">    grid $tab_frame.rf   -row 3 -column 0 -sticky ew</span>
<a name="l03122"></a>03122 <span class="stringliteral">    grid $tab_frame.sep1 -row 4 -column 0 -sticky ew</span>
<a name="l03123"></a>03123 <span class="stringliteral">    if {$diff} {</span>
<a name="l03124"></a>03124 <span class="stringliteral">      grid $tab_frame.df   -row 5 -column 0 -sticky ew</span>
<a name="l03125"></a>03125 <span class="stringliteral">      grid $tab_frame.sep2 -row 6 -column 0 -sticky ew</span>
<a name="l03126"></a>03126 <span class="stringliteral">    }</span>
<a name="l03127"></a>03127 <span class="stringliteral"></span>
<a name="l03128"></a>03128 <span class="stringliteral">    # Hide the vim command entry, search bar, search/replace bar and search separator</span>
<a name="l03129"></a>03129 <span class="stringliteral">    grid remove $tab_frame.ve</span>
<a name="l03130"></a>03130 <span class="stringliteral">    grid remove $tab_frame.sf</span>
<a name="l03131"></a>03131 <span class="stringliteral">    grid remove $tab_frame.rf</span>
<a name="l03132"></a>03132 <span class="stringliteral">    grid remove $tab_frame.sep1</span>
<a name="l03133"></a>03133 <span class="stringliteral"></span>
<a name="l03134"></a>03134 <span class="stringliteral">    # Get the adjusted index</span>
<a name="l03135"></a>03135 <span class="stringliteral">    set adjusted_index [$tb index $index]</span>
<a name="l03136"></a>03136 <span class="stringliteral"></span>
<a name="l03137"></a>03137 <span class="stringliteral">    # Add the text bindings</span>
<a name="l03138"></a>03138 <span class="stringliteral">    indent::add_bindings          $txt</span>
<a name="l03139"></a>03139 <span class="stringliteral">    multicursor::add_bindings     $txt</span>
<a name="l03140"></a>03140 <span class="stringliteral">    snippets::add_bindings        $txt</span>
<a name="l03141"></a>03141 <span class="stringliteral">    vim::set_vim_mode             $txt {}</span>
<a name="l03142"></a>03142 <span class="stringliteral">    completer::add_bindings       $txt</span>
<a name="l03143"></a>03143 <span class="stringliteral">    plugins::handle_text_bindings $txt</span>
<a name="l03144"></a>03144 <span class="stringliteral"></span>
<a name="l03145"></a>03145 <span class="stringliteral">    # Apply the appropriate syntax highlighting for the given extension</span>
<a name="l03146"></a>03146 <span class="stringliteral">    if {$initial_language eq &quot;</span><span class="stringliteral">&quot;} {</span>
<a name="l03147"></a>03147 <span class="stringliteral">      syntax::initialize_language $txt [syntax::get_default_language $title]</span>
<a name="l03148"></a>03148 <span class="stringliteral">    } else {</span>
<a name="l03149"></a>03149 <span class="stringliteral">      syntax::initialize_language $txt $initial_language</span>
<a name="l03150"></a>03150 <span class="stringliteral">    }</span>
<a name="l03151"></a>03151 <span class="stringliteral"></span>
<a name="l03152"></a>03152 <span class="stringliteral">    # Add any gutters</span>
<a name="l03153"></a>03153 <span class="stringliteral">    foreach gutter $gutters {</span>
<a name="l03154"></a>03154 <span class="stringliteral">      $txt gutter create {*}$gutter</span>
<a name="l03155"></a>03155 <span class="stringliteral">    }</span>
<a name="l03156"></a>03156 <span class="stringliteral"></span>
<a name="l03157"></a>03157 <span class="stringliteral">    # Add the new tab to the notebook in alphabetical order (if specified) and if</span>
<a name="l03158"></a>03158 <span class="stringliteral">    # the given index is &quot;</span>end<span class="stringliteral">&quot;</span>
<a name="l03159"></a>03159 <span class="stringliteral">    if {[preferences::get View/OpenTabsAlphabetically] &amp;&amp; ($index eq &quot;</span>end<span class="stringliteral">&quot;)} {</span>
<a name="l03160"></a>03160 <span class="stringliteral">      set added 0</span>
<a name="l03161"></a>03161 <span class="stringliteral">      foreach t [$tb tabs] {</span>
<a name="l03162"></a>03162 <span class="stringliteral">        if {[string compare &quot;</span> $title<span class="stringliteral">&quot; [$tb tab $t -text]] == -1} {</span>
<a name="l03163"></a>03163 <span class="stringliteral">          $tb insert $t $tab_frame -text &quot;</span> $title<span class="stringliteral">&quot; -emboss 0</span>
<a name="l03164"></a>03164 <span class="stringliteral">          set added 1</span>
<a name="l03165"></a>03165 <span class="stringliteral">          break</span>
<a name="l03166"></a>03166 <span class="stringliteral">        }</span>
<a name="l03167"></a>03167 <span class="stringliteral">      }</span>
<a name="l03168"></a>03168 <span class="stringliteral">      if {$added == 0} {</span>
<a name="l03169"></a>03169 <span class="stringliteral">        $tb insert end $tab_frame -text &quot;</span> $title<span class="stringliteral">&quot; -emboss 0</span>
<a name="l03170"></a>03170 <span class="stringliteral">      }</span>
<a name="l03171"></a>03171 <span class="stringliteral"></span>
<a name="l03172"></a>03172 <span class="stringliteral">    # Otherwise, add the tab in the specified location</span>
<a name="l03173"></a>03173 <span class="stringliteral">    } else {</span>
<a name="l03174"></a>03174 <span class="stringliteral">      $tb insert $index $tab_frame -text &quot;</span> $title<span class="stringliteral">&quot; -emboss 0</span>
<a name="l03175"></a>03175 <span class="stringliteral">    }</span>
<a name="l03176"></a>03176 <span class="stringliteral"></span>
<a name="l03177"></a>03177 <span class="stringliteral">    # Make the new tab the current tab</span>
<a name="l03178"></a>03178 <span class="stringliteral">    set_current_tab $tab_frame</span>
<a name="l03179"></a>03179 <span class="stringliteral"></span>
<a name="l03180"></a>03180 <span class="stringliteral">    # Set the current language</span>
<a name="l03181"></a>03181 <span class="stringliteral">    syntax::set_current_language {}</span>
<a name="l03182"></a>03182 <span class="stringliteral"></span>
<a name="l03183"></a>03183 <span class="stringliteral">    # Give the text widget the focus</span>
<a name="l03184"></a>03184 <span class="stringliteral">    set_txt_focus $txt</span>
<a name="l03185"></a>03185 <span class="stringliteral"></span>
<a name="l03186"></a>03186 <span class="stringliteral">    return $tab_frame</span>
<a name="l03187"></a>03187 <span class="stringliteral"></span>
<a name="l03188"></a>03188 <span class="stringliteral">  }</span>
<a name="l03189"></a>03189 <span class="stringliteral"></span>
<a name="l03190"></a>03190 <span class="stringliteral">  ######################################################################</span>
<a name="l03191"></a>03191 <span class="stringliteral">  # Adds a peer ctext widget to the current widget in the pane just below</span>
<a name="l03192"></a>03192 <span class="stringliteral">  # the current pane.</span>
<a name="l03193"></a>03193 <span class="stringliteral">  proc show_split_pane {tid} {</span>
<a name="l03194"></a>03194 <span class="stringliteral"></span>
<a name="l03195"></a>03195 <span class="stringliteral">    variable images</span>
<a name="l03196"></a>03196 <span class="stringliteral"></span>
<a name="l03197"></a>03197 <span class="stringliteral">    # Get the current paned window</span>
<a name="l03198"></a>03198 <span class="stringliteral">    set txt  [current_txt $tid]</span>
<a name="l03199"></a>03199 <span class="stringliteral">    set pw   [winfo parent [winfo parent $txt]]</span>
<a name="l03200"></a>03200 <span class="stringliteral">    set tb   [winfo parent $pw]</span>
<a name="l03201"></a>03201 <span class="stringliteral">    set txt2 $pw.tf2.txt</span>
<a name="l03202"></a>03202 <span class="stringliteral"></span>
<a name="l03203"></a>03203 <span class="stringliteral">    # Create the editor frame</span>
<a name="l03204"></a>03204 <span class="stringliteral">    $pw insert 0 [ttk::frame $pw.tf2]</span>
<a name="l03205"></a>03205 <span class="stringliteral">    ctext $txt2 -wrap none -undo 1 -autoseparators 1 -insertofftime 0 -font editor_font \</span>
<a name="l03206"></a>03206 <span class="stringliteral">      -highlightcolor yellow -warnwidth [preferences::get Editor/WarningWidth] \</span>
<a name="l03207"></a>03207 <span class="stringliteral">      -maxundo [preferences::get Editor/MaxUndo] \</span>
<a name="l03208"></a>03208 <span class="stringliteral">      -linemap [preferences::get View/ShowLineNumbers] \</span>
<a name="l03209"></a>03209 <span class="stringliteral">      -linemap_mark_command [ns gui]::mark_command -linemap_select_bg orange -peer $txt \</span>
<a name="l03210"></a>03210 <span class="stringliteral">      -xscrollcommand &quot;</span>utils::set_xscrollbar $pw.tf2.hb<span class="stringliteral">&quot; \</span>
<a name="l03211"></a>03211 <span class="stringliteral">      -yscrollcommand &quot;</span>utils::set_yscrollbar $pw.tf2.vb<span class="stringliteral">&quot;</span>
<a name="l03212"></a>03212 <span class="stringliteral">    ttk::label     $pw.tf2.split -image $images(close) -anchor center</span>
<a name="l03213"></a>03213 <span class="stringliteral">    ttk::scrollbar $pw.tf2.vb    -orient vertical   -command &quot;</span>$txt2 yview<span class="stringliteral">&quot;</span>
<a name="l03214"></a>03214 <span class="stringliteral">    ttk::scrollbar $pw.tf2.hb    -orient horizontal -command &quot;</span>$txt2 xview<span class="stringliteral">&quot;</span>
<a name="l03215"></a>03215 <span class="stringliteral"></span>
<a name="l03216"></a>03216 <span class="stringliteral">    bind $txt2.t       &lt;FocusIn&gt;             &quot;</span>+[ns gui]::set_current_tab_from_txt %W<span class="stringliteral">&quot;</span>
<a name="l03217"></a>03217 <span class="stringliteral">    bind $txt2.l       &lt;ButtonPress-3&gt;       [bind $txt2.l &lt;ButtonPress-1&gt;]</span>
<a name="l03218"></a>03218 <span class="stringliteral">    bind $txt2.l       &lt;ButtonPress-1&gt;       &quot;</span>[ns gui]::select_line %W %y<span class="stringliteral">&quot;</span>
<a name="l03219"></a>03219 <span class="stringliteral">    bind $txt2.l       &lt;B1-Motion&gt;           &quot;</span>[ns gui]::select_lines %W %y<span class="stringliteral">&quot;</span>
<a name="l03220"></a>03220 <span class="stringliteral">    bind $txt2.l       &lt;Shift-ButtonPress-1&gt; &quot;</span>[ns gui]::select_lines %W %y<span class="stringliteral">&quot;</span>
<a name="l03221"></a>03221 <span class="stringliteral">    bind $txt2         &lt;&lt;Selection&gt;&gt;         &quot;</span>[ns gui]::selection_changed $txt2<span class="stringliteral">&quot;</span>
<a name="l03222"></a>03222 <span class="stringliteral">    bind $txt2         &lt;ButtonPress-1&gt;       &quot;</span>after idle [list [ns gui]::update_position $txt2]<span class="stringliteral">&quot;</span>
<a name="l03223"></a>03223 <span class="stringliteral">    bind $txt2         &lt;B1-Motion&gt;           &quot;</span>[ns gui]::update_position $txt2<span class="stringliteral">&quot;</span>
<a name="l03224"></a>03224 <span class="stringliteral">    bind $txt2         &lt;KeyRelease&gt;          &quot;</span>[ns gui]::update_position $txt2<span class="stringliteral">&quot;</span>
<a name="l03225"></a>03225 <span class="stringliteral">    bind $txt2         &lt;Motion&gt;              &quot;</span>[ns gui]::clear_tab_tooltip $tb<span class="stringliteral">&quot;</span>
<a name="l03226"></a>03226 <span class="stringliteral">    bind $pw.tf2.split &lt;Button-1&gt;            &quot;</span>[ns gui]::toggle_split_pane {}<span class="stringliteral">&quot;</span>
<a name="l03227"></a>03227 <span class="stringliteral"></span>
<a name="l03228"></a>03228 <span class="stringliteral">    # Move the all bindtag ahead of the Text bindtag</span>
<a name="l03229"></a>03229 <span class="stringliteral">    set text_index [lsearch [bindtags $txt2.t] Text]</span>
<a name="l03230"></a>03230 <span class="stringliteral">    set all_index  [lsearch [bindtags $txt2.t] all]</span>
<a name="l03231"></a>03231 <span class="stringliteral">    bindtags $txt2.t [lreplace [bindtags $txt2.t] $all_index $all_index]</span>
<a name="l03232"></a>03232 <span class="stringliteral">    bindtags $txt2.t [linsert  [bindtags $txt2.t] $text_index all]</span>
<a name="l03233"></a>03233 <span class="stringliteral"></span>
<a name="l03234"></a>03234 <span class="stringliteral">    grid rowconfigure    $pw.tf2 1 -weight 1</span>
<a name="l03235"></a>03235 <span class="stringliteral">    grid columnconfigure $pw.tf2 0 -weight 1</span>
<a name="l03236"></a>03236 <span class="stringliteral">    grid $pw.tf2.txt   -row 0 -column 0 -sticky news -rowspan 2</span>
<a name="l03237"></a>03237 <span class="stringliteral">    grid $pw.tf2.split -row 0 -column 1 -sticky news</span>
<a name="l03238"></a>03238 <span class="stringliteral">    grid $pw.tf2.vb    -row 1 -column 1 -sticky ns</span>
<a name="l03239"></a>03239 <span class="stringliteral">    grid $pw.tf2.hb    -row 2 -column 0 -sticky ew</span>
<a name="l03240"></a>03240 <span class="stringliteral"></span>
<a name="l03241"></a>03241 <span class="stringliteral">    # Associate the existing command entry field with this text widget</span>
<a name="l03242"></a>03242 <span class="stringliteral">    [ns vim]::bind_command_entry $txt2 $tb.ve {}</span>
<a name="l03243"></a>03243 <span class="stringliteral"></span>
<a name="l03244"></a>03244 <span class="stringliteral">    # Add the text bindings</span>
<a name="l03245"></a>03245 <span class="stringliteral">    [ns indent]::add_bindings          $txt2</span>
<a name="l03246"></a>03246 <span class="stringliteral">    [ns multicursor]::add_bindings     $txt2</span>
<a name="l03247"></a>03247 <span class="stringliteral">    [ns snippets]::add_bindings        $txt2</span>
<a name="l03248"></a>03248 <span class="stringliteral">    [ns vim]::set_vim_mode             $txt2 {}</span>
<a name="l03249"></a>03249 <span class="stringliteral">    [ns completer]::add_bindings       $txt2</span>
<a name="l03250"></a>03250 <span class="stringliteral">    [ns plugins]::handle_text_bindings $txt2</span>
<a name="l03251"></a>03251 <span class="stringliteral"></span>
<a name="l03252"></a>03252 <span class="stringliteral">    # Apply the appropriate syntax highlighting for the given extension</span>
<a name="l03253"></a>03253 <span class="stringliteral">    set language [[ns syntax]::get_current_language $txt]</span>
<a name="l03254"></a>03254 <span class="stringliteral">    [ns syntax]::initialize_language $txt2 $language</span>
<a name="l03255"></a>03255 <span class="stringliteral"></span>
<a name="l03256"></a>03256 <span class="stringliteral">    # Hide the split pane button in the other text frame</span>
<a name="l03257"></a>03257 <span class="stringliteral">    grid remove $pw.tf.split</span>
<a name="l03258"></a>03258 <span class="stringliteral"></span>
<a name="l03259"></a>03259 <span class="stringliteral">    # Set the current language</span>
<a name="l03260"></a>03260 <span class="stringliteral">    [ns syntax]::set_language $language $txt2</span>
<a name="l03261"></a>03261 <span class="stringliteral"></span>
<a name="l03262"></a>03262 <span class="stringliteral">    # Give the text widget the focus</span>
<a name="l03263"></a>03263 <span class="stringliteral">    set_txt_focus $txt2</span>
<a name="l03264"></a>03264 <span class="stringliteral"></span>
<a name="l03265"></a>03265 <span class="stringliteral">  }</span>
<a name="l03266"></a>03266 <span class="stringliteral"></span>
<a name="l03267"></a>03267 <span class="stringliteral">  ######################################################################</span>
<a name="l03268"></a>03268 <span class="stringliteral">  # Removes the split pane</span>
<a name="l03269"></a>03269 <span class="stringliteral">  proc hide_split_pane {tid} {</span>
<a name="l03270"></a>03270 <span class="stringliteral"></span>
<a name="l03271"></a>03271 <span class="stringliteral">    # Get the current paned window</span>
<a name="l03272"></a>03272 <span class="stringliteral">    set txt [current_txt $tid]</span>
<a name="l03273"></a>03273 <span class="stringliteral">    set pw  [winfo parent [winfo parent $txt]]</span>
<a name="l03274"></a>03274 <span class="stringliteral"></span>
<a name="l03275"></a>03275 <span class="stringliteral">    # Delete the extra text widget</span>
<a name="l03276"></a>03276 <span class="stringliteral">    $pw forget $pw.tf2</span>
<a name="l03277"></a>03277 <span class="stringliteral"></span>
<a name="l03278"></a>03278 <span class="stringliteral">    # Destroy the extra text widget frame</span>
<a name="l03279"></a>03279 <span class="stringliteral">    destroy $pw.tf2</span>
<a name="l03280"></a>03280 <span class="stringliteral"></span>
<a name="l03281"></a>03281 <span class="stringliteral">    # Show the split pane widget in the other text widget frame</span>
<a name="l03282"></a>03282 <span class="stringliteral">    grid $pw.tf.split</span>
<a name="l03283"></a>03283 <span class="stringliteral"></span>
<a name="l03284"></a>03284 <span class="stringliteral">    # Set the focus back on the tf text widget</span>
<a name="l03285"></a>03285 <span class="stringliteral">    set_txt_focus $pw.tf.txt</span>
<a name="l03286"></a>03286 <span class="stringliteral"></span>
<a name="l03287"></a>03287 <span class="stringliteral">  }</span>
<a name="l03288"></a>03288 <span class="stringliteral"></span>
<a name="l03289"></a>03289 <span class="stringliteral">  ######################################################################</span>
<a name="l03290"></a>03290 <span class="stringliteral">  # Handles a change to the current text widget.</span>
<a name="l03291"></a>03291 <span class="stringliteral">  proc text_changed {txt} {</span>
<a name="l03292"></a>03292 <span class="stringliteral"></span>
<a name="l03293"></a>03293 <span class="stringliteral">    variable files</span>
<a name="l03294"></a>03294 <span class="stringliteral">    variable files_index</span>
<a name="l03295"></a>03295 <span class="stringliteral">    variable cursor_hist</span>
<a name="l03296"></a>03296 <span class="stringliteral"></span>
<a name="l03297"></a>03297 <span class="stringliteral">    if {[$txt edit modified]} {</span>
<a name="l03298"></a>03298 <span class="stringliteral"></span>
<a name="l03299"></a>03299 <span class="stringliteral">      # Get the tab path from the text path</span>
<a name="l03300"></a>03300 <span class="stringliteral">      set tab [winfo parent [winfo parent [winfo parent $txt]]]</span>
<a name="l03301"></a>03301 <span class="stringliteral"></span>
<a name="l03302"></a>03302 <span class="stringliteral">      # Get the file index for the given text widget</span>
<a name="l03303"></a>03303 <span class="stringliteral">      set file_index [lsearch -index $files_index(tab) $files $tab]</span>
<a name="l03304"></a>03304 <span class="stringliteral"></span>
<a name="l03305"></a>03305 <span class="stringliteral">      if {![catch { lindex $files $file_index $files_index(buffer) } rc] &amp;&amp; ($rc == 0)} {</span>
<a name="l03306"></a>03306 <span class="stringliteral"></span>
<a name="l03307"></a>03307 <span class="stringliteral">        # Save the modified state to the files list</span>
<a name="l03308"></a>03308 <span class="stringliteral">        catch { lset files $file_index $files_index(modified) 1 }</span>
<a name="l03309"></a>03309 <span class="stringliteral"></span>
<a name="l03310"></a>03310 <span class="stringliteral">        # Get the current notebook</span>
<a name="l03311"></a>03311 <span class="stringliteral">        set tb [lindex [pane_tb_index_from_tab $tab] 1]</span>
<a name="l03312"></a>03312 <span class="stringliteral"></span>
<a name="l03313"></a>03313 <span class="stringliteral">        # Change the look of the tab</span>
<a name="l03314"></a>03314 <span class="stringliteral">        if {[string index [set name [string trimleft [$tb tab $tab -text]]] 0] ne &quot;</span>*<span class="stringliteral">&quot;} {</span>
<a name="l03315"></a>03315 <span class="stringliteral">          $tb tab $tab -text &quot;</span> * $name<span class="stringliteral">&quot;</span>
<a name="l03316"></a>03316 <span class="stringliteral">          set_title</span>
<a name="l03317"></a>03317 <span class="stringliteral">        }</span>
<a name="l03318"></a>03318 <span class="stringliteral"></span>
<a name="l03319"></a>03319 <span class="stringliteral">      }</span>
<a name="l03320"></a>03320 <span class="stringliteral"></span>
<a name="l03321"></a>03321 <span class="stringliteral">      # Clear the cursor history</span>
<a name="l03322"></a>03322 <span class="stringliteral">      array unset cursor_hist $txt,*</span>
<a name="l03323"></a>03323 <span class="stringliteral"></span>
<a name="l03324"></a>03324 <span class="stringliteral">    }</span>
<a name="l03325"></a>03325 <span class="stringliteral"></span>
<a name="l03326"></a>03326 <span class="stringliteral">  }</span>
<a name="l03327"></a>03327 <span class="stringliteral"></span>
<a name="l03328"></a>03328 <span class="stringliteral">  ######################################################################</span>
<a name="l03329"></a>03329 <span class="stringliteral">  # Handles a change to the current text widget selection.</span>
<a name="l03330"></a>03330 <span class="stringliteral">  proc selection_changed {txt} {</span>
<a name="l03331"></a>03331 <span class="stringliteral"></span>
<a name="l03332"></a>03332 <span class="stringliteral">    # Get the first range of selected text</span>
<a name="l03333"></a>03333 <span class="stringliteral">    if {[set range [$txt tag nextrange sel 1.0]] ne &quot;</span><span class="stringliteral">&quot;} {</span>
<a name="l03334"></a>03334 <span class="stringliteral"></span>
<a name="l03335"></a>03335 <span class="stringliteral">      # Get the current search entry field</span>
<a name="l03336"></a>03336 <span class="stringliteral">      set sentry [current_search].e</span>
<a name="l03337"></a>03337 <span class="stringliteral"></span>
<a name="l03338"></a>03338 <span class="stringliteral">      # Set the search frame</span>
<a name="l03339"></a>03339 <span class="stringliteral">      $sentry delete 0 end</span>
<a name="l03340"></a>03340 <span class="stringliteral">      $sentry insert end [$txt get {*}$range]</span>
<a name="l03341"></a>03341 <span class="stringliteral"></span>
<a name="l03342"></a>03342 <span class="stringliteral">    }</span>
<a name="l03343"></a>03343 <span class="stringliteral"></span>
<a name="l03344"></a>03344 <span class="stringliteral">  }</span>
<a name="l03345"></a>03345 <span class="stringliteral"></span>
<a name="l03346"></a>03346 <span class="stringliteral">  ######################################################################</span>
<a name="l03347"></a>03347 <span class="stringliteral">  # Selects the given line in the text widget.</span>
<a name="l03348"></a>03348 <span class="stringliteral">  proc select_line {w y} {</span>
<a name="l03349"></a>03349 <span class="stringliteral"></span>
<a name="l03350"></a>03350 <span class="stringliteral">    variable line_sel_anchor</span>
<a name="l03351"></a>03351 <span class="stringliteral"></span>
<a name="l03352"></a>03352 <span class="stringliteral">    # Get the parent window</span>
<a name="l03353"></a>03353 <span class="stringliteral">    set txt [winfo parent $w]</span>
<a name="l03354"></a>03354 <span class="stringliteral"></span>
<a name="l03355"></a>03355 <span class="stringliteral">    # Get the current line from the line sidebar</span>
<a name="l03356"></a>03356 <span class="stringliteral">    set index [$txt index @0,$y]</span>
<a name="l03357"></a>03357 <span class="stringliteral"></span>
<a name="l03358"></a>03358 <span class="stringliteral">    # Select the corresponding line in the text widget</span>
<a name="l03359"></a>03359 <span class="stringliteral">    $txt tag remove sel 1.0 end</span>
<a name="l03360"></a>03360 <span class="stringliteral">    $txt tag add sel &quot;</span>$index linestart<span class="stringliteral">&quot; &quot;</span>$index lineend<span class="stringliteral">&quot;</span>
<a name="l03361"></a>03361 <span class="stringliteral"></span>
<a name="l03362"></a>03362 <span class="stringliteral">    # Save the selected line to the anchor</span>
<a name="l03363"></a>03363 <span class="stringliteral">    set line_sel_anchor($w) $index</span>
<a name="l03364"></a>03364 <span class="stringliteral"></span>
<a name="l03365"></a>03365 <span class="stringliteral">  }</span>
<a name="l03366"></a>03366 <span class="stringliteral"></span>
<a name="l03367"></a>03367 <span class="stringliteral">  ######################################################################</span>
<a name="l03368"></a>03368 <span class="stringliteral">  # Selects all lines between the anchored line and the current line,</span>
<a name="l03369"></a>03369 <span class="stringliteral">  # inclusive.</span>
<a name="l03370"></a>03370 <span class="stringliteral">  proc select_lines {w y} {</span>
<a name="l03371"></a>03371 <span class="stringliteral"></span>
<a name="l03372"></a>03372 <span class="stringliteral">    variable line_sel_anchor</span>
<a name="l03373"></a>03373 <span class="stringliteral"></span>
<a name="l03374"></a>03374 <span class="stringliteral">    # Get the parent window</span>
<a name="l03375"></a>03375 <span class="stringliteral">    set txt [winfo parent $w]</span>
<a name="l03376"></a>03376 <span class="stringliteral"></span>
<a name="l03377"></a>03377 <span class="stringliteral">    # Get the current line from the line sidebar</span>
<a name="l03378"></a>03378 <span class="stringliteral">    set index [$txt index @0,$y]</span>
<a name="l03379"></a>03379 <span class="stringliteral"></span>
<a name="l03380"></a>03380 <span class="stringliteral">    # Remove the current selection</span>
<a name="l03381"></a>03381 <span class="stringliteral">    $txt tag remove sel 1.0 end</span>
<a name="l03382"></a>03382 <span class="stringliteral"></span>
<a name="l03383"></a>03383 <span class="stringliteral">    # If the anchor has not been set, set it now</span>
<a name="l03384"></a>03384 <span class="stringliteral">    if {![info exists line_sel_anchor($w)]} {</span>
<a name="l03385"></a>03385 <span class="stringliteral">      set line_sel_anchor($w) $index</span>
<a name="l03386"></a>03386 <span class="stringliteral">    }</span>
<a name="l03387"></a>03387 <span class="stringliteral"></span>
<a name="l03388"></a>03388 <span class="stringliteral">    # Add the selection between the anchor and this line, inclusive</span>
<a name="l03389"></a>03389 <span class="stringliteral">    if {[$txt compare $index &lt; $line_sel_anchor($w)]} {</span>
<a name="l03390"></a>03390 <span class="stringliteral">      $txt tag add sel &quot;</span>$index linestart<span class="stringliteral">&quot; &quot;</span>$line_sel_anchor($w) lineend&quot;
<a name="l03391"></a>03391     } else {
<a name="l03392"></a>03392       $txt tag add sel <span class="stringliteral">&quot;$line_sel_anchor($w) linestart&quot;</span> <span class="stringliteral">&quot;$index lineend&quot;</span>
<a name="l03393"></a>03393     }
<a name="l03394"></a>03394 
<a name="l03395"></a>03395   }
<a name="l03396"></a>03396 
<a name="l03397"></a>03397 <span class="preprocessor">  ######################################################################</span>
<a name="l03398"></a>03398 <span class="preprocessor"></span><span class="preprocessor">  # Returns the main text widget from the given tab.</span>
<a name="l03399"></a>03399 <span class="preprocessor"></span>  proc get_txt_from_tab {tab} {
<a name="l03400"></a>03400 
<a name="l03401"></a>03401     <span class="keywordflow">return</span> <span class="stringliteral">&quot;$tab.pw.tf.txt&quot;</span>
<a name="l03402"></a>03402 
<a name="l03403"></a>03403   }
<a name="l03404"></a>03404 
<a name="l03405"></a>03405 <span class="preprocessor">  ######################################################################</span>
<a name="l03406"></a>03406 <span class="preprocessor"></span><span class="preprocessor">  # Returns the secondary text widget from the given tab.</span>
<a name="l03407"></a>03407 <span class="preprocessor"></span>  proc get_txt2_from_tab {tab} {
<a name="l03408"></a>03408 
<a name="l03409"></a>03409     <span class="keywordflow">return</span> <span class="stringliteral">&quot;$tab.pw.tf2.txt&quot;</span>
<a name="l03410"></a>03410 
<a name="l03411"></a>03411   }
<a name="l03412"></a>03412 
<a name="l03413"></a>03413 <span class="preprocessor">  ######################################################################</span>
<a name="l03414"></a>03414 <span class="preprocessor"></span><span class="preprocessor">  # Make the specified tab the current tab.</span>
<a name="l03415"></a>03415 <span class="preprocessor"></span>  proc set_current_tab {tab {skip_focus 0} {skip_check 0}} {
<a name="l03416"></a>03416 
<a name="l03417"></a>03417     variable widgets
<a name="l03418"></a>03418     variable pw_current
<a name="l03419"></a>03419     variable tab_current
<a name="l03420"></a>03420 
<a name="l03421"></a>03421 <span class="preprocessor">    # Set the current pane and get the notebook ID</span>
<a name="l03422"></a>03422 <span class="preprocessor"></span>    lassign [pane_tb_index_from_tab $tab] pw_current tb
<a name="l03423"></a>03423 
<a name="l03424"></a>03424 <span class="preprocessor">    # We only need to refresh if the tab was changed.</span>
<a name="l03425"></a>03425 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {![info exists tab_current($pw_current)] || ($tab_current($pw_current) ne $tab)} {
<a name="l03426"></a>03426 
<a name="l03427"></a>03427 <span class="preprocessor">      # Set the current tab</span>
<a name="l03428"></a>03428 <span class="preprocessor"></span>      $tb select $tab
<a name="l03429"></a>03429 
<a name="l03430"></a>03430 <span class="preprocessor">      # Set the current tab for the given notebook</span>
<a name="l03431"></a>03431 <span class="preprocessor"></span>      <span class="keyword">set</span> tab_current($pw_current) $tab
<a name="l03432"></a>03432 
<a name="l03433"></a>03433       <span class="preprocessor"># Set the current tab</span>
<a name="l03434"></a>03434 <span class="preprocessor"></span>      $tb select $tab
<a name="l03435"></a>03435 
<a name="l03436"></a>03436       <span class="keyword">set</span> tf [winfo parent [winfo parent $tb]].tf
<a name="l03437"></a>03437 
<a name="l03438"></a>03438       <span class="keywordflow">if</span> {[<span class="keyword">set</span> slave [pack slaves $tf]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l03439"></a>03439         pack forget $slave
<a name="l03440"></a>03440       }
<a name="l03441"></a>03441       pack [$tb select] -in $tf -fill both -expand yes
<a name="l03442"></a>03442 
<a name="l03443"></a>03443 <span class="preprocessor">      # Update the preferences</span>
<a name="l03444"></a>03444 <span class="preprocessor"></span>      preferences::update_prefs
<a name="l03445"></a>03445 
<a name="l03446"></a>03446     }
<a name="l03447"></a>03447 
<a name="l03448"></a>03448 <span class="preprocessor">    # Set the text widget</span>
<a name="l03449"></a>03449 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [last_txt_focus {} $tab]
<a name="l03450"></a>03450 
<a name="l03451"></a>03451 <span class="preprocessor">    # Set the line and row information</span>
<a name="l03452"></a>03452 <span class="preprocessor"></span>    update_position $txt
<a name="l03453"></a>03453 
<a name="l03454"></a>03454 <span class="preprocessor">    # Set the syntax menubutton to the current language</span>
<a name="l03455"></a>03455 <span class="preprocessor"></span>    syntax::update_menubutton $widgets(info_syntax)
<a name="l03456"></a>03456 
<a name="l03457"></a>03457     <span class="preprocessor"># Update the indentation indicator</span>
<a name="l03458"></a>03458 <span class="preprocessor"></span>    update_auto_indent $txt
<a name="l03459"></a>03459 
<a name="l03460"></a>03460 <span class="preprocessor">    # Set the application title bar</span>
<a name="l03461"></a>03461 <span class="preprocessor"></span>    set_title
<a name="l03462"></a>03462 
<a name="l03463"></a>03463 <span class="preprocessor">    # Check to see if the file has changed</span>
<a name="l03464"></a>03464 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {!$skip_check} {
<a name="l03465"></a>03465       <span class="keywordflow">catch</span> { check_file [current_file] }
<a name="l03466"></a>03466     }
<a name="l03467"></a>03467 
<a name="l03468"></a>03468 <span class="preprocessor">    # Finally, set the focus to the text widget</span>
<a name="l03469"></a>03469 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {([focus] ne <span class="stringliteral">&quot;$txt.t&quot;</span>) &amp;&amp; !$skip_focus} {
<a name="l03470"></a>03470       set_txt_focus $txt
<a name="l03471"></a>03471     }
<a name="l03472"></a>03472 
<a name="l03473"></a>03473   }
<a name="l03474"></a>03474 
<a name="l03475"></a>03475 <span class="preprocessor">  ######################################################################</span>
<a name="l03476"></a>03476 <span class="preprocessor"></span><span class="preprocessor">  # Sets the current tab information based on the given notebook.</span>
<a name="l03477"></a>03477 <span class="preprocessor"></span>  proc set_current_tab_from_tb {tb {frm <span class="stringliteral">&quot;&quot;</span>}} {
<a name="l03478"></a>03478 
<a name="l03479"></a>03479 <span class="preprocessor">    # Get the pane index</span>
<a name="l03480"></a>03480 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> tab [$tb select]] eq <span class="stringliteral">&quot;&quot;</span>} {
<a name="l03481"></a>03481       <span class="keywordflow">return</span>
<a name="l03482"></a>03482     }
<a name="l03483"></a>03483 
<a name="l03484"></a>03484 <span class="preprocessor">    # Set the current tab</span>
<a name="l03485"></a>03485 <span class="preprocessor"></span>    set_current_tab $tab
<a name="l03486"></a>03486 
<a name="l03487"></a>03487   }
<a name="l03488"></a>03488 
<a name="l03489"></a>03489 <span class="preprocessor">  ######################################################################</span>
<a name="l03490"></a>03490 <span class="preprocessor"></span><span class="preprocessor">  # Sets the current tab information based on the given text widget.</span>
<a name="l03491"></a>03491 <span class="preprocessor"></span>  proc set_current_tab_from_txt {txt} {
<a name="l03492"></a>03492 
<a name="l03493"></a>03493     variable pw_current
<a name="l03494"></a>03494 
<a name="l03495"></a>03495     <span class="keywordflow">if</span> {[winfo ismapped $txt]} {
<a name="l03496"></a>03496 
<a name="l03497"></a>03497 <span class="preprocessor">      # Get the tab</span>
<a name="l03498"></a>03498 <span class="preprocessor"></span>      <span class="keyword">set</span> tab [winfo parent [winfo parent [winfo parent [winfo parent $txt]]]]
<a name="l03499"></a>03499 
<a name="l03500"></a>03500 <span class="preprocessor">      # Get the current tab</span>
<a name="l03501"></a>03501 <span class="preprocessor"></span>      set_current_tab $tab 1
<a name="l03502"></a>03502 
<a name="l03503"></a>03503 <span class="preprocessor">      # Handle any on_focusin events</span>
<a name="l03504"></a>03504 <span class="preprocessor"></span>      plugins::handle_on_focusin $tab
<a name="l03505"></a>03505 
<a name="l03506"></a>03506     }
<a name="l03507"></a>03507 
<a name="l03508"></a>03508   }
<a name="l03509"></a>03509 
<a name="l03510"></a>03510 <span class="preprocessor">  ######################################################################</span>
<a name="l03511"></a>03511 <span class="preprocessor"></span><span class="preprocessor">  # Sets the current tab information based on the given filename.</span>
<a name="l03512"></a>03512 <span class="preprocessor"></span>  proc set_current_tab_from_fname {fname} {
<a name="l03513"></a>03513 
<a name="l03514"></a>03514     variable files
<a name="l03515"></a>03515     variable files_index
<a name="l03516"></a>03516 
<a name="l03517"></a>03517     <span class="keywordflow">if</span> {[<span class="keyword">set</span> index [lsearch -index $files_index(fname) $files $fname]] != -1} {
<a name="l03518"></a>03518       set_current_tab [lindex $files $index $files_index(tab)]
<a name="l03519"></a>03519     }
<a name="l03520"></a>03520 
<a name="l03521"></a>03521   }
<a name="l03522"></a>03522 
<a name="l03523"></a>03523 <span class="preprocessor">  ######################################################################</span>
<a name="l03524"></a>03524 <span class="preprocessor"></span><span class="preprocessor">  # Returns the pathname to the current notebook.</span>
<a name="l03525"></a>03525 <span class="preprocessor"></span>  proc current_tabbar {} {
<a name="l03526"></a>03526 
<a name="l03527"></a>03527     variable widgets
<a name="l03528"></a>03528     variable pw_current
<a name="l03529"></a>03529 
<a name="l03530"></a>03530     <span class="keywordflow">if</span> {[llength [$widgets(nb_pw) panes]] == 0} {
<a name="l03531"></a>03531       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>
<a name="l03532"></a>03532     } <span class="keywordflow">else</span> {
<a name="l03533"></a>03533       <span class="keywordflow">return</span> <span class="stringliteral">&quot;[lindex [$widgets(nb_pw) panes] $pw_current].tbf.tb&quot;</span>
<a name="l03534"></a>03534     }
<a name="l03535"></a>03535 
<a name="l03536"></a>03536   }
<a name="l03537"></a>03537 
<a name="l03538"></a>03538 <span class="preprocessor">  ######################################################################</span>
<a name="l03539"></a>03539 <span class="preprocessor"></span><span class="preprocessor">  # Returns the current text widget pathname.</span>
<a name="l03540"></a>03540 <span class="preprocessor"></span>  proc current_txt {tid} {
<a name="l03541"></a>03541 
<a name="l03542"></a>03542     variable pw_current
<a name="l03543"></a>03543     variable tab_current
<a name="l03544"></a>03544     variable txt_current
<a name="l03545"></a>03545 
<a name="l03546"></a>03546     <span class="keywordflow">if</span> {$tid eq <span class="stringliteral">&quot;&quot;</span>} {
<a name="l03547"></a>03547       <span class="keywordflow">if</span> {![info exists tab_current($pw_current)]} {
<a name="l03548"></a>03548         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>
<a name="l03549"></a>03549       } elseif {![info exists txt_current($tab_current($pw_current))]} {
<a name="l03550"></a>03550         <span class="keywordflow">return</span> [get_txt_from_tab $tab_current($pw_current)]
<a name="l03551"></a>03551       } <span class="keywordflow">else</span> {
<a name="l03552"></a>03552         <span class="keywordflow">return</span> $txt_current($tab_current($pw_current))
<a name="l03553"></a>03553       }
<a name="l03554"></a>03554     } <span class="keywordflow">else</span> {
<a name="l03555"></a>03555       <span class="keywordflow">return</span> $tid
<a name="l03556"></a>03556     }
<a name="l03557"></a>03557 
<a name="l03558"></a>03558   }
<a name="l03559"></a>03559 
<a name="l03560"></a>03560 <span class="preprocessor">  ######################################################################</span>
<a name="l03561"></a>03561 <span class="preprocessor"></span><span class="preprocessor">  # Returns the current search entry pathname.</span>
<a name="l03562"></a>03562 <span class="preprocessor"></span>  proc current_search {} {
<a name="l03563"></a>03563 
<a name="l03564"></a>03564     variable pw_current
<a name="l03565"></a>03565     variable tab_current
<a name="l03566"></a>03566 
<a name="l03567"></a>03567     <span class="keywordflow">return</span> <span class="stringliteral">&quot;$tab_current($pw_current).sf&quot;</span>
<a name="l03568"></a>03568 
<a name="l03569"></a>03569   }
<a name="l03570"></a>03570 
<a name="l03571"></a>03571 <span class="preprocessor">  ######################################################################</span>
<a name="l03572"></a>03572 <span class="preprocessor"></span><span class="preprocessor">  # Gets the current index into the file list based on the current pane</span>
<a name="l03573"></a>03573 <span class="preprocessor"></span><span class="preprocessor">  # and notebook tab.</span>
<a name="l03574"></a>03574 <span class="preprocessor"></span>  proc current_file {} {
<a name="l03575"></a>03575 
<a name="l03576"></a>03576     variable pw_current
<a name="l03577"></a>03577     variable tab_current
<a name="l03578"></a>03578 
<a name="l03579"></a>03579 <span class="preprocessor">    # Returns the file index</span>
<a name="l03580"></a>03580 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {![info exists tab_current($pw_current)]} {
<a name="l03581"></a>03581       <span class="keywordflow">return</span> -1
<a name="l03582"></a>03582     } <span class="keywordflow">else</span> {
<a name="l03583"></a>03583       <span class="keywordflow">return</span> [get_file_index $tab_current($pw_current)]
<a name="l03584"></a>03584     }
<a name="l03585"></a>03585 
<a name="l03586"></a>03586   }
<a name="l03587"></a>03587 
<a name="l03588"></a>03588 <span class="preprocessor">  ######################################################################</span>
<a name="l03589"></a>03589 <span class="preprocessor"></span><span class="preprocessor">  # Returns the index of the file list that pertains to the given file.</span>
<a name="l03590"></a>03590 <span class="preprocessor"></span>  proc get_file_index {tab} {
<a name="l03591"></a>03591 
<a name="l03592"></a>03592     variable files
<a name="l03593"></a>03593     variable files_index
<a name="l03594"></a>03594 
<a name="l03595"></a>03595 <span class="preprocessor">    # Look for the file index</span>
<a name="l03596"></a>03596 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> index [lsearch -index $files_index(tab) $files $tab]] != -1} {
<a name="l03597"></a>03597       <span class="keywordflow">return</span> $index
<a name="l03598"></a>03598     }
<a name="l03599"></a>03599 
<a name="l03600"></a>03600 <span class="preprocessor">    # Throw an exception if we couldn&#39;t find the current file</span>
<a name="l03601"></a>03601 <span class="preprocessor"></span><span class="preprocessor">    # (this is considered an unhittable case)</span>
<a name="l03602"></a>03602 <span class="preprocessor"></span>    <span class="keywordflow">return</span> -code error [msgcat::mc <span class="stringliteral">&quot;Unable to find current file (tab: %s)&quot;</span> $tab]
<a name="l03603"></a>03603 
<a name="l03604"></a>03604   }
<a name="l03605"></a>03605 
<a name="l03606"></a>03606 <span class="preprocessor">  ######################################################################</span>
<a name="l03607"></a>03607 <span class="preprocessor"></span><span class="preprocessor">  # Updates the current position information in the information bar based</span>
<a name="l03608"></a>03608 <span class="preprocessor"></span><span class="preprocessor">  # on the current location of the insertion cursor.</span>
<a name="l03609"></a>03609 <span class="preprocessor"></span>  proc update_position {txt} {
<a name="l03610"></a>03610 
<a name="l03611"></a>03611     variable widgets
<a name="l03612"></a>03612 
<a name="l03613"></a>03613 <span class="preprocessor">    # Get the current position of the insertion cursor</span>
<a name="l03614"></a>03614 <span class="preprocessor"></span>    lassign [split [$txt index insert] .] line column
<a name="l03615"></a>03615 
<a name="l03616"></a>03616 <span class="preprocessor">    # Update the information widgets</span>
<a name="l03617"></a>03617 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> vim_mode [vim::get_mode $txt]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l03618"></a>03618       $widgets(info_state) configure -text [msgcat::mc &quot;%s, Line: %d, Column: %d&quot; $vim_mode $line [expr $column + 1]]
<a name="l03619"></a>03619     } else {
<a name="l03620"></a>03620       $widgets(info_state) configure -text [msgcat::mc &quot;Line: %d, Column: %d&quot; $line [expr $column + 1]]
<a name="l03621"></a>03621     }
<a name="l03622"></a>03622 
<a name="l03623"></a>03623   }
<a name="l03624"></a>03624 
<a name="l03625"></a>03625   <span class="preprocessor">######################################################################</span>
<a name="l03626"></a>03626 <span class="preprocessor"></span><span class="preprocessor">  # Display the file count information in the status bar.</span>
<a name="l03627"></a>03627 <span class="preprocessor"></span>  proc display_file_counts {txt} {
<a name="l03628"></a>03628 
<a name="l03629"></a>03629     variable widgets
<a name="l03630"></a>03630 
<a name="l03631"></a>03631 <span class="preprocessor">    # Get the current position of the insertion cursor</span>
<a name="l03632"></a>03632 <span class="preprocessor"></span>    lassign [split [$txt index insert] .] line column
<a name="l03633"></a>03633 
<a name="l03634"></a>03634 <span class="preprocessor">    # Get the total line count</span>
<a name="l03635"></a>03635 <span class="preprocessor"></span>    <span class="keyword">set</span> lines [$txt count -lines 1.0 end]
<a name="l03636"></a>03636 
<a name="l03637"></a>03637 <span class="preprocessor">    # Get the total character count</span>
<a name="l03638"></a>03638 <span class="preprocessor"></span>    <span class="keyword">set</span> chars [$txt count -chars 1.0 end]
<a name="l03639"></a>03639 
<a name="l03640"></a>03640 <span class="preprocessor">    # Update the information widget</span>
<a name="l03641"></a>03641 <span class="preprocessor"></span>    set_info_message [msgcat::mc <span class="stringliteral">&quot;Total Lines: %d, Total Characters: %d&quot;</span> $lines $chars]
<a name="l03642"></a>03642 
<a name="l03643"></a>03643   }
<a name="l03644"></a>03644 
<a name="l03645"></a>03645 <span class="preprocessor">  ######################################################################</span>
<a name="l03646"></a>03646 <span class="preprocessor"></span><span class="preprocessor">  # Returns the list of procs in the current text widget.  Uses the _procs</span>
<a name="l03647"></a>03647 <span class="preprocessor"></span><span class="preprocessor">  # highlighting to tag to quickly find procs in the widget.</span>
<a name="l03648"></a>03648 <span class="preprocessor"></span>  proc get_symbol_list {tid} {
<a name="l03649"></a>03649 
<a name="l03650"></a>03650     variable lengths
<a name="l03651"></a>03651 
<a name="l03652"></a>03652 <span class="preprocessor">    # Get current text widget</span>
<a name="l03653"></a>03653 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l03654"></a>03654 
<a name="l03655"></a>03655     <span class="keyword">set</span> proclist [list]
<a name="l03656"></a>03656     <span class="keywordflow">foreach</span> tag [$txt tag names] {
<a name="l03657"></a>03657       <span class="keywordflow">if</span> {[<span class="keywordtype">string</span> range $tag 0 8] eq <span class="stringliteral">&quot;_symbols:&quot;</span>} {
<a name="l03658"></a>03658         <span class="keywordflow">if</span> {[<span class="keyword">set</span> type [<span class="keywordtype">string</span> range $tag 9 end]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l03659"></a>03659           append type <span class="stringliteral">&quot;: &quot;</span>
<a name="l03660"></a>03660         }
<a name="l03661"></a>03661         <span class="keywordflow">foreach</span> {startpos endpos} [$txt tag ranges $tag] {
<a name="l03662"></a>03662           lappend proclist <span class="stringliteral">&quot;$type[$txt get $startpos $endpos]&quot;</span> $startpos
<a name="l03663"></a>03663         }
<a name="l03664"></a>03664       }
<a name="l03665"></a>03665     }
<a name="l03666"></a>03666 
<a name="l03667"></a>03667     <span class="keywordflow">return</span> $proclist
<a name="l03668"></a>03668 
<a name="l03669"></a>03669   }
<a name="l03670"></a>03670 
<a name="l03671"></a>03671 <span class="preprocessor">  ######################################################################</span>
<a name="l03672"></a>03672 <span class="preprocessor"></span><span class="preprocessor">  # Create a marker at the current insertion cursor line of the current</span>
<a name="l03673"></a>03673 <span class="preprocessor"></span><span class="preprocessor">  # editor.</span>
<a name="l03674"></a>03674 <span class="preprocessor"></span>  proc create_current_marker {tid} {
<a name="l03675"></a>03675     
<a name="l03676"></a>03676 <span class="preprocessor">    # Get the current text widget</span>
<a name="l03677"></a>03677 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l03678"></a>03678     
<a name="l03679"></a>03679 <span class="preprocessor">    # Get the current line</span>
<a name="l03680"></a>03680 <span class="preprocessor"></span>    <span class="keyword">set</span> line [lindex [split [$txt index insert] .] 0]
<a name="l03681"></a>03681     
<a name="l03682"></a>03682 <span class="preprocessor">    # Add the marker at the current line</span>
<a name="l03683"></a>03683 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> tag [ctext::linemapSetMark $txt $line]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l03684"></a>03684       <span class="keywordflow">if</span> {![markers::add $txt $tag]} {
<a name="l03685"></a>03685         ctext::linemapClearMark $txt $line
<a name="l03686"></a>03686       }
<a name="l03687"></a>03687     }
<a name="l03688"></a>03688     
<a name="l03689"></a>03689   }
<a name="l03690"></a>03690   
<a name="l03691"></a>03691 <span class="preprocessor">  ######################################################################</span>
<a name="l03692"></a>03692 <span class="preprocessor"></span><span class="preprocessor">  # Removes all markers placed at the current line.</span>
<a name="l03693"></a>03693 <span class="preprocessor"></span>  proc remove_current_marker {tid} {
<a name="l03694"></a>03694     
<a name="l03695"></a>03695 <span class="preprocessor">    # Get the current text widget</span>
<a name="l03696"></a>03696 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l03697"></a>03697     
<a name="l03698"></a>03698 <span class="preprocessor">    # Get the current line number</span>
<a name="l03699"></a>03699 <span class="preprocessor"></span>    <span class="keyword">set</span> line [lindex [split [$txt index insert] .] 0]
<a name="l03700"></a>03700     
<a name="l03701"></a>03701 <span class="preprocessor">    # Remove all markers at the current line</span>
<a name="l03702"></a>03702 <span class="preprocessor"></span>    markers::delete_by_line $txt $line
<a name="l03703"></a>03703     ctext::linemapClearMark $txt $line
<a name="l03704"></a>03704     
<a name="l03705"></a>03705   }
<a name="l03706"></a>03706   
<a name="l03707"></a>03707 <span class="preprocessor">  ######################################################################</span>
<a name="l03708"></a>03708 <span class="preprocessor"></span><span class="preprocessor">  # Removes all of the markers from the current editor.</span>
<a name="l03709"></a>03709 <span class="preprocessor"></span>  proc remove_all_markers {tid} {
<a name="l03710"></a>03710     
<a name="l03711"></a>03711 <span class="preprocessor">    # Get the current text widget</span>
<a name="l03712"></a>03712 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l03713"></a>03713     
<a name="l03714"></a>03714     <span class="keywordflow">foreach</span> name [markers::get_all_names $txt] {
<a name="l03715"></a>03715       <span class="keyword">set</span> line [lindex [split [markers::get_index $txt $name] .] 0]
<a name="l03716"></a>03716       markers::delete_by_name $txt $name
<a name="l03717"></a>03717       ctext::linemapClearMark $txt $line
<a name="l03718"></a>03718     }
<a name="l03719"></a>03719     
<a name="l03720"></a>03720   }
<a name="l03721"></a>03721   
<a name="l03722"></a>03722 <span class="preprocessor">  ######################################################################</span>
<a name="l03723"></a>03723 <span class="preprocessor"></span><span class="preprocessor">  # Returns the list of markers in the current text widget.</span>
<a name="l03724"></a>03724 <span class="preprocessor"></span>  proc get_marker_list {tid} {
<a name="l03725"></a>03725 
<a name="l03726"></a>03726 <span class="preprocessor">    # Get the current text widget</span>
<a name="l03727"></a>03727 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l03728"></a>03728 
<a name="l03729"></a>03729 <span class="preprocessor">    # Create a list of marker names and index</span>
<a name="l03730"></a>03730 <span class="preprocessor"></span>    <span class="keyword">set</span> markers [list]
<a name="l03731"></a>03731     <span class="keywordflow">foreach</span> name [markers::get_all_names $txt] {
<a name="l03732"></a>03732       lappend markers $name [markers::get_index $txt $name]
<a name="l03733"></a>03733     }
<a name="l03734"></a>03734 
<a name="l03735"></a>03735     <span class="keywordflow">return</span> $markers
<a name="l03736"></a>03736 
<a name="l03737"></a>03737   }
<a name="l03738"></a>03738 
<a name="l03739"></a>03739 <span class="preprocessor">  ######################################################################</span>
<a name="l03740"></a>03740 <span class="preprocessor"></span><span class="preprocessor">  # Jump to the given position.</span>
<a name="l03741"></a>03741 <span class="preprocessor"></span>  proc jump_to {tid pos} {
<a name="l03742"></a>03742 
<a name="l03743"></a>03743 <span class="preprocessor">    # Get the current text widget</span>
<a name="l03744"></a>03744 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l03745"></a>03745 
<a name="l03746"></a>03746 <span class="preprocessor">    # Set the current insertion marker and make it viewable.</span>
<a name="l03747"></a>03747 <span class="preprocessor"></span>    $txt mark <span class="keyword">set</span> insert $pos
<a name="l03748"></a>03748     $txt see $pos
<a name="l03749"></a>03749 
<a name="l03750"></a>03750   }
<a name="l03751"></a>03751 
<a name="l03752"></a>03752 <span class="preprocessor">  ######################################################################</span>
<a name="l03753"></a>03753 <span class="preprocessor"></span><span class="preprocessor">  # Finds the matching character for the one at the current insertion</span>
<a name="l03754"></a>03754 <span class="preprocessor"></span><span class="preprocessor">  # marker.</span>
<a name="l03755"></a>03755 <span class="preprocessor"></span>  proc show_match_pair {tid} {
<a name="l03756"></a>03756 
<a name="l03757"></a>03757 <span class="preprocessor">    # Get the current widget</span>
<a name="l03758"></a>03758 <span class="preprocessor"></span>    <span class="keyword">set</span> txt [current_txt $tid]
<a name="l03759"></a>03759 
<a name="l03760"></a>03760 <span class="preprocessor">    # If the current character is a matchable character, change the</span>
<a name="l03761"></a>03761 <span class="preprocessor"></span><span class="preprocessor">    # insertion cursor to the matching character.</span>
<a name="l03762"></a>03762 <span class="preprocessor"></span>    <span class="keywordflow">switch</span> -- [$txt <span class="keyword">get</span> insert] {
<a name="l03763"></a>03763       <span class="stringliteral">&quot;\{&quot;</span> { <span class="keyword">set</span> index [find_match_brace $txt <span class="stringliteral">&quot;\\\}&quot;</span> <span class="stringliteral">&quot;\\\{&quot;</span> -forwards] }
<a name="l03764"></a>03764       <span class="stringliteral">&quot;\}&quot;</span> { <span class="keyword">set</span> index [find_match_brace $txt <span class="stringliteral">&quot;\\\{&quot;</span> <span class="stringliteral">&quot;\\\}&quot;</span> -backwards] }
<a name="l03765"></a>03765       <span class="stringliteral">&quot;\[&quot;</span> { <span class="keyword">set</span> index [find_match_brace $txt <span class="stringliteral">&quot;\\\]&quot;</span> <span class="stringliteral">&quot;\\\[&quot;</span> -forwards] }
<a name="l03766"></a>03766       <span class="stringliteral">&quot;\]&quot;</span> { <span class="keyword">set</span> index [find_match_brace $txt <span class="stringliteral">&quot;\\\[&quot;</span> <span class="stringliteral">&quot;\\\]&quot;</span> -backwards] }
<a name="l03767"></a>03767       <span class="stringliteral">&quot;\(&quot;</span> { <span class="keyword">set</span> index [find_match_brace $txt <span class="stringliteral">&quot;\\\)&quot;</span> <span class="stringliteral">&quot;\\\(&quot;</span> -forwards] }
<a name="l03768"></a>03768       <span class="stringliteral">&quot;\)&quot;</span> { <span class="keyword">set</span> index [find_match_brace $txt <span class="stringliteral">&quot;\\\(&quot;</span> <span class="stringliteral">&quot;\\\)&quot;</span> -backwards] }
<a name="l03769"></a>03769       <span class="stringliteral">&quot;&lt;&quot;</span> { <span class="keyword">set</span> index [find_match_brace $txt <span class="stringliteral">&quot;\\&gt;&quot;</span> <span class="stringliteral">&quot;\\&lt;&quot;</span> -forwards] }
<a name="l03770"></a>03770       <span class="stringliteral">&quot;&gt;&quot;</span> { <span class="keyword">set</span> index [find_match_brace $txt <span class="stringliteral">&quot;\\&lt;&quot;</span> <span class="stringliteral">&quot;\\&gt;&quot;</span> -backwards] }
<a name="l03771"></a>03771       <span class="stringliteral">&quot;\&quot;&quot;</span> { <span class="keyword">set</span> index [find_match_quote $txt] }
<a name="l03772"></a>03772     }
<a name="l03773"></a>03773 
<a name="l03774"></a>03774 <span class="preprocessor">    # Change the insertion cursor to the matching character</span>
<a name="l03775"></a>03775 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$index != -1} {
<a name="l03776"></a>03776       $txt mark <span class="keyword">set</span> insert $index
<a name="l03777"></a>03777       $txt see insert
<a name="l03778"></a>03778     }
<a name="l03779"></a>03779 
<a name="l03780"></a>03780   }
<a name="l03781"></a>03781 
<a name="l03782"></a>03782 <span class="preprocessor">  ######################################################################</span>
<a name="l03783"></a>03783 <span class="preprocessor"></span><span class="preprocessor">  # Finds the matching bracket type and returns it&#39;s index if found;</span>
<a name="l03784"></a>03784 <span class="preprocessor"></span><span class="preprocessor">  # otherwise, returns -1.</span>
<a name="l03785"></a>03785 <span class="preprocessor"></span>  proc find_match_brace {txt str1 str2 dir} {
<a name="l03786"></a>03786 
<a name="l03787"></a>03787     <span class="keywordflow">if</span> {[ctext::isEscaped $txt insert]} {
<a name="l03788"></a>03788       <span class="keywordflow">return</span> -1
<a name="l03789"></a>03789     }
<a name="l03790"></a>03790 
<a name="l03791"></a>03791     <span class="keyword">set</span> search_re <span class="stringliteral">&quot;[set str1]|[set str2]&quot;</span>
<a name="l03792"></a>03792     <span class="keyword">set</span> count     1
<a name="l03793"></a>03793     <span class="keyword">set</span> pos       [$txt index [expr {($dir eq <span class="stringliteral">&quot;-forwards&quot;</span>) ? <span class="stringliteral">&quot;insert+1c&quot;</span> : <span class="stringliteral">&quot;insert&quot;</span>}]]
<a name="l03794"></a>03794 
<a name="l03795"></a>03795     # Calculate the endpos
<a name="l03796"></a>03796     <span class="keywordflow">if</span> {[<span class="keyword">set</span> incomstr [ctext::inCommentString $txt $pos srange]]} {
<a name="l03797"></a>03797       <span class="keywordflow">if</span> {$dir eq <span class="stringliteral">&quot;-forwards&quot;</span>} {
<a name="l03798"></a>03798         <span class="keyword">set</span> endpos [lindex $srange 1]
<a name="l03799"></a>03799       } <span class="keywordflow">else</span> {
<a name="l03800"></a>03800         <span class="keyword">set</span> endpos [lindex $srange 0]
<a name="l03801"></a>03801       }
<a name="l03802"></a>03802     } <span class="keywordflow">else</span> {
<a name="l03803"></a>03803       <span class="keywordflow">if</span> {$dir eq <span class="stringliteral">&quot;-forwards&quot;</span>} {
<a name="l03804"></a>03804         <span class="keyword">set</span> endpos <span class="stringliteral">&quot;end&quot;</span>
<a name="l03805"></a>03805       } <span class="keywordflow">else</span> {
<a name="l03806"></a>03806         <span class="keyword">set</span> endpos <span class="stringliteral">&quot;1.0&quot;</span>
<a name="l03807"></a>03807       }
<a name="l03808"></a>03808     }
<a name="l03809"></a>03809 
<a name="l03810"></a>03810     <span class="keywordflow">while</span> {1} {
<a name="l03811"></a>03811 
<a name="l03812"></a>03812       <span class="keywordflow">if</span> {[<span class="keyword">set</span> found [$txt search $dir -regexp -- $search_re $pos $endpos]] eq <span class="stringliteral">&quot;&quot;</span>} {
<a name="l03813"></a>03813         <span class="keywordflow">return</span> -1
<a name="l03814"></a>03814       }
<a name="l03815"></a>03815 
<a name="l03816"></a>03816       <span class="keyword">set</span> <span class="keywordtype">char</span> [$txt <span class="keyword">get</span> $found]
<a name="l03817"></a>03817       <span class="keywordflow">if</span> {$dir eq <span class="stringliteral">&quot;-forwards&quot;</span>} {
<a name="l03818"></a>03818         <span class="keyword">set</span> pos <span class="stringliteral">&quot;$found+1c&quot;</span>
<a name="l03819"></a>03819       } <span class="keywordflow">else</span> {
<a name="l03820"></a>03820         <span class="keyword">set</span> pos $found
<a name="l03821"></a>03821       }
<a name="l03822"></a>03822 
<a name="l03823"></a>03823       <span class="keywordflow">if</span> {[ctext::isEscaped $txt $found] || (!$incomstr &amp;&amp; [ctext::inCommentString $txt $found])} {
<a name="l03824"></a>03824         <span class="keywordflow">continue</span>
<a name="l03825"></a>03825       } elseif {[<span class="keywordtype">string</span> equal $char [subst $str2]]} {
<a name="l03826"></a>03826         incr count
<a name="l03827"></a>03827       } elseif {[<span class="keywordtype">string</span> equal $char [subst $str1]]} {
<a name="l03828"></a>03828         incr count -1
<a name="l03829"></a>03829         <span class="keywordflow">if</span> {$count == 0} {
<a name="l03830"></a>03830           <span class="keywordflow">return</span> $found
<a name="l03831"></a>03831         }
<a name="l03832"></a>03832       }
<a name="l03833"></a>03833 
<a name="l03834"></a>03834     }
<a name="l03835"></a>03835 
<a name="l03836"></a>03836   }
<a name="l03837"></a>03837 
<a name="l03838"></a>03838 <span class="preprocessor">  ######################################################################</span>
<a name="l03839"></a>03839 <span class="preprocessor"></span><span class="preprocessor">  # Returns the index of the matching quotation mark; otherwise, if one</span>
<a name="l03840"></a>03840 <span class="preprocessor"></span><span class="preprocessor">  # is not found, returns -1.</span>
<a name="l03841"></a>03841 <span class="preprocessor"></span>  proc find_match_quote {txt} {
<a name="l03842"></a>03842 
<a name="l03843"></a>03843     <span class="keyword">set</span> end_quote  [$txt index insert]
<a name="l03844"></a>03844     <span class="keyword">set</span> last_found <span class="stringliteral">&quot;&quot;</span>
<a name="l03845"></a>03845 
<a name="l03846"></a>03846     <span class="keywordflow">if</span> {[ctext::isEscaped $txt $end_quote]} {
<a name="l03847"></a>03847       <span class="keywordflow">return</span>
<a name="l03848"></a>03848     }
<a name="l03849"></a>03849 
<a name="l03850"></a>03850 <span class="preprocessor">    # Figure out if we need to search forwards or backwards</span>
<a name="l03851"></a>03851 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[lsearch [$txt tag names $end_quote-1c] _dString] == -1} {
<a name="l03852"></a>03852       <span class="keyword">set</span> dir   <span class="stringliteral">&quot;-forwards&quot;</span>
<a name="l03853"></a>03853       <span class="keyword">set</span> start [$txt index <span class="stringliteral">&quot;insert+1c&quot;</span>]
<a name="l03854"></a>03854     } <span class="keywordflow">else</span> {
<a name="l03855"></a>03855       <span class="keyword">set</span> dir   <span class="stringliteral">&quot;-backwards&quot;</span>
<a name="l03856"></a>03856       <span class="keyword">set</span> start $end_quote
<a name="l03857"></a>03857     }
<a name="l03858"></a>03858 
<a name="l03859"></a>03859     <span class="keywordflow">while</span> {1} {
<a name="l03860"></a>03860 
<a name="l03861"></a>03861       <span class="keyword">set</span> start_quote [$txt search $dir \<span class="stringliteral">&quot; $start]</span>
<a name="l03862"></a>03862 <span class="stringliteral"></span>
<a name="l03863"></a>03863 <span class="stringliteral">      if {($start_quote eq &quot;</span><span class="stringliteral">&quot;) || \</span>
<a name="l03864"></a>03864 <span class="stringliteral">          (($dir eq &quot;</span>-backwards<span class="stringliteral">&quot;) &amp;&amp; [$txt compare $start_quote &gt; $start]) || \</span>
<a name="l03865"></a>03865 <span class="stringliteral">          (($dir eq &quot;</span>-forwards<span class="stringliteral">&quot;)  &amp;&amp; [$txt compare $start_quote &lt; $start]) || \</span>
<a name="l03866"></a>03866 <span class="stringliteral">          (($last_found ne &quot;</span><span class="stringliteral">&quot;) &amp;&amp; [$txt compare $last_found == $start_quote])} {</span>
<a name="l03867"></a>03867 <span class="stringliteral">        return -1</span>
<a name="l03868"></a>03868 <span class="stringliteral">      }</span>
<a name="l03869"></a>03869 <span class="stringliteral"></span>
<a name="l03870"></a>03870 <span class="stringliteral">      set last_found $start_quote</span>
<a name="l03871"></a>03871 <span class="stringliteral">      if {$dir eq &quot;</span>-backwards<span class="stringliteral">&quot;} {</span>
<a name="l03872"></a>03872 <span class="stringliteral">        set start $start_quote</span>
<a name="l03873"></a>03873 <span class="stringliteral">      } else {</span>
<a name="l03874"></a>03874 <span class="stringliteral">        set start [$txt index &quot;</span>$start_quote+1c<span class="stringliteral">&quot;]</span>
<a name="l03875"></a>03875 <span class="stringliteral">      }</span>
<a name="l03876"></a>03876 <span class="stringliteral"></span>
<a name="l03877"></a>03877 <span class="stringliteral">      if {[ctext::isEscaped $txt $last_found]} {</span>
<a name="l03878"></a>03878 <span class="stringliteral">        continue</span>
<a name="l03879"></a>03879 <span class="stringliteral">      }</span>
<a name="l03880"></a>03880 <span class="stringliteral"></span>
<a name="l03881"></a>03881 <span class="stringliteral">      return $last_found</span>
<a name="l03882"></a>03882 <span class="stringliteral"></span>
<a name="l03883"></a>03883 <span class="stringliteral">    }</span>
<a name="l03884"></a>03884 <span class="stringliteral"></span>
<a name="l03885"></a>03885 <span class="stringliteral">  }</span>
<a name="l03886"></a>03886 <span class="stringliteral"></span>
<a name="l03887"></a>03887 <span class="stringliteral">  ######################################################################</span>
<a name="l03888"></a>03888 <span class="stringliteral">  # Handles a mark request when the line is clicked.</span>
<a name="l03889"></a>03889 <span class="stringliteral">  proc mark_command {win type tag} {</span>
<a name="l03890"></a>03890 <span class="stringliteral"></span>
<a name="l03891"></a>03891 <span class="stringliteral">    if {$type eq &quot;</span>marked<span class="stringliteral">&quot;} {</span>
<a name="l03892"></a>03892 <span class="stringliteral">      if {![markers::add $win $tag]} {</span>
<a name="l03893"></a>03893 <span class="stringliteral">        ctext::linemapClearMark $win [lindex [split [$win index $tag.first] .] 0]</span>
<a name="l03894"></a>03894 <span class="stringliteral">      }</span>
<a name="l03895"></a>03895 <span class="stringliteral">    } else {</span>
<a name="l03896"></a>03896 <span class="stringliteral">      markers::delete_by_tag $win $tag</span>
<a name="l03897"></a>03897 <span class="stringliteral">    }</span>
<a name="l03898"></a>03898 <span class="stringliteral"></span>
<a name="l03899"></a>03899 <span class="stringliteral">  }</span>
<a name="l03900"></a>03900 <span class="stringliteral"></span>
<a name="l03901"></a>03901 <span class="stringliteral">  ######################################################################</span>
<a name="l03902"></a>03902 <span class="stringliteral">  # Displays all of the unhidden tabs.</span>
<a name="l03903"></a>03903 <span class="stringliteral">  proc show_tabs {nb} {</span>
<a name="l03904"></a>03904 <span class="stringliteral"></span>
<a name="l03905"></a>03905 <span class="stringliteral">    set tb    $nb.tbf.tb</span>
<a name="l03906"></a>03906 <span class="stringliteral">    set extra $nb.tbf.extra</span>
<a name="l03907"></a>03907 <span class="stringliteral">    set mnu   $extra.mnu</span>
<a name="l03908"></a>03908 <span class="stringliteral"></span>
<a name="l03909"></a>03909 <span class="stringliteral">    # Get the shown tabs</span>
<a name="l03910"></a>03910 <span class="stringliteral">    set shown [$tb xview shown]</span>
<a name="l03911"></a>03911 <span class="stringliteral">    lset shown 1 [expr [lindex $shown 1] + 1]</span>
<a name="l03912"></a>03912 <span class="stringliteral"></span>
<a name="l03913"></a>03913 <span class="stringliteral">    # Clear the menu</span>
<a name="l03914"></a>03914 <span class="stringliteral">    $mnu delete 0 end</span>
<a name="l03915"></a>03915 <span class="stringliteral"></span>
<a name="l03916"></a>03916 <span class="stringliteral">    set i 0</span>
<a name="l03917"></a>03917 <span class="stringliteral">    foreach tab [$tb tabs] {</span>
<a name="l03918"></a>03918 <span class="stringliteral">      if {[lindex $shown 0] == $i} {</span>
<a name="l03919"></a>03919 <span class="stringliteral">        if {$i &gt; 0} {</span>
<a name="l03920"></a>03920 <span class="stringliteral">          $mnu add separator</span>
<a name="l03921"></a>03921 <span class="stringliteral">        }</span>
<a name="l03922"></a>03922 <span class="stringliteral">        set shown [lassign $shown tmp]</span>
<a name="l03923"></a>03923 <span class="stringliteral">      }</span>
<a name="l03924"></a>03924 <span class="stringliteral">      if {[$tb tab $tab -state] ne &quot;</span>hidden<span class="stringliteral">&quot;} {</span>
<a name="l03925"></a>03925 <span class="stringliteral">        $mnu add command -label [$tb tab $tab -text] -command &quot;</span>gui::set_current_tab $tab<span class="stringliteral">&quot;</span>
<a name="l03926"></a>03926 <span class="stringliteral">      }</span>
<a name="l03927"></a>03927 <span class="stringliteral">      incr i</span>
<a name="l03928"></a>03928 <span class="stringliteral">    }</span>
<a name="l03929"></a>03929 <span class="stringliteral"></span>
<a name="l03930"></a>03930 <span class="stringliteral">    # Display the menu</span>
<a name="l03931"></a>03931 <span class="stringliteral">    tk_popup $mnu [expr ([winfo rootx $extra] + [winfo reqwidth $extra]) - [winfo reqwidth $mnu]] \</span>
<a name="l03932"></a>03932 <span class="stringliteral">                  [expr [winfo rooty $extra] + [winfo reqheight $extra]]</span>
<a name="l03933"></a>03933 <span class="stringliteral"></span>
<a name="l03934"></a>03934 <span class="stringliteral">  }</span>
<a name="l03935"></a>03935 <span class="stringliteral"></span>
<a name="l03936"></a>03936 <span class="stringliteral">  ######################################################################</span>
<a name="l03937"></a>03937 <span class="stringliteral">  # Sets the focus to the given ctext widget.</span>
<a name="l03938"></a>03938 <span class="stringliteral">  proc set_txt_focus {txt} {</span>
<a name="l03939"></a>03939 <span class="stringliteral"></span>
<a name="l03940"></a>03940 <span class="stringliteral">    variable txt_current</span>
<a name="l03941"></a>03941 <span class="stringliteral"></span>
<a name="l03942"></a>03942 <span class="stringliteral">    # Set the focus</span>
<a name="l03943"></a>03943 <span class="stringliteral">    focus $txt.t</span>
<a name="l03944"></a>03944 <span class="stringliteral"></span>
<a name="l03945"></a>03945 <span class="stringliteral">    # Save the last text widget in focus</span>
<a name="l03946"></a>03946 <span class="stringliteral">    set txt_current([winfo parent [winfo parent [winfo parent $txt]]]) $txt</span>
<a name="l03947"></a>03947 <span class="stringliteral"></span>
<a name="l03948"></a>03948 <span class="stringliteral">  }</span>
<a name="l03949"></a>03949 <span class="stringliteral"></span>
<a name="l03950"></a>03950 <span class="stringliteral">  ######################################################################</span>
<a name="l03951"></a>03951 <span class="stringliteral">  # Returns the path to the ctext widget that last received focus.</span>
<a name="l03952"></a>03952 <span class="stringliteral">  proc last_txt_focus {tid {tab &quot;</span><span class="stringliteral">&quot;}} {</span>
<a name="l03953"></a>03953 <span class="stringliteral"></span>
<a name="l03954"></a>03954 <span class="stringliteral">    variable pw_current</span>
<a name="l03955"></a>03955 <span class="stringliteral">    variable tab_current</span>
<a name="l03956"></a>03956 <span class="stringliteral">    variable txt_current</span>
<a name="l03957"></a>03957 <span class="stringliteral"></span>
<a name="l03958"></a>03958 <span class="stringliteral">    if {$tid eq &quot;</span><span class="stringliteral">&quot;} {</span>
<a name="l03959"></a>03959 <span class="stringliteral">      if {$tab eq &quot;</span><span class="stringliteral">&quot;} {</span>
<a name="l03960"></a>03960 <span class="stringliteral">        return $txt_current($tab_current($pw_current))</span>
<a name="l03961"></a>03961 <span class="stringliteral">      } elseif {[info exists txt_current($tab)]} {</span>
<a name="l03962"></a>03962 <span class="stringliteral">        return $txt_current($tab)</span>
<a name="l03963"></a>03963 <span class="stringliteral">      } else {</span>
<a name="l03964"></a>03964 <span class="stringliteral">        return [get_txt_from_tab $tab]</span>
<a name="l03965"></a>03965 <span class="stringliteral">      }</span>
<a name="l03966"></a>03966 <span class="stringliteral">    } else {</span>
<a name="l03967"></a>03967 <span class="stringliteral">      return $tid</span>
<a name="l03968"></a>03968 <span class="stringliteral">    }</span>
<a name="l03969"></a>03969 <span class="stringliteral"></span>
<a name="l03970"></a>03970 <span class="stringliteral">  }</span>
<a name="l03971"></a>03971 <span class="stringliteral"></span>
<a name="l03972"></a>03972 <span class="stringliteral">  ######################################################################</span>
<a name="l03973"></a>03973 <span class="stringliteral">  # Scrubs the given text widget, returning the scrubbed text as a string</span>
<a name="l03974"></a>03974 <span class="stringliteral">  # to be used for saving to a file.</span>
<a name="l03975"></a>03975 <span class="stringliteral">  proc scrub_text {txt} {</span>
<a name="l03976"></a>03976 <span class="stringliteral"></span>
<a name="l03977"></a>03977 <span class="stringliteral">    variable trailing_ws_re</span>
<a name="l03978"></a>03978 <span class="stringliteral"></span>
<a name="l03979"></a>03979 <span class="stringliteral">    # Clean up the text from Vim</span>
<a name="l03980"></a>03980 <span class="stringliteral">    set str [vim::get_cleaned_content $txt]</span>
<a name="l03981"></a>03981 <span class="stringliteral"></span>
<a name="l03982"></a>03982 <span class="stringliteral">    if {[preferences::get Editor/RemoveTrailingWhitespace]} {</span>
<a name="l03983"></a>03983 <span class="stringliteral">      regsub -all -lineanchor -- $trailing_ws_re $str {} str</span>
<a name="l03984"></a>03984 <span class="stringliteral">    }</span>
<a name="l03985"></a>03985 <span class="stringliteral"></span>
<a name="l03986"></a>03986 <span class="stringliteral">    return $str</span>
<a name="l03987"></a>03987 <span class="stringliteral"></span>
<a name="l03988"></a>03988 <span class="stringliteral">  }</span>
<a name="l03989"></a>03989 <span class="stringliteral"></span>
<a name="l03990"></a>03990 <span class="stringliteral">  ######################################################################</span>
<a name="l03991"></a>03991 <span class="stringliteral">  # Jumps to the next cursor as specified by direction.  Returns a boolean</span>
<a name="l03992"></a>03992 <span class="stringliteral">  # value of true if a jump occurs (or can occur).</span>
<a name="l03993"></a>03993 <span class="stringliteral">  proc jump_to_cursor {tid dir jump} {</span>
<a name="l03994"></a>03994 <span class="stringliteral"></span>
<a name="l03995"></a>03995 <span class="stringliteral">    variable cursor_hist</span>
<a name="l03996"></a>03996 <span class="stringliteral"></span>
<a name="l03997"></a>03997 <span class="stringliteral">    # Get the current text widget</span>
<a name="l03998"></a>03998 <span class="stringliteral">    set txt [current_txt $tid]</span>
<a name="l03999"></a>03999 <span class="stringliteral"></span>
<a name="l04000"></a>04000 <span class="stringliteral">    # Get the index of the cursor in the cursor hist to use</span>
<a name="l04001"></a>04001 <span class="stringliteral">    if {![info exists cursor_hist($txt,hist)]} {</span>
<a name="l04002"></a>04002 <span class="stringliteral">      set cursor_hist($txt,hist)  [$txt edit cursorhist]</span>
<a name="l04003"></a>04003 <span class="stringliteral">      set cursor_hist($txt,index) [llength $cursor_hist($txt,hist)]</span>
<a name="l04004"></a>04004 <span class="stringliteral">    }</span>
<a name="l04005"></a>04005 <span class="stringliteral"></span>
<a name="l04006"></a>04006 <span class="stringliteral">    set index  $cursor_hist($txt,index)</span>
<a name="l04007"></a>04007 <span class="stringliteral">    set length [llength $cursor_hist($txt,hist)]</span>
<a name="l04008"></a>04008 <span class="stringliteral">    set diff   [preferences::get Find/JumpDistance]</span>
<a name="l04009"></a>04009 <span class="stringliteral"></span>
<a name="l04010"></a>04010 <span class="stringliteral">    if {$index == $length} {</span>
<a name="l04011"></a>04011 <span class="stringliteral">      set last_line [lindex [split [$txt index insert] .] 0]</span>
<a name="l04012"></a>04012 <span class="stringliteral">    } else {</span>
<a name="l04013"></a>04013 <span class="stringliteral">      set last_line [lindex [split [lindex $cursor_hist($txt,hist) $index] .] 0]</span>
<a name="l04014"></a>04014 <span class="stringliteral">    }</span>
<a name="l04015"></a>04015 <span class="stringliteral"></span>
<a name="l04016"></a>04016 <span class="stringliteral">    # Get the cursor index</span>
<a name="l04017"></a>04017 <span class="stringliteral">    while {([incr index $dir] &gt;= 0) &amp;&amp; ($index &lt; $length)} {</span>
<a name="l04018"></a>04018 <span class="stringliteral">      set cursor     [lindex $cursor_hist($txt,hist) $index]</span>
<a name="l04019"></a>04019 <span class="stringliteral">      set index_line [lindex [split $cursor .] 0]</span>
<a name="l04020"></a>04020 <span class="stringliteral">      if {[expr abs( $index_line - $last_line ) &gt;= $diff]} {</span>
<a name="l04021"></a>04021 <span class="stringliteral">        if {$jump} {</span>
<a name="l04022"></a>04022 <span class="stringliteral">          set cursor_hist($txt,index) $index</span>
<a name="l04023"></a>04023 <span class="stringliteral">          $txt mark set insert &quot;</span>$cursor linestart<span class="stringliteral">&quot;</span>
<a name="l04024"></a>04024 <span class="stringliteral">          $txt see insert</span>
<a name="l04025"></a>04025 <span class="stringliteral">          if {[vim::in_vim_mode $txt.t]} {</span>
<a name="l04026"></a>04026 <span class="stringliteral">            vim::adjust_insert $txt.t</span>
<a name="l04027"></a>04027 <span class="stringliteral">          }</span>
<a name="l04028"></a>04028 <span class="stringliteral">        }</span>
<a name="l04029"></a>04029 <span class="stringliteral">        return 1</span>
<a name="l04030"></a>04030 <span class="stringliteral">      }</span>
<a name="l04031"></a>04031 <span class="stringliteral">    }</span>
<a name="l04032"></a>04032 <span class="stringliteral"></span>
<a name="l04033"></a>04033 <span class="stringliteral">    return 0</span>
<a name="l04034"></a>04034 <span class="stringliteral"></span>
<a name="l04035"></a>04035 <span class="stringliteral">  }</span>
<a name="l04036"></a>04036 <span class="stringliteral">  </span>
<a name="l04037"></a>04037 <span class="stringliteral">  ######################################################################</span>
<a name="l04038"></a>04038 <span class="stringliteral">  # Jumps to the next difference in the specified direction.  Returns</span>
<a name="l04039"></a>04039 <span class="stringliteral">  # a boolean value of true if a jump occurs (or can occur).</span>
<a name="l04040"></a>04040 <span class="stringliteral">  proc jump_to_difference {tid dir jump} {</span>
<a name="l04041"></a>04041 <span class="stringliteral">    </span>
<a name="l04042"></a>04042 <span class="stringliteral">    # Get the current text widget</span>
<a name="l04043"></a>04043 <span class="stringliteral">    set txt [current_txt $tid]</span>
<a name="l04044"></a>04044 <span class="stringliteral">    </span>
<a name="l04045"></a>04045 <span class="stringliteral">    # Get the list of ranges</span>
<a name="l04046"></a>04046 <span class="stringliteral">    if {[llength [set ranges [$txt diff ranges both]]] &gt; 0} {</span>
<a name="l04047"></a>04047 <span class="stringliteral">      </span>
<a name="l04048"></a>04048 <span class="stringliteral">      if {$jump} {</span>
<a name="l04049"></a>04049 <span class="stringliteral">    </span>
<a name="l04050"></a>04050 <span class="stringliteral">        # Get the list of difference ranges</span>
<a name="l04051"></a>04051 <span class="stringliteral">        if {$dir == 1} {</span>
<a name="l04052"></a>04052 <span class="stringliteral">          set index [$txt index @0,[winfo height $txt]]</span>
<a name="l04053"></a>04053 <span class="stringliteral">          foreach {start end} $ranges {</span>
<a name="l04054"></a>04054 <span class="stringliteral">            if {[$txt compare $start &gt; $index]} {</span>
<a name="l04055"></a>04055 <span class="stringliteral">              $txt see $start</span>
<a name="l04056"></a>04056 <span class="stringliteral">            }</span>
<a name="l04057"></a>04057 <span class="stringliteral">          }</span>
<a name="l04058"></a>04058 <span class="stringliteral">          $txt see [lindex $ranges 0]</span>
<a name="l04059"></a>04059 <span class="stringliteral">        } else {</span>
<a name="l04060"></a>04060 <span class="stringliteral">          set index [$txt index @0,0]</span>
<a name="l04061"></a>04061 <span class="stringliteral">          foreach {end start} [lreverse $ranges] {</span>
<a name="l04062"></a>04062 <span class="stringliteral">            if {[$txt compare $start &lt; $index]} {</span>
<a name="l04063"></a>04063 <span class="stringliteral">              $txt see $start</span>
<a name="l04064"></a>04064 <span class="stringliteral">            }</span>
<a name="l04065"></a>04065 <span class="stringliteral">          }</span>
<a name="l04066"></a>04066 <span class="stringliteral">          $txt see [lindex $ranges end-1]</span>
<a name="l04067"></a>04067 <span class="stringliteral">        }</span>
<a name="l04068"></a>04068 <span class="stringliteral">        </span>
<a name="l04069"></a>04069 <span class="stringliteral">      }</span>
<a name="l04070"></a>04070 <span class="stringliteral">      </span>
<a name="l04071"></a>04071 <span class="stringliteral">      return 1</span>
<a name="l04072"></a>04072 <span class="stringliteral">      </span>
<a name="l04073"></a>04073 <span class="stringliteral">    }</span>
<a name="l04074"></a>04074 <span class="stringliteral">    </span>
<a name="l04075"></a>04075 <span class="stringliteral">    return 0</span>
<a name="l04076"></a>04076 <span class="stringliteral">    </span>
<a name="l04077"></a>04077 <span class="stringliteral">  }</span>
<a name="l04078"></a>04078 <span class="stringliteral"></span>
<a name="l04079"></a>04079 <span class="stringliteral">}</span>
<a name="l04080"></a>04080 <span class="stringliteral"></span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Mar 30 00:02:06 2015 for TKE by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
