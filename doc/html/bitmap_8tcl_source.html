<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TKE: /Users/trevorw/projects/tke-code/lib/bitmap.tcl Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>/Users/trevorw/projects/tke-code/lib/bitmap.tcl</h1><a href="bitmap_8tcl.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor"># TKE - Advanced Programmer&#39;s Editor</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># Copyright (C) 2014-2019  Trevor Williams (phase1geo@gmail.com)</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># it under the terms of the GNU General Public License as published by</span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># You should have received a copy of the GNU General Public License along</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor"># with this program; if not, write to the Free Software Foundation, Inc.,</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor"># 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span>
<a name="l00018"></a>00018 <span class="preprocessor">######################################################################</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span><span class="preprocessor"># Name:    bitmap.tcl</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="preprocessor"># Author:  Trevor Williams  (trevorw@sgi.com)</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="preprocessor"># Date:    05/21/2013</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span><span class="preprocessor"># Brief:   Widget tool to create a two-color bitmap.</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">######################################################################</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span>
<a name="l00025"></a>00025 <span class="preprocessor"># msgcat::note Strings are found in the theme editor for a bitmapped image</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 <span class="keywordflow">if</span> {0} {
<a name="l00028"></a>00028   <span class="keyword">set</span> tke_dir [file join ~ projects tke-code]
<a name="l00029"></a>00029   source [file join $::tke_dir lib utils.tcl]
<a name="l00030"></a>00030 }
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="keyword">namespace </span>eval bitmap {
<a name="l00033"></a>00033 
<a name="l00034"></a>00034   array <span class="keyword">set</span> data {}
<a name="l00035"></a>00035 
<a name="l00036"></a>00036   <span class="keyword">set</span> data(bg) [utils::get_default_background]
<a name="l00037"></a>00037   <span class="keyword">set</span> data(fg) [utils::get_default_foreground]
<a name="l00038"></a>00038 
<a name="l00039"></a>00039   <span class="keywordflow">if</span> {[<span class="keywordflow">catch</span> { ttk::spinbox .__tmp }]} {
<a name="l00040"></a>00040     <span class="keyword">set</span> data(sb)          <span class="stringliteral">&quot;spinbox&quot;</span>
<a name="l00041"></a>00041     <span class="keyword">set</span> data(sb_opts)     <span class="stringliteral">&quot;-relief flat -buttondownrelief flat -buttonuprelief flat -background $data(bg) -foreground $data(fg)&quot;</span>
<a name="l00042"></a>00042     <span class="keyword">set</span> data(sb_normal)   <span class="stringliteral">&quot;configure -state normal&quot;</span>
<a name="l00043"></a>00043     <span class="keyword">set</span> data(sb_disabled) <span class="stringliteral">&quot;configure -state disabled&quot;</span>
<a name="l00044"></a>00044     <span class="keyword">set</span> data(sb_readonly) <span class="stringliteral">&quot;configure -state readonly&quot;</span>
<a name="l00045"></a>00045   } <span class="keywordflow">else</span> {
<a name="l00046"></a>00046     <span class="keyword">set</span> data(sb)          <span class="stringliteral">&quot;ttk::spinbox&quot;</span>
<a name="l00047"></a>00047     <span class="keyword">set</span> data(sb_opts)     <span class="stringliteral">&quot;-justify center&quot;</span>
<a name="l00048"></a>00048     <span class="keyword">set</span> data(sb_normal)   <span class="stringliteral">&quot;state !disabled&quot;</span>
<a name="l00049"></a>00049     <span class="keyword">set</span> data(sb_disabled) <span class="stringliteral">&quot;state disabled&quot;</span>
<a name="l00050"></a>00050     <span class="keyword">set</span> data(sb_readonly) <span class="stringliteral">&quot;state readonly&quot;</span>
<a name="l00051"></a>00051     destroy .__tmp
<a name="l00052"></a>00052   }
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">  ######################################################################</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">  # Creates a bitmap widget and returns the widget name.</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>  proc create {w type args} {
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     variable data
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     array <span class="keyword">set</span> opts {
<a name="l00061"></a>00061       -color1     blue
<a name="l00062"></a>00062       -color2     green
<a name="l00063"></a>00063       -size       10
<a name="l00064"></a>00064       -width      32
<a name="l00065"></a>00065       -height     32
<a name="l00066"></a>00066       -swatches   {}
<a name="l00067"></a>00067     }
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     array <span class="keyword">set</span> opts $args
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="preprocessor">    # Initialize variables</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span>    <span class="keyword">set</span> data($w,type)      $type
<a name="l00073"></a>00073     set data($w,-size)     $opts(-size)
<a name="l00074"></a>00074     set data($w,-width)    $opts(-width)
<a name="l00075"></a>00075     set data($w,-height)   $opts(-height)
<a name="l00076"></a>00076     set data($w,-swatches) $opts(-swatches)
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     if {$type eq <span class="stringliteral">&quot;mono&quot;</span>} {
<a name="l00079"></a>00079       <span class="keyword">set</span> data($w,colors) [list $data(bg) $opts(-color1)]
<a name="l00080"></a>00080     } else {
<a name="l00081"></a>00081       <span class="keyword">set</span> data($w,colors) [list $data(bg) $opts(-color1) $opts(-color2)]
<a name="l00082"></a>00082     }
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     ttk::frame $w
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     <span class="preprocessor"># Create the bitmap canvas</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>    <span class="keyword">set</span> width  [expr ($data($w,-size) * 32) + 1]
<a name="l00088"></a>00088     <span class="keyword">set</span> height [expr ($data($w,-size) * 32) + 1]
<a name="l00089"></a>00089     <span class="keyword">set</span> data($w,grid) [canvas $w.c -background $data(bg) -width $width -height $height]
<a name="l00090"></a>00090 
<a name="l00091"></a>00091     bind $data($w,grid) &lt;B1-Motion&gt; [list bitmap::change_square_motion $w %x %y]
<a name="l00092"></a>00092     bind $data($w,grid) &lt;B$::right_click-Motion&gt; [list bitmap::change_square_motion $w %x %y]
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="preprocessor">    # Create the right frame</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>    ttk::frame $w.rf
<a name="l00096"></a>00096     <span class="keyword">set</span> data($w,plabel) [ttk::label $w.rf.p -relief solid -padding 10 -anchor center]
<a name="l00097"></a>00097     ttk::labelframe $w.rf.mf -text [msgcat::mc <span class="stringliteral">&quot;Transform Tools&quot;</span>]
<a name="l00098"></a>00098     grid columnconfigure $w.rf.mf 0 -weight 1
<a name="l00099"></a>00099     grid columnconfigure $w.rf.mf 4 -weight 1
<a name="l00100"></a>00100     grid [ttk::button $w.rf.mf.up     -style BButton -text <span class="stringliteral">&quot;\u25b2&quot;</span> -command [list bitmap::move $w up]]         -row 0 -column 2 -sticky news -padx 2 -pady 2
<a name="l00101"></a>00101     grid [ttk::button $w.rf.mf.left   -style BButton -text <span class="stringliteral">&quot;\u25c0&quot;</span> -command [list bitmap::move $w left]]       -row 1 -column 1 -sticky news -padx 2 -pady 2
<a name="l00102"></a>00102     grid [ttk::button $w.rf.mf.center -style BButton -text <span class="stringliteral">&quot;\u25fc&quot;</span> -command [list bitmap::move $w center]]     -row 1 -column 2 -sticky news -padx 2 -pady 2
<a name="l00103"></a>00103     grid [ttk::button $w.rf.mf.right  -style BButton -text <span class="stringliteral">&quot;\u25b6&quot;</span> -command [list bitmap::move $w right]]      -row 1 -column 3 -sticky news -padx 2 -pady 2
<a name="l00104"></a>00104     grid [ttk::button $w.rf.mf.down   -style BButton -text <span class="stringliteral">&quot;\u25bc&quot;</span> -command [list bitmap::move $w down]]       -row 2 -column 2 -sticky news -padx 2 -pady 2
<a name="l00105"></a>00105     grid [ttk::button $w.rf.mf.flipv  -style BButton -text <span class="stringliteral">&quot;\u2b0c&quot;</span> -command [list bitmap::flip $w vertical]]   -row 3 -column 1 -sticky news -padx 2 -pady 2
<a name="l00106"></a>00106     grid [ttk::button $w.rf.mf.rot    -style BButton -text <span class="stringliteral">&quot;\u21ba&quot;</span> -command [list bitmap::rotate $w]]          -row 3 -column 2 -sticky news -padx 2 -pady 2
<a name="l00107"></a>00107     grid [ttk::button $w.rf.mf.fliph  -style BButton -text <span class="stringliteral">&quot;\u2b0d&quot;</span> -command [list bitmap::flip $w horizontal]] -row 3 -column 3 -sticky news -padx 2 -pady 2
<a name="l00108"></a>00108     <span class="keyword">set</span> data($w,c1_lbl) [ttk::label $w.rf.l1 -text <span class="stringliteral">&quot;Color-1:&quot;</span> -background [lindex $data($w,colors) 1]]
<a name="l00109"></a>00109     <span class="keyword">set</span> data($w,color1) [ttk::menubutton $w.rf.sb1 -text [lindex $data($w,colors) 1] -menu [<span class="keyword">set</span> data($w,color1_mnu) [menu $w.rf.mnu1 -tearoff 0]]]
<a name="l00110"></a>00110     <span class="keywordflow">if</span> {$type eq <span class="stringliteral">&quot;mono&quot;</span>} {
<a name="l00111"></a>00111       $data($w,c1_lbl) configure -text &quot;Color:&quot;
<a name="l00112"></a>00112     } else {
<a name="l00113"></a>00113       <span class="keyword">set</span> data($w,c2_lbl) [ttk::label $w.rf.l2 -text <span class="stringliteral">&quot;Color-2:&quot;</span> -background [lindex $data($w,colors) 2]]
<a name="l00114"></a>00114       <span class="keyword">set</span> data($w,color2) [ttk::menubutton $w.rf.sb2 -text [lindex $data($w,colors) 2] -menu [<span class="keyword">set</span> data($w,color2_mnu) [menu $w.rf.mnu2 -tearoff 0]]]
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116     ttk::label $w.rf.l3 -text <span class="stringliteral">&quot;Width:&quot;</span>
<a name="l00117"></a>00117     <span class="keyword">set</span> data($w,width)  [$data(sb) $w.rf.width {*}$data(sb_opts)  -width 2 -values [list 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16] -command [list bitmap::set_grid_size $w width]]
<a name="l00118"></a>00118     ttk::label $w.rf.l4 -text <span class="stringliteral">&quot;Height:&quot;</span>
<a name="l00119"></a>00119     <span class="keyword">set</span> data($w,height) [$data(sb) $w.rf.height {*}$data(sb_opts) -width 2 -values [list 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16] -command [list bitmap::set_grid_size $w height]]
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     $data($w,width)  set $data($w,-width)
<a name="l00122"></a>00122     $data($w,height) set $data($w,-height)
<a name="l00123"></a>00123     $data($w,width)  {*}$data(sb_readonly)
<a name="l00124"></a>00124     $data($w,height) {*}$data(sb_readonly)
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     tooltip::tooltip $w.rf.mf.up     [msgcat::mc &quot;Move image up&quot;]
<a name="l00127"></a>00127     tooltip::tooltip $w.rf.mf.left   [msgcat::mc &quot;Move image left&quot;]
<a name="l00128"></a>00128     tooltip::tooltip $w.rf.mf.center [msgcat::mc &quot;Center image&quot;]
<a name="l00129"></a>00129     tooltip::tooltip $w.rf.mf.right  [msgcat::mc &quot;Move image right&quot;]
<a name="l00130"></a>00130     tooltip::tooltip $w.rf.mf.down   [msgcat::mc &quot;Move image down&quot;]
<a name="l00131"></a>00131     tooltip::tooltip $w.rf.mf.flipv  [msgcat::mc &quot;Flip image vertically&quot;]
<a name="l00132"></a>00132     tooltip::tooltip $w.rf.mf.rot    [msgcat::mc &quot;Rotate image 90 degrees&quot;]
<a name="l00133"></a>00133     tooltip::tooltip $w.rf.mf.fliph  [msgcat::mc &quot;Flip image horizontally&quot;]
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     grid rowconfigure    $w.rf 1 -weight 1
<a name="l00136"></a>00136     grid rowconfigure    $w.rf 3 -weight 1
<a name="l00137"></a>00137     grid columnconfigure $w.rf 1 -weight 1
<a name="l00138"></a>00138     grid $data($w,plabel) -row 0 -column 0 -padx 2 -pady 2 -columnspan 2
<a name="l00139"></a>00139     grid $w.rf.mf         -row 2 -column 0 -padx 2 -pady 2 -columnspan 2
<a name="l00140"></a>00140     grid $data($w,c1_lbl) -row 4 -column 0 -sticky news -padx 2 -pady 2
<a name="l00141"></a>00141     grid $data($w,color1) -row 4 -column 1 -sticky news -padx 2 -pady 2
<a name="l00142"></a>00142     if {$type ne <span class="stringliteral">&quot;mono&quot;</span>} {
<a name="l00143"></a>00143       grid $data($w,c2_lbl) -row 5 -column 0 -sticky news -padx 2 -pady 2
<a name="l00144"></a>00144       grid $data($w,color2) -row 5 -column 1 -sticky news -padx 2 -pady 2
<a name="l00145"></a>00145     }
<a name="l00146"></a>00146     grid $w.rf.l3         -row 6 -column 0 -sticky news -padx 2 -pady 2
<a name="l00147"></a>00147     grid $data($w,width)  -row 6 -column 1 -sticky news -padx 2 -pady 2
<a name="l00148"></a>00148     grid $w.rf.l4         -row 7 -column 0 -sticky news -padx 2 -pady 2
<a name="l00149"></a>00149     grid $data($w,height) -row 7 -column 1 -sticky news -padx 2 -pady 2
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     pack $w.c  -side left -padx 2 -pady 2
<a name="l00152"></a>00152     pack $w.rf -side left -padx 2 -pady 2 -fill y
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="preprocessor">    # Draw the bitmap</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>    draw_grid $w $data($w,-width) $data($w,-height)
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="preprocessor"># Update the menus</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>    update_menus $w
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="preprocessor">    # Create the preview image</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>    array <span class="keyword">set</span> info [get_info $w]
<a name="l00162"></a>00162     <span class="keywordflow">if</span> {$type eq <span class="stringliteral">&quot;mono&quot;</span>} {
<a name="l00163"></a>00163       <span class="keyword">set</span> data($w,preview) [image create bitmap -data $info(dat) -maskdata $info(msk) -foreground $info(fg)]
<a name="l00164"></a>00164     } <span class="keywordflow">else</span> {
<a name="l00165"></a>00165       <span class="keyword">set</span> data($w,preview) [image create bitmap -data $info(dat) -maskdata $info(msk) -foreground $info(fg) -background $info(bg)]
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167     $data($w,plabel) configure -image $data($w,preview)
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     rename ::$w $w
<a name="l00170"></a>00170     interp alias {} ::$w {} bitmap::widget_cmd $w
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="keywordflow">return</span> $w
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="preprocessor">  ######################################################################</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="preprocessor">  # Runs the specified widget command.</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>  proc widget_cmd {w args} {
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="keyword">set</span> args [lassign $args cmd]
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     <span class="keywordflow">switch</span> -exact $cmd {
<a name="l00183"></a>00183       cget      { <span class="keywordflow">return</span> [cget $w {*}$args] }
<a name="l00184"></a>00184       configure { <span class="keywordflow">return</span> [configure $w {*}$args] }
<a name="l00185"></a>00185       <span class="keywordflow">default</span>   { <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;Unknown bitmap command ($cmd)&quot;</span> }
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188   }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 <span class="preprocessor">  ######################################################################</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor">  # Returns the specified bitmap option value.</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>  proc cget {w args} {
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     variable data
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <span class="keywordflow">if</span> {[llength $args] != 1} {
<a name="l00197"></a>00197       <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;Illegal number of arguments to bitmap::cget&quot;</span>
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="keywordflow">if</span> {![info exists data($w,[lindex $args 0])]} {
<a name="l00201"></a>00201       <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;Unknown bitmap option [lindex $args 0]&quot;</span>
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     <span class="keywordflow">return</span> $data($w,[lindex $args 0])
<a name="l00205"></a>00205 
<a name="l00206"></a>00206   }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="preprocessor">  ######################################################################</span>
<a name="l00209"></a>00209 <span class="preprocessor"></span><span class="preprocessor">  # Sets options in the bitmap widget.</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span>  proc configure {w args} {
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     variable data
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="keywordflow">if</span> {[llength $args] % 2} {
<a name="l00215"></a>00215       <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;Illegal number of arguments to bitmap::configure&quot;</span>
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     array <span class="keyword">set</span> opts {
<a name="l00219"></a>00219       -background {}
<a name="l00220"></a>00220       -swatches   {}
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     array <span class="keyword">set</span> opts $args
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 <span class="preprocessor">    # Store the options</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>    <span class="keyword">set</span> data($w,-swatches) $opts(-swatches)
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="preprocessor"># If a background color was specified, change the color in the widget</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$opts(-background) ne &quot;&quot;} {
<a name="l00229"></a>00229       lset data($w,colors) 0 $opts(-background)
<a name="l00230"></a>00230       $data($w,grid)   configure -background $opts(-background)
<a name="l00231"></a>00231       $data($w,plabel) configure -background $opts(-background)
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="preprocessor"># Update the UI</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>    update_menus $w
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="preprocessor">  ######################################################################</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span><span class="preprocessor">  # Draws the bitmap grid.</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span>  proc draw_grid {w width height {fg <span class="stringliteral">&quot;&quot;</span>}} {
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     variable data
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="preprocessor">    # Calculate the background and foreground colors, if necessary</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span>    <span class="keyword">set</span> bg [lindex $data($w,colors) 0]
<a name="l00247"></a>00247     <span class="keyword">set</span> fg [expr {($fg eq <span class="stringliteral">&quot;&quot;</span>) ? $data(fg) : $fg}]
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="preprocessor">    # Clear the grid</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>    $data($w,grid) delete all
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="preprocessor"># Calculate the x and y adjustment</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>    <span class="keyword">set</span> x_adjust [expr ((32 - $width)  * ($data($w,-size) / 2)) + 1]
<a name="l00254"></a>00254     <span class="keyword">set</span> y_adjust [expr ((32 - $height) * ($data($w,-size) / 2)) + 1]
<a name="l00255"></a>00255 
<a name="l00256"></a>00256     <span class="keywordflow">for</span> {<span class="keyword">set</span> row 0} {$row &lt; $height} {incr row} {
<a name="l00257"></a>00257 
<a name="l00258"></a>00258       <span class="keywordflow">for</span> {<span class="keyword">set</span> col 0} {$col &lt; $width} {incr col} {
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 <span class="preprocessor">        # Calculate the square positions</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span>        <span class="keyword">set</span> x1 [expr ($col * $data($w,-size)) + $x_adjust]
<a name="l00262"></a>00262         <span class="keyword">set</span> y1 [expr ($row * $data($w,-size)) + $y_adjust]
<a name="l00263"></a>00263         <span class="keyword">set</span> x2 [expr (($col + 1) * $data($w,-size)) + $x_adjust]
<a name="l00264"></a>00264         <span class="keyword">set</span> y2 [expr (($row + 1) * $data($w,-size)) + $y_adjust]
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 <span class="preprocessor">        # Create the square</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span>        <span class="keyword">set</span> data($w,$row,$col) [$data($w,grid) create rectangle $x1 $y1 $x2 $y2 -fill $bg -outline $fg -width 1 -tags s0]
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="preprocessor"># Create the square bindings</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span>        $data($w,grid) bind $data($w,$row,$col) &lt;ButtonPress-1&gt; [list bitmap::change_square $w $row $col  1]
<a name="l00271"></a>00271         $data($w,grid) bind $data($w,$row,$col) &lt;ButtonPress-$::right_click&gt; [list bitmap::change_square $w $row $col -1]
<a name="l00272"></a>00272 
<a name="l00273"></a>00273       }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279   <span class="preprocessor">######################################################################</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span><span class="preprocessor">  # Set the size of the grid.</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span>  proc set_grid_size {w type} {
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     variable data
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="preprocessor">    # Get the spinbox value</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span>    <span class="keyword">set</span> data($w,-$type) [$data($w,$type) get]
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="preprocessor"># Update the grid</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span>    set_from_info $w [<span class="keyword">set</span> info [get_info $w]] 0
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="preprocessor">    # Generate the event</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>    <span class="keyword">event</span> generate $w &lt;&lt;BitmapChanged&gt;&gt; -data $info
<a name="l00293"></a>00293 
<a name="l00294"></a>00294   }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 <span class="preprocessor">  ######################################################################</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span><span class="preprocessor">  # Changes the fill color of the selected square to the color indicated</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span><span class="preprocessor">  # by the current color</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span>  proc change_square {w row col dir} {
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     variable data
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 <span class="preprocessor">    # Get the current color</span>
<a name="l00304"></a>00304 <span class="preprocessor"></span>    <span class="keyword">set</span> curr_tag [<span class="keywordtype">string</span> index [$data($w,grid) itemcget $data($w,$row,$col) -tags] 1]
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="preprocessor"># If this is the initial press, save the replace color</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span>    <span class="keyword">set</span> data($w,replace)      $curr_tag
<a name="l00308"></a>00308     set data($w,replace_with) [expr ($curr_tag + $dir) % [llength $data($w,colors)]]
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="preprocessor"># Set the square fill color</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span>    $data($w,grid) itemconfigure $data($w,$row,$col) -fill [lindex $data($w,colors) $data($w,replace_with)] -tags s$data($w,replace_with)
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="preprocessor"># Update the preview</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span>    array <span class="keyword">set</span> info [get_info $w]
<a name="l00315"></a>00315     $data($w,preview) configure -data $info(dat) -maskdata $info(msk)
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     <span class="preprocessor"># Generate the event</span>
<a name="l00318"></a>00318 <span class="preprocessor"></span>    <span class="keyword">event</span> generate $w &lt;&lt;BitmapChanged&gt;&gt; -data [array <span class="keyword">get</span> info]
<a name="l00319"></a>00319 
<a name="l00320"></a>00320   }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <span class="preprocessor">  ######################################################################</span>
<a name="l00323"></a>00323 <span class="preprocessor"></span><span class="preprocessor">  # Specifies that the current change is done.</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>  proc change_square_motion {w x y} {
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     variable data
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     <span class="keyword">set</span> <span class="keywordtype">id</span> [$data($w,grid) find closest $x $y]
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     <span class="preprocessor"># Get the current color</span>
<a name="l00331"></a>00331 <span class="preprocessor"></span>    <span class="keyword">set</span> tag [<span class="keywordtype">string</span> index [$data($w,grid) itemcget $id -tags] 1]
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     if {$data($w,replace) eq $tag} {
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 <span class="preprocessor">      # Configure the square color</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span>      $data($w,grid) itemconfigure $id -fill [lindex $data($w,colors) $data($w,replace_with)] -tags s$data($w,replace_with)
<a name="l00337"></a>00337 
<a name="l00338"></a>00338       <span class="preprocessor"># Update the preview</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span>      array <span class="keyword">set</span> info [get_info $w]
<a name="l00340"></a>00340       $data($w,preview) configure -data $info(dat) -maskdata $info(msk)
<a name="l00341"></a>00341 
<a name="l00342"></a>00342       <span class="preprocessor"># Generate the event</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span>      <span class="keyword">event</span> generate $w &lt;&lt;BitmapChanged&gt;&gt; -data [array <span class="keyword">get</span> info]
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347   }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 <span class="preprocessor">  ######################################################################</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span><span class="preprocessor">  # Returns the bitmap information in the form of an array.</span>
<a name="l00351"></a>00351 <span class="preprocessor"></span>  proc get_info {w} {
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     variable data
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="keyword">set</span> dat <span class="stringliteral">&quot;#define img_width $data($w,-width)\n#define img_height $data($w,-height)\nstatic char img_bits\[\] = {\n&quot;</span>
<a name="l00356"></a>00356     <span class="keyword">set</span> msk <span class="stringliteral">&quot;#define img_width $data($w,-width)\n#define img_height $data($w,-height)\nstatic char img_bits\[\] = {\n&quot;</span>
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     lassign $data($w,colors) dummy color1 color2
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     for {<span class="keyword">set</span> row 0} {$row &lt; $data($w,-height)} {incr row} {
<a name="l00361"></a>00361       <span class="keyword">set</span> dat_val 0
<a name="l00362"></a>00362       <span class="keyword">set</span> msk_val 0
<a name="l00363"></a>00363       <span class="keywordflow">for</span> {<span class="keyword">set</span> col 0} {$col &lt; $data($w,-width)} {incr col} {
<a name="l00364"></a>00364         <span class="keyword">set</span> color [$data($w,grid) itemcget $data($w,$row,$col) -fill]
<a name="l00365"></a>00365         if {$color eq $color1} {
<a name="l00366"></a>00366           <span class="keyword">set</span> dat_val [expr $dat_val | (0x1 &lt;&lt; $col)]
<a name="l00367"></a>00367           <span class="keyword">set</span> msk_val [expr $msk_val | (0x1 &lt;&lt; $col)]
<a name="l00368"></a>00368         } elseif {$color eq $color2} {
<a name="l00369"></a>00369           <span class="keyword">set</span> msk_val [expr $msk_val | (0x1 &lt;&lt; $col)]
<a name="l00370"></a>00370         }
<a name="l00371"></a>00371       }
<a name="l00372"></a>00372       <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; [expr $data($w,-width) / 8]} {incr i } {
<a name="l00373"></a>00373         append dat [format {0x%02x, } [expr ($dat_val &gt;&gt; ($i * 8)) &amp; 0xff]]
<a name="l00374"></a>00374         append msk [format {0x%02x, } [expr ($msk_val &gt;&gt; ($i * 8)) &amp; 0xff]]
<a name="l00375"></a>00375       }
<a name="l00376"></a>00376       <span class="keywordflow">if</span> {[expr $data($w,-width) % 8]} {
<a name="l00377"></a>00377         <span class="keyword">set</span> byte [expr $data($w,-width) / 8]
<a name="l00378"></a>00378         append dat [format {0x%02x, } [expr ($dat_val &gt;&gt; ($byte * 8)) &amp; 0xff]]
<a name="l00379"></a>00379         append msk [format {0x%02x, } [expr ($msk_val &gt;&gt; ($byte * 8)) &amp; 0xff]]
<a name="l00380"></a>00380       }
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keyword">set</span> dat <span class="stringliteral">&quot;[string range $dat 0 end-2]};&quot;</span>
<a name="l00384"></a>00384     <span class="keyword">set</span> msk <span class="stringliteral">&quot;[string range $msk 0 end-2]};&quot;</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="keywordflow">if</span> {$data($w,type) eq &quot;mono&quot;} {
<a name="l00387"></a>00387       <span class="keywordflow">return</span> [list dat $dat msk $msk fg $color1]
<a name="l00388"></a>00388     } <span class="keywordflow">else</span> {
<a name="l00389"></a>00389       <span class="keywordflow">return</span> [list dat $dat msk $msk fg $color1 bg $color2]
<a name="l00390"></a>00390     }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392   }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 <span class="preprocessor">  ######################################################################</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span><span class="preprocessor">  # Update the widget from the information.</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>  proc set_from_info {w info_list {resize 1}} {
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     variable data
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     array <span class="keyword">set</span> info $info_list
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 <span class="preprocessor">    # Set the background color if it does not exist</span>
<a name="l00403"></a>00403 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {($data($w,type) ne &quot;mono&quot;) &amp;&amp; ![info exists info(bg)]} {
<a name="l00404"></a>00404       <span class="keyword">set</span> info(bg) $data(bg)
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     <span class="preprocessor"># Set the grid foreground</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span>    <span class="keyword">set</span> grid_fg [expr {($info(fg) eq &quot;black&quot;) ? &quot;grey&quot; : &quot;black&quot;}]
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="preprocessor"># Parse the data and mask BMP strings</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keywordflow">catch</span> {
<a name="l00412"></a>00412       array <span class="keyword">set</span> dat_info [parse_bmp $info(dat)]
<a name="l00413"></a>00413       <span class="keywordflow">if</span> {$data($w,type) eq &quot;mono&quot;} {
<a name="l00414"></a>00414         array <span class="keyword">set</span> msk_info [array <span class="keyword">get</span> dat_info]
<a name="l00415"></a>00415       } <span class="keywordflow">else</span> {
<a name="l00416"></a>00416         array <span class="keyword">set</span> msk_info [parse_bmp $info(msk)]
<a name="l00417"></a>00417       }
<a name="l00418"></a>00418     } rc]} {
<a name="l00419"></a>00419       <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;Error parsing BMP file ($rc)&quot;</span>
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 <span class="preprocessor">    # Set the variables</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$resize} {
<a name="l00424"></a>00424       <span class="keyword">set</span> data($w,-width)  $dat_info(width)
<a name="l00425"></a>00425       set data($w,-height) $dat_info(height)
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427     if {$data($w,type) eq &quot;mono&quot;} {
<a name="l00428"></a>00428       lset data($w,colors) 1 $info(fg)
<a name="l00429"></a>00429     } <span class="keywordflow">else</span> {
<a name="l00430"></a>00430       lset data($w,colors) 1 $info(fg)
<a name="l00431"></a>00431       lset data($w,colors) 2 $info(bg)
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <span class="preprocessor"># Update the preview</span>
<a name="l00435"></a>00435 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$data($w,type) eq &quot;mono&quot;} {
<a name="l00436"></a>00436       $data($w,preview) configure -foreground $info(fg) -data $info(dat) -maskdata $info(msk)
<a name="l00437"></a>00437     } else {
<a name="l00438"></a>00438       $data($w,preview) configure -foreground $info(fg) -background $info(bg) -data $info(dat) -maskdata $info(msk)
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="preprocessor"># Redraw the grid</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span>    draw_grid $w $data($w,-width) $data($w,-height) $grid_fg
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="preprocessor"># Update the widgets</span>
<a name="l00445"></a>00445 <span class="preprocessor"></span>    $data($w,c1_lbl) configure -background $info(fg) -foreground [utils::get_complementary_mono_color $info(fg)]
<a name="l00446"></a>00446     $data($w,color1) configure -text $info(fg)
<a name="l00447"></a>00447     if {$data($w,type) ne &quot;mono&quot;} {
<a name="l00448"></a>00448       $data($w,c2_lbl) configure -background $info(bg) -foreground [utils::get_complementary_mono_color $info(bg)]
<a name="l00449"></a>00449       $data($w,color2) configure -text $info(bg)
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451     $data($w,width)  set $dat_info(width)
<a name="l00452"></a>00452     $data($w,height) set $dat_info(height)
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     for {<span class="keyword">set</span> row 0} {$row &lt; $data($w,-height)} {incr row} {
<a name="l00455"></a>00455       <span class="keyword">set</span> dat_val [lindex $dat_info(rows) $row]
<a name="l00456"></a>00456       set msk_val [lindex $msk_info(rows) $row]
<a name="l00457"></a>00457       for {<span class="keyword">set</span> col 0} {$col &lt; $data($w,-width)} {incr col} {
<a name="l00458"></a>00458         <span class="keywordflow">if</span> {[expr $dat_val &amp; (0x1 &lt;&lt; $col)]} {
<a name="l00459"></a>00459           $data($w,grid) itemconfigure $data($w,$row,$col) -fill $info(fg) -tags s1
<a name="l00460"></a>00460         } elseif {[expr $msk_val &amp; (0x1 &lt;&lt; $col)]} {
<a name="l00461"></a>00461           $data($w,grid) itemconfigure $data($w,$row,$col) -fill $info(bg) -tags s2
<a name="l00462"></a>00462         } else {
<a name="l00463"></a>00463           $data($w,grid) itemconfigure $data($w,$row,$col) -tags s0
<a name="l00464"></a>00464         }
<a name="l00465"></a>00465       }
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470   <span class="preprocessor">######################################################################</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span><span class="preprocessor">  # Parses the given BMP file contents and returns a more usable format</span>
<a name="l00472"></a>00472 <span class="preprocessor"></span><span class="preprocessor">  # of the data.</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span>  proc parse_bmp {bmp_str} {
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     array <span class="keyword">set</span> bmp_data [list]
<a name="l00476"></a>00476 
<a name="l00477"></a>00477 <span class="preprocessor">    # Parse out the width and height</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[regexp {#define\s+\w+\s+(\d+).*#define\s+\w+\s+(\d+).*\{(.*)\}} [<span class="keywordtype">string</span> map {\n { }} $bmp_str] -&gt; bmp_data(width) bmp_data(height) values]} {
<a name="l00479"></a>00479       <span class="keywordflow">if</span> {$bmp_data(width) &gt; 32} {
<a name="l00480"></a>00480         <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;BMP data width is greater than 32&quot;</span>
<a name="l00481"></a>00481       }
<a name="l00482"></a>00482       <span class="keywordflow">if</span> {$bmp_data(height) &gt; 32} {
<a name="l00483"></a>00483         <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;BMP data height is greater than 32&quot;</span>
<a name="l00484"></a>00484       }
<a name="l00485"></a>00485       <span class="keyword">set</span> values [<span class="keywordtype">string</span> map {{,} {}} [<span class="keywordtype">string</span> trim $values]]
<a name="l00486"></a>00486       <span class="keywordflow">switch</span> [expr ($bmp_data(width) - 1) / 8] {
<a name="l00487"></a>00487         0 {
<a name="l00488"></a>00488           <span class="keywordflow">foreach</span> val $values {
<a name="l00489"></a>00489             lappend bmp_data(rows) $val
<a name="l00490"></a>00490           }
<a name="l00491"></a>00491         }
<a name="l00492"></a>00492         1 {
<a name="l00493"></a>00493           <span class="keywordflow">foreach</span> {val1 val2} $values {
<a name="l00494"></a>00494             lappend bmp_data(rows) [expr ($val2 &lt;&lt; 8) | $val1]
<a name="l00495"></a>00495           }
<a name="l00496"></a>00496         }
<a name="l00497"></a>00497         2 {
<a name="l00498"></a>00498           <span class="keywordflow">foreach</span> {val1 val2 val3} $values {
<a name="l00499"></a>00499             lappend bmp_data(rows) [expr ($val3 &lt;&lt; 16) | ($val2 &lt;&lt; 8) | $val1]
<a name="l00500"></a>00500           }
<a name="l00501"></a>00501         }
<a name="l00502"></a>00502         3 {
<a name="l00503"></a>00503           <span class="keywordflow">foreach</span> {val1 val2 val3 val4} $value {
<a name="l00504"></a>00504             lappend bmp_data(rows) [expr ($val4 &lt;&lt; 24) | ($val3 &lt;&lt; 16) | ($val2 &lt;&lt; 8) | $val1]
<a name="l00505"></a>00505           }
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507       }
<a name="l00508"></a>00508       <span class="keywordflow">return</span> [array <span class="keyword">get</span> bmp_data]
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511     <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;Illegal BMP data string specified&quot;</span>
<a name="l00512"></a>00512 
<a name="l00513"></a>00513   }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 <span class="preprocessor">  ######################################################################</span>
<a name="l00516"></a>00516 <span class="preprocessor"></span><span class="preprocessor">  # Updates the color menus</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span>  proc update_menus {w} {
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     variable data
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="keywordflow">for</span> {<span class="keyword">set</span> i 1} {$i &lt;= [expr {($data($w,type) eq &quot;mono&quot;) ? 1 : 2}]} {incr i} {
<a name="l00522"></a>00522       <span class="keyword">set</span> mnu $data($w,color${i}_mnu)
<a name="l00523"></a>00523       $mnu <span class="keyword">delete</span> 0 end
<a name="l00524"></a>00524       $mnu add command -label <span class="stringliteral">&quot;Custom color...&quot;</span> -command [list bitmap::set_custom_color $w $i]
<a name="l00525"></a>00525       <span class="keywordflow">if</span> {[llength $data($w,-swatches)] &gt; 0} {
<a name="l00526"></a>00526         $mnu add separator
<a name="l00527"></a>00527         $mnu add command -label <span class="stringliteral">&quot;Swatch Colors&quot;</span> -state disabled
<a name="l00528"></a>00528         <span class="keywordflow">foreach</span> swatch $data($w,-swatches) {
<a name="l00529"></a>00529           $mnu add command -label $swatch -command [list bitmap::set_color $w $i $swatch]
<a name="l00530"></a>00530         }
<a name="l00531"></a>00531       }
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534   }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 <span class="preprocessor">  ######################################################################</span>
<a name="l00537"></a>00537 <span class="preprocessor"></span><span class="preprocessor">  # Set a custom color</span>
<a name="l00538"></a>00538 <span class="preprocessor"></span>  proc set_custom_color {w index} {
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     variable data
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordflow">if</span> {[<span class="keyword">set</span> color [tk_chooseColor -initialcolor [lindex $data($w,colors) $index]]] ne &quot;&quot;} {
<a name="l00543"></a>00543       set_color $w $index $color
<a name="l00544"></a>00544     }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 <span class="preprocessor">  ######################################################################</span>
<a name="l00549"></a>00549 <span class="preprocessor"></span><span class="preprocessor">  # Sets the specified color index with the given color and updates the</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span><span class="preprocessor">  # widget.</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span>  proc set_color {w index color} {
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     variable data
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 <span class="preprocessor">    # Set the color</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span>    lset data($w,colors) $index $color
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="preprocessor"># Set the preview color</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {$index == 1} {
<a name="l00560"></a>00560       $data($w,preview) configure -foreground $color
<a name="l00561"></a>00561     } else {
<a name="l00562"></a>00562       $data($w,preview) configure -background $color
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     <span class="preprocessor"># Set the label background color</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span>    $data($w,c${index}_lbl) configure -background $color
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     # Set the menubutton label
<a name="l00569"></a>00569     $data($w,color$index) configure -text $color
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="preprocessor">    # Update the colors</span>
<a name="l00572"></a>00572 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> <span class="keywordtype">id</span> [$data($w,grid) find withtag s$index] {
<a name="l00573"></a>00573       $data($w,grid) itemconfigure $id -fill $color
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576     <span class="preprocessor"># Generate a BitmapChanged event</span>
<a name="l00577"></a>00577 <span class="preprocessor"></span>    <span class="keyword">event</span> generate $w &lt;&lt;BitmapChanged&gt;&gt; -data [get_info $w]
<a name="l00578"></a>00578 
<a name="l00579"></a>00579   }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581 <span class="preprocessor">  ######################################################################</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span><span class="preprocessor">  # Prompts the user for a file to import and updates the UI based on</span>
<a name="l00583"></a>00583 <span class="preprocessor"></span><span class="preprocessor">  # the read in file and type specified.</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span>  proc <span class="keyword">import</span> {w vec} {
<a name="l00585"></a>00585 
<a name="l00586"></a>00586     variable data
<a name="l00587"></a>00587 
<a name="l00588"></a>00588 <span class="preprocessor">    # Prompt the user for a BMP filename</span>
<a name="l00589"></a>00589 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> fname [tk_getOpenFile -parent $w -filetypes {{{Bitmap files} {.bmp}}}]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 <span class="preprocessor">      # Open the file for reading</span>
<a name="l00592"></a>00592 <span class="preprocessor"></span>      <span class="keywordflow">if</span> {[<span class="keywordflow">catch</span> { open $fname r } rc]} {
<a name="l00593"></a>00593         <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;Unable to open $fname for reading&quot;</span>
<a name="l00594"></a>00594       }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596 <span class="preprocessor">      # Get the file content</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span>      <span class="keyword">set</span> content [read $rc]
<a name="l00598"></a>00598       close $rc
<a name="l00599"></a>00599 
<a name="l00600"></a>00600 <span class="preprocessor">      # Update the UI</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span>      array <span class="keyword">set</span> info [get_info $w]
<a name="l00602"></a>00602       <span class="keywordflow">if</span> {$vec &amp; 0x1} {
<a name="l00603"></a>00603         <span class="keyword">set</span> info(dat) $content
<a name="l00604"></a>00604       }
<a name="l00605"></a>00605       if {$vec &amp; 0x2} {
<a name="l00606"></a>00606         <span class="keyword">set</span> info(msk) $content
<a name="l00607"></a>00607       }
<a name="l00608"></a>00608       if {[<span class="keywordflow">catch</span> { set_from_info $w [array <span class="keyword">get</span> info] } rc]} {
<a name="l00609"></a>00609         tk_messageBox -parent $w -icon error -message <span class="stringliteral">&quot;Unable to parse BMP file $fname&quot;</span>
<a name="l00610"></a>00610       }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612 <span class="preprocessor">      # Generate the event</span>
<a name="l00613"></a>00613 <span class="preprocessor"></span>      <span class="keyword">event</span> generate $w &lt;&lt;BitmapChanged&gt;&gt; -data [array <span class="keyword">get</span> info]
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617   }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 <span class="preprocessor">  ######################################################################</span>
<a name="l00620"></a>00620 <span class="preprocessor"></span><span class="preprocessor">  # Exports the current bitmap information to a file.  The value of type</span>
<a name="l00621"></a>00621 <span class="preprocessor"></span><span class="preprocessor">  # can be &#39;data&#39; or &#39;mask&#39;.</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span>  proc export {w type} {
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="preprocessor">    # Prompt the user for a BMP filename to save to</span>
<a name="l00625"></a>00625 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[<span class="keyword">set</span> fname [tk_getSaveFile -parent $w -filetypes {{{Bitmap files} {.bmp}}}]] ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 <span class="preprocessor">      # Open the file for writing</span>
<a name="l00628"></a>00628 <span class="preprocessor"></span>      <span class="keywordflow">if</span> {[<span class="keywordflow">catch</span> { open $fname w } rc]} {
<a name="l00629"></a>00629         <span class="keywordflow">return</span> -code error <span class="stringliteral">&quot;Unable to open $fname for writing&quot;</span>
<a name="l00630"></a>00630       }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 <span class="preprocessor">      # Get the bitmap information</span>
<a name="l00633"></a>00633 <span class="preprocessor"></span>      array <span class="keyword">set</span> info [get_info $w]
<a name="l00634"></a>00634 
<a name="l00635"></a>00635 <span class="preprocessor">      # Write the information</span>
<a name="l00636"></a>00636 <span class="preprocessor"></span>      <span class="keywordflow">if</span> {$type eq <span class="stringliteral">&quot;data&quot;</span>} {
<a name="l00637"></a>00637         puts $rc $info(dat)
<a name="l00638"></a>00638       } <span class="keywordflow">else</span> {
<a name="l00639"></a>00639         puts $rc $info(msk)
<a name="l00640"></a>00640       }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 <span class="preprocessor">      # Close the file</span>
<a name="l00643"></a>00643 <span class="preprocessor"></span>      close $rc
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 <span class="preprocessor">  ######################################################################</span>
<a name="l00650"></a>00650 <span class="preprocessor"></span><span class="preprocessor">  # Counts the number of blanks for the given orientation.</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span>  proc count_blanks {w orient rows cols} {
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     variable data
<a name="l00654"></a>00654 
<a name="l00655"></a>00655     <span class="keyword">set</span> blanks 0
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     <span class="keywordflow">if</span> {$orient eq <span class="stringliteral">&quot;row&quot;</span>} {
<a name="l00658"></a>00658       <span class="keywordflow">foreach</span> row $rows {
<a name="l00659"></a>00659         <span class="keywordflow">foreach</span> col $cols {
<a name="l00660"></a>00660           <span class="keywordflow">if</span> {[$data($w,grid) itemcget $data($w,$row,$col) -tags] ne &quot;s0&quot;} {
<a name="l00661"></a>00661             <span class="keywordflow">return</span> $blanks
<a name="l00662"></a>00662           }
<a name="l00663"></a>00663         }
<a name="l00664"></a>00664         incr blanks
<a name="l00665"></a>00665       }
<a name="l00666"></a>00666     } <span class="keywordflow">else</span> {
<a name="l00667"></a>00667       <span class="keywordflow">foreach</span> col $cols {
<a name="l00668"></a>00668         <span class="keywordflow">foreach</span> row $rows {
<a name="l00669"></a>00669           <span class="keywordflow">if</span> {[$data($w,grid) itemcget $data($w,$row,$col) -tags] ne &quot;s0&quot;} {
<a name="l00670"></a>00670             <span class="keywordflow">return</span> $blanks
<a name="l00671"></a>00671           }
<a name="l00672"></a>00672         }
<a name="l00673"></a>00673         incr blanks
<a name="l00674"></a>00674       }
<a name="l00675"></a>00675     }
<a name="l00676"></a>00676 
<a name="l00677"></a>00677     <span class="keywordflow">return</span> $blanks
<a name="l00678"></a>00678 
<a name="l00679"></a>00679   }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 <span class="preprocessor">  ######################################################################</span>
<a name="l00682"></a>00682 <span class="preprocessor"></span><span class="preprocessor">  # Moves all of the pixels in the canvas in the given direction by one</span>
<a name="l00683"></a>00683 <span class="preprocessor"></span><span class="preprocessor">  # pixel.</span>
<a name="l00684"></a>00684 <span class="preprocessor"></span>  proc move {w dir} {
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     variable data
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     <span class="keyword">set</span> row_adjust 0
<a name="l00689"></a>00689     <span class="keyword">set</span> col_adjust 0
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; $data($w,-height)} {incr i} { lappend rows $i }
<a name="l00692"></a>00692     <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; $data($w,-width)}  {incr i} { lappend cols $i }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="keywordflow">switch</span> $dir {
<a name="l00695"></a>00695       up     { <span class="keyword">set</span> row_adjust  1 }
<a name="l00696"></a>00696       down   { <span class="keyword">set</span> row_adjust -1; <span class="keyword">set</span> rows [lreverse $rows] }
<a name="l00697"></a>00697       left   { <span class="keyword">set</span> col_adjust  1 }
<a name="l00698"></a>00698       right  { <span class="keyword">set</span> col_adjust -1; <span class="keyword">set</span> cols [lreverse $cols] }
<a name="l00699"></a>00699       center {
<a name="l00700"></a>00700         <span class="keyword">set</span> top    [count_blanks $w row $rows $cols]
<a name="l00701"></a>00701         <span class="keyword">set</span> bottom [count_blanks $w row [lreverse $rows] $cols]
<a name="l00702"></a>00702         <span class="keyword">set</span> left   [count_blanks $w col $rows $cols]
<a name="l00703"></a>00703         <span class="keyword">set</span> right  [count_blanks $w col $rows [lreverse $cols]]
<a name="l00704"></a>00704         <span class="keywordflow">if</span> {[<span class="keyword">set</span> row_adjust [expr $top - (($top + $bottom) / 2)]] &lt; 0} {
<a name="l00705"></a>00705           <span class="keyword">set</span> rows [lreverse $rows]
<a name="l00706"></a>00706         }
<a name="l00707"></a>00707         <span class="keywordflow">if</span> {[<span class="keyword">set</span> col_adjust [expr $left - (($left + $right) / 2)]] &lt; 0} {
<a name="l00708"></a>00708           <span class="keyword">set</span> cols [lreverse $cols]
<a name="l00709"></a>00709         }
<a name="l00710"></a>00710         <span class="keywordflow">if</span> {($row_adjust == 0) &amp;&amp; ($col_adjust == 0)} {
<a name="l00711"></a>00711           <span class="keywordflow">return</span>
<a name="l00712"></a>00712         }
<a name="l00713"></a>00713       }
<a name="l00714"></a>00714     }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="keywordflow">foreach</span> row $rows {
<a name="l00717"></a>00717       <span class="keyword">set</span> old_row [expr $row + $row_adjust]
<a name="l00718"></a>00718       <span class="keywordflow">foreach</span> col $cols {
<a name="l00719"></a>00719         <span class="keyword">set</span> old_col [expr $col + $col_adjust]
<a name="l00720"></a>00720         <span class="keywordflow">if</span> {($old_row &lt; 0) || ($old_row &gt;= $data($w,-height)) || ($old_col &lt; 0) || ($old_col &gt;= $data($w,-width))} {
<a name="l00721"></a>00721           $data($w,grid) itemconfigure $data($w,$row,$col) -fill &quot;&quot; -tags s0
<a name="l00722"></a>00722         } else {
<a name="l00723"></a>00723           $data($w,grid) itemconfigure $data($w,$row,$col) \
<a name="l00724"></a>00724             -fill [$data($w,grid) itemcget $data($w,$old_row,$old_col) -fill] \
<a name="l00725"></a>00725             -tags [$data($w,grid) itemcget $data($w,$old_row,$old_col) -tags]
<a name="l00726"></a>00726         }
<a name="l00727"></a>00727       }
<a name="l00728"></a>00728     }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="preprocessor"># Update the preview</span>
<a name="l00731"></a>00731 <span class="preprocessor"></span>    array <span class="keyword">set</span> info [get_info $w]
<a name="l00732"></a>00732     $data($w,preview) configure -data $info(dat) -maskdata $info(msk)
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     <span class="preprocessor"># Generate the event</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span>    <span class="keyword">event</span> generate $w &lt;&lt;BitmapChanged&gt;&gt; -data [array <span class="keyword">get</span> info]
<a name="l00736"></a>00736 
<a name="l00737"></a>00737   }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 <span class="preprocessor">  ######################################################################</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span><span class="preprocessor">  # Flips the image horizontally or vertically.</span>
<a name="l00741"></a>00741 <span class="preprocessor"></span>  proc flip {w orient} {
<a name="l00742"></a>00742 
<a name="l00743"></a>00743     variable data
<a name="l00744"></a>00744 
<a name="l00745"></a>00745     <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; $data($w,-height)} {incr i} { lappend rows $i }
<a name="l00746"></a>00746     <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; $data($w,-width)}  {incr i} { lappend cols $i }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     <span class="keywordflow">if</span> {$orient eq <span class="stringliteral">&quot;vertical&quot;</span>} {
<a name="l00749"></a>00749       <span class="keywordflow">foreach</span> row $rows {
<a name="l00750"></a>00750         <span class="keywordflow">foreach</span> lcol $cols rcol [lreverse $cols] {
<a name="l00751"></a>00751           <span class="keywordflow">if</span> {$lcol &gt;= $rcol} {
<a name="l00752"></a>00752             <span class="keywordflow">break</span>
<a name="l00753"></a>00753           } <span class="keywordflow">else</span> {
<a name="l00754"></a>00754             <span class="keyword">set</span> fill [$data($w,grid) itemcget $data($w,$row,$lcol) -fill]
<a name="l00755"></a>00755             set tags [$data($w,grid) itemcget $data($w,$row,$lcol) -tags]
<a name="l00756"></a>00756             $data($w,grid) itemconfigure $data($w,$row,$lcol) \
<a name="l00757"></a>00757               -fill [$data($w,grid) itemcget $data($w,$row,$rcol) -fill] \
<a name="l00758"></a>00758               -tags [$data($w,grid) itemcget $data($w,$row,$rcol) -tags]
<a name="l00759"></a>00759             $data($w,grid) itemconfigure $data($w,$row,$rcol) -fill $fill -tags $tags
<a name="l00760"></a>00760           }
<a name="l00761"></a>00761         }
<a name="l00762"></a>00762       }
<a name="l00763"></a>00763     } else {
<a name="l00764"></a>00764       <span class="keywordflow">foreach</span> col $cols {
<a name="l00765"></a>00765         <span class="keywordflow">foreach</span> trow $rows brow [lreverse $rows] {
<a name="l00766"></a>00766           <span class="keywordflow">if</span> {$trow &gt;= $brow} {
<a name="l00767"></a>00767             <span class="keywordflow">break</span>
<a name="l00768"></a>00768           } <span class="keywordflow">else</span> {
<a name="l00769"></a>00769             <span class="keyword">set</span> fill [$data($w,grid) itemcget $data($w,$trow,$col) -fill]
<a name="l00770"></a>00770             set tags [$data($w,grid) itemcget $data($w,$trow,$col) -tags]
<a name="l00771"></a>00771             $data($w,grid) itemconfigure $data($w,$trow,$col) \
<a name="l00772"></a>00772               -fill [$data($w,grid) itemcget $data($w,$brow,$col) -fill] \
<a name="l00773"></a>00773               -tags [$data($w,grid) itemcget $data($w,$brow,$col) -tags]
<a name="l00774"></a>00774             $data($w,grid) itemconfigure $data($w,$brow,$col) -fill $fill -tags $tags
<a name="l00775"></a>00775           }
<a name="l00776"></a>00776         }
<a name="l00777"></a>00777       }
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780     <span class="preprocessor"># Update the preview</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>    array <span class="keyword">set</span> info [get_info $w]
<a name="l00782"></a>00782     $data($w,preview) configure -data $info(dat) -maskdata $info(msk)
<a name="l00783"></a>00783 
<a name="l00784"></a>00784     <span class="preprocessor"># Generate the event</span>
<a name="l00785"></a>00785 <span class="preprocessor"></span>    <span class="keyword">event</span> generate $w &lt;&lt;BitmapChanged&gt;&gt; -data [array <span class="keyword">get</span> info]
<a name="l00786"></a>00786 
<a name="l00787"></a>00787   }
<a name="l00788"></a>00788 
<a name="l00789"></a>00789 <span class="preprocessor">  ######################################################################</span>
<a name="l00790"></a>00790 <span class="preprocessor"></span><span class="preprocessor">  # Rotates the image by 90 degrees.</span>
<a name="l00791"></a>00791 <span class="preprocessor"></span>  proc rotate {w} {
<a name="l00792"></a>00792 
<a name="l00793"></a>00793     variable data
<a name="l00794"></a>00794 
<a name="l00795"></a>00795     <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; $data($w,-height)} {incr i} { lappend rows $i }
<a name="l00796"></a>00796     <span class="keywordflow">for</span> {<span class="keyword">set</span> i 0} {$i &lt; $data($w,-width)}  {incr i} { lappend cols $i }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798 <span class="preprocessor">    # Copy the image to a source array and clear the destination</span>
<a name="l00799"></a>00799 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> row $rows {
<a name="l00800"></a>00800       <span class="keyword">set</span> src_row [list]
<a name="l00801"></a>00801       <span class="keywordflow">foreach</span> col $cols {
<a name="l00802"></a>00802         lappend src_row [list -fill [$data($w,grid) itemcget $data($w,$row,$col) -fill] -tags [$data($w,grid) itemcget $data($w,$row,$col) -tags]]
<a name="l00803"></a>00803         $data($w,grid) itemconfigure $data($w,$row,$col) -fill &quot;&quot; -tags &quot;&quot;
<a name="l00804"></a>00804       }
<a name="l00805"></a>00805       lappend src $src_row
<a name="l00806"></a>00806     }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     foreach col $cols src_row $rows {
<a name="l00809"></a>00809       <span class="keywordflow">if</span> {($col eq <span class="stringliteral">&quot;&quot;</span>) || ($src_row eq <span class="stringliteral">&quot;&quot;</span>)} {
<a name="l00810"></a>00810         <span class="keywordflow">return</span>
<a name="l00811"></a>00811       }
<a name="l00812"></a>00812       <span class="keywordflow">foreach</span> row [lreverse $rows] src_col $cols {
<a name="l00813"></a>00813         <span class="keywordflow">if</span> {($row eq <span class="stringliteral">&quot;&quot;</span>) || ($src_col eq <span class="stringliteral">&quot;&quot;</span>)} {
<a name="l00814"></a>00814           <span class="keywordflow">break</span>
<a name="l00815"></a>00815         }
<a name="l00816"></a>00816         $data($w,grid) itemconfigure $data($w,$row,$col) {*}[lindex $src $src_row $src_col]
<a name="l00817"></a>00817       }
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820 <span class="preprocessor">    # Update the preview</span>
<a name="l00821"></a>00821 <span class="preprocessor"></span>    array <span class="keyword">set</span> info [get_info $w]
<a name="l00822"></a>00822     $data($w,preview) configure -data $info(dat) -maskdata $info(msk)
<a name="l00823"></a>00823 
<a name="l00824"></a>00824     <span class="preprocessor"># Generate the event</span>
<a name="l00825"></a>00825 <span class="preprocessor"></span>    <span class="keyword">event</span> generate $w &lt;&lt;BitmapChanged&gt;&gt; -data [array <span class="keyword">get</span> info]
<a name="l00826"></a>00826 
<a name="l00827"></a>00827   }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829 }
<a name="l00830"></a>00830 
<a name="l00831"></a>00831 <span class="keywordflow">if</span> {0} {
<a name="l00832"></a>00832   pack [bitmap::create .bm] -side left
<a name="l00833"></a>00833   <span class="keywordflow">if</span> {![<span class="keywordflow">catch</span> { open images/sopen.bmp r } rc]} {
<a name="l00834"></a>00834     <span class="keyword">set</span> content [read $rc]
<a name="l00835"></a>00835     close $rc
<a name="l00836"></a>00836     bitmap::set_from_info .bm [list fg black bg white dat $content msk $content]
<a name="l00837"></a>00837   }
<a name="l00838"></a>00838 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed Jan 16 08:45:10 2019 for TKE by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
