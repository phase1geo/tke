<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TKE: /Users/trevorw/projects/tke-code/lib/socksend.tcl Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>/Users/trevorw/projects/tke-code/lib/socksend.tcl</h1><a href="socksend_8tcl.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="socksend_8tcl.html#a48ea2ceb8cd93269e5e2a612c6d1cea3">00001</a> <span class="keyword">set</span> <a class="code" href="socksend_8tcl.html#a48ea2ceb8cd93269e5e2a612c6d1cea3">Release</a>(socksend.tcl) {$Header: /home/cvs/tktest/socksend/socksend.tcl,v 1.21 2015/11/16 18:26:15 clif Exp $}
<a name="l00002"></a><a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">00002</a> <span class="keyword">set</span> <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>(debug) 0
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 proc socksendDebug {str} {
<a name="l00005"></a>00005     global <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>
<a name="l00006"></a>00006     <span class="keywordflow">if</span> {!$SockData(debug)} {<span class="keywordflow">return</span>}
<a name="l00007"></a>00007     <span class="keywordflow">if</span> {![info exists <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>(dbgout)]} {
<a name="l00008"></a>00008       <span class="keyword">set</span> <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>(dbgout) [open /tmp/tkreplSS-[pid].txt w]
<a name="l00009"></a>00009     }
<a name="l00010"></a>00010     puts $SockData(dbgout) $str
<a name="l00011"></a>00011     flush $SockData(dbgout)
<a name="l00012"></a>00012 }
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 socksendDebug &quot;I AM: [tk appname] -- [info script]&quot;
<a name="l00015"></a>00015 proc socksendsetup {port} {
<a name="l00016"></a>00016     global <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>
<a name="l00017"></a>00017     <span class="keywordflow">if</span> {[<span class="keywordflow">catch</span> {socket -server sockconnect $port} ret]} {
<a name="l00018"></a>00018         puts stderr <span class="stringliteral">&quot;socksendsetup: (set up server) socket $port failed ($ret)&quot;</span>
<a name="l00019"></a>00019     error $ret $ret
<a name="l00020"></a>00020     }
<a name="l00021"></a>00021 }
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 proc sockconnect {channel hostaddr port} {
<a name="l00024"></a>00024     global <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>
<a name="l00025"></a>00025     global ReplayData
<a name="l00026"></a>00026     <span class="keyword">set</span> name [gets $channel]
<a name="l00027"></a>00027     <span class="keyword">set</span> <span class="keywordtype">id</span> $name
<a name="l00028"></a>00028     <span class="keyword">set</span> <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>($id,channel) $channel
<a name="l00029"></a>00029 
<a name="l00030"></a>00030     fileevent $channel readable &quot;sockreceive $channel&quot;
<a name="l00031"></a>00031     after 500 [list ConnectToApp $id]
<a name="l00032"></a>00032 }
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 proc sockreceive {channel} {
<a name="l00035"></a>00035     global ReplayData
<a name="l00036"></a>00036     global <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038     <span class="keywordflow">if</span> [eof $channel] {
<a name="l00039"></a>00039         close $channel
<a name="l00040"></a>00040 
<a name="l00041"></a>00041         <span class="keyword">set</span> ReplayData(ConnectedApps) {}
<a name="l00042"></a>00042         <span class="keyword">set</span> ReplayData(Status) Disconnected
<a name="l00043"></a>00043     
<a name="l00044"></a>00044         return
<a name="l00045"></a>00045     }
<a name="l00046"></a>00046     set line [gets $channel]
<a name="l00047"></a>00047     socksendDebug &quot;READ: $line&quot;
<a name="l00048"></a>00048     append <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>($channel,Command) $line\n
<a name="l00049"></a>00049     if {[info complete $SockData($channel,Command)]} {
<a name="l00050"></a>00050 <span class="preprocessor">      # processData might not return quickly - if</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">      # there is a vwait in the command invoked, for instance.</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">      #  Must clear that data buffer before invoking this to avoid</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">      # multiple copies of the command being invoked.</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055       <span class="keyword">set</span> data $SockData($channel,Command)
<a name="l00056"></a>00056       set <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>($channel,Command) &quot;&quot;
<a name="l00057"></a>00057       processData $data
<a name="l00058"></a>00058     }
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 proc processData {data} {
<a name="l00062"></a>00062   socksendDebug <span class="stringliteral">&quot;PROCESS: $data&quot;</span>
<a name="l00063"></a>00063   <span class="keyword">set</span> fail [<span class="keywordflow">catch</span> {uplevel #0 $data} rtn]
<a name="l00064"></a>00064   <span class="keywordflow">if</span> {$fail} {
<a name="l00065"></a>00065 <span class="preprocessor">      # Sigh.  I don&#39;t like putting a call to higher level</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="preprocessor">      #  code in a low level function, but there&#39;s no good way</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">      #  to pass the error condition back up to application code</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">      #  from a function invoked from the event loop.</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>      socksendDebug <span class="stringliteral">&quot;ERROR: $data \n  Rtn: $rtn&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">      # RemoteMsgToUser &quot;ERROR: $data \n  Rtn: $rtn&quot; high</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>  }
<a name="l00072"></a>00072 }
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 proc sockappsetup {his_name his_port {his_addr localhost}} {
<a name="l00075"></a>00075     socksendDebug <span class="stringliteral">&quot;his_name: $his_name his_port $his_port his_addr: $his_addr&quot;</span>
<a name="l00076"></a>00076     global <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>
<a name="l00077"></a>00077     <span class="keyword">set</span> count 0
<a name="l00078"></a>00078     <span class="keywordflow">while</span> {[<span class="keywordflow">catch</span> {socket $his_addr $his_port} ch]} {
<a name="l00079"></a>00079        incr count
<a name="l00080"></a>00080        <span class="keywordflow">if</span> {$count &gt; 20} {
<a name="l00081"></a>00081            tk_messageBox -type ok -message <span class="stringliteral">&quot;Unable to contact $his_name ($his_port at $his_addr)&quot;</span>
<a name="l00082"></a>00082        exit
<a name="l00083"></a>00083        }
<a name="l00084"></a>00084        after 1000
<a name="l00085"></a>00085     }
<a name="l00086"></a>00086     fileevent $ch readable <span class="stringliteral">&quot;sockreceive $ch&quot;</span>
<a name="l00087"></a>00087     <span class="keyword">set</span> <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>($his_name,channel) $ch
<a name="l00088"></a>00088 <span class="preprocessor">#    puts $ch [file tail [info script]]</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>    puts $ch [tk appname]
<a name="l00090"></a>00090     flush $ch
<a name="l00091"></a>00091     socksendDebug <span class="stringliteral">&quot;OPENED CLIENT SOCKET as [tk appname]&quot;</span>
<a name="l00092"></a>00092 }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 proc tkrsend {args} {
<a name="l00095"></a>00095    <span class="keywordflow">return</span> [eval socksend $args]
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 proc tkerror {msg} {
<a name="l00099"></a>00099   puts <span class="stringliteral">&quot;TKERROR: $msg&quot;</span>
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 proc socksendopen {<span class="keywordtype">id</span> port {host localhost}} {
<a name="l00103"></a>00103     global <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>
<a name="l00104"></a>00104     <span class="keyword">set</span> <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>($id,channel) [socket $host $port]
<a name="l00105"></a>00105     fileevent $ch readable <span class="stringliteral">&quot;sockreceive $SockData($id,channel)&quot;</span>
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 proc socksend {args} {
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     global ReplayData
<a name="l00111"></a>00111     global <a class="code" href="socksend_8tcl.html#aaa51854a095ba15d00786b28f5d5b385">SockData</a>
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="keywordflow">if</span> {[info exists ReplayData(RecordingOn)] &amp;&amp;
<a name="l00114"></a>00114         ($ReplayData(RecordingOn) ==1)} {
<a name="l00115"></a>00115       whereAmI-Server
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     <span class="keywordflow">if</span> {[<span class="keywordtype">string</span> first <span class="stringliteral">&quot;-a&quot;</span> $args] == 0} {
<a name="l00119"></a>00119         <span class="keyword">set</span> args [<span class="keywordtype">string</span> trim [<span class="keywordtype">string</span> range $args 6 end]]
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121     lassign $args key val
<a name="l00122"></a>00122     <span class="keyword">set</span> key [concat {*}$key]
<a name="l00123"></a>00123     socksendDebug <span class="stringliteral">&quot;SOCKSEND: $args -- $key -- $val&quot;</span>
<a name="l00124"></a>00124     <span class="keywordflow">if</span> {([<span class="keywordtype">string</span> first Destroy $val]  &gt; 0) &amp;&amp;
<a name="l00125"></a>00125         ([<span class="keywordtype">string</span> first <span class="stringliteral">&quot;MsgToU&quot;</span> $val] &lt; 0)} {
<a name="l00126"></a>00126         <span class="keywordflow">if</span> {![<span class="keywordtype">string</span> equal <span class="stringliteral">&quot;&quot;</span> [info procs whereAmI-Client]]} {
<a name="l00127"></a>00127       whereAmI-Client
<a name="l00128"></a>00128     }
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130     socksendDebug <span class="stringliteral">&quot;SOCKSEND: puts $SockData($key,channel) &#39;$val&#39;&quot;</span>
<a name="l00131"></a>00131     puts $SockData($key,channel) $val
<a name="l00132"></a>00132     flush $SockData($key,channel)
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 proc GetUniqueSocketId {} {
<a name="l00136"></a>00136   error GetUniqueSocketId
<a name="l00137"></a>00137 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed Jan 16 08:45:10 2019 for TKE by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
