<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>TKE: /Users/trevorw/projects/tke-code/lib/snippets.tcl Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>/Users/trevorw/projects/tke-code/lib/snippets.tcl</h1><a href="snippets_8tcl.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor"># Name:    snippets.tcl</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># Author:  Trevor Williams  (phase1geo@gmail.com)</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Date:    5/11/2013</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># Brief:   Namespace containing functionality to support snippets</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span>
<a name="l00006"></a><a class="code" href="namespacesnippets.html">00006</a> <span class="keyword">namespace </span>eval snippets {
<a name="l00007"></a>00007 
<a name="l00008"></a>00008   source [file join $::tke_dir lib ns.tcl]
<a name="l00009"></a>00009     
<a name="l00010"></a>00010   variable snippets_dir [file join $::tke_home snippets]
<a name="l00011"></a>00011 
<a name="l00012"></a>00012   array <span class="keyword">set</span> widgets  {}
<a name="l00013"></a>00013   array <span class="keyword">set</span> snippets {}
<a name="l00014"></a>00014   array <span class="keyword">set</span> within   {}
<a name="l00015"></a>00015   
<a name="l00016"></a>00016 <span class="preprocessor">  ######################################################################</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="preprocessor">  # Loads the snippet information.</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span>  proc load {} {
<a name="l00019"></a>00019   
<a name="l00020"></a>00020     variable snippets_dir
<a name="l00021"></a>00021     
<a name="l00022"></a>00022 <span class="preprocessor">    # If the snippets directory does not exist, create it</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {![file exists $snippets_dir]} {
<a name="l00024"></a>00024       file mkdir $snippets_dir
<a name="l00025"></a>00025     }
<a name="l00026"></a>00026     
<a name="l00027"></a>00027   }
<a name="l00028"></a>00028   
<a name="l00029"></a>00029 <span class="preprocessor">  ######################################################################</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="preprocessor">  # Reloads the current snippet.</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>  proc reload_snippets {} {
<a name="l00032"></a>00032     
<a name="l00033"></a>00033 <span class="preprocessor">    # Get the current language</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>    <span class="keyword">set</span> language [syntax::get_current_language [gui::current_txt $tid]]
<a name="l00035"></a>00035     
<a name="l00036"></a>00036 <span class="preprocessor">    # Reload the snippet file for the current language</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>    set_language $language
<a name="l00038"></a>00038     
<a name="l00039"></a>00039   }
<a name="l00040"></a>00040   
<a name="l00041"></a>00041 <span class="preprocessor">  ######################################################################</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">  # Load the snippets file.</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span>  proc set_language {language} {
<a name="l00044"></a>00044     
<a name="l00045"></a>00045     variable snippets_dir
<a name="l00046"></a>00046     variable snippets
<a name="l00047"></a>00047     
<a name="l00048"></a>00048 <span class="preprocessor">    # Create language-specific snippets filename</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span>    <span class="keyword">set</span> sfile [file join $snippets_dir $language.snippets]
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">    # Clear the snippets for the given file</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>    array unset snippets $language,*
<a name="l00053"></a>00053       
<a name="l00054"></a>00054 <span class="preprocessor">    # Remove any launcher commands that would be associated with this file</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>    [ns launcher]::unregister [msgcat::mc <span class="stringliteral">&quot;Snippet: *&quot;</span>]
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     <span class="keywordflow">if</span> {![<span class="keywordflow">catch</span> { open $sfile r } rc]} {
<a name="l00058"></a>00058       
<a name="l00059"></a>00059 <span class="preprocessor">      # Read the contents of the snippets file</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>      <span class="keyword">set</span> contents [read $rc]
<a name="l00061"></a>00061       close $rc
<a name="l00062"></a>00062       
<a name="l00063"></a>00063       <span class="keyword">set</span> in_snippet 0
<a name="l00064"></a>00064      
<a name="l00065"></a>00065 <span class="preprocessor">      # Do a quick parse of the snippets file</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>      <span class="keywordflow">foreach</span> line [concat [split $contents \n] <span class="stringliteral">&quot;&quot;</span>] {
<a name="l00067"></a>00067         <span class="keywordflow">if</span> {$in_snippet} {
<a name="l00068"></a>00068           <span class="keywordflow">if</span> {[regexp {^\t(.*)$} $line -&gt; txt]} {
<a name="l00069"></a>00069             append snippet <span class="stringliteral">&quot;[string trimright $txt]\n&quot;</span>
<a name="l00070"></a>00070           } <span class="keywordflow">else</span> {
<a name="l00071"></a>00071             <span class="keyword">set</span> in_snippet 0
<a name="l00072"></a>00072             <span class="keywordflow">if</span> {![<span class="keywordflow">catch</span> { parse_snippet [<span class="keywordtype">string</span> range $snippet 0 end-1] } rc]} {
<a name="l00073"></a>00073               <span class="keyword">set</span> snippets($language,$name) $rc
<a name="l00074"></a>00074 <span class="preprocessor">#              array set snip $snippets($language,$name)</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor">#              [ns launcher]::register [msgcat::mc &quot;Snippet: %s: %s&quot; $name [string range $snip(raw_string) 0 30]] \</span>
<a name="l00076"></a>00076 <span class="preprocessor">#                [list [ns snippets]::insert_snippet_into_current {} $snippets($language,$name)] </span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>            }
<a name="l00078"></a>00078           }
<a name="l00079"></a>00079         }
<a name="l00080"></a>00080         <span class="keywordflow">if</span> {[regexp {^snippet\s+(\w+)} $line -&gt; name]} {
<a name="l00081"></a>00081           <span class="keyword">set</span> in_snippet 1
<a name="l00082"></a>00082           <span class="keyword">set</span> snippet    <span class="stringliteral">&quot;&quot;</span>
<a name="l00083"></a>00083         }
<a name="l00084"></a>00084         
<a name="l00085"></a>00085       }
<a name="l00086"></a>00086       
<a name="l00087"></a>00087     }
<a name="l00088"></a>00088     
<a name="l00089"></a>00089   }
<a name="l00090"></a>00090   
<a name="l00091"></a>00091 <span class="preprocessor">  ######################################################################</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">  # Returns a list array containing the information obtained from parsing</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">  # the given snippet.</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>  proc parse_snippet {snippet} {
<a name="l00095"></a>00095     
<a name="l00096"></a>00096     <span class="keyword">set</span> in_dollar  0
<a name="l00097"></a>00097     <span class="keyword">set</span> in_tick    0
<a name="l00098"></a>00098     <span class="keyword">set</span> in_escape  0
<a name="l00099"></a>00099     <span class="keyword">set</span> from_start 0
<a name="l00100"></a>00100     <span class="keyword">set</span> linenum    0
<a name="l00101"></a>00101     <span class="keyword">set</span> shell_str  <span class="stringliteral">&quot;&quot;</span>
<a name="l00102"></a>00102     <span class="keyword">set</span> raw_string <span class="stringliteral">&quot;&quot;</span>
<a name="l00103"></a>00103     <span class="keyword">set</span> tabs       [list]
<a name="l00104"></a>00104     <span class="keyword">set</span> dynamics   [list]
<a name="l00105"></a>00105     
<a name="l00106"></a>00106     <span class="keyword">set</span> i 0
<a name="l00107"></a>00107     <span class="keywordflow">while</span> {$i &lt; [<span class="keywordtype">string</span> length $snippet]} {
<a name="l00108"></a>00108       
<a name="l00109"></a>00109 <span class="preprocessor">      # Get the current character</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>      <span class="keyword">set</span> <span class="keywordtype">char</span> [<span class="keywordtype">string</span> index $snippet $i]
<a name="l00111"></a>00111       
<a name="l00112"></a>00112 <span class="preprocessor">      # We have found a dollar sign</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>      <span class="keywordflow">if</span> {!$in_escape &amp;&amp; !$in_tick &amp;&amp; ($char eq <span class="stringliteral">&quot;\$&quot;</span>)} {
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="preprocessor">        # Handle a tab stop</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>        <span class="keywordflow">if</span> {[regexp {^(\d+)} [<span class="keywordtype">string</span> range $snippet [expr $i + 1] end] -&gt; number]} {
<a name="l00117"></a>00117           <span class="keywordflow">if</span> {![info exists tabstop_string($number)]} {
<a name="l00118"></a>00118             lappend tabs [list snippet_mark_$number $from_start [expr $from_start + 1]]
<a name="l00119"></a>00119           } <span class="keywordflow">else</span> {
<a name="l00120"></a>00120             lappend tabs [list snippet_mirror_$number $from_start [expr $from_start + [<span class="keywordtype">string</span> length $tabstop_string($number)]]]
<a name="l00121"></a>00121             append raw_string $tabstop_string($number)
<a name="l00122"></a>00122             incr from_start [<span class="keywordtype">string</span> length $tabstop_string($number)]
<a name="l00123"></a>00123           }
<a name="l00124"></a>00124           incr i [<span class="keywordtype">string</span> length $number]
<a name="l00125"></a>00125           
<a name="l00126"></a>00126 <span class="preprocessor">        # Handle a single variable substitution</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span>        } elseif {[regexp {^(\w+)} [<span class="keywordtype">string</span> range $snippet [expr $i + 1] end] -&gt; varname]} {
<a name="l00128"></a>00128           
<a name="l00129"></a>00129           lappend dynamics [list var $varname $from_start <span class="stringliteral">&quot;&quot;</span>]
<a name="l00130"></a>00130           incr i [<span class="keywordtype">string</span> length $varname]
<a name="l00131"></a>00131           
<a name="l00132"></a>00132         } <span class="keywordflow">else</span> {
<a name="l00133"></a>00133           incr i
<a name="l00134"></a>00134           
<a name="l00135"></a>00135 <span class="preprocessor">          # Handle a more complex dollar operator</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>          <span class="keywordflow">if</span> {[<span class="keywordtype">string</span> index $snippet $i] eq <span class="stringliteral">&quot;\{&quot;</span>} {
<a name="l00137"></a>00137             incr in_dollar
<a name="l00138"></a>00138             incr i
<a name="l00139"></a>00139           
<a name="l00140"></a>00140 <span class="preprocessor">            # Start handling a complex tab stop</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>            <span class="keywordflow">if</span> {[regexp {^(\d+):} [<span class="keywordtype">string</span> range $snippet $i end] -&gt; number]} {
<a name="l00142"></a>00142               <span class="keyword">set</span> dollar($in_dollar,<span class="keywordtype">string</span>)  <span class="stringliteral">&quot;&quot;</span>
<a name="l00143"></a>00143               <span class="keyword">set</span> dollar($in_dollar,start)   $from_start
<a name="l00144"></a>00144               <span class="keyword">set</span> dollar($in_dollar,tabstop) $number
<a name="l00145"></a>00145               incr i [<span class="keywordtype">string</span> length $number]
<a name="l00146"></a>00146               
<a name="l00147"></a>00147 <span class="preprocessor">            # Handle a tab stop mirror</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span>            } elseif {[regexp {^(\d+)/(.*)/(.*)/(.*)} [<span class="keywordtype">string</span> range $snippet $i end] -&gt; number expr format opts]} {
<a name="l00149"></a>00149               <span class="keyword">set</span> dollar($in_dollar,<span class="keywordtype">string</span>)  <span class="stringliteral">&quot;&quot;</span>
<a name="l00150"></a>00150               <span class="keyword">set</span> dollar($in_dollar,start)   $from_start
<a name="l00151"></a>00151               <span class="keyword">set</span> dollar($in_dollar,tabstop) $number
<a name="l00152"></a>00152               <span class="keyword">set</span> dollar($in_dollar,regsub)  [list $expr $format $opts]
<a name="l00153"></a>00153               incr i [expr [<span class="keywordtype">string</span> length $number] + [<span class="keywordtype">string</span> length $expr] + [<span class="keywordtype">string</span> length $format] + [<span class="keywordtype">string</span> length $opts] + 3]
<a name="l00154"></a>00154               
<a name="l00155"></a>00155 <span class="preprocessor">            # Start handling a complex variable substitution  </span>
<a name="l00156"></a>00156 <span class="preprocessor"></span>            } elseif {[regexp {^(\w+):} [<span class="keywordtype">string</span> range $snippet $i end] -&gt; varname]} {
<a name="l00157"></a>00157               <span class="keyword">set</span> dollar($in_dollar,<span class="keywordtype">string</span>)  <span class="stringliteral">&quot;&quot;</span>
<a name="l00158"></a>00158               <span class="keyword">set</span> dollar($in_dollar,start)   $from_start
<a name="l00159"></a>00159               <span class="keyword">set</span> dollar($in_dollar,varname) $varname
<a name="l00160"></a>00160               incr i [<span class="keywordtype">string</span> length $varname]
<a name="l00161"></a>00161               
<a name="l00162"></a>00162 <span class="preprocessor">            # Handle a variable with regular expression substitution</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>            } elseif {[regexp {^(\w+)/(.*)/(.*)/(.*)} [<span class="keywordtype">string</span> range $snippet $i end] -&gt; varname expr format opts]} {
<a name="l00164"></a>00164               <span class="keyword">set</span> dollar($in_dollar,<span class="keywordtype">string</span>)  <span class="stringliteral">&quot;&quot;</span>
<a name="l00165"></a>00165               <span class="keyword">set</span> dollar($in_dollar,start)   $from_start
<a name="l00166"></a>00166               <span class="keyword">set</span> dollar($in_dollar,varname) $varname
<a name="l00167"></a>00167               <span class="keyword">set</span> dollar($in_dollar,regsub)  [list $expr $format $opts]
<a name="l00168"></a>00168               incr i [expr [<span class="keywordtype">string</span> length $varname] + [<span class="keywordtype">string</span> length $expr] + [<span class="keywordtype">string</span> length $format] + [<span class="keywordtype">string</span> length $opts] + 3]
<a name="l00169"></a>00169             }
<a name="l00170"></a>00170             
<a name="l00171"></a>00171           }
<a name="l00172"></a>00172           
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174         
<a name="l00175"></a>00175 <span class="preprocessor">      # We have found an unescaped right brace</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span>      } elseif {$in_dollar &amp;&amp; !$in_escape &amp;&amp; ($char eq <span class="stringliteral">&quot;\}&quot;</span>)} {
<a name="l00177"></a>00177         <span class="keywordflow">if</span> {[info exists dollar($in_dollar,varname)]} {
<a name="l00178"></a>00178           lappend dynamics [list var $dollar($in_dollar,varname) $dollar($in_dollar,start) $dollar($in_dollar,<span class="keywordtype">string</span>)]
<a name="l00179"></a>00179         } <span class="keywordflow">else</span> {
<a name="l00180"></a>00180           <span class="keyword">set</span> tabstop_string($dollar($in_dollar,tabstop)) $dollar($in_dollar,<span class="keywordtype">string</span>)
<a name="l00181"></a>00181           lappend tabs [list snippet_sel_$dollar($in_dollar,tabstop) $dollar($in_dollar,start) [expr $dollar($in_dollar,start) + [<span class="keywordtype">string</span> length $dollar($in_dollar,<span class="keywordtype">string</span>)]]]
<a name="l00182"></a>00182         }
<a name="l00183"></a>00183         array unset dollar $in_dollar,*
<a name="l00184"></a>00184         incr in_dollar -1
<a name="l00185"></a>00185         
<a name="l00186"></a>00186 <span class="preprocessor">      # We have found a tick, se we are either starting or stopping a shell command</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>      } elseif {!$in_escape &amp;&amp; ($char eq <span class="stringliteral">&quot;`&quot;</span>)} {
<a name="l00188"></a>00188         <span class="keywordflow">if</span> {$in_tick} {
<a name="l00189"></a>00189           <span class="keyword">set</span> in_tick 0
<a name="l00190"></a>00190           lappend dynamics [list cmd $shell_str $from_start <span class="stringliteral">&quot;&quot;</span>]
<a name="l00191"></a>00191         } <span class="keywordflow">else</span> {
<a name="l00192"></a>00192           <span class="keyword">set</span> in_tick    1
<a name="l00193"></a>00193           <span class="keyword">set</span> sub_string <span class="stringliteral">&quot;&quot;</span>
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195         
<a name="l00196"></a>00196 <span class="preprocessor">      # We have found an escape character</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span>      } elseif {!$in_escape &amp;&amp; ($char eq <span class="stringliteral">&quot;\\&quot;</span>)} {
<a name="l00198"></a>00198         <span class="keyword">set</span> in_escape 1
<a name="l00199"></a>00199         
<a name="l00200"></a>00200 <span class="preprocessor">      # We are in a shell command</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>      } elseif {$in_tick} {
<a name="l00202"></a>00202         append shell_str $char
<a name="l00203"></a>00203         <span class="keyword">set</span> in_escape 0
<a name="l00204"></a>00204         
<a name="l00205"></a>00205 <span class="preprocessor">      # We are in a dollar sign expression</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span>      } elseif {$in_dollar} {
<a name="l00207"></a>00207         append dollar($in_dollar,<span class="keywordtype">string</span>) $char
<a name="l00208"></a>00208         append raw_string $char
<a name="l00209"></a>00209         <span class="keyword">set</span> in_escape 0
<a name="l00210"></a>00210         incr from_start
<a name="l00211"></a>00211         
<a name="l00212"></a>00212 <span class="preprocessor">      # This is just a raw expression</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> {
<a name="l00214"></a>00214         append raw_string [expr {($char eq <span class="stringliteral">&quot;\$&quot;</span>) ? <span class="stringliteral">&quot;\$&quot;</span> : $char}]
<a name="l00215"></a>00215         <span class="keyword">set</span> in_escape 0
<a name="l00216"></a>00216         incr from_start
<a name="l00217"></a>00217       }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219       incr i
<a name="l00220"></a>00220       
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     
<a name="l00223"></a>00223     <span class="keywordflow">return</span> [list raw_string $raw_string tabs $tabs dynamics $dynamics snippet $snippet]   
<a name="l00224"></a>00224     
<a name="l00225"></a>00225   }
<a name="l00226"></a>00226   
<a name="l00227"></a>00227   ######################################################################
<a name="l00228"></a>00228   # Adds the text widget bindings.
<a name="l00229"></a>00229   proc add_bindings {txt} {
<a name="l00230"></a>00230     
<a name="l00231"></a>00231     variable within
<a name="l00232"></a>00232     
<a name="l00233"></a>00233 <span class="preprocessor">    # Initialize the within array</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span>    <span class="keyword">set</span> within($txt.t) 0
<a name="l00235"></a>00235     
<a name="l00236"></a>00236 <span class="preprocessor">    # Bind whitespace</span>
<a name="l00237"></a>00237 <span class="preprocessor"></span>    bind snippet$txt &lt;Key-space&gt; <span class="stringliteral">&quot;if {\[[ns snippets]::check_snippet %W\]} { break }&quot;</span>
<a name="l00238"></a>00238     bind snippet$txt &lt;Return&gt;    <span class="stringliteral">&quot;if {\[[ns snippets]::check_snippet %W\]} { break }&quot;</span>
<a name="l00239"></a>00239     bind snippet$txt &lt;Tab&gt;       <span class="stringliteral">&quot;if {\[[ns snippets]::handle_tab %W\]} { break }&quot;</span>
<a name="l00240"></a>00240     
<a name="l00241"></a>00241     bindtags $txt.t [linsert [bindtags $txt.t] 3 snippet$txt]
<a name="l00242"></a>00242     
<a name="l00243"></a>00243   }
<a name="l00244"></a>00244   
<a name="l00245"></a>00245 <span class="preprocessor">  ######################################################################</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span><span class="preprocessor">  # Handles a tab key event.</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span>  proc handle_tab {W} {
<a name="l00248"></a>00248   
<a name="l00249"></a>00249     <span class="keywordflow">if</span> {![tab_clicked $W]} {
<a name="l00250"></a>00250       <span class="keywordflow">if</span> {![[ns vim]::in_vim_mode $W] &amp;&amp; ![[ns syntax]::get_tabs_allowed [winfo parent $W]]} {
<a name="l00251"></a>00251         $W insert insert [<span class="keywordtype">string</span> repeat <span class="stringliteral">&quot; &quot;</span> [[ns preferences]::get Editor/SpacesPerTab]]
<a name="l00252"></a>00252         <span class="keywordflow">return</span> 1
<a name="l00253"></a>00253       }
<a name="l00254"></a>00254     } <span class="keywordflow">else</span> {
<a name="l00255"></a>00255       <span class="keywordflow">return</span> 1
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257     
<a name="l00258"></a>00258     <span class="keywordflow">return</span> 0
<a name="l00259"></a>00259   
<a name="l00260"></a>00260   }
<a name="l00261"></a>00261   
<a name="l00262"></a>00262 <span class="preprocessor">  ######################################################################</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span><span class="preprocessor">  # Checks the text widget to see if a snippet name was just typed in</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor">  # the text widget.  If it was, delete the string and replace it with</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor">  # the snippet string.</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span>  proc check_snippet {txt} {
<a name="l00267"></a>00267     
<a name="l00268"></a>00268     variable snippets
<a name="l00269"></a>00269     variable within
<a name="l00270"></a>00270     
<a name="l00271"></a>00271 <span class="preprocessor">    # Get the last word</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span>    <span class="keyword">set</span> last_word [<span class="keywordtype">string</span> trim [$txt <span class="keyword">get</span> <span class="stringliteral">&quot;insert-1c wordstart&quot;</span> <span class="stringliteral">&quot;insert-1c wordend&quot;</span>]]
<a name="l00273"></a>00273         
<a name="l00274"></a>00274 <span class="preprocessor">    # If the last word is not a valid word, stop now</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {![regexp {^[a-zA-Z0-9_]+$} $last_word]} {
<a name="l00276"></a>00276       <span class="keywordflow">return</span> 0
<a name="l00277"></a>00277     }
<a name="l00278"></a>00278     
<a name="l00279"></a>00279 <span class="preprocessor">    # If the snippet exists, perform the replacement.</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[llength [<span class="keyword">set</span> snippet [array names snippets *,$last_word]]] == 1} {
<a name="l00281"></a>00281       
<a name="l00282"></a>00282 <span class="preprocessor">      # Delete the last_word</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span>      $txt <span class="keyword">delete</span> <span class="stringliteral">&quot;insert-1c wordstart&quot;</span> <span class="stringliteral">&quot;insert-1c wordend&quot;</span>
<a name="l00284"></a>00284       
<a name="l00285"></a>00285 <span class="preprocessor">      # Insert the new text in its place</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span>      insert_snippet $txt $snippets($snippet)
<a name="l00287"></a>00287       
<a name="l00288"></a>00288       <span class="preprocessor"># Make sure that the whitespace character is not inserted into the widget</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span>      <span class="keywordflow">return</span> 1
<a name="l00290"></a>00290       
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292     
<a name="l00293"></a>00293     <span class="keywordflow">return</span> 0
<a name="l00294"></a>00294     
<a name="l00295"></a>00295   }
<a name="l00296"></a>00296   
<a name="l00297"></a>00297 <span class="preprocessor">  ######################################################################</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span><span class="preprocessor">  # Inserts the given snippet into the text widget, adhering to indentation.</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span>  proc insert_snippet {txt snippet} {
<a name="l00300"></a>00300   
<a name="l00301"></a>00301     variable tabpoints
<a name="l00302"></a>00302     variable within
<a name="l00303"></a>00303     
<a name="l00304"></a>00304 <span class="preprocessor">    # Assign the snippet array information to an array</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>    array <span class="keyword">set</span> snip $snippet
<a name="l00306"></a>00306     
<a name="l00307"></a>00307 <span class="preprocessor">    # Initialize the tabpoints counter</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>    <span class="keyword">set</span> tabpoints($txt) 1
<a name="l00309"></a>00309     <span class="keyword">set</span> within($txt)    0
<a name="l00310"></a>00310     <span class="keyword">set</span> insert_index    [$txt index insert]
<a name="l00311"></a>00311     <span class="keyword">set</span> current_line    [$txt <span class="keyword">get</span> <span class="stringliteral">&quot;insert linestart&quot;</span> <span class="stringliteral">&quot;insert lineend&quot;</span>]
<a name="l00312"></a>00312     
<a name="l00313"></a>00313 <span class="preprocessor">    # Insert the raw string into the text widget</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span>    [winfo parent $txt] insert insert $snip(raw_string)
<a name="l00315"></a>00315     
<a name="l00316"></a>00316     <span class="preprocessor"># Create a tag for the inserted text</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>    $txt tag add snippet_raw $insert_index <span class="stringliteral">&quot;$insert_index+[string length $snip(raw_string)]c&quot;</span>
<a name="l00318"></a>00318     
<a name="l00319"></a>00319 <span class="preprocessor">    # Create the tab point selection tags</span>
<a name="l00320"></a>00320 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> tab $snip(tabs) {
<a name="l00321"></a>00321       $txt tag add [lindex $tab 0] <span class="stringliteral">&quot;$insert_index+[lindex $tab 1]c&quot;</span> <span class="stringliteral">&quot;$insert_index+[lindex $tab 2]c&quot;</span>
<a name="l00322"></a>00322       <span class="keyword">set</span> within($txt) 1
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325 <span class="preprocessor">    # Insert the dynamics into the raw string</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> dynamic [lreverse $snip(dynamics)] {
<a name="l00327"></a>00327       <span class="keywordflow">if</span> {[lindex $dynamic 0] eq <span class="stringliteral">&quot;var&quot;</span>} {
<a name="l00328"></a>00328         <span class="keywordflow">switch</span> [lindex $dynamic 1] {
<a name="l00329"></a>00329           CLIPBOARD      { <span class="keyword">set</span> str [expr {![<span class="keywordflow">catch</span> <span class="stringliteral">&quot;clipboard get&quot;</span> rc] ? $rc : <span class="stringliteral">&quot;&quot;</span>}] }
<a name="l00330"></a>00330           CURRENT_LINE   { <span class="keyword">set</span> str $current_line }
<a name="l00331"></a>00331           CURRENT_WORD   { <span class="keyword">set</span> str [$txt <span class="keyword">get</span> <span class="stringliteral">&quot;insert wordstart&quot;</span> <span class="stringliteral">&quot;insert wordend&quot;</span>] }
<a name="l00332"></a>00332           DIRECTORY      { <span class="keyword">set</span> str [file dirname [gui::current_filename]] }
<a name="l00333"></a>00333           FILEPATH       { <span class="keyword">set</span> str [gui::current_filename] }
<a name="l00334"></a>00334           FILENAME       { <span class="keyword">set</span> str [file tail [gui::current_filename]] }
<a name="l00335"></a>00335           FILENAME_UPPER { <span class="keyword">set</span> str [<span class="keywordtype">string</span> toupper [file tail [gui::current_filename]]] }
<a name="l00336"></a>00336           LINE_INDEX     { <span class="keyword">set</span> str [lindex [split [$txt index insert] .] 1] }
<a name="l00337"></a>00337           LINE_NUMBER    { <span class="keyword">set</span> str [lindex [split [$txt index insert] .] 0] }
<a name="l00338"></a>00338           CURRENT_DATE   { <span class="keyword">set</span> str [clock format [clock seconds] -format <span class="stringliteral">&quot;%m/%d/%Y&quot;</span>] }
<a name="l00339"></a>00339           <span class="keywordflow">default</span>        { <span class="keyword">set</span> str <span class="stringliteral">&quot;&quot;</span> }
<a name="l00340"></a>00340         }
<a name="l00341"></a>00341       } elseif {[lindex $dynamic 0] eq <span class="stringliteral">&quot;cmd&quot;</span>} {
<a name="l00342"></a>00342         <span class="keywordflow">if</span> {[<span class="keywordflow">catch</span> <span class="stringliteral">&quot;exec sh -c [lindex $dynamic 1]&quot;</span> str]} {
<a name="l00343"></a>00343           <span class="keyword">set</span> str <span class="stringliteral">&quot;&quot;</span>
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345       }
<a name="l00346"></a>00346       <span class="keywordflow">if</span> {$str ne <span class="stringliteral">&quot;&quot;</span>} {
<a name="l00347"></a>00347         $txt replace <span class="stringliteral">&quot;$insert_index+[lindex $dynamic 2]c&quot;</span> <span class="stringliteral">&quot;$insert_index+[expr [lindex $dynamic 2] + [string length [lindex $dynamic 3]]]c&quot;</span> $str snippet_raw
<a name="l00348"></a>00348       }
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351 <span class="preprocessor">    # Indent the text</span>
<a name="l00352"></a>00352 <span class="preprocessor"></span>    indent::format_text $txt [$txt index snippet_raw.first] [$txt index snippet_raw.last]
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 <span class="preprocessor">    # Delete the snippet_raw tag</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span>    $txt tag <span class="keyword">delete</span> snippet_raw
<a name="l00356"></a>00356     
<a name="l00357"></a>00357 <span class="preprocessor">    # Start to traverse the snippet</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span>    traverse_snippet $txt
<a name="l00359"></a>00359     
<a name="l00360"></a>00360   }
<a name="l00361"></a>00361   
<a name="l00362"></a>00362 <span class="preprocessor">  ######################################################################</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span><span class="preprocessor">  # Inserts the given snippet into the current text widget, adhering to</span>
<a name="l00364"></a>00364 <span class="preprocessor"></span><span class="preprocessor">  # indentation rules.</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span>  proc insert_snippet_into_current {tid snippet} {
<a name="l00366"></a>00366     
<a name="l00367"></a>00367     insert_snippet [gui::current_txt $tid].t $snippet
<a name="l00368"></a>00368     
<a name="l00369"></a>00369   }
<a name="l00370"></a>00370   
<a name="l00371"></a>00371 <span class="preprocessor">  ######################################################################</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span><span class="preprocessor">  # Handles a tab insertion</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span>  proc tab_clicked {txt} {
<a name="l00374"></a>00374     
<a name="l00375"></a>00375     variable within
<a name="l00376"></a>00376     
<a name="l00377"></a>00377     <span class="keywordflow">if</span> {$within($txt)} {
<a name="l00378"></a>00378       traverse_snippet $txt
<a name="l00379"></a>00379       <span class="keywordflow">return</span> 1
<a name="l00380"></a>00380     } <span class="keywordflow">else</span> {
<a name="l00381"></a>00381       <span class="keywordflow">return</span> [check_snippet $txt]
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383     
<a name="l00384"></a>00384   }
<a name="l00385"></a>00385   
<a name="l00386"></a>00386 <span class="preprocessor">  ######################################################################</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span><span class="preprocessor">  # Moves the insertion cursor or selection to the next position in the</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span><span class="preprocessor">  # snippet.</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span>  proc traverse_snippet {txt} {
<a name="l00390"></a>00390   
<a name="l00391"></a>00391     variable tabpoints
<a name="l00392"></a>00392     variable within
<a name="l00393"></a>00393     variable tabstart
<a name="l00394"></a>00394     
<a name="l00395"></a>00395 <span class="preprocessor">    # Update any mirrored tab points</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[info exists tabstart($txt)]} {
<a name="l00397"></a>00397       <span class="keyword">set</span> mirrored_value [$txt <span class="keyword">get</span> $tabstart($txt) insert]
<a name="l00398"></a>00398       <span class="keywordflow">foreach</span> {endpos startpos} [lreverse [$txt tag ranges snippet_mirror_[expr $tabpoints($txt) - 1]]] {
<a name="l00399"></a>00399         $txt <span class="keyword">delete</span> $startpos $endpos
<a name="l00400"></a>00400         $txt insert $startpos $mirrored_value
<a name="l00401"></a>00401       }
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="preprocessor">    # Remove the selection</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>    $txt tag <span class="keyword">remove</span> sel 1.0 end
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="preprocessor">    # Find the current tab point tag</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {[llength [<span class="keyword">set</span> range [$txt tag ranges snippet_sel_$tabpoints($txt)]]] == 2} {
<a name="l00409"></a>00409       $txt tag add sel {*}$range
<a name="l00410"></a>00410       $txt tag <span class="keyword">delete</span> snippet_sel_$tabpoints($txt)
<a name="l00411"></a>00411       $txt mark <span class="keyword">set</span> insert [lindex $range 1]
<a name="l00412"></a>00412       <span class="keyword">set</span> tabstart($txt) [lindex $range 0]
<a name="l00413"></a>00413     } elseif {[llength [<span class="keyword">set</span> range [$txt tag ranges snippet_mark_$tabpoints($txt)]]] == 2} {
<a name="l00414"></a>00414       $txt mark <span class="keyword">set</span> insert [lindex $range 0]
<a name="l00415"></a>00415       $txt tag <span class="keyword">delete</span> snippet_mark_$tabpoints($txt)
<a name="l00416"></a>00416       <span class="keyword">set</span> tabstart($txt) [lindex $range 0]
<a name="l00417"></a>00417     } elseif {[llength [<span class="keyword">set</span> range [$txt tag ranges snippet_mark_0]]] == 2} {
<a name="l00418"></a>00418       $txt mark <span class="keyword">set</span> insert [lindex $range 0]
<a name="l00419"></a>00419       $txt tag <span class="keyword">delete</span> snippet_mark_0
<a name="l00420"></a>00420       <span class="keyword">set</span> tabstart($txt) [lindex $range 0]
<a name="l00421"></a>00421       <span class="keyword">set</span> within($txt)   0
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423     
<a name="l00424"></a>00424 <span class="preprocessor">    # Increment the tabpoint</span>
<a name="l00425"></a>00425 <span class="preprocessor"></span>    incr tabpoints($txt)
<a name="l00426"></a>00426     
<a name="l00427"></a>00427   }
<a name="l00428"></a>00428   
<a name="l00429"></a>00429 <span class="preprocessor">  ######################################################################</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span><span class="preprocessor">  # If a snippet file does not exist for the current language, creates</span>
<a name="l00431"></a>00431 <span class="preprocessor"></span><span class="preprocessor">  # an empty snippet file in the user&#39;s local snippet directory.  Opens</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span><span class="preprocessor">  # the snippet file for editing.</span>
<a name="l00433"></a>00433 <span class="preprocessor"></span>  proc add_new_snippet {tid} {
<a name="l00434"></a>00434     
<a name="l00435"></a>00435     variable snippets_dir
<a name="l00436"></a>00436     
<a name="l00437"></a>00437 <span class="preprocessor">    # Get the current language</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>    <span class="keyword">set</span> language [syntax::get_current_language [gui::current_txt $tid]]
<a name="l00439"></a>00439     
<a name="l00440"></a>00440 <span class="preprocessor">    # Get the snippet file name</span>
<a name="l00441"></a>00441 <span class="preprocessor"></span>    <span class="keyword">set</span> fname [file join $::tke_home snippets $language.snippets]
<a name="l00442"></a>00442     
<a name="l00443"></a>00443 <span class="preprocessor">    # If the snippet file does not exist, create the file</span>
<a name="l00444"></a>00444 <span class="preprocessor"></span>    <span class="keywordflow">if</span> {![file exists $fname]} {
<a name="l00445"></a>00445       exec touch $fname
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447     
<a name="l00448"></a>00448 <span class="preprocessor">    # Add the snippet file to the editor</span>
<a name="l00449"></a>00449 <span class="preprocessor"></span>    gui::add_file end $fname -sidebar 0 -savecommand [list snippets::set_language $language]
<a name="l00450"></a>00450     
<a name="l00451"></a>00451   }
<a name="l00452"></a>00452   
<a name="l00453"></a>00453 <span class="preprocessor">  ######################################################################</span>
<a name="l00454"></a>00454 <span class="preprocessor"></span><span class="preprocessor">  # Returns the list of snippets</span>
<a name="l00455"></a>00455 <span class="preprocessor"></span>  proc get_current_snippets {} {
<a name="l00456"></a>00456     
<a name="l00457"></a>00457     variable snippets
<a name="l00458"></a>00458     
<a name="l00459"></a>00459 <span class="preprocessor">    # Get the current language</span>
<a name="l00460"></a>00460 <span class="preprocessor"></span>    <span class="keyword">set</span> language [syntax::get_current_language [gui::current_txt {}]]
<a name="l00461"></a>00461     
<a name="l00462"></a>00462     <span class="keyword">set</span> names [list]
<a name="l00463"></a>00463     
<a name="l00464"></a>00464     <span class="keywordflow">foreach</span> name [array names snippets $language,*] {
<a name="l00465"></a>00465       lappend names [list [lindex [split $name ,] 1] $snippets($name)]
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467     
<a name="l00468"></a>00468     <span class="keywordflow">return</span> $names
<a name="l00469"></a>00469     
<a name="l00470"></a>00470   }
<a name="l00471"></a>00471   
<a name="l00472"></a>00472 <span class="preprocessor">  ######################################################################</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span><span class="preprocessor">  # Displays all of the available snippets in the current editor in the</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span><span class="preprocessor">  # command launcher.</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span>  proc show_snippets {} {
<a name="l00476"></a>00476     
<a name="l00477"></a>00477 <span class="preprocessor">    # Add temporary registries to launcher</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span>    <span class="keyword">set</span> i 0
<a name="l00479"></a>00479     <span class="keywordflow">foreach</span> snippet [get_current_snippets] {
<a name="l00480"></a>00480       lassign $snippet name value
<a name="l00481"></a>00481       array <span class="keyword">set</span> snip $value
<a name="l00482"></a>00482       launcher::register_temp <span class="stringliteral">&quot;`SNIPPET:$name&quot;</span> \
<a name="l00483"></a>00483         [list [ns snippets]::insert_snippet_into_current {} $value] \
<a name="l00484"></a>00484         $name $i [list snippets::add_detail $snip(snippet)]
<a name="l00485"></a>00485       incr i
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487     
<a name="l00488"></a>00488 <span class="preprocessor">    # Display the launcher in SNIPPET: mode</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span>    launcher::launch <span class="stringliteral">&quot;`SNIPPET:&quot;</span> 1
<a name="l00490"></a>00490     
<a name="l00491"></a>00491   }
<a name="l00492"></a>00492   
<a name="l00493"></a>00493 <span class="preprocessor">  ######################################################################</span>
<a name="l00494"></a>00494 <span class="preprocessor"></span><span class="preprocessor">  # Adds the given detail</span>
<a name="l00495"></a>00495 <span class="preprocessor"></span>  proc add_detail {str txt} {
<a name="l00496"></a>00496     
<a name="l00497"></a>00497     $txt insert end $str
<a name="l00498"></a>00498     
<a name="l00499"></a>00499   }
<a name="l00500"></a>00500   
<a name="l00501"></a>00501 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Tue Dec 23 19:05:14 2014 for TKE by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
